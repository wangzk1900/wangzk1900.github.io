<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.1.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="记录学习总结和思考">
<meta property="og:type" content="website">
<meta property="og:title" content="wangzk1900&#39;s site">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="wangzk1900&#39;s site">
<meta property="og:description" content="记录学习总结和思考">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="wangzk1900&#39;s site">
<meta name="twitter:description" content="记录学习总结和思考">





  
  
  <link rel="canonical" href="http://yoursite.com/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>wangzk1900's site</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">wangzk1900's site</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">我的小站</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/22/Servlet_07_分发请求/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wangzk1900">
      <meta itemprop="description" content="记录学习总结和思考">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangzk1900's site">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/22/Servlet_07_分发请求/" class="post-title-link" itemprop="url">07_分发请求</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-22 00:00:00" itemprop="dateCreated datePublished" datetime="2019-08-22T00:00:00+08:00">2019-08-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-20 15:26:10" itemprop="dateModified" datetime="2019-08-20T15:26:10+08:00">2019-08-20</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java-EE/" itemprop="url" rel="index"><span itemprop="name">Java EE</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java-EE/Servlet/" itemprop="url" rel="index"><span itemprop="name">Servlet</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>构建Web应用时，把请求转发给另一个servlet处理、或在response中包含另一个servlet的输出通常是很有用的。<code>RequestDispatcher</code>接口提供了一种机制来实现这种功能。</p>
<p>此接口的主要目的是包装 Servlet，但 Servlet 容器可以创建 RequestDispatcher 对象来包装任何类型的资源。被包装的 Servlet 也被称为目标 Servlet。</p>
<h1 id="获取RequestDispatcher"><a href="#获取RequestDispatcher" class="headerlink" title="获取RequestDispatcher"></a>获取RequestDispatcher</h1><p>使用<code>ServletContext</code>接口的下面两个方法获取 RequestDispatcher：</p>
<ul>
<li><strong>getRequestDispatcher(String path)</strong>  – path 需是基于 ServletContext 根路径的</li>
<li><strong>getNamedDispatcher(String name)</strong> – name 是一个 Servlet 名称，即在web.xml中<code>&lt;servlet-name&gt;</code>标签指定的名称或<code>@WebServlet</code>注解指定的名称。</li>
</ul>
<p>另外，也可以使用<code>ServletRequest</code>接口的<code>getRequestDispatcher(String path)</code>方法。这个方法的 path 参数指定的路径需是相对于当前 Servlet 的。</p>
<h1 id="Include-方法"><a href="#Include-方法" class="headerlink" title="Include 方法"></a>Include 方法</h1><p>用途：将目标 Servlet 输出的内容添加到当前 Servlet 对象的输出中。</p>
<p>该方法可在任何时间被调用，目标 Servlet 可以访问 Request 对象中的所有内容，但它只能把信息写到 Request 对象的<code>ServletOutputStream</code>或<code>Writer</code>中，或提交在最后写保留在response缓冲区中的内容，或通过显式地调用<code>ServletResponse</code>接口的<code>flushBuffer</code>方法。它不能设置响应头部信息或调用任何影响响应头部信息的方法，<code>HttpServletRequest.getSession()</code>和<code>HttpServletRequest.getSession(boolean)</code>方法除外。</p>
<p>当使用<code>getRequestDispatcher(String path)</code>方法获取 RequestDispatcher 对象时，传入入目标 Servlet 的 Request 对象必需设置下面这些属性：</p>
<blockquote>
<p>javax.servlet.include.request_uri<br>javax.servlet.include.context_path<br>javax.servlet.include.servlet_path<br>javax.servlet.include.mapping<br>javax.servlet.include.path_info<br>javax.servlet.include.query_string</p>
</blockquote>
<p>这些属性有什么用？？？</p>
<h1 id="Forward-方法"><a href="#Forward-方法" class="headerlink" title="Forward 方法"></a>Forward 方法</h1><p>用途： 将 Request 对象转发给目标 Servlet 处理。</p>
<p>如果已经访问了 ServletOutputStream 对象或者 PrintWriter 对象，那么就不能调用该方法了。</p>
<p>当使用<code>getRequestDispatcher(String path)</code>方法获取 RequestDispatcher 对象时，传入入目标 Servlet 的 Request 对象必需设置下面这些属性：</p>
<blockquote>
<p>javax.servlet.forward.mapping<br>javax.servlet.forward.request_uri<br>javax.servlet.forward.context_path<br>javax.servlet.forward.servlet_path<br>javax.servlet.forward.path_info<br>javax.servlet.forward.query_string</p>
</blockquote>
<p>通过这些属性，目标 Servlet 可以访问<strong>原始</strong> Request 对象中的请求路径。</p>
<h1 id="Dispatch方法"><a href="#Dispatch方法" class="headerlink" title="Dispatch方法"></a>Dispatch方法</h1><p><code>AsyncContext</code>接口提供了 dispatch 方法，使用该方法可以对请求进行分发。</p>
<ul>
<li><strong>dispatch(path)</strong> – path 需是基于 ServletContext 根路径的</li>
<li><strong>dispatch(servletContext, path)</strong></li>
<li><strong>dispatch()</strong></li>
</ul>
<p>目标 Servlet 可以通过下面这些属性名访问原始 Request 中的路径信息。</p>
<blockquote>
<p>javax.servlet.async.mapping<br>javax.servlet.async.request_uri<br>javax.servlet.async.context_path<br>javax.servlet.async.servlet_path<br>javax.servlet.async.path_info<br>javax.servlet.async.query_string</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/21/Servlet_06_Filter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wangzk1900">
      <meta itemprop="description" content="记录学习总结和思考">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangzk1900's site">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/21/Servlet_06_Filter/" class="post-title-link" itemprop="url">06_Filter</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-21 00:00:00" itemprop="dateCreated datePublished" datetime="2019-08-21T00:00:00+08:00">2019-08-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-20 15:44:34" itemprop="dateModified" datetime="2019-08-20T15:44:34+08:00">2019-08-20</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java-EE/" itemprop="url" rel="index"><span itemprop="name">Java EE</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java-EE/Servlet/" itemprop="url" rel="index"><span itemprop="name">Servlet</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="过滤器是什么"><a href="#过滤器是什么" class="headerlink" title="过滤器是什么"></a>过滤器是什么</h1><p>过滤器是一个可以转换请求或响应的报头和内容（或两者）的对象。</p>
<p>过滤器的主要任务：</p>
<ul>
<li>Query the request and act accordingly.</li>
<li>Block the request-and-response pair from passing any further.</li>
<li>Modify the request headers and data. You do this by providing a customized version of the request.</li>
<li>Modify the response headers and data. You do this by providing a customized version of the response.</li>
<li>Interact with external resources.</li>
</ul>
<p>过滤器类型：</p>
<ul>
<li>Authentication filters</li>
<li>Logging and auditing filters</li>
<li>Image conversion filters</li>
<li>Data compression filters</li>
<li>Encryption filters</li>
<li>Tokenizing filters</li>
<li>Filters that trigger resource access events</li>
<li>XSL/T filters that transform XML content</li>
<li>MIME-type chain filters</li>
<li>Caching filters</li>
</ul>
<p>过滤器相关的API主要包括：<code>javax.servlet.Filter</code>，<code>javax.servlet.FilterChain</code>和<code>javax.servlet.FilterConfig</code>。<br>通过实现<code>javax.servlet.Filter</code>接口来定义一个 Filter。</p>
<h1 id="过滤器配置"><a href="#过滤器配置" class="headerlink" title="过滤器配置"></a>过滤器配置</h1><p>Filter 定义完成之后，需要进行相关配置告诉 Servlet 容器这是一个过滤器以及在什么情况下调用这个过滤器。和 Servlet 类一样，有两种配置方式。</p>
<h2 id="使用配置文件"><a href="#使用配置文件" class="headerlink" title="使用配置文件"></a>使用配置文件</h2><p>在web.xml文件使用<code>&lt;filter&gt;</code>和<code>&lt;filter-mapping&gt;</code>标签进行配置。</p>
<p><strong>\&lt;filter>标签</strong><br>使用<code>&lt;filter&gt;</code>标签声明一个过滤器，这个标签主要包含下面三个子标签：</p>
<ul>
<li>filter-name : used to map the filter to a servlet or URL</li>
<li>filter-class : used by the container to identify the filter type</li>
<li>init-params : initialization parameters for a filter</li>
</ul>
<p><em>示例：</em><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>Image Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.example.ImageServlet<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><strong>\&lt;filter-mapping>标签</strong><br>使用<code>&lt;filter-mapping&gt;</code>标签指定过滤器需要处理的Servlet或静态资源。</p>
<p><em>示例：</em><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>Image Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ImageServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>Logging Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>另外，从 Servlet 2.4 开始，增加了一个新特性，就是基于<code>forward()</code>和<code>include()</code>方法调用过滤器。<br>在 <code>&lt;filter-mapping&gt;</code>标签下增加了一个<code>&lt;dispatcher&gt;</code>子标签。可配置的值有下面几个：</p>
<ul>
<li><strong>REQUEST</strong> – 客户端直接发来的请求，匹配<code>&lt;servlet-name&gt;</code>或<code>&lt;url-pattern&gt;</code>时调用过滤器。</li>
<li><strong>FORWARD</strong> – RequestDispatcher匹配<code>&lt;servlet-name&gt;</code>或<code>&lt;url-pattern&gt;</code>，并且用<code>forward()</code>方法处理请求时，调用过滤器。</li>
<li><strong>INCLUDE</strong> – RequestDispatcher匹配<code>&lt;servlet-name&gt;</code>或<code>&lt;url-pattern&gt;</code>，并且用<code>include()</code>方法处理请求时，调用过滤器。</li>
<li><strong>ERROR</strong> – 返回给客户端的error页面匹配<code>&lt;url-pattern&gt;</code>时调用过滤器。</li>
<li><strong>ASYNC</strong> – 当被<code>AsyncContext</code>接口的<code>dispatch</code>方法处理的请求匹配<code>&lt;url-pattern&gt;</code>时调用过滤器。</li>
</ul>
<p><em>示例：</em></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>Logging Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ProductServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dispatcher</span>&gt;</span>INCLUDE<span class="tag">&lt;/<span class="name">dispatcher</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="使用注解配置"><a href="#使用注解配置" class="headerlink" title="使用注解配置"></a>使用注解配置</h2><p>使用<code>@WebFilter</code>注解。</p>
<p><em>示例：</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebFilter;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebInitParam;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebFilter</span>(filterName = <span class="string">"TimeOfDayFilter"</span>,</span><br><span class="line">urlPatterns = &#123;<span class="string">"/*"</span>&#125;,</span><br><span class="line">initParams = &#123;</span><br><span class="line">    <span class="meta">@WebInitParam</span>(name = <span class="string">"mood"</span>, value = <span class="string">"awake"</span>)&#125;</span><br><span class="line">dispatcherTypes= &#123;DispatcherType.INCLUDE&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeOfDayFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/20/Servlet_05_Response/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wangzk1900">
      <meta itemprop="description" content="记录学习总结和思考">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangzk1900's site">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/20/Servlet_05_Response/" class="post-title-link" itemprop="url">05_Response</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-20 00:00:00" itemprop="dateCreated datePublished" datetime="2019-08-20T00:00:00+08:00">2019-08-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-19 14:10:38" itemprop="dateModified" datetime="2019-08-19T14:10:38+08:00">2019-08-19</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java-EE/" itemprop="url" rel="index"><span itemprop="name">Java EE</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java-EE/Servlet/" itemprop="url" rel="index"><span itemprop="name">Servlet</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>所有的 Response 类都要实现<code>ServletResponse</code>接口。<br>与 Request 对象一样，Response 对象是由 Servlet 容器负责创建和维护的，并将其传入 Servlet 对象的 <code>service()</code>方法。<br>利用 Response 对象中的方法，我们可以编写响应给客户端的内容，做一些相关的配置。</p>
<h1 id="缓冲（Buffering）"><a href="#缓冲（Buffering）" class="headerlink" title="缓冲（Buffering）"></a>缓冲（Buffering）</h1><p>为了提高效率，可以利用<code>ServletResponse</code>接口提供的一些方法设置缓冲。</p>
<p>相关的方法：<br>■ getBufferSize<br>■ setBufferSize<br>■ isCommitted<br>■ reset<br>■ resetBuffer<br>■ flushBuffer</p>
<h1 id="响应头（Headers）"><a href="#响应头（Headers）" class="headerlink" title="响应头（Headers）"></a>响应头（Headers）</h1><p>利用<code>HttpServletResponse</code>接口提供的方法可以设置响应头中的信息：<br>■ setHeader<br>■ addHeader<br>■ setIntHeader<br>■ setDateHeader<br>■ addIntHeader<br>■ addDateHeader</p>
<h1 id="便利方法"><a href="#便利方法" class="headerlink" title="便利方法"></a>便利方法</h1><p><strong>重定向（Redirect）</strong><br>利用<code>HttpServletResponse</code>接口的<code>sendRedirect</code>方法设置适当的响应信息，可以将客户端重定向到不同的URL。</p>
<p><strong>错误信息</strong><br>利用<code>HttpServletResponse</code>接口的<code>sendError</code>方法可以在响应中设置错误信息。</p>
<h1 id="国际化"><a href="#国际化" class="headerlink" title="国际化"></a>国际化</h1><p>编写 Servlet 时，根据不同的地区和语言，应该设置 Response 的区域（locale）和字符编码。<br>区域的默认值由 Servlet 容器默认设置有关，字符编码的默认值是：ISO-8859-1。</p>
<p>在web.xml显式配置区域和字符编码：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--设置区域--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">locale-encoding-mapping-list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">locale-encoding-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">locale</span>&gt;</span>ja<span class="tag">&lt;/<span class="name">locale</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>Shift_JIS<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">locale-encoding-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">locale-encoding-mapping-list</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--设置字符编码，对所有response有效--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">response-character-encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">response-character-encoding</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><code>ServletResponse</code>提供的相关方法：</p>
<ul>
<li>getCharacterEncoding</li>
<li>setCharacterEncoding</li>
<li>getContentType</li>
<li>setContentType</li>
<li>getLocale</li>
<li>setLocale  – 设置区域，并根据web.xml中配置的映射关系或者容器提供的映射关系，设置字符编码。当<code>setCharacterEncoding</code>和<code>setContentType</code>方法都未调用时，该方法设置的字符编码才有效。</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/19/Servlet_04_Request/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wangzk1900">
      <meta itemprop="description" content="记录学习总结和思考">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangzk1900's site">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/19/Servlet_04_Request/" class="post-title-link" itemprop="url">04_Request</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-19 00:00:00 / 修改时间：14:10:24" itemprop="dateCreated datePublished" datetime="2019-08-19T00:00:00+08:00">2019-08-19</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java-EE/" itemprop="url" rel="index"><span itemprop="name">Java EE</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java-EE/Servlet/" itemprop="url" rel="index"><span itemprop="name">Servlet</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>所有的 Request 类都要实现<code>ServletRequest</code>接口，<code>HttpServletRequest</code>对象中包含请求URL、HTTP报头、查询字符串等数据。<br>Request 对象是由 Servlet 容器负责创建和维护的，并将其传入 Servlet 对象的 <code>service()</code>方法。<br>利用 Request 对象提供的方法，我们可以获取跟请求相关的数据。</p>
<h1 id="HTTP协议参数"><a href="#HTTP协议参数" class="headerlink" title="HTTP协议参数"></a>HTTP协议参数</h1><p>利用下面的方法可以获取请求参数信息，比如表单中的参数名称和值。<br>■ getParameter<br>■ getParameterNames<br>■ getParameterValues<br>■ getParameterMap</p>
<h1 id="上传文件"><a href="#上传文件" class="headerlink" title="上传文件"></a>上传文件</h1><p>通过 Request 可以获取表单中<code>multipart/form-data</code>格式的数据，从而实现文件上传的功能。<br>为了使 Servlet 能够处理<code>multipart/form-data</code>格式的数据，需要进行一些额外的配置。</p>
<p><strong>配置方式一：</strong><br>使用web.xml文件，需要在<code>&lt;servlet&gt;</code>标签下使用<code>&lt;multipart-config&gt;</code>进行配置，如下所示：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>FileUpload<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.my.request.FileUpload<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">multipart-config</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">location</span>&gt;</span>/tmp<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">max-file-size</span>&gt;</span>20848820<span class="tag">&lt;/<span class="name">max-file-size</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">max-request-size</span>&gt;</span>418018841<span class="tag">&lt;/<span class="name">max-request-size</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file-size-threshold</span>&gt;</span>1048576<span class="tag">&lt;/<span class="name">file-size-threshold</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">multipart-config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><strong>配置方式二：</strong><br>使用<code>@MultipartConfig</code>注解，如下所示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet</span>(<span class="string">"/FileUpload"</span>)</span><br><span class="line"><span class="meta">@MultipartConfig</span>(location=<span class="string">"/tmp"</span>, fileSizeThreshold=<span class="number">1024</span>*<span class="number">1024</span>,</span><br><span class="line">maxFileSize=<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">5</span>, maxRequestSize=<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">5</span>*<span class="number">5</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileUpload</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="属性（Attributes）"><a href="#属性（Attributes）" class="headerlink" title="属性（Attributes）"></a>属性（Attributes）</h1><p>属性分为两种：<br>一种是 Servlet 容器设置的一些属性。<br>另外，Servlet 也可以设置属性，通过这种方式与其它 Servlet 进行沟通。</p>
<p>在某些情况下，Servlet 规范规定了 Servlet 容器必须设置一些属性。比如，当客户端通过安全协议（比如：HTTPS）发送请求时，Servlet 容器必须设置下面三个属性：</p>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Attribute Name</th>
<th>Java Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>cipher suite</td>
<td>javax.servlet.request.cipher_suite</td>
<td>String</td>
</tr>
<tr>
<td>bit size of the algorithm</td>
<td>javax.servlet.request.key_size</td>
<td>Integer</td>
</tr>
<tr>
<td>SSL session id</td>
<td>javax.servlet.request.ssl_session_id</td>
<td>String</td>
</tr>
</tbody>
</table>
<p>Request 中访问属性的方法：<br>■ getAttribute<br>■ getAttributeNames<br>■ setAttribute</p>
<h1 id="请求头（Headers）"><a href="#请求头（Headers）" class="headerlink" title="请求头（Headers）"></a>请求头（Headers）</h1><p>通过<code>HttpServletRequest</code>接口的方法可以访问 HTTP 请求头中的信息。</p>
<p>相关的方法：<br>■ getHeader<br>■ getHeaders<br>■ getHeaderNames<br>■ getIntHeader<br>■ getDateHeader</p>
<h1 id="请求路径"><a href="#请求路径" class="headerlink" title="请求路径"></a>请求路径</h1><p>一个请求URL包含下面几部分：<br><code>http://[host]:[port][request-path]?[query-string]</code></p>
<p>其中的<code>request-path</code>包含下面三种元素：</p>
<ul>
<li><strong>Context path</strong>: A concatenation of a forward slash ( / ) with the context root of the servlet’s web application.</li>
<li><strong>Servlet path</strong>: The path section that corresponds to the component alias that activated this request. This path starts with a forward slash ( / ).</li>
<li><strong>Path info</strong>: The part of the request path that is not part of the context path or the servlet path.</li>
</ul>
<p><strong>request-path = contextPath + servletPath + pathInfo</strong><br>可以通过<code>getContextPath()</code>，<code>getServletPath()</code>和<code>getPathInfo()</code>方法访问这些信息。</p>
<p>另外，Servlet API 还提供了两个便捷的方法来获取真实的系统路径：<br>■ ServletContext.getRealPath<br>■ HttpServletRequest.getPathTranslated</p>
<h1 id="Cookies"><a href="#Cookies" class="headerlink" title="Cookies"></a>Cookies</h1><p><code>HttpServletRequest</code>接口提供了<code>getCookies</code>方法来获取 HTTP 请求中的 cookie。</p>
<h1 id="Request-编码"><a href="#Request-编码" class="headerlink" title="Request 编码"></a>Request 编码</h1><p><strong>获取 Request 编码</strong><br>使用<code>getCharacterEncoding()</code>方法，若浏览器发送的请求中没有包含编码信息，则该方法返回 NULL。</p>
<p><strong>设置 Request 编码</strong><br>有三种方法：</p>
<ul>
<li>使用<code>ServletContext</code>中的<code>setRequestCharacterEncoding(String enc)</code>方法。</li>
<li>在 web.xml 文件中使用<code>&lt;request-character-encoding&gt;</code>元素指定。</li>
<li>使用<code>ServletRequest</code>接口中的<code>setCharacterEncoding(String enc)</code>方法。</li>
</ul>
<p><code>setCharacterEncoding(String enc)</code>方法可以覆盖前两种方法设置的值。并且，该方法必须在从 Request 中获取数据之前设置，否则无效。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/18/Servlet_03_Servlet 定义/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wangzk1900">
      <meta itemprop="description" content="记录学习总结和思考">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangzk1900's site">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/18/Servlet_03_Servlet 定义/" class="post-title-link" itemprop="url">03_Servlet 定义</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-18 00:00:00" itemprop="dateCreated datePublished" datetime="2019-08-18T00:00:00+08:00">2019-08-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-20 13:52:03" itemprop="dateModified" datetime="2019-08-20T13:52:03+08:00">2019-08-20</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java-EE/" itemprop="url" rel="index"><span itemprop="name">Java EE</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java-EE/Servlet/" itemprop="url" rel="index"><span itemprop="name">Servlet</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在 Web 应用开发中，要定义一个 Servlet 需要继承<code>javax.servlet.http.HttpServlet</code>类。</p>
<p>针对不同的请求，可以定义不同的 Servlet 进行处理。我们需要配置请求和 Servlet 之间的映射关系，否则 Web 容器接收请求之后不知道将请求发送给谁处理。</p>
<p>Servlet 规范提供了两种方式：<br>方式一：在 web.xml 文件中注册 Servlet，并配置 Servlet 和请求路径（URL）的映射关系。<br>方式二：使用<code>@WebServlet</code>注解修饰 Servlet 类，并指定对应的请求路径（URL）。</p>
<p><strong>示例一：</strong>在web.xml文件进行配置<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee                                               http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">version</span>=<span class="string">"4.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>servlet_study_01<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>index.html<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>index.htm<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>index.jsp<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DisplayParameters<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.my.request.DisplayParameters<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DisplayParameters<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/DisplayParameters<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>Web 容器会根据<code>&lt;url-pattern&gt;</code>找到对应的<code>&lt;servlet-name&gt;</code>，然后根据<code>&lt;servlet-name&gt;</code>找到对应的<code>&lt;servlet-class&gt;</code>，从而对其进行加载和实例化。</p>
<p><strong>示例二：</strong>使用<code>@WebServlet</code>注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet</span>(<span class="string">"/report"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MoodServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Web 容器把Servlet类加载和实例化之后，会调用<code>init()</code>方法对Servlet进行初始化。<br>我们也可以重写Servlet接口的<code>init()</code>方法，或者在<code>@WebServlet</code>注解中指定<code>initParams</code>属性。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/17/Servlet_02_Servlet 生命周期/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wangzk1900">
      <meta itemprop="description" content="记录学习总结和思考">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangzk1900's site">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/17/Servlet_02_Servlet 生命周期/" class="post-title-link" itemprop="url">02_Servlet 生命周期</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-17 00:00:00" itemprop="dateCreated datePublished" datetime="2019-08-17T00:00:00+08:00">2019-08-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-16 12:25:26" itemprop="dateModified" datetime="2019-08-16T12:25:26+08:00">2019-08-16</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java-EE/" itemprop="url" rel="index"><span itemprop="name">Java EE</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java-EE/Servlet/" itemprop="url" rel="index"><span itemprop="name">Servlet</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h1><p>Servlet 生命周期包括从它被加载、实例化到销毁的全过程：</p>
<ul>
<li>加载 Servlet 类并实例化（时机：在 Servlet 被需要时加载，也可以指定在容器启动时加载）</li>
<li>调用<code>init ()</code>方法对 Servlet 进行初始化。</li>
<li>调用<code>service()</code>方法，传入 Request 和 Response 对象，处理来自客户端的请求。</li>
<li>调用<code>destroy()</code>方法释放 Servelet 占用的资源并进行必要的持久化。</li>
</ul>
<p>调用<code>destroy()</code>方法之后，Servlet 容器需要释放这个实例，以便  JVM 的垃圾回收器对其进行回收。</p>
<h2 id="init-方法"><a href="#init-方法" class="headerlink" title="init() 方法"></a>init() 方法</h2><p>在 Servlet 生命周期中，<code>init()</code>方法只会被调用一次。即：在 Servlet 被实例化的时候被调用。</p>
<p>定义init() 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">  <span class="comment">// Initialization code...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="service-方法"><a href="#service-方法" class="headerlink" title="service() 方法"></a>service() 方法</h2><p>service() 方法是<code>javax.servlet</code>接口中定义的方法。</p>
<p>另外，<code>javax.servlet.http.HttpServlet</code>抽象类中新增了下面这些方法：</p>
<ul>
<li><code>doGet()</code> for handling HTTP  GET requests</li>
<li><code>doPost()</code> for handling HTTP  POST requests</li>
<li><code>doPut()</code> for handling HTTP  PUT requests</li>
<li><code>doDelete()</code> for handling HTTP  DELETE requests</li>
<li><code>doHead()</code> for handling HTTP  HEAD requests</li>
<li><code>doOptions()</code> for handling HTTP  OPTIONS requests</li>
<li><code>doTrace()</code> for handling HTTP  TRACE requests</li>
</ul>
<p>这些方法专门用来处理 HTTP 请求，编写<code>HttpServlet</code>的子类时只需根据客户端的请求类型来重写上面的某些方法。<br><code>service()</code>方法会检查 HTTP 请求类型（GET、POST、PUT、DELETE 等），并在适当的时候调用 <code>doGet()</code>、<code>doPost()</code>、<code>doPut()</code>、<code>doDelete()</code> 等方法。</p>
<p>定义 doGet() 和 doPost() 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// doGet() 方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">// Servlet code</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// doPost() 方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">// Servlet code</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="destroy-方法"><a href="#destroy-方法" class="headerlink" title="destroy() 方法"></a>destroy() 方法</h2><p><code>destroy()</code>方法只在 Servlet  生命周期结束时被调用一次。<code>destroy()</code>方法可以让你的 Servlet 关闭数据库连接、停止后台线程、将 cookie 列表或点击计数器写入磁盘，并执行其他类似的清理活动。</p>
<p>定义destroy() 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Finalization code...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="生命周期事件"><a href="#生命周期事件" class="headerlink" title="生命周期事件"></a>生命周期事件</h1><p>在Servlet生命周期中，我们可以监控发生的事件并作出反应。</p>
<p>生命周期事件：</p>
<table>
<thead>
<tr>
<th>Object</th>
<th>Event</th>
<th>Listener Interface and Event Class</th>
</tr>
</thead>
<tbody>
<tr>
<td>Web context</td>
<td>Initialization and destruction</td>
<td>javax.servlet.ServletContextListener and ServletContextEvent</td>
</tr>
<tr>
<td>Web context</td>
<td>Attribute added, removed, or replaced</td>
<td>javax.servlet.ServletContextAttributeListener andServletContextAttributeEvent</td>
</tr>
<tr>
<td>Session</td>
<td>Creation, invalidation, activation, passivation, and timeout</td>
<td>javax.servlet.http.HttpSessionListener,javax.servlet.http.HttpSessionActivationListener, and HttpSessionEvent</td>
</tr>
<tr>
<td>Session</td>
<td>Attribute added, removed, or replaced</td>
<td>javax.servlet.http.HttpSessionAttributeListener andHttpSessionBindingEvent</td>
</tr>
<tr>
<td>Request</td>
<td>A servlet request has started being processed by web components</td>
<td>javax.servlet.ServletRequestListener and ServletRequestEvent</td>
</tr>
<tr>
<td>Request</td>
<td>Attribute added, removed, or replaced</td>
<td>javax.servlet.ServletRequestAttributeListener andServletRequestAttributeEvent</td>
</tr>
</tbody>
</table>
<p>使用<code>@WebListener</code>注解定义一个监听器，<code>@WebListener</code>注解的类必须实现下面的某个接口：</p>
<blockquote>
<p>javax.servlet.ServletContextListener<br>javax.servlet.ServletContextAttributeListener<br>javax.servlet.ServletRequestListener<br>javax.servlet.ServletRequestAttributeListener<br>javax.servlet..http.HttpSessionListener<br>javax.servlet..http.HttpSessionAttributeListener</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/16/Servlet_01_Servlet 介绍/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wangzk1900">
      <meta itemprop="description" content="记录学习总结和思考">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangzk1900's site">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/08/16/Servlet_01_Servlet 介绍/" class="post-title-link" itemprop="url">01_Servlet 介绍</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-16 00:00:00" itemprop="dateCreated datePublished" datetime="2019-08-16T00:00:00+08:00">2019-08-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-20 14:10:26" itemprop="dateModified" datetime="2019-08-20T14:10:26+08:00">2019-08-20</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java-EE/" itemprop="url" rel="index"><span itemprop="name">Java EE</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java-EE/Servlet/" itemprop="url" rel="index"><span itemprop="name">Servlet</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>Servlet 是什么？</strong><br>Servlet 是基于 java 的 web 组件（Java对象），用来处理客户端请求并动态生成响应内容。<br>Servlet 容器管理这些对象的创建、初始化和销毁。可以使用 Servlet 技术来开发简单的 Web 应用。</p>
<p><strong>Servlet 容器</strong><br>Servlet 容器有时又被称为 Servlet 引擎，是Web服务器或应用程序服务器的一部分。常用的 Servlet 容器有：Tomcat、WebLogic、WebSphere等。</p>
<p><strong>Web 应用</strong></p>
<p>下图是编译、打包（war包）之后 Web 应用的目录结构：<br><img src="/images/servlet/web_module_structure.png" alt="Web Module Structure"><br><code>WEB-INF/classes</code>目录：存放编写的 Servlet 类、Filter类以及各种业务类的class文件；<br><code>WEB-INF/bin</code>目录：存放应用依赖的jar包；<br><code>WEB-INF/web.xml</code>配置文件：包含Web 组件的配置和部署信息；<br><code>Web pages</code>：一般是html、jsp文件，可以被浏览器直接访问。</p>
<p><strong>Servlet 规范</strong><br>JSR 53: Java Servlet 2.3 and JavaServer Pages 1.2 Specifications<br>JSR 154: Java Servlet 2.4 Specification<br>JSR 315: Java Servlet 3.0 Specification<br>JSR 340: Java Servlet 3.1 Specification<br>JSR 369: Java Servlet 4.0 Specification</p>
<p>Servlet 规范（JSR 369）：<a href="https://jcp.org/en/jsr/detail?id=369" target="_blank" rel="noopener">https://jcp.org/en/jsr/detail?id=369</a><br>Servlet 参考实现（RI）：<a href="https://github.com/javaee/servlet-spec" target="_blank" rel="noopener">https://github.com/javaee/servlet-spec</a><br>Collaboration home for Java Servlet Specification：<a href="https://javaee.github.io/servlet-spec/" target="_blank" rel="noopener">https://javaee.github.io/servlet-spec/</a></p>
<p><strong>Servlet API</strong><br>Java 包：<code>javax.servle</code>和<code>javax.servlet.http</code>提供了用来编写 Servlet 的接口和类。</p>
<p>Java(TM) EE 7 Specification APIs：<br><a href="https://docs.oracle.com/javaee/7/api/toc.htm" target="_blank" rel="noopener">https://docs.oracle.com/javaee/7/api/toc.htm</a></p>
<p><strong>相关教程</strong><br>The Java EE 7 Tutorial: <a href="https://docs.oracle.com/javaee/7/tutorial/index.html" target="_blank" rel="noopener">https://docs.oracle.com/javaee/7/tutorial/index.html</a><br>Servlets Tutorial: <a href="https://www.tutorialspoint.com/servlets/" target="_blank" rel="noopener">https://www.tutorialspoint.com/servlets/</a><br>Servlet 教程：<a href="https://www.runoob.com/servlet/servlet-tutorial.html" target="_blank" rel="noopener">https://www.runoob.com/servlet/servlet-tutorial.html</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/24/MySQL安装/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wangzk1900">
      <meta itemprop="description" content="记录学习总结和思考">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangzk1900's site">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/24/MySQL安装/" class="post-title-link" itemprop="url">MySQL安装</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-24 00:00:00 / 修改时间：14:42:15" itemprop="dateCreated datePublished" datetime="2019-07-24T00:00:00+08:00">2019-07-24</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>实验环境</strong><br>虚拟机软件：VMware Workstation 15 Pro<br>虚拟机系统：CentOS Linux release 7.2.1511 (Core)<br>虚拟机内存：4G</p>
<p>MySQL 在 CentOS 上有三种安装方式：</p>
<ul>
<li>使用通用的二进制包进行安装</li>
<li>使用 rpm 包安装</li>
<li>使用源码自行编译安装</li>
</ul>
<h1 id="通用的二进制包"><a href="#通用的二进制包" class="headerlink" title="通用的二进制包"></a>通用的二进制包</h1><p>下载地址：<a href="https://dev.mysql.com/downloads/mysql/" target="_blank" rel="noopener">https://dev.mysql.com/downloads/mysql/</a><br>操作系统选择：Linux - Generic</p>
<p>首先，将二进制包上传到/tmp目录下，然后按照下面的步骤进行安装。其中5.7之前和之后的版本在初始化时稍有不同。</p>
<h2 id="版本5-7之前"><a href="#版本5-7之前" class="headerlink" title="版本5.7之前"></a>版本5.7之前</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 卸载系统自带的mariadb</span><br><span class="line">rpm -qa | grep mariadb</span><br><span class="line">rpm -evh --nodeps mariadb-libs-5.5.44-2.el7.centos.x86_64</span><br><span class="line"><span class="meta">#</span># 或者使用yum</span><br><span class="line">yum list installed | grep mariadb</span><br><span class="line">yum -y remove mariadb-libs.x86_64</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 创建用户和组</span><br><span class="line">groupadd mysql</span><br><span class="line">useradd -r -g mysql -s /bin/false mysql</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 切换到/tmp目录，解压</span><br><span class="line">cd /tmp</span><br><span class="line">tar zxvf mysql-5.5.62-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line"><span class="meta">#</span>tar zxvf mysql-5.6.44-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 将解压后的目录移动到/usr/local目录下</span><br><span class="line">mv mysql-5.5.62-linux-glibc2.12-x86_64 /usr/local/mysql</span><br><span class="line"><span class="meta">#</span>mv mysql-5.6.44-linux-glibc2.12-x86_64 /usr/local/mysql</span><br><span class="line">chown mysql:mysql -R /usr/local/mysql</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 初始化数据目录</span><br><span class="line">cd /usr/local/mysql/</span><br><span class="line">scripts/mysql_install_db --user=mysql</span><br><span class="line">chown -R root .</span><br><span class="line">chown -R mysql data</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 启动和关闭</span><br><span class="line">cp support-files/my-medium.cnf /etc/my.cnf # 版本5.5</span><br><span class="line">bin/mysqld_safe --user=mysql &amp;</span><br><span class="line">bin/mysqladmin shutdown</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span> 配置MySQL开机自动启动</span><br><span class="line">cp support-files/mysql.server /etc/init.d/mysql.server</span><br><span class="line">chmod 755 /etc/init.d/mysql.server</span><br><span class="line">systemctl enable mysql.server</span><br></pre></td></tr></table></figure>
<h2 id="版本5-7之后"><a href="#版本5-7之后" class="headerlink" title="版本5.7之后"></a>版本5.7之后</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 卸载系统自带的mariadb</span><br><span class="line">rpm -qa | grep mariadb</span><br><span class="line">rpm -evh --nodeps mariadb-libs-5.5.44-2.el7.centos.x86_64</span><br><span class="line"><span class="meta">#</span># 或者使用yum</span><br><span class="line">yum list installed | grep mariadb</span><br><span class="line">yum -y remove mariadb-libs.x86_64</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 创建用户和组</span><br><span class="line">groupadd mysql</span><br><span class="line">useradd -r -g mysql -s /bin/false mysql</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 切换到/tmp目录，解压</span><br><span class="line">cd /tmp</span><br><span class="line">tar zxvf mysql-5.7.26-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 将解压后的目录移动到/usr/local目录下</span><br><span class="line">mv mysql-5.7.26-linux-glibc2.12-x86_64 /usr/local/mysql</span><br><span class="line">chown mysql:mysql -R /usr/local/mysql</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 初始化数据目录</span><br><span class="line">cd /usr/local/mysql/</span><br><span class="line">mkdir mysql-files</span><br><span class="line">chmod 750 mysql-files</span><br><span class="line">bin/mysqld --initialize --user=mysql #初始化时会为root@localhost账号生成一个临时密码</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 启动和关闭（关闭时需要输入密码）</span><br><span class="line">bin/mysqld_safe --user=mysql &amp;</span><br><span class="line">bin/mysqladmin shutdown -p</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 配置MySQL开机自动启动</span><br><span class="line">cp support-files/mysql.server /etc/init.d/mysql.server</span><br><span class="line">chmod 755 /etc/init.d/mysql.server</span><br><span class="line">systemctl enable mysql.server</span><br></pre></td></tr></table></figure>
<h2 id="自定义配置"><a href="#自定义配置" class="headerlink" title="自定义配置"></a>自定义配置</h2><p>我们可以自己创建数据库和日志存放目录，配置文件等。在初始化时通过参数指定这些自定义的目录和文件。<br>首先，将安装包上传到<code>/tmp</code>目录，将准备好的配置文件（比如：my3306.cnf）上传到<code>/etc</code>目录下。然后，按照下面的步骤进行安装。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 创建用户和组</span><br><span class="line">groupadd mysql</span><br><span class="line">useradd -r -g mysql -s /bin/false mysql</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 切换到/tmp目录，解压</span><br><span class="line">cd /tmp</span><br><span class="line">tar zxvf mysql-5.6.44-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 将解压后的目录移动到/usr/local目录下</span><br><span class="line">cp -rf mysql-5.6.44-linux-glibc2.12-x86_64 /usr/local/mysql</span><br><span class="line">chown mysql:mysql -R /usr/local/mysql</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 创建数据库目录和日志目录</span><br><span class="line">mkdir -p /data/mysql3306/mysql3306</span><br><span class="line">mkdir -p /data/mysql3306/logs</span><br><span class="line">chown mysql:mysql -R /data</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 初始化数据目录</span><br><span class="line">/usr/local/mysql/scripts/mysql_install_db --basedir=/usr/local/mysql/ --datadir=/data/mysql3306/mysql3306 --defaults-file=/etc/my3306.cnf --user=mysql</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 启动服务</span><br><span class="line">/usr/local/mysql/bin/mysqld_safe --defaults-file=/etc/my3306.cnf --user=mysql &amp;</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span> 连接数据库</span><br><span class="line">/usr/local/mysql/bin/mysql -S /tmp/mysql3306.sock</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 配置环境变量</span><br><span class="line">vim /etc/profile</span><br><span class="line"><span class="meta">#</span> 添加内容：</span><br><span class="line">export PATH=$PATH:/usr/local/mysql/bin</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span> 配置MySQL开机自动启动</span><br><span class="line">cp support-files/mysql.server /etc/init.d/mysql.server</span><br><span class="line">chmod 755 /etc/init.d/mysql.server</span><br><span class="line">systemctl enable mysql.server</span><br></pre></td></tr></table></figure>
<p><code>my3306.cnf</code>文件的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">port= 3306</span><br><span class="line">socket= /tmp/mysql3306.sock</span><br><span class="line">secure_auth= false</span><br><span class="line"> </span><br><span class="line">[mysqld]</span><br><span class="line">port= 3306</span><br><span class="line">socket= /tmp/mysql3306.sock</span><br><span class="line">datadir= /data/mysql3306/mysql3306</span><br><span class="line"><span class="meta">#</span>read_only= on</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span>--- GLOBAL ---#</span><br><span class="line">character_set_server    = utf8</span><br><span class="line">lower_case_table_names  = 1</span><br><span class="line">log-output              = FILE</span><br><span class="line">log-error               = /data/mysql3306/logs/mysql-error.log</span><br><span class="line"><span class="meta">#</span>general_log</span><br><span class="line">general_log_file        = /data/mysql3306/logs/mysql.log</span><br><span class="line">pid-file                = /data/mysql3306/mysql.pid</span><br><span class="line">slow-query-log          = 1</span><br><span class="line">slow_query_log_file     = /data/mysql3306/logs/mysql-slow.log</span><br><span class="line">tmpdir                  = /tmp/</span><br><span class="line">long_query_time         = 2</span><br><span class="line">innodb_force_recovery   = 0</span><br><span class="line"><span class="meta">#</span>innodb_buffer_pool_dump_at_shutdown = 1</span><br><span class="line"><span class="meta">#</span>innodb_buffer_pool_load_at_startup = 1</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span>--------------#</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span>thread_concurrency      = 8</span><br><span class="line">thread_cache_size       = 51</span><br><span class="line">table_open_cache        = 16384</span><br><span class="line">open_files_limit        = 65535</span><br><span class="line">table_definition_cache  = 16384</span><br><span class="line">sort_buffer_size        = 2M</span><br><span class="line">join_buffer_size        = 2M</span><br><span class="line">read_buffer_size        = 2M</span><br><span class="line">read_rnd_buffer_size    = 8M</span><br><span class="line">key_buffer_size         = 32M</span><br><span class="line">bulk_insert_buffer_size = 16M</span><br><span class="line">myisam_sort_buffer_size = 64M</span><br><span class="line">tmp_table_size      = 32M</span><br><span class="line">max_heap_table_size     = 16M</span><br><span class="line">query_cache_size       = 32MB</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span>gtid_mode=on</span><br><span class="line"><span class="meta">#</span>log_slave_updates=1</span><br><span class="line"><span class="meta">#</span>enforce_gtid_consistency=1</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span>--- NETWORK ---#</span><br><span class="line">back_log                = 103</span><br><span class="line">max-connections         = 512</span><br><span class="line">max_connect_errors   = 100000</span><br><span class="line">max_allowed_packet      = 32M</span><br><span class="line">interactive_timeout     = 600</span><br><span class="line">wait_timeout            = 600</span><br><span class="line">skip-external-locking</span><br><span class="line"><span class="meta">#</span>max_user_connections    = 0</span><br><span class="line">external-locking        = FALSE</span><br><span class="line"><span class="meta">#</span>skip-name-resolve</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span>--- REPL ---#</span><br><span class="line">server-id               = 28703306</span><br><span class="line">sync_binlog             = 1</span><br><span class="line">log-bin                 = mysql-bin</span><br><span class="line">binlog_format           = row</span><br><span class="line">expire_logs_days        = 10</span><br><span class="line">relay-log               = relay-log</span><br><span class="line">replicate-ignore-db     = test</span><br><span class="line">log_slave_updates       =1</span><br><span class="line"><span class="meta">#</span>skip-slave-start</span><br><span class="line">binlog_cache_size       =4M</span><br><span class="line">max_binlog_cache_size   =8M</span><br><span class="line">max_binlog_size         =1024M</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span>--- INNODB ---#</span><br><span class="line">default_storage_engine          = InnoDB</span><br><span class="line">innodb_data_file_path           = ibdata1:1024M:autoextend</span><br><span class="line">innodb_buffer_pool_size         = 1040M</span><br><span class="line">innodb_buffer_pool_instances    = 1</span><br><span class="line">innodb_additional_mem_pool_size = 16M</span><br><span class="line">innodb_log_files_in_group       = 2</span><br><span class="line">innodb_log_file_size            = 256MB</span><br><span class="line">innodb_log_buffer_size          = 16M</span><br><span class="line">innodb_flush_log_at_trx_commit  = 2</span><br><span class="line">innodb_lock_wait_timeout        = 30</span><br><span class="line">innodb_flush_method             = O_DIRECT</span><br><span class="line">innodb_max_dirty_pages_pct      = 75</span><br><span class="line">innodb_io_capacity              = 200</span><br><span class="line">innodb_thread_concurrency       = 32</span><br><span class="line">innodb_open_files               = 65535</span><br><span class="line">innodb_file_per_table           = 1</span><br><span class="line">transaction_isolation           = REPEATABLE-READ</span><br><span class="line">innodb_locks_unsafe_for_binlog  = 0</span><br><span class="line"><span class="meta">#</span>innodb_purge_thread             = 4</span><br><span class="line">[mysqldump]</span><br><span class="line">quick</span><br><span class="line">max_allowed_packet = 32M</span><br><span class="line"> </span><br><span class="line">[mysql]</span><br><span class="line">auto-rehash</span><br><span class="line"><span class="meta">#</span> Remove the next comment character if you are not familiar with SQL</span><br><span class="line"><span class="meta">#</span>safe-updates</span><br><span class="line">default_character_set=utf8</span><br><span class="line"> </span><br><span class="line">[mysqlhotcopy]</span><br><span class="line">interactive-timeout</span><br></pre></td></tr></table></figure>
<h1 id="使用RPM包安装"><a href="#使用RPM包安装" class="headerlink" title="使用RPM包安装"></a>使用RPM包安装</h1><p>既可以下载 RPM 安装包进行手动安装，也可以通过 yum 工具进行安装。</p>
<h2 id="使用-yum-工具"><a href="#使用-yum-工具" class="headerlink" title="使用 yum 工具"></a>使用 yum 工具</h2><p>前提：虚拟机能够访问互联网。<br>特点：不需要手动卸载系统自带的 MariaDB，yum 工具会自动帮我们卸载。</p>
<h3 id="配置-Yum-Repository"><a href="#配置-Yum-Repository" class="headerlink" title="配置 Yum Repository"></a>配置 Yum Repository</h3><p>首先，下载配置 yum 仓库的 rpm 包：<code>mysql80-community-release-el7-3.noarch.rpm</code><br>下载地址：<a href="https://dev.mysql.com/downloads/repo/yum/" target="_blank" rel="noopener">https://dev.mysql.com/downloads/repo/yum/</a></p>
<p>然后将其上传到虚拟机的<code>/tmp</code>目录进行安装。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum localinstall mysql80-community-release-el7-3.noarch.rpm</span><br><span class="line"><span class="meta">#</span> 确认</span><br><span class="line">yum repolist enabled | grep "mysql.*-community.*"</span><br></pre></td></tr></table></figure></p>
<p>安装成功后，可以在<code>/etc/yum.repos.d/</code>目录下找到两个新增的的 <code>repo</code> 文件：<code>mysql-community.repo</code> 和 <code>mysql-community-source.repo</code>。<br>默认启用的是最新版本 MySQL 的 Yum Repository，如下所示，是<code>mysql-community.repo</code>文件中的部分内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[mysql57-community]</span><br><span class="line">name=MySQL 5.7 Community Server</span><br><span class="line">baseurl=http://repo.mysql.com/yum/mysql-5.7-community/el/7/$basearch/</span><br><span class="line">enabled=0</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql</span><br><span class="line"></span><br><span class="line">[mysql80-community]</span><br><span class="line">name=MySQL 8.0 Community Server</span><br><span class="line">baseurl=http://repo.mysql.com/yum/mysql-8.0-community/el/7/$basearch/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql</span><br></pre></td></tr></table></figure>
<p>国外的yum源可能会比较慢，最好可以修改为国内的。比如可以将上面5.7的<code>baseurl</code>修改为网易的地址：<a href="http://mirrors.163.com/mysql/Downloads/MySQL-5.7/" target="_blank" rel="noopener">http://mirrors.163.com/mysql/Downloads/MySQL-5.7/</a></p>
<p>若要安装其它版本的 MySQL ，则需要需改上面的配置文件，也可以使用下面的命令：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager --disable mysql80-community</span><br><span class="line">yum-config-manager --enable mysql57-community</span><br></pre></td></tr></table></figure></p>
<h3 id="安装并启动"><a href="#安装并启动" class="headerlink" title="安装并启动"></a>安装并启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 用yum安装</span><br><span class="line">yum -y install mysql-community-server</span><br><span class="line"><span class="meta">#</span> 启动MySQL服务</span><br><span class="line">systemctl start mysqld.service</span><br><span class="line"><span class="meta">#</span> 查看服务状态</span><br><span class="line">systemctl status mysqld.service</span><br></pre></td></tr></table></figure>
<p>若查看服务状态时，是下面的结果，说明 MySQL 服务没有设置为开机启动。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# systemctl status mysqld.service</span><br><span class="line">● mysqld.service - MySQL Community Server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/mysqld.service; disabled; vendor preset: disabled)</span><br><span class="line">......</span><br></pre></td></tr></table></figure></p>
<p>可使用下面的命令将 MySQL 服务设置为开机启动。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable mysqld.service</span><br></pre></td></tr></table></figure></p>
<h2 id="手动安装"><a href="#手动安装" class="headerlink" title="手动安装"></a>手动安装</h2><h3 id="下载安装包"><a href="#下载安装包" class="headerlink" title="下载安装包"></a>下载安装包</h3><p>下载地址：<a href="https://dev.mysql.com/downloads/mysql/" target="_blank" rel="noopener">https://dev.mysql.com/downloads/mysql/</a><br>操作系统：Red Hat Enterprise Linux / Oracle Linux<br>系统版本：Red Hat Enterprise Linux 7 / Oracle Linux 7 (x86, 64-bit)</p>
<p>可下载的 RPM Bundle：</p>
<blockquote>
<p>MySQL-5.5.62-1.el7.x86_64.rpm-bundle.tar<br>MySQL-5.6.44-1.el7.x86_64.rpm-bundle.tar<br>mysql-5.7.26-1.el7.x86_64.rpm-bundle.tar<br>mysql-8.0.16-2.el7.x86_64.rpm-bundle.tar</p>
</blockquote>
<h3 id="安装并启动-1"><a href="#安装并启动-1" class="headerlink" title="安装并启动"></a>安装并启动</h3><p>首先卸载系统自带的 MariaDB：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 使用rpm卸载</span><br><span class="line">rpm -qa | grep mariadb</span><br><span class="line">rpm -evh --nodeps mariadb-libs-5.5.44-2.el7.centos.x86_64</span><br></pre></td></tr></table></figure></p>
<p>将下载的安装包上传到虚拟机，并安装<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 版本5.5</span><br><span class="line">tar -xvf MySQL-5.5.62-1.el7.x86_64.rpm-bundle.tar</span><br><span class="line">rpm -ivh MySQL-server-5.5.62-1.el7.x86_64.rpm</span><br><span class="line">rpm -ivh MySQL-client-5.5.62-1.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 版本5.6</span><br><span class="line">tar xvf MySQL-5.6.44-1.el7.x86_64.rpm-bundle.tar</span><br><span class="line">rpm -ivh MySQL-server-5.6.44-1.el7.x86_64.rpm</span><br><span class="line">rpm -ivh MySQL-client-5.6.44-1.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 版本5.7</span><br><span class="line">tar xvf mysql-5.7.26-1.el7.x86_64.rpm-bundle.tar</span><br><span class="line">rpm -ivh mysql-community-common-5.7.26-1.el7.x86_64.rpm</span><br><span class="line">rpm -ivh mysql-community-libs-5.7.26-1.el7.x86_64.rpm</span><br><span class="line">rpm -ivh mysql-community-client-5.7.26-1.el7.x86_64.rpm</span><br><span class="line">rpm -ivh mysql-community-server-5.7.26-1.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 版本5.8</span><br><span class="line">tar xvf mysql-8.0.16-2.el7.x86_64.rpm-bundle.tar</span><br><span class="line">rpm -ivh mysql-community-common-8.0.16-2.el7.x86_64.rpm</span><br><span class="line">rpm -ivh mysql-community-libs-8.0.16-2.el7.x86_64.rpm</span><br><span class="line">rpm -ivh mysql-community-client-8.0.16-2.el7.x86_64.rpm</span><br><span class="line">rpm -ivh mysql-community-server-8.0.16-2.el7.x86_64.rpm</span><br></pre></td></tr></table></figure></p>
<p>启动服务：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 5.7之前的版本</span><br><span class="line">mysqld_safe --user=mysql &amp;</span><br><span class="line"><span class="meta">#</span> 5.7版本，及之后的版本</span><br><span class="line">systemctl start mysqld.service</span><br></pre></td></tr></table></figure></p>
<h1 id="通过源码安装"><a href="#通过源码安装" class="headerlink" title="通过源码安装"></a>通过源码安装</h1><p>有两种方法来使用源码安装MySQL:</p>
<ul>
<li>使用一种标准的MySQL源码安装。标准的可用源码文件被压缩成tar文件，zip文件或RPM包。文件名的格式为mysql-version.tar.gz,mysql-version.zip或mysql-version.rpm。其中version是版本号比例如5.7.25。</li>
<li>使用MySQL开发树。</li>
</ul>
<p>使用源码安装所需的前提条件：</p>
<ul>
<li><code>CMake</code>，用来在所有平台上构建框架，可以从 <a href="http://www.cmake.org" target="_blank" rel="noopener">http://www.cmake.org</a> 来下载<code>CMake</code>。</li>
<li>一个好的make程序，强烈建议使用GNU make 3.75或更高版本。可以从<a href="http://www.gnu.org/software/make/" target="_blank" rel="noopener">http://www.gnu.org/software/make/</a> 下载GNU make。</li>
<li><code>ANSI C++</code>编译器。可以对force_unsupported_compiler的描述。</li>
<li><code>ncurses</code>库，可从 <a href="https://www.gnu.org/software/ncurses/ncurses.html" target="_blank" rel="noopener">https://www.gnu.org/software/ncurses/ncurses.html</a> 下载。</li>
<li>为了构建MySQL需要Boost C++库(但不使用它)。Boost 1.59.0必须被安装。为了获得Boost与它的安装指令，可以访问 <a href="https://www.boost.org/" target="_blank" rel="noopener">https://www.boost.org/</a> 网址。（MySQL 5.7）</li>
<li>足够的空闲内存。</li>
<li>如果要运行测试脚本那么就需要安装<code>perl</code>。大多数类Unix的系统已经包含了<code>perl</code>。在windows上可以使用 ActiveState Perl。</li>
</ul>
<p>如果使用标准源码安装，还需要下面的工具来解压源码文件：</p>
<ul>
<li>对于一个<code>.tar.gz</code>的压缩tar文件，<code>GNU gunzip</code>命令可以用来解压，<code>tar</code>命令用来unpack。如果你的<code>tar</code>命令支持z选项，它可以用来解压与 unpack文件。</li>
<li>对于一个<code>.zip</code>归档文件，winzip或另外的工具可以读取.zip文件。</li>
<li>对于一个<code>.rpm</code>的RPM包，<code>rpmbuild</code>命令用来对构建的发布版本进行unpack操作。</li>
</ul>
<p>若使用开发源码树来安装MySQL，需要安装以下额外的工具:</p>
<ul>
<li>需要Git版本控制系统来获得开发源代码。<a href="https://help.github.com/en" target="_blank" rel="noopener">https://help.github.com/en</a> 提供了指令在不同平台上下载与安装Git。MySQL官方组织已经于2014年9月加入了GitHub。</li>
<li><code>bison 2.1</code>或更高版本，可以从 <a href="http://www.gnu.org/software/bison/" target="_blank" rel="noopener">http://www.gnu.org/software/bison/</a> 网址进行下载(1版本不再支持)，尽可能的使用最新版本。</li>
<li>在Solaris平台上,除了<code>bison</code>之外<code>m4</code>必须被安装。<code>m4</code>可以从 <a href="http://www.gnu.org/software/m4/" target="_blank" rel="noopener">http://www.gnu.org/software/m4/</a> 网址下载。</li>
</ul>
<h2 id="使用标准源码安装"><a href="#使用标准源码安装" class="headerlink" title="使用标准源码安装"></a>使用标准源码安装</h2><p>将源码包<code>mysql-version.tar.gz</code>上传到虚拟机，然后按照下面的步骤进行安装。</p>
<p><strong>5.7之前的版本</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 卸载系统自带的mariadb</span><br><span class="line">rpm -qa | grep mariadb</span><br><span class="line">rpm -evh --nodeps mariadb-libs-5.5.44-2.el7.centos.x86_64</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 安装所需的工具包</span><br><span class="line">yum -y install cmake* make* gcc* gcc-c++ ncurses* ncurses-devel* perl*</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 创建mysql用户</span><br><span class="line">groupadd mysql</span><br><span class="line">useradd -r -g mysql -s /bin/false mysql</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 解压并安装</span><br><span class="line">tar zxvf mysql-5.5.62.tar.gz</span><br><span class="line">cd mysql-5.5.62/</span><br><span class="line"><span class="meta">#</span>tar zxvf mysql-5.6.45.tar.gz</span><br><span class="line"><span class="meta">#</span>cd mysql-5.6.45/</span><br><span class="line">mkdir bld</span><br><span class="line">cd bld</span><br><span class="line">cmake ..</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 初始化</span><br><span class="line">cd /usr/local/mysql</span><br><span class="line"></span><br><span class="line">chown -R mysql:mysql .</span><br><span class="line">scripts/mysql_install_db --user=mysql</span><br><span class="line">chown -R root .</span><br><span class="line">chown -R mysql data</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 启动服务</span><br><span class="line">cp support-files/my-medium.cnf /etc/my.cnf #5.5</span><br><span class="line">bin/mysqld_safe --user=mysql &amp;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 配置开机启动</span><br><span class="line">cp support-files/mysql.server /etc/init.d/mysql.server</span><br><span class="line">chmod 755 /etc/init.d/mysql.server</span><br><span class="line">systemctl enable mysql.server</span><br></pre></td></tr></table></figure>
<p><strong>5.7版本</strong></p>
<p>下载<code>boost_1_59_0.tar.gz</code>并上传到虚拟机的<code>/tmp</code>目录。<br>下载地址：<a href="https://jaist.dl.sourceforge.net/project/boost/boost/1.59.0/boost_1_59_0.tar.gz" target="_blank" rel="noopener">https://jaist.dl.sourceforge.net/project/boost/boost/1.59.0/boost_1_59_0.tar.gz</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 卸载系统自带的mariadb</span><br><span class="line">rpm -qa | grep mariadb</span><br><span class="line">rpm -evh --nodeps mariadb-libs-5.5.44-2.el7.centos.x86_64</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 安装所需的工具包</span><br><span class="line">yum -y install cmake* make* gcc* gcc-c++ ncurses* ncurses-devel* perl*</span><br><span class="line">cd /tmp</span><br><span class="line">tar zxvf boost_1_59_0.tar.gz</span><br><span class="line">mv boost_1_59_0 /usr/local/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 创建mysql用户</span><br><span class="line">groupadd mysql</span><br><span class="line">useradd -r -g mysql -s /bin/false mysql</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 解压并安装</span><br><span class="line">tar zxvf mysql-5.7.27.tar.gz</span><br><span class="line">cd mysql-5.7.27/</span><br><span class="line">mkdir bld</span><br><span class="line">cd bld</span><br><span class="line">cmake .. -DWITH_BOOST=/usr/local/boost_1_59_0</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 初始化</span><br><span class="line">cd /usr/local/mysql</span><br><span class="line">mkdir mysql-files</span><br><span class="line">chown mysql:mysql mysql-files</span><br><span class="line">bin/mysqld --initialize --user=mysql</span><br><span class="line">bin/mysql_ssl_rsa_setup</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 启动服务</span><br><span class="line">bin/mysqld_safe --user=mysql &amp;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 配置开机启动</span><br><span class="line">cp support-files/mysql.server /etc/init.d/mysql.server</span><br><span class="line">chmod 755 /etc/init.d/mysql.server</span><br><span class="line">systemctl enable mysql.server</span><br></pre></td></tr></table></figure>
<h2 id="使用开发树安装"><a href="#使用开发树安装" class="headerlink" title="使用开发树安装"></a>使用开发树安装</h2><p>从GitHub获取源码进行安装，与使用标准源码安装类似，只是获取源码的方式不一样。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 安装Git</span><br><span class="line">yum -y install git</span><br><span class="line"><span class="meta">#</span> 克隆MySQL仓库到本地</span><br><span class="line">git clone https://github.com/mysql/mysql-server.git</span><br><span class="line"><span class="meta">#</span> 切换到mysql-server目录</span><br><span class="line">cd mysql-server</span><br></pre></td></tr></table></figure>
<h1 id="连接-MySQL"><a href="#连接-MySQL" class="headerlink" title="连接 MySQL"></a>连接 MySQL</h1><p>启动成功之后就可以使用<code>mysql</code>命令进行连接了。<br>MySQL 5.7之前的版本可以在本地直接连接，不需要输入密码。如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mysql</span><br><span class="line">Welcome to the MySQL monitor. Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.5.62 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span></span><br></pre></td></tr></table></figure>
<p>对于5.7及之后的版本：<br><strong>a)</strong> 若MySQL是通过rpm包安装的，服务在启动时会创建超级账户<code>&#39;root&#39;@&#39;localhost&#39;</code>，并为其生成一个临时的密码，可通过下面的命令进行查看：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 直接连接会报错</span><br><span class="line">[root@localhost ~]# mysql</span><br><span class="line">ERROR 1045 (28000): Access denied for user 'root'@'localhost' (using password: NO)</span><br><span class="line"><span class="meta">#</span> 查看临时密码</span><br><span class="line">[root@localhost ~]# grep 'temporary password' /var/log/mysqld.log</span><br><span class="line"><span class="meta">#</span> 用root账户连接，需输入密码</span><br><span class="line">[root@localhost ~]# mysql -uroot -p</span><br></pre></td></tr></table></figure></p>
<p><strong>b)</strong> 若MySQL是通过通用的二进制包或者源码安装的，在初始化的时候会生成一个临时密码，在终端输出的日志中可以看到，如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mysql]# bin/mysqld --initialize --user=mysql</span><br><span class="line">2019-07-22T08:51:10.366309Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).</span><br><span class="line">2019-07-22T08:51:11.141264Z 0 [Warning] InnoDB: New log files created, LSN=45790</span><br><span class="line">2019-07-22T08:51:11.245915Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line">2019-07-22T08:51:11.319143Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: dabbd8fc-ac5d-11e9-8579-000c29562563.</span><br><span class="line">2019-07-22T08:51:11.324567Z 0 [Warning] Gtid table is not ready to be used. Table 'mysql.gtid_executed' cannot be opened.</span><br><span class="line">2019-07-22T08:51:11.329523Z 1 [Note] A temporary password is generated for root@localhost: Zyreghpk3n_s</span><br></pre></td></tr></table></figure>
<p>连接之后，需要将临时密码改掉之后才能进行其它操作：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show databases;</span><br><span class="line">ERROR 1820 (HY000): You must <span class="keyword">reset</span> your <span class="keyword">password</span> <span class="keyword">using</span> <span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="keyword">statement</span> <span class="keyword">before</span> executing this statement.</span><br><span class="line">mysql&gt; <span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="string">'root'</span>@<span class="string">'localhost'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'MyNewPass4!'</span>;</span><br></pre></td></tr></table></figure></p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="https://dev.mysql.com/doc/refman/5.5/en/" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.5/en/</a><br><a href="https://dev.mysql.com/doc/refman/5.6/en/" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.6/en/</a><br><a href="https://dev.mysql.com/doc/refman/5.7/en/" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/</a><br><a href="https://dev.mysql.com/doc/refman/8.0/en/" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/8.0/en/</a><br><a href="http://www.jydba.net/linux%E4%BD%BF%E7%94%A8%E6%BA%90%E7%A0%81%E6%9D%A5%E5%AE%89%E8%A3%85mysql-5-7/" target="_blank" rel="noopener">http://www.jydba.net/linux%E4%BD%BF%E7%94%A8%E6%BA%90%E7%A0%81%E6%9D%A5%E5%AE%89%E8%A3%85mysql-5-7/</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/08/SICP笔记_03_模块化、对象和状态/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wangzk1900">
      <meta itemprop="description" content="记录学习总结和思考">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangzk1900's site">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/08/SICP笔记_03_模块化、对象和状态/" class="post-title-link" itemprop="url">03_模块化、对象和状态</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-08 00:00:00" itemprop="dateCreated datePublished" datetime="2019-07-08T00:00:00+08:00">2019-07-08</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-16 10:16:36" itemprop="dateModified" datetime="2019-07-16T10:16:36+08:00">2019-07-16</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/SICP笔记/" itemprop="url" rel="index"><span itemprop="name">SICP笔记</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>对于构建复杂的系统，前两章介绍的抽象方法是不够用的。<br>本章将介绍两种方法：基于对象的方法和流处理方法。</p>
<h1 id="赋值和局部状态"><a href="#赋值和局部状态" class="headerlink" title="赋值和局部状态"></a>赋值和局部状态</h1><p>(3.1 Assignment and Local State)</p>
<p>我们通常将世界看作是由众多相互独立的“对象”组成，每个“对象”都有自己的状态，并且状态是随着时间在变化的。<br>同样地，在编程时我们可以采用这种方式来组织各种计算性对象。每个计算性对象必须包含自己的局部状态变量，用这些变量来描述其对应的现实世界中的的东西。</p>
<h2 id="局部状态变量"><a href="#局部状态变量" class="headerlink" title="局部状态变量"></a>局部状态变量</h2><p>(3.1.1 Local State Variables)</p>
<p>假设使用过程<code>withdraw</code>表示从账户中取钱，若账户中的钱充足，则返回账户余额，否则提示余额不足。<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">withdraw</span> <span class="number">25</span>)</span><br><span class="line"><span class="number">75</span></span><br><span class="line">(<span class="name">withdraw</span> <span class="number">25</span>)</span><br><span class="line"><span class="number">50</span></span><br><span class="line">(<span class="name">withdraw</span> <span class="number">60</span>)</span><br><span class="line"><span class="string">"Insufficient funds"</span></span><br><span class="line">(<span class="name">withdraw</span> <span class="number">15</span>)</span><br><span class="line"><span class="number">35</span></span><br></pre></td></tr></table></figure></p>
<p>为了实现<code>withdraw</code>，首先需要定义一个变量<code>balance</code>表示账户中的余额。<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> balance <span class="number">100</span>)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">withdraw</span> amount)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">      (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">             balance)</span><br><span class="line">      <span class="string">"Insufficient funds"</span>))</span><br></pre></td></tr></table></figure></p>
<p>其中，<code>set!</code>是Scheme提供的操作符，用来给变量赋值：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(set! ⟨name⟩ ⟨new-value⟩)</span><br></pre></td></tr></table></figure></p>
<p><code>begin</code>后的表达式会依次被计算，并返回最后一个表达式的值：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(begin ⟨exp1⟩ ⟨exp2⟩ ... ⟨expk⟩)</span><br></pre></td></tr></table></figure></p>
<p>在上面的<code>withdraw</code>定义中，变量<code>balance</code>是定义在全局环境中的，可以被其它过程自由访问。这明显是不合适的。<br>重新定义<code>new-withdraw</code>过程，将<code>balance</code>定义为局部变量：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> new-withdraw</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">balance</span> <span class="number">100</span>))</span><br><span class="line">    (<span class="name"><span class="builtin-name">lambda</span></span> (amount)</span><br><span class="line">      (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">          (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">                 balance)</span><br><span class="line">          <span class="string">"Insufficient funds"</span>))))</span><br></pre></td></tr></table></figure></p>
<p>定义过程<code>make-withdraw</code>，通过参数<code>balance</code>来初始化账户余额：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-withdraw</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">lambda</span></span> (amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">        (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">               balance)</span><br><span class="line">        <span class="string">"Insufficient funds"</span>)))</span><br><span class="line"><span class="comment">; 然后定义两个对象</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> W1 (<span class="name">make-withdraw</span> <span class="number">100</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> W2 (<span class="name">make-withdraw</span> <span class="number">100</span>))</span><br><span class="line">(<span class="name">W1</span> <span class="number">50</span>)</span><br><span class="line"><span class="number">50</span></span><br><span class="line">(<span class="name">W2</span> <span class="number">70</span>)</span><br><span class="line"><span class="number">30</span></span><br><span class="line">(<span class="name">W2</span> <span class="number">40</span>)</span><br><span class="line"><span class="string">"Insufficient funds"</span></span><br><span class="line">(<span class="name">W1</span> <span class="number">40</span>)</span><br><span class="line"><span class="number">10</span></span><br></pre></td></tr></table></figure></p>
<p>很容易观察出，上面两个对象是相互独立的。</p>
<p>对帐户而言，不止有取款操作，还有存款操作。因此，我们可以定义一个对象，并将这个对象和取款存款过程绑定在一起。<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-account</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">withdraw</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">        (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">               balance)</span><br><span class="line">        <span class="string">"Insufficient funds"</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deposit</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">+</span></span> balance amount))</span><br><span class="line">    balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'withdraw</span>) withdraw)</span><br><span class="line">          ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'deposit</span>) deposit)</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown request -- MAKE-ACCOUNT"</span></span><br><span class="line">                       m))))</span><br><span class="line">  dispatch)</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> acc (<span class="name">make-account</span> <span class="number">100</span>))</span><br><span class="line">((<span class="name">acc</span> <span class="symbol">'withdraw</span>) <span class="number">50</span>)</span><br><span class="line"><span class="number">50</span></span><br><span class="line">((<span class="name">acc</span> <span class="symbol">'withdraw</span>) <span class="number">60</span>)</span><br><span class="line"><span class="string">"Insufficient funds"</span></span><br><span class="line">((<span class="name">acc</span> <span class="symbol">'deposit</span>) <span class="number">40</span>)</span><br><span class="line"><span class="number">90</span></span><br><span class="line">((<span class="name">acc</span> <span class="symbol">'withdraw</span>) <span class="number">60</span>)</span><br><span class="line"><span class="number">30</span></span><br></pre></td></tr></table></figure></p>
<p>疑问：局部状态变量会保存多久？</p>
<h3 id="Exercise-3-1"><a href="#Exercise-3-1" class="headerlink" title="Exercise 3.1"></a>Exercise 3.1</h3><p>An <em>accumulator</em> is a procedure that is called repeatedly with a single numeric argument and accumulates its arguments into a sum. Each time it is called, it returns the currently accumulated sum. Write a procedure <strong>make-accumulator</strong> that generates accumulators,each maintaining an independent sum. The input to <strong>make-accumulator</strong> should specify the initial value of the sum; for example<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> A (<span class="name">make-accumulator</span> <span class="number">5</span>))</span><br><span class="line">(<span class="name">A</span> <span class="number">10</span>)</span><br><span class="line"><span class="number">15</span></span><br><span class="line">(<span class="name">A</span> <span class="number">10</span>)</span><br><span class="line"><span class="number">25</span></span><br></pre></td></tr></table></figure></p>
<p>我的答案：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-accumulator</span> sum)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-sum</span> n)</span><br><span class="line">    (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> sum (<span class="name"><span class="builtin-name">+</span></span> sum n)) sum))</span><br><span class="line">  make-sum)</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-3-2"><a href="#Exercise-3-2" class="headerlink" title="Exercise 3.2"></a>Exercise 3.2</h3><p>In software-testing applications, it is useful to be able to count the number of times a given procedure is called during the course of a computation. Write a procedure <strong>make-monitored</strong> that takes as input a procedure, <strong>f</strong> , that itself takes one input. The result returned by make-monitored is a third procedure, say <strong>mf</strong>, that keeps track of the number of times it has been called by maintaining an internal counter. If the input to <strong>mf</strong> is the special symbol <strong>how-many-calls?</strong>, then <strong>mf</strong> returns the value of the counter. If the input is the special symbol <strong>reset-count</strong> , then <strong>mf</strong> resets the counter to zero. For any other input, <strong>mf</strong> returns the result of calling <strong>f</strong> on that input and increments the counter. For instance, we could make a monitored version of the <strong>sqrt</strong> procedure:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> s (<span class="name">make-monitored</span> sqrt))</span><br><span class="line">(<span class="name">s</span> <span class="number">100</span>)</span><br><span class="line"><span class="number">10</span></span><br><span class="line">(<span class="name">s</span> <span class="symbol">'how-many-calls?</span>)</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p>我的答案：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-monitored</span> f)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> times <span class="number">0</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">mf</span> arg)</span><br><span class="line">     (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> arg <span class="symbol">'how-many-calls?</span>) times)</span><br><span class="line">           ((<span class="name"><span class="builtin-name">eq?</span></span> arg <span class="symbol">'reset-count</span>) (<span class="name"><span class="builtin-name">set!</span></span> times <span class="number">0</span>))</span><br><span class="line">           (<span class="name"><span class="builtin-name">else</span></span> (<span class="name"><span class="builtin-name">set!</span></span> times (<span class="name"><span class="builtin-name">+</span></span> times <span class="number">1</span>)) (<span class="name">f</span> arg))))</span><br><span class="line">  mf)</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-3-3"><a href="#Exercise-3-3" class="headerlink" title="Exercise 3.3"></a>Exercise 3.3</h3><p>Modify the <strong>make-account</strong> procedure so that it creates password-protected accounts.That is, <strong>make-account</strong> should take a symbol as an additional argument, as in<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> acc (<span class="name">make-account</span> <span class="number">100</span> <span class="symbol">'secret-password</span>))</span><br></pre></td></tr></table></figure></p>
<p>The resulting account object should process a request only if it is accompanied by the password with which the account was created,and should otherwise return a complaint:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">((<span class="name">acc</span> <span class="symbol">'secret-password</span> <span class="symbol">'withdraw</span>) <span class="number">40</span>)</span><br><span class="line"><span class="number">60</span></span><br><span class="line">((<span class="name">acc</span> <span class="symbol">'some-other-password</span> <span class="symbol">'deposit</span>) <span class="number">50</span>)</span><br><span class="line"><span class="string">"Incorrect password"</span></span><br></pre></td></tr></table></figure></p>
<p>我的答案：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-account</span> balance password)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">withdraw</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">        (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">               balance)</span><br><span class="line">        <span class="string">"Insufficient funds"</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deposit</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">+</span></span> balance amount))</span><br><span class="line">    balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> p m)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">eq?</span></span> p password)</span><br><span class="line">        (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'withdraw</span>) withdraw)</span><br><span class="line">              ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'deposit</span>) deposit)</span><br><span class="line">              (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown request -- MAKE-ACCOUNT"</span></span><br><span class="line">                           m)))</span><br><span class="line">        (<span class="name">error</span> <span class="string">"Incorrect password"</span>)))</span><br><span class="line">  dispatch)</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-3-4"><a href="#Exercise-3-4" class="headerlink" title="Exercise 3.4"></a>Exercise 3.4</h3><p>Modify the make-account procedure of Exercise 3.3 by adding another local state variable so that, if an account is accessed more than seven consecutive times with an incorrect password,it invokes the procedure <strong>call-the-cops</strong></p>
<p>我的答案：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-account</span> balance password)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> error_num <span class="number">0</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">withdraw</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">        (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">               balance)</span><br><span class="line">        <span class="string">"Insufficient funds"</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deposit</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">+</span></span> balance amount))</span><br><span class="line">    balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">call-the-cops</span>)</span><br><span class="line">    (<span class="name"><span class="builtin-name">display</span></span> <span class="string">"Call the cops"</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> p m)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">eq?</span></span> p password)</span><br><span class="line">        (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'withdraw</span>) withdraw)</span><br><span class="line">              ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'deposit</span>) deposit)</span><br><span class="line">              (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown request -- MAKE-ACCOUNT"</span></span><br><span class="line">                           m)))</span><br><span class="line">        (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&lt;</span></span> error_num <span class="number">7</span>)</span><br><span class="line">            (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> error_num (<span class="name"><span class="builtin-name">+</span></span> error_num <span class="number">1</span>)) (<span class="name">error</span> <span class="string">"Incorrect password"</span> error_num))</span><br><span class="line">            (<span class="name"><span class="builtin-name">lambda</span></span> (x) (<span class="name">call-the-cops</span>)))))</span><br><span class="line">  dispatch)</span><br><span class="line"><span class="comment">; 测试</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> acc (<span class="name">make-account</span> <span class="number">100</span> <span class="symbol">'a</span>))</span><br><span class="line">((<span class="name">acc</span> <span class="symbol">'b</span> <span class="symbol">'withdraw</span>) <span class="number">10</span>)</span><br></pre></td></tr></table></figure></p>
<h2 id="引进赋值带来的利益"><a href="#引进赋值带来的利益" class="headerlink" title="引进赋值带来的利益"></a>引进赋值带来的利益</h2><p>(3.1.2 The Benefits of Introducing Assignment)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;; *following uses rand-update -- see ch3support.scm</span></span><br><span class="line"><span class="comment">;; *also must set random-init to some value</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> random-init <span class="number">7</span>)            <span class="comment">;**not in book**</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> rand</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">x</span> random-init))</span><br><span class="line">    (<span class="name"><span class="builtin-name">lambda</span></span> ()</span><br><span class="line">      (<span class="name"><span class="builtin-name">set!</span></span> x (<span class="name">rand-update</span> x))</span><br><span class="line">      x)))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">estimate-pi</span> trials)</span><br><span class="line">  (<span class="name"><span class="builtin-name">sqrt</span></span> (<span class="name"><span class="builtin-name">/</span></span> <span class="number">6</span> (<span class="name">monte-carlo</span> trials cesaro-test))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">cesaro-test</span>)</span><br><span class="line">   (<span class="name"><span class="builtin-name">=</span></span> (<span class="name"><span class="builtin-name">gcd</span></span> (<span class="name">rand</span>) (<span class="name">rand</span>)) <span class="number">1</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">monte-carlo</span> trials experiment)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">iter</span> trials-remaining trials-passed)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">=</span></span> trials-remaining <span class="number">0</span>)</span><br><span class="line">           (<span class="name"><span class="builtin-name">/</span></span> trials-passed trials))</span><br><span class="line">          ((<span class="name">experiment</span>)</span><br><span class="line">           (<span class="name">iter</span> (<span class="name"><span class="builtin-name">-</span></span> trials-remaining <span class="number">1</span>) (<span class="name"><span class="builtin-name">+</span></span> trials-passed <span class="number">1</span>)))</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span></span><br><span class="line">           (<span class="name">iter</span> (<span class="name"><span class="builtin-name">-</span></span> trials-remaining <span class="number">1</span>) trials-passed))))</span><br><span class="line">  (<span class="name">iter</span> trials <span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;; second version (no assignment)</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">estimate-pi</span> trials)</span><br><span class="line">  (<span class="name"><span class="builtin-name">sqrt</span></span> (<span class="name"><span class="builtin-name">/</span></span> <span class="number">6</span> (<span class="name">random-gcd-test</span> trials random-init))))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">random-gcd-test</span> trials initial-x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">iter</span> trials-remaining trials-passed x)</span><br><span class="line">    (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">x1</span> (<span class="name">rand-update</span> x)))</span><br><span class="line">      (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">x2</span> (<span class="name">rand-update</span> x1)))</span><br><span class="line">        (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">=</span></span> trials-remaining <span class="number">0</span>) </span><br><span class="line">               (<span class="name"><span class="builtin-name">/</span></span> trials-passed trials))</span><br><span class="line">              ((<span class="name"><span class="builtin-name">=</span></span> (<span class="name"><span class="builtin-name">gcd</span></span> x1 x2) <span class="number">1</span>)</span><br><span class="line">               (<span class="name">iter</span> (<span class="name"><span class="builtin-name">-</span></span> trials-remaining <span class="number">1</span>)</span><br><span class="line">                     (<span class="name"><span class="builtin-name">+</span></span> trials-passed <span class="number">1</span>)</span><br><span class="line">                     x2))</span><br><span class="line">              (<span class="name"><span class="builtin-name">else</span></span></span><br><span class="line">               (<span class="name">iter</span> (<span class="name"><span class="builtin-name">-</span></span> trials-remaining <span class="number">1</span>)</span><br><span class="line">                     trials-passed</span><br><span class="line">                     x2))))))</span><br><span class="line">  (<span class="name">iter</span> trials <span class="number">0</span> initial-x))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-5"><a href="#Exercise-3-5" class="headerlink" title="Exercise 3.5"></a>Exercise 3.5</h3><p>Monte Carlo integration is a method of estimatingdefinite integrals by means of Monte Carlo simulation.Consider computing the area of a region of space describedby a predicate P(x ; y) that is true for points (x ; y)in the region and false for points not in the region. Forexample, the region contained within a circle of radius 3centered at (5, 7) is described by the predicate that testswhether $[Math Processing Error]x−5^{2}+[Math Processing Error]y−7^{2}\leq3^{2}$. To estimate the area of theregion described by such a predicate, begin by choosing arectangle that contains the region. For example, a rectanglewith diagonally opposite corners at (2, 4) and (8, 10) containsthe circle above. The desired integral is the area ofthat portion of the rectangle that lies in the region. We canestimate the integral by picking, at random, points (x ; y)that lie in the rectangle, and testing P(x ; y) for each pointto determine whether the point lies in the region. If we trythis with many points, then the fraction of points that fallin the region should give an estimate of the proportion ofthe rectangle that lies in the region. Hence, multiplying thisfraction by the area of the entire rectangle should producean estimate of the integral.<br>Implement Monte Carlo integration as a procedure estimateintegralthat takes as arguments a predicate P, upper andlower bounds x1, x2, y1, and y2 for the rectangle, and thenumber of trials to perform in order to produce the estimate.Your procedure should use the same monte-carlo procedure that was used above to estimate π. Use your estimateintegralto produce an estimate of π by measuring thearea of a unit circle.<br>You will find it useful to have a procedure that returns a number chosen at random from a given range. The following random-in-range procedure implements this in terms of the random procedure used in Section 1.2.6, which returns a nonnegative number less than its input.<br>(define (random-in-range low high)<br>  (let ((range (- high low)))<br>    (+ low (random range))))</p>
<h3 id="Exercise-3-6"><a href="#Exercise-3-6" class="headerlink" title="Exercise 3.6"></a>Exercise 3.6</h3><p>It is useful to be able to reset a random-numbergenerator to produce a sequence starting from a given value.Design a new rand procedure that is called with an argumentthat is either the symbol generate or the symbol reset and behaves as follows: (rand ‘generate) producesa new random number; ((rand ‘reset) ⟨new-value⟩) resetsthe internal state variable to the designated ⟨new-value⟩.Thus, by resetting the state, one can generate repeatable sequences.These are very handy to have when testing anddebugging programs that use random numbers.</p>
<h2 id="引进赋值的代价"><a href="#引进赋值的代价" class="headerlink" title="引进赋值的代价"></a>引进赋值的代价</h2><p>(3.1.3 The Costs of Introducing Assignment)</p>
<p>代换模型将不再适用。<br>前两章介绍的是函数式编程，不需要保存状态。</p>
<p>简化版的<code>make-simplified-withdraw</code>过程：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-simplified-withdraw</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">lambda</span></span> (amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">    balance))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> W (<span class="name">make-simplified-withdraw</span> <span class="number">25</span>))</span><br><span class="line">(<span class="name">W</span> <span class="number">20</span>)</span><br><span class="line"><span class="number">5</span></span><br><span class="line">(<span class="name">W</span> <span class="number">10</span>)</span><br><span class="line"><span class="number">-5</span></span><br></pre></td></tr></table></figure></p>
<p>不使用<code>set!</code>：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-decrementer</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">lambda</span></span> (amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">-</span></span> balance amount)))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> D (<span class="name">make-decrementer</span> <span class="number">25</span>))</span><br><span class="line">(<span class="name">D</span> <span class="number">20</span>)</span><br><span class="line"><span class="number">5</span></span><br><span class="line">(<span class="name">D</span> <span class="number">10</span>)</span><br><span class="line"><span class="number">15</span></span><br></pre></td></tr></table></figure></p>
<p>使用代换模型分析<code>make-decrementer</code><br>(D 20)<br>((make-decrementer 25) 20)<br>((lambda (amount) (- 25 amount)) 20)<br>(- 25 20)<br>5</p>
<p>使用代换模型分析<code>make-simplified-withdraw</code><br>(W 20)<br>((make-simplified-withdraw 25) 20)<br>((lambda (amount) (set! balance (- 25 amount)) 25) 20)<br>(set! balance (- 25 20)) 25</p>
<p>引入<code>set!</code>之后，变量不再是一个简单的名字了，它更像是一个可以存放数值的地方，并且保存在那的数值是可以改变的。</p>
<p><strong>同一和变化(Sameness and change)</strong></p>
<p>D1和D2可以看作是相同的<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> D1 (<span class="name">make-decrementer</span> <span class="number">25</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> D2 (<span class="name">make-decrementer</span> <span class="number">25</span>))</span><br></pre></td></tr></table></figure></p>
<p>但是W1和W2却是不同的，它们有自己单独的状态<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> W1 (<span class="name">make-simplified-withdraw</span> <span class="number">25</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> W2 (<span class="name">make-simplified-withdraw</span> <span class="number">25</span>))</span><br><span class="line">(<span class="name">W1</span> <span class="number">20</span>)</span><br><span class="line"><span class="number">5</span></span><br><span class="line">(<span class="name">W1</span> <span class="number">20</span>)</span><br><span class="line"><span class="number">-15</span></span><br><span class="line">(<span class="name">W2</span> <span class="number">20</span>)</span><br><span class="line"><span class="number">5</span></span><br></pre></td></tr></table></figure></p>
<p>;: (define peter-acc (make-account 100))<br>;: (define paul-acc (make-account 100))<br>;:<br>;: (define peter-acc (make-account 100))<br>;: (define paul-acc peter-acc)</p>
<p><strong>命令式程序设计的缺陷(Pitfalls of imperative programming)</strong></p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">factorial</span> n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">iter</span> product counter)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;</span></span> counter n)</span><br><span class="line">        product</span><br><span class="line">        (<span class="name">iter</span> (<span class="name"><span class="builtin-name">*</span></span> counter product)</span><br><span class="line">              (<span class="name"><span class="builtin-name">+</span></span> counter <span class="number">1</span>))))</span><br><span class="line">  (<span class="name">iter</span> <span class="number">1</span> <span class="number">1</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">factorial</span> n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">product</span> <span class="number">1</span>)</span><br><span class="line">        (<span class="name">counter</span> <span class="number">1</span>))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">iter</span>)</span><br><span class="line">      (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;</span></span> counter n)</span><br><span class="line">          product</span><br><span class="line">          (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> product (<span class="name"><span class="builtin-name">*</span></span> counter product))</span><br><span class="line">                 (<span class="name"><span class="builtin-name">set!</span></span> counter (<span class="name"><span class="builtin-name">+</span></span> counter <span class="number">1</span>))</span><br><span class="line">                 (<span class="name">iter</span>))))</span><br><span class="line">    (<span class="name">iter</span>)))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-7"><a href="#Exercise-3-7" class="headerlink" title="Exercise 3.7"></a>Exercise 3.7</h3><p>Consider the bank account objects created by <strong>make-account</strong>, with the password modification described in Exercise 3.3. Suppose that our banking system requires the ability to make joint accounts. Define a procedure <strong>make-joint</strong> that accomplishes this. <strong>make-joint</strong> should take three arguments. The first is a password-protected account. The second argument must match the password with which the account was defined in order for the <strong>make-joint</strong> operation to proceed. The third argument is a new password. <strong>make-jointis</strong> to create an additional access to the original accountusing the new password. For example, if peter-accis a bank account with password <strong>open-sesame</strong>, then<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> paul-acc</span><br><span class="line">  (<span class="name">make-joint</span> peter-acc <span class="symbol">'open-sesame</span> <span class="symbol">'rosebud</span>))</span><br></pre></td></tr></table></figure></p>
<p>will allow one to make transactions on <strong>peter-acc</strong> using the name paul-acc and the password rosebud. You may wish to modify your solution to Exercise 3.3 to accommodate this new feature.
</p>
<h3 id="Exercise-3-8"><a href="#Exercise-3-8" class="headerlink" title="Exercise 3.8"></a>Exercise 3.8</h3><p>When we defined the evaluation model in Section 1.1.3, we said that the first step in evaluating an expression is to evaluate its subexpressions. But we never specified the order in which the subexpressions should be evaluated (e.g., left to right or right to left). When we introduce assignment, the order in which the arguments to a procedure are evaluated can make a difference to the result. Define a simple procedure f such that evaluating<br><code>(+ (f 0) (f 1))</code><br>will return 0 if the arguments to + are evaluated from left to right but will return 1 if the arguments are evaluated from right to left.</p>
<h1 id="求值的环境模型"><a href="#求值的环境模型" class="headerlink" title="求值的环境模型"></a>求值的环境模型</h1><p>(3.2 The Environment Model of Evaluation)</p>
<h2 id="求值的规则"><a href="#求值的规则" class="headerlink" title="求值的规则"></a>求值的规则</h2><p>(3.2.1 The Rules for Evaluation)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">square</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">*</span></span> x x))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> square</span><br><span class="line">  (<span class="name"><span class="builtin-name">lambda</span></span> (x) (<span class="name"><span class="builtin-name">*</span></span> x x)))</span><br></pre></td></tr></table></figure>
<h2 id="简单过程的应用"><a href="#简单过程的应用" class="headerlink" title="简单过程的应用"></a>简单过程的应用</h2><p>(3.2.2 Applying Simple Procedures)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">square</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">*</span></span> x x))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sum-of-squares</span> x y)</span><br><span class="line">  (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">square</span> x) (<span class="name">square</span> y)))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">f</span> a)</span><br><span class="line">  (<span class="name">sum-of-squares</span> (<span class="name"><span class="builtin-name">+</span></span> a <span class="number">1</span>) (<span class="name"><span class="builtin-name">*</span></span> a <span class="number">2</span>)))</span><br></pre></td></tr></table></figure>
<p>我们也可以使用环境模型来分析上面的三个过程。<br><img src="/images/sicp/Figure_3.4.png" alt></p>
<p>;: (sum-of-squares (+ a 1) (* a 2))</p>
<h3 id="Exercise-3-9"><a href="#Exercise-3-9" class="headerlink" title="Exercise 3.9"></a>Exercise 3.9</h3><p>In Section1.2.1 we used the substitution model to analyze two procedures for computing factorials,arecursive version<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">factorial</span> n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> n <span class="number">1</span>) <span class="number">1</span> (<span class="name"><span class="builtin-name">*</span></span> n (<span class="name">factorial</span> (<span class="name"><span class="builtin-name">-</span></span> n <span class="number">1</span>)))))</span><br></pre></td></tr></table></figure></p>
<p>and an iterative version<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(define (factorial n) (fact-iter 1 1 n))</span><br><span class="line">(define (fact-iter product counter max-count)</span><br><span class="line">  (if (&gt; counter max-count)</span><br><span class="line">      product</span><br><span class="line">      (fact-iter (* counter product)</span><br><span class="line">                 (+ counter 1)</span><br><span class="line">                 max-count)))</span><br></pre></td></tr></table></figure></p>
<p>Show the environment structures created by evaluating (factorial 6) using each version of the factorial procedure.</p>
<h2 id="Frames作为局部状态的存储库"><a href="#Frames作为局部状态的存储库" class="headerlink" title="Frames作为局部状态的存储库"></a>Frames作为局部状态的存储库</h2><p>(3.2.3 Frames as the Repository of Local State)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-withdraw</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">lambda</span></span> (amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">        (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">               balance)</span><br><span class="line">        <span class="string">"Insufficient funds"</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment">;: (define W1 (make-withdraw 100))</span></span><br><span class="line"><span class="comment">;: (W1 50)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;: (define W2 (make-withdraw 100))</span></span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-10"><a href="#Exercise-3-10" class="headerlink" title="Exercise 3.10"></a>Exercise 3.10</h3><p>In the <strong>make-withdraw</strong> procedure, the local variable balance is created as aparameter of <strong>make-withdraw</strong>. We could also create the local state variable explicitly, using let , as follows:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-withdraw</span> initial-amount)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">balance</span> initial-amount))</span><br><span class="line">    (<span class="name"><span class="builtin-name">lambda</span></span> (amount)</span><br><span class="line">      (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">          (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">                 balance)</span><br><span class="line">          <span class="string">"Insufficient funds"</span>))))</span><br></pre></td></tr></table></figure></p>
<p>Recall from Section 1.3.2 that let is simply syntactic sugar for a procedure call:<br><code>(let (( ⟨ var ⟩ ⟨ exp ⟩ )) ⟨ body ⟩ )</code><br>is interpreted as an alternate syntax for<br><code>((lambda ( ⟨ var ⟩ ) ⟨ body ⟩ ) ⟨ exp ⟩ )</code><br>Use the environment model to analyze this alternate version of <strong>make-withdraw</strong>, drawing figures like the ones above to illustrate the interactions<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> W1 (<span class="name">make-withdraw</span> <span class="number">100</span>))</span><br><span class="line">(<span class="name">W1</span> <span class="number">50</span>)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> W2 (<span class="name">make-withdraw</span> <span class="number">100</span>))</span><br></pre></td></tr></table></figure></p>
<p>Show that the two versions of make-withdraw create objects with the same behavior. How do the environment structures differ for the two versions?</p>
<h2 id="内部定义"><a href="#内部定义" class="headerlink" title="内部定义"></a>内部定义</h2><p>(3.2.4 Internal Definitions)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">;; same as in section 1.1.8</span><br><span class="line">(define (sqrt x)</span><br><span class="line">  (define (good-enough? guess)</span><br><span class="line">    (&lt; (abs (- (square guess) x)) 0.001))</span><br><span class="line">  (define (improve guess)</span><br><span class="line">    (average guess (/ x guess)))</span><br><span class="line">  (define (sqrt-iter guess)</span><br><span class="line">    (if (good-enough? guess)</span><br><span class="line">        guess</span><br><span class="line">        (sqrt-iter (improve guess))))</span><br><span class="line">  (sqrt-iter 1.0))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-3-11"><a href="#Exercise-3-11" class="headerlink" title="Exercise 3.11"></a>Exercise 3.11</h3><p>In Section 3.2.3 we saw how the environment model described the behavior of procedures with local state. Now we have seen how internal definitions work. A typical message-passing procedure contains both of  these aspects. Consider the bank account procedure of Section 3.1.1:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-account</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">withdraw</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">        (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">               balance)</span><br><span class="line">        <span class="string">"Insufficient funds"</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deposit</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">+</span></span> balance amount))</span><br><span class="line">    balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'withdraw</span>) withdraw)</span><br><span class="line">          ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'deposit</span>) deposit)</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown request -- MAKE-ACCOUNT"</span></span><br><span class="line">                       m))))</span><br><span class="line">  dispatch)</span><br></pre></td></tr></table></figure></p>
<p>Show the environment structure generated by these quence of interactions<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> acc (<span class="name">make-account</span> <span class="number">50</span>))</span><br><span class="line">((<span class="name">acc</span> <span class="symbol">'deposit</span>) <span class="number">40</span>)</span><br><span class="line"><span class="number">90</span></span><br><span class="line">((<span class="name">acc</span> <span class="symbol">'withdraw</span>) <span class="number">60</span>)</span><br><span class="line"><span class="number">30</span></span><br></pre></td></tr></table></figure></p>
<p>Where is the local state for acc kept? Suppose we define another account<br><code>(define acc (make-account 50))</code><br>How are the local states for the two accounts kept distinct? Which parts of the environment structure are shared between acc and acc2 ?</p>
<h1 id="用可变数据做模拟"><a href="#用可变数据做模拟" class="headerlink" title="用可变数据做模拟"></a>用可变数据做模拟</h1><p>(3.3 Modeling with Mutable Data)</p>
<h2 id="可变列表结构"><a href="#可变列表结构" class="headerlink" title="可变列表结构"></a>可变列表结构</h2><p>(3.3.1 Mutable List Structure)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">cons</span></span> x y)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">new</span> (<span class="name">get-new-pair</span>)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">set-car!</span></span> new x)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set-cdr!</span></span> new y)</span><br><span class="line">    new))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-12"><a href="#Exercise-3-12" class="headerlink" title="Exercise 3.12"></a>Exercise 3.12</h3><p>The following procedure for appending lists was introduced in Section 2.2.1:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">append</span></span> x y)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> x)</span><br><span class="line">      y</span><br><span class="line">      (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">car</span></span> x) (<span class="name"><span class="builtin-name">append</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> x) y))))</span><br></pre></td></tr></table></figure></p>
<p>append forms a new list by successively cons ing the elements of x onto y. The procedure <strong>append!</strong> is similar to append , but it is a mutator rather than a constructor. It appends the lists by splicing them together, modifying the final pair of x so that its cdr is now y . (It is an error to call <strong>append!</strong> with an empty x .)<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">append!</span> x y)</span><br><span class="line">  (<span class="name"><span class="builtin-name">set-cdr!</span></span> (<span class="name">last-pair</span> x) y)</span><br><span class="line">  x)</span><br></pre></td></tr></table></figure></p>
<p>Here <strong>last-pair</strong> is a procedure that returns the last pair in its argument:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">last-pair</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> x)) x (<span class="name">last-pair</span> (<span class="name"><span class="builtin-name">cdr</span></span> x))))</span><br></pre></td></tr></table></figure></p>
<p>Consider the interaction<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> x (<span class="name"><span class="builtin-name">list</span></span> <span class="symbol">'a</span> <span class="symbol">'b</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> y (<span class="name"><span class="builtin-name">list</span></span> <span class="symbol">'c</span> <span class="symbol">'d</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> z (<span class="name"><span class="builtin-name">append</span></span> x y))</span><br><span class="line">z</span><br><span class="line">(<span class="name">a</span> b c d)</span><br><span class="line">(<span class="name"><span class="builtin-name">cdr</span></span> x)</span><br><span class="line">⟨response⟩</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> w (<span class="name">append!</span> x y))</span><br><span class="line">w</span><br><span class="line">(<span class="name">a</span> b c d)</span><br><span class="line">(<span class="name"><span class="builtin-name">cdr</span></span> x)</span><br><span class="line">⟨response⟩</span><br></pre></td></tr></table></figure></p>
<p>What are the missing ⟨response⟩s? Draw box-and-pointer diagrams to explain your answer.</p>
<p>答案：<br>(b)<br>(b c d)</p>
<h3 id="Exercise-3-13"><a href="#Exercise-3-13" class="headerlink" title="Exercise 3.13"></a>Exercise 3.13</h3><p>Consider the following <strong>make-cycle procedure</strong>, which uses the <strong>last-pair</strong> procedure defined in Exercise 3.12:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-cycle</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">set-cdr!</span></span> (<span class="name">last-pair</span> x) x)</span><br><span class="line">  x)</span><br></pre></td></tr></table></figure></p>
<p>Draw a box-and-pointer diagram that shows the structure z created by<br>(define z (make-cycle (list ‘a ‘b ‘c)))<br>What happens if we try to compute (last-pair z) ?</p>
<p>答案：<br>进入死循环</p>
<h3 id="Exercise-3-14"><a href="#Exercise-3-14" class="headerlink" title="Exercise 3.14"></a>Exercise 3.14</h3><p>The following procedure is quite useful, although obscure:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">mystery</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">loop</span> x y)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> x)</span><br><span class="line">        y</span><br><span class="line">        (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">temp</span> (<span class="name"><span class="builtin-name">cdr</span></span> x)))</span><br><span class="line">          (<span class="name"><span class="builtin-name">set-cdr!</span></span> x y)</span><br><span class="line">          (<span class="name">loop</span> temp x))))</span><br><span class="line">  (<span class="name">loop</span> x '()))</span><br></pre></td></tr></table></figure></p>
<p><strong>loop</strong> uses the “temporary” variable temp to hold the old value of the <strong>cdr</strong> of x , since the <strong>set-cdr!</strong> on the next line destroys the <strong>cdr</strong> . Explain what <strong>mystery</strong> does in general. Suppose v is defined by <code>(define v (list &#39;a &#39;b &#39;c &#39;d))</code> . Draw the box-and-pointer diagram that represents the list to which v is bound. Suppose that we now evaluate <code>(define w (mystery v))</code> . Draw box-and-pointer diagrams that show the structures v and w after evaluating this expression. What would be printed as the values of v and w?</p>
<p>答案：<br>v (a)<br>w (d c b c)</p>
<h3 id="Sharing-and-identity"><a href="#Sharing-and-identity" class="headerlink" title="Sharing and identity"></a>Sharing and identity</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> x (<span class="name"><span class="builtin-name">list</span></span> <span class="symbol">'a</span> <span class="symbol">'b</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> z1 (<span class="name"><span class="builtin-name">cons</span></span> x x))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> z2 (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">list</span></span> <span class="symbol">'a</span> <span class="symbol">'b</span>) (<span class="name"><span class="builtin-name">list</span></span> <span class="symbol">'a</span> <span class="symbol">'b</span>)))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">set-to-wow!</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">set-car!</span></span> (<span class="name"><span class="builtin-name">car</span></span> x) <span class="symbol">'wow</span>)</span><br><span class="line">  x)</span><br></pre></td></tr></table></figure>
<p>;: z1<br>;: (set-to-wow! z1)<br>;: z2<br>;: (set-to-wow! z2)</p>
<p>判断两个对象是否是相同：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">eq?</span></span> (<span class="name"><span class="builtin-name">car</span></span> z1) (<span class="name"><span class="builtin-name">cdr</span></span> z1))</span><br><span class="line"><span class="comment">;Value: #t</span></span><br><span class="line">(<span class="name"><span class="builtin-name">eq?</span></span> (<span class="name"><span class="builtin-name">car</span></span> z2) (<span class="name"><span class="builtin-name">cdr</span></span> z2))</span><br><span class="line"><span class="comment">;Value: #f</span></span><br></pre></td></tr></table></figure></p>
<h4 id="Exercise-3-15"><a href="#Exercise-3-15" class="headerlink" title="Exercise 3.15"></a>Exercise 3.15</h4><p>Draw box-and-pointer diagrams to explain the effect of <strong>set-to-wow!</strong> on the structures z1 and z2 above.</p>
<h4 id="Exercise-3-16"><a href="#Exercise-3-16" class="headerlink" title="Exercise 3.16"></a>Exercise 3.16</h4><p>Ben Bitdiddle decides to write a procedure to count the number of pairs in any list structure. “It’s easy,” he reasons. “The number of pairs in any structure is the number in the car plus the number in the cdr plus one more to count the current pair.” So Ben writes the following procedure:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">count-pairs</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">not</span></span> (<span class="name"><span class="builtin-name">pair?</span></span> x))</span><br><span class="line">      <span class="number">0</span></span><br><span class="line">      (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">count-pairs</span> (<span class="name"><span class="builtin-name">car</span></span> x))</span><br><span class="line">         (<span class="name">count-pairs</span> (<span class="name"><span class="builtin-name">cdr</span></span> x))</span><br><span class="line">         <span class="number">1</span>)))</span><br></pre></td></tr></table></figure></p>
<p>Show that this procedure is not correct. In particular, draw box-and-pointer diagrams representing lists tructures made up of exactly three pairs for which Ben’s procedure would return 3; return 4; return 7; never return at all.</p>
<h4 id="Exercise3-17"><a href="#Exercise3-17" class="headerlink" title="Exercise3.17"></a>Exercise3.17</h4><p>Devise a correct version of the <strong>count-pairs</strong> procedure of Exercise 3.16 that returns the number of distinct pairs in any structure. (Hint: Traverse the structure, maintaining an auxiliary data structure that is used to keep track of which pairs have already been counted.)</p>
<h4 id="Exercise-3-18"><a href="#Exercise-3-18" class="headerlink" title="Exercise 3.18"></a>Exercise 3.18</h4><p>Write a procedure that examines a list and determines whether it contains a cycle, that is, whether a program that tried to find the end of the list by taking successive cdrs would go into an infinite loop. Exercise 3.13 constructed such lists.</p>
<h4 id="Exercise-3-19"><a href="#Exercise-3-19" class="headerlink" title="Exercise 3.19"></a>Exercise 3.19</h4><p>Redo Exercise 3.18 using an algorithm that takes only a constant amount of space.(This requires a very clever idea.)</p>
<h3 id="Mutation-as-assignment"><a href="#Mutation-as-assignment" class="headerlink" title="Mutation as assignment"></a>Mutation as assignment</h3><p>序对可以存粹使用过程来表示(Section 2.1.3)：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">cons</span></span> x y)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'car</span>) x)</span><br><span class="line">          ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'cdr</span>) y)</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Undefined operation -- CONS"</span> m))))</span><br><span class="line">  dispatch)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">car</span></span> z) (<span class="name">z</span> <span class="symbol">'car</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> z) (<span class="name">z</span> <span class="symbol">'cdr</span>))</span><br></pre></td></tr></table></figure></p>
<p>可将其进行扩展，使其支持<code>set-car!</code>和<code>set-cdr!</code>：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">cons</span></span> x y)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">set-x!</span> v) (<span class="name"><span class="builtin-name">set!</span></span> x v))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">set-y!</span> v) (<span class="name"><span class="builtin-name">set!</span></span> y v))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'car</span>) x)</span><br><span class="line">          ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'cdr</span>) y)</span><br><span class="line">          ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'set-car!</span>) set-x!)</span><br><span class="line">          ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'set-cdr!</span>) set-y!)</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Undefined operation -- CONS"</span> m))))</span><br><span class="line">  dispatch)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">car</span></span> z) (<span class="name">z</span> <span class="symbol">'car</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> z) (<span class="name">z</span> <span class="symbol">'cdr</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">set-car!</span></span> z new-value)</span><br><span class="line">  ((<span class="name">z</span> <span class="symbol">'set-car!</span>) new-value) z)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">set-cdr!</span></span> z new-value)</span><br><span class="line">  ((<span class="name">z</span> <span class="symbol">'set-cdr!</span>) new-value) z)</span><br></pre></td></tr></table></figure></p>
<h4 id="Exercise-3-20"><a href="#Exercise-3-20" class="headerlink" title="Exercise 3.20"></a>Exercise 3.20</h4><p>Draw environment diagrams to illustrate the evaluation of the sequence of expressions<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> x (<span class="name"><span class="builtin-name">cons</span></span> <span class="number">1</span> <span class="number">2</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> z (<span class="name"><span class="builtin-name">cons</span></span> x x))</span><br><span class="line">(<span class="name"><span class="builtin-name">set-car!</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> z) <span class="number">17</span>)</span><br><span class="line">(<span class="name"><span class="builtin-name">car</span></span> x)</span><br></pre></td></tr></table></figure></p>
<p>using the procedural implementation of pairs given above. (Compare Exercise 3.11.)</p>
<h2 id="队列的表示"><a href="#队列的表示" class="headerlink" title="队列的表示"></a>队列的表示</h2><p>(3.3.2 Representing Queues)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 头结点和尾结点的指针</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">front-ptr</span> queue) (<span class="name"><span class="builtin-name">car</span></span> queue))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">rear-ptr</span> queue) (<span class="name"><span class="builtin-name">cdr</span></span> queue))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">set-front-ptr!</span> queue item) (<span class="name"><span class="builtin-name">set-car!</span></span> queue item))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">set-rear-ptr!</span> queue item) (<span class="name"><span class="builtin-name">set-cdr!</span></span> queue item))</span><br><span class="line"><span class="comment">; 判断队列是否为空</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">empty-queue?</span> queue) (<span class="name"><span class="builtin-name">null?</span></span> (<span class="name">front-ptr</span> queue)))</span><br><span class="line"><span class="comment">; 队列构造器</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-queue</span>) (<span class="name"><span class="builtin-name">cons</span></span> '() '()))</span><br><span class="line"><span class="comment">; 头结点</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">front-queue</span> queue)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">empty-queue?</span> queue)</span><br><span class="line">      (<span class="name">error</span> <span class="string">"FRONT called with an empty queue"</span> queue)</span><br><span class="line">      (<span class="name"><span class="builtin-name">car</span></span> (<span class="name">front-ptr</span> queue))))</span><br><span class="line"><span class="comment">; 入队</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">insert-queue!</span> queue item)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">new-pair</span> (<span class="name"><span class="builtin-name">cons</span></span> item '())))</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name">empty-queue?</span> queue)</span><br><span class="line">           (<span class="name">set-front-ptr!</span> queue new-pair)</span><br><span class="line">           (<span class="name">set-rear-ptr!</span> queue new-pair)</span><br><span class="line">           queue)</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span></span><br><span class="line">           (<span class="name"><span class="builtin-name">set-cdr!</span></span> (<span class="name">rear-ptr</span> queue) new-pair)</span><br><span class="line">           (<span class="name">set-rear-ptr!</span> queue new-pair)</span><br><span class="line">           queue))))</span><br><span class="line"><span class="comment">; 出队</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">delete-queue!</span> queue)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name">empty-queue?</span> queue)</span><br><span class="line">         (<span class="name">error</span> <span class="string">"DELETE! called with an empty queue"</span> queue))</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span></span><br><span class="line">         (<span class="name">set-front-ptr!</span> queue (<span class="name"><span class="builtin-name">cdr</span></span> (<span class="name">front-ptr</span> queue)))</span><br><span class="line">         queue)))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-21"><a href="#Exercise-3-21" class="headerlink" title="Exercise 3.21"></a>Exercise 3.21</h3><p>Ben Bitdiddle decides to test the queue implementation described above. He types in the procedures to the Lisp interpreter and proceeds to try them out:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> q1 (<span class="name">make-queue</span>))</span><br><span class="line">(<span class="name">insert-queue!</span> q1 <span class="symbol">'a</span>)</span><br><span class="line">(<span class="name">insert-queue!</span> q1 <span class="symbol">'b</span>)</span><br><span class="line">(<span class="name">delete-queue!</span> q1)</span><br><span class="line">(<span class="name">delete-queue!</span> q1)</span><br></pre></td></tr></table></figure></p>
<p>“It’s all wrong!” he complains. “The interpreter’s response shows that the last item is inserted into the queue twice. And when I delete both items, the second b is still there, so the queue isn’t empty, even though it’s supposed to be.” Eva Lu Ator suggests that Ben has misunderstood what is happening. “It’s not that the items are going into the queue twice,” she explains. “It’s just that the standard Lisp printer doesn’t know how to make sense of the queue representa- tion. If you want to see the queue printed correctly, you’ll have to define your own print procedure for queues.” Explain what Eva Lu is talking about. In particular, show why Ben’s examples produce the printed results that they do. Define a procedure <strong>print-queue</strong> that takes a queue as input and prints the sequence of items in the queue.</p>
<h3 id="Exercise-3-22"><a href="#Exercise-3-22" class="headerlink" title="Exercise 3.22"></a>Exercise 3.22</h3><p>Instead of representing a queue as a pair of pointers, we can build a queue as a procedure with local state. The local state will consist of pointers to the beginning and the end of an ordinary list. us, the <strong>make-queue</strong> procedure will have the form<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-queue</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">front-ptr</span> .. . )</span><br><span class="line">    (<span class="name">rear-ptr</span> .. . ))</span><br><span class="line">  ⟨ definitions of internal procedures ⟩</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m) .. . )</span><br><span class="line">  dispatch))</span><br></pre></td></tr></table></figure></p>
<p>Complete the definition of <strong>make-queue</strong> and provide implementations of the queue operations using this representation.</p>
<h3 id="Exercise-3-23"><a href="#Exercise-3-23" class="headerlink" title="Exercise 3.23"></a>Exercise 3.23</h3><p>A deque (“double-endedqueue”)isasequence in which items can be inserted and deleted at either the front or the rear. Operations on deques are the constructor <strong>make-deque</strong> , the predicate <strong>empty-deque?</strong> , selectors <strong>front-deque</strong> and <strong>rear-deque</strong> , mutators <strong>front-insert-deque!</strong> , <strong>rear-insert-deque!</strong> , <strong>front-delete-deque!</strong> ,and <strong>rear-delete- deque!</strong> . Show how to represent deques using pairs, and give implementations of the operations. 23 All operations should be accomplished in Θ(1) steps.</p>
<h2 id="表的表示"><a href="#表的表示" class="headerlink" title="表的表示"></a>表的表示</h2><p>(3.3.3 Representing Tables)</p>
<p>一维表可以使用序对的列表进行表示：<br><img src="/images/sicp/Figure_3.22.png" alt><br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 查找 key 所对应的 value</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">lookup</span> key table)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">record</span> (<span class="name"><span class="builtin-name">assoc</span></span> key (<span class="name"><span class="builtin-name">cdr</span></span> table))))</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> record</span><br><span class="line">        (<span class="name"><span class="builtin-name">cdr</span></span> record)</span><br><span class="line">        false)))</span><br><span class="line"><span class="comment">; 查找 key 所对应的记录</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">assoc</span></span> key records)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">null?</span></span> records) false)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">equal?</span></span> key (<span class="name"><span class="builtin-name">caar</span></span> records)) (<span class="name"><span class="builtin-name">car</span></span> records))</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name"><span class="builtin-name">assoc</span></span> key (<span class="name"><span class="builtin-name">cdr</span></span> records)))))</span><br><span class="line"><span class="comment">; 插入新的键值对</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">insert!</span> key value table)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">record</span> (<span class="name"><span class="builtin-name">assoc</span></span> key (<span class="name"><span class="builtin-name">cdr</span></span> table))))</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> record</span><br><span class="line">        (<span class="name"><span class="builtin-name">set-cdr!</span></span> record value)</span><br><span class="line">        (<span class="name"><span class="builtin-name">set-cdr!</span></span> table</span><br><span class="line">                  (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">cons</span></span> key value) (<span class="name"><span class="builtin-name">cdr</span></span> table)))))</span><br><span class="line">  <span class="symbol">'ok</span>)</span><br><span class="line"><span class="comment">; 表的构造器</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-table</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">list</span></span> <span class="symbol">'*table*</span>))</span><br></pre></td></tr></table></figure></p>
<h3 id="二维表-Two-dimensional-tables"><a href="#二维表-Two-dimensional-tables" class="headerlink" title="二维表(Two-dimensional tables)"></a>二维表(Two-dimensional tables)</h3><p>在二维表中，一个值由两个键索引。<br>可以使用一维表进行表示，将一维表的每个键指向一个子表。如下图所示：<br><img src="/images/sicp/Figure_3.23.png" alt></p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 查找两个键对应的值，若未找到则返回false</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">lookup</span> key-1 key-2 table)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">subtable</span> (<span class="name"><span class="builtin-name">assoc</span></span> key-1 (<span class="name"><span class="builtin-name">cdr</span></span> table))))</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> subtable</span><br><span class="line">        (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">record</span> (<span class="name"><span class="builtin-name">assoc</span></span> key-2 (<span class="name"><span class="builtin-name">cdr</span></span> subtable))))</span><br><span class="line">          (<span class="name"><span class="builtin-name">if</span></span> record</span><br><span class="line">              (<span class="name"><span class="builtin-name">cdr</span></span> record)</span><br><span class="line">              false))</span><br><span class="line">        false)))</span><br><span class="line"><span class="comment">; 插入新的键值对</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">insert!</span> key-1 key-2 value table)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">subtable</span> (<span class="name"><span class="builtin-name">assoc</span></span> key-1 (<span class="name"><span class="builtin-name">cdr</span></span> table))))</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> subtable</span><br><span class="line">        (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">record</span> (<span class="name"><span class="builtin-name">assoc</span></span> key-2 (<span class="name"><span class="builtin-name">cdr</span></span> subtable))))</span><br><span class="line">          (<span class="name"><span class="builtin-name">if</span></span> record</span><br><span class="line">              (<span class="name"><span class="builtin-name">set-cdr!</span></span> record value)</span><br><span class="line">              (<span class="name"><span class="builtin-name">set-cdr!</span></span> subtable</span><br><span class="line">                        (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">cons</span></span> key-2 value)</span><br><span class="line">                              (<span class="name"><span class="builtin-name">cdr</span></span> subtable)))))</span><br><span class="line">        (<span class="name"><span class="builtin-name">set-cdr!</span></span> table</span><br><span class="line">                  (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">list</span></span> key-1</span><br><span class="line">                              (<span class="name"><span class="builtin-name">cons</span></span> key-2 value))</span><br><span class="line">                        (<span class="name"><span class="builtin-name">cdr</span></span> table)))))</span><br><span class="line">  <span class="symbol">'ok</span>)</span><br></pre></td></tr></table></figure>
<h3 id="创建局部表-Creating-local-tables"><a href="#创建局部表-Creating-local-tables" class="headerlink" title="创建局部表(Creating local tables)"></a>创建局部表(Creating local tables)</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-table</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">local-table</span> (<span class="name"><span class="builtin-name">list</span></span> <span class="symbol">'*table*</span>)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">lookup</span> key-1 key-2)</span><br><span class="line">      (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">subtable</span> (<span class="name"><span class="builtin-name">assoc</span></span> key-1 (<span class="name"><span class="builtin-name">cdr</span></span> local-table))))</span><br><span class="line">        (<span class="name"><span class="builtin-name">if</span></span> subtable</span><br><span class="line">            (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">record</span> (<span class="name"><span class="builtin-name">assoc</span></span> key-2 (<span class="name"><span class="builtin-name">cdr</span></span> subtable))))</span><br><span class="line">              (<span class="name"><span class="builtin-name">if</span></span> record</span><br><span class="line">                  (<span class="name"><span class="builtin-name">cdr</span></span> record)</span><br><span class="line">                  false))</span><br><span class="line">            false)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">insert!</span> key-1 key-2 value)</span><br><span class="line">      (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">subtable</span> (<span class="name"><span class="builtin-name">assoc</span></span> key-1 (<span class="name"><span class="builtin-name">cdr</span></span> local-table))))</span><br><span class="line">        (<span class="name"><span class="builtin-name">if</span></span> subtable</span><br><span class="line">            (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">record</span> (<span class="name"><span class="builtin-name">assoc</span></span> key-2 (<span class="name"><span class="builtin-name">cdr</span></span> subtable))))</span><br><span class="line">              (<span class="name"><span class="builtin-name">if</span></span> record</span><br><span class="line">                  (<span class="name"><span class="builtin-name">set-cdr!</span></span> record value)</span><br><span class="line">                  (<span class="name"><span class="builtin-name">set-cdr!</span></span> subtable</span><br><span class="line">                            (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">cons</span></span> key-2 value)</span><br><span class="line">                                  (<span class="name"><span class="builtin-name">cdr</span></span> subtable)))))</span><br><span class="line">            (<span class="name"><span class="builtin-name">set-cdr!</span></span> local-table</span><br><span class="line">                      (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">list</span></span> key-1</span><br><span class="line">                                  (<span class="name"><span class="builtin-name">cons</span></span> key-2 value))</span><br><span class="line">                            (<span class="name"><span class="builtin-name">cdr</span></span> local-table)))))</span><br><span class="line">      <span class="symbol">'ok</span>)  </span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m)</span><br><span class="line">      (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'lookup-proc</span>) lookup)</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'insert-proc!</span>) insert!)</span><br><span class="line">            (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown operation -- TABLE"</span> m))))</span><br><span class="line">    dispatch))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> operation-table (<span class="name">make-table</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> get (<span class="name">operation-table</span> <span class="symbol">'lookup-proc</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> put (<span class="name">operation-table</span> <span class="symbol">'insert-proc!</span>))</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-3-24"><a href="#Exercise-3-24" class="headerlink" title="Exercise 3.24"></a>Exercise 3.24</h4><p>In the table implementations above,the keys are tested for equality using <strong>equal?</strong> (called by assoc ). This is not always the appropriate test. For instance, we might have a table with numeric keys in which we don’t need an exact match to the number we’re looking up, but only a number within some tolerance of it. Design a table constructor <strong>make-table</strong> that takes as an argument a <strong>same-key?</strong> procedure that will be used to test “equality” of keys. <strong>make-table</strong> should return a dispatch procedure that can be used to access appropriate <strong>lookup</strong> and <strong>insert!</strong> procedures for a local table.</p>
<h4 id="Exercise-3-25"><a href="#Exercise-3-25" class="headerlink" title="Exercise 3.25"></a>Exercise 3.25</h4><p>Generalizing one- and two-dimensional tables, show how to implement a table in which values are stored under an arbitrary number of keys and different values may be stored under different numbers of keys. The <strong>lookup</strong> and <strong>insert!</strong> procedures should take as input a list of keys used to access the table.</p>
<h4 id="Exercise-3-26"><a href="#Exercise-3-26" class="headerlink" title="Exercise 3.26"></a>Exercise 3.26</h4><p>To search a table as implemented above,one needs to scan through the list of records. This is basically the unordered list representation of Section 2.3.3. For large tables,it may be more efficient to structure the table in a different manner. Describe a table implementation where the 367 (key, value) records are organized using a binary tree, assuming that keys can be ordered in some way (e.g., numerically or alphabetically). (Compare Exercise 2.66 of Chapter 2.)</p>
<h4 id="Exercise-3-27"><a href="#Exercise-3-27" class="headerlink" title="Exercise 3.27"></a>Exercise 3.27</h4><p>Memoization (alsocalled tabulation )is a technique that enables a procedure to record, in a local table, values that have previously been computed. This technique can make a vast difference in the performance of aprogram. A memoized procedure maintains a table in which values of previous calls are stored using as keys the arguments that produced the values. When the memoized procedure is asked to compute a value, it first checks the table to see if the value is already the reand,if so,just returns that value. Otherwise, it computes the new value in the ordinary way and stores this in the table. As an example of memoization, recall from Section 1.2.2 the exponential process for computing Fibonacci numbers:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">fib</span> n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">=</span></span> n <span class="number">0</span>) <span class="number">0</span>)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">=</span></span> n <span class="number">1</span>) <span class="number">1</span>)</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">fib</span> (<span class="name"><span class="builtin-name">-</span></span> n <span class="number">1</span>))</span><br><span class="line">                 (<span class="name">fib</span> (<span class="name"><span class="builtin-name">-</span></span> n <span class="number">2</span>))))))</span><br></pre></td></tr></table></figure></p>
<p>The memoized version of the same procedure is<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> memo-fib</span><br><span class="line">  (<span class="name">memoize</span> (<span class="name"><span class="builtin-name">lambda</span></span> (n)</span><br><span class="line">             (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">=</span></span> n <span class="number">0</span>) <span class="number">0</span>)</span><br><span class="line">                   ((<span class="name"><span class="builtin-name">=</span></span> n <span class="number">1</span>) <span class="number">1</span>)</span><br><span class="line">                   (<span class="name"><span class="builtin-name">else</span></span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">memo-fib</span> (<span class="name"><span class="builtin-name">-</span></span> n <span class="number">1</span>))</span><br><span class="line">                            (<span class="name">memo-fib</span> (<span class="name"><span class="builtin-name">-</span></span> n <span class="number">2</span>))))))))</span><br></pre></td></tr></table></figure></p>
<p>where the memoizer is defined as<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">memoize</span> f)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">table</span> (<span class="name">make-table</span>)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">lambda</span></span> (x)</span><br><span class="line">      (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">previously-computed-result</span> (<span class="name">lookup</span> x table)))</span><br><span class="line">        (<span class="name"><span class="builtin-name">or</span></span> previously-computed-result</span><br><span class="line">            (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">result</span> (<span class="name">f</span> x)))</span><br><span class="line">              (<span class="name">insert!</span> x result table)</span><br><span class="line">              result))))))</span><br></pre></td></tr></table></figure></p>
<p>Draw an environment diagram to analyze the computation of (memo-fib 3). Explain why memo-fib computes the nth Fibonacci number in a number of steps proportional to n. Would the scheme still work if we had simply defined <strong>memo-fib</strong> to be (memoize fib)?
</p>
<h2 id="数字电路模拟器"><a href="#数字电路模拟器" class="headerlink" title="数字电路模拟器"></a>数字电路模拟器</h2><p>(3.3.4 A Simulator for Digital Circuits)</p>
<p>逻辑电路中的非门、与门和或门：<br><img src="/images/sicp/Figure_3.24.png" alt></p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 导线</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> a (<span class="name">make-wire</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> b (<span class="name">make-wire</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> c (<span class="name">make-wire</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> d (<span class="name">make-wire</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> e (<span class="name">make-wire</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> s (<span class="name">make-wire</span>))</span><br><span class="line"><span class="comment">; 逻辑门</span></span><br><span class="line">(<span class="name">or-gate</span> a b d)</span><br><span class="line">(<span class="name">and-gate</span> a b c)</span><br><span class="line">(<span class="name">inverter</span> c e)</span><br><span class="line">(<span class="name">and-gate</span> d e s)</span><br></pre></td></tr></table></figure>
<p>半加法电路：<br><img src="/images/sicp/Figure_3.25.png" alt><br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;;NB. To use half-adder, need or-gate from exercise 3.28</span></span><br><span class="line"><span class="comment">; 定义半加法器</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">half-adder</span> a b s c)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">d</span> (<span class="name">make-wire</span>)) (<span class="name">e</span> (<span class="name">make-wire</span>)))</span><br><span class="line">    (<span class="name">or-gate</span> a b d)</span><br><span class="line">    (<span class="name">and-gate</span> a b c)</span><br><span class="line">    (<span class="name">inverter</span> c e)</span><br><span class="line">    (<span class="name">and-gate</span> d e s)</span><br><span class="line">    <span class="symbol">'ok</span>))</span><br></pre></td></tr></table></figure></p>
<p>全加法电路：<br><img src="/images/sicp/Figure_3.26.png" alt></p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 定义全加法器</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">full-adder</span> a b c-in sum c-out)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">s</span> (<span class="name">make-wire</span>)) (<span class="name">c1</span> (<span class="name">make-wire</span>)) (<span class="name">c2</span> (<span class="name">make-wire</span>)))</span><br><span class="line">    (<span class="name">half-adder</span> b c-in s c1)</span><br><span class="line">    (<span class="name">half-adder</span> a s sum c2)</span><br><span class="line">    (<span class="name">or-gate</span> c1 c2 c-out)</span><br><span class="line">    <span class="symbol">'ok</span>))</span><br></pre></td></tr></table></figure>
<h3 id="基本功能块-Primitive-function-boxes"><a href="#基本功能块-Primitive-function-boxes" class="headerlink" title="基本功能块(Primitive function boxes)"></a>基本功能块(Primitive function boxes)</h3><p>在导线上的操作：<br><code>(get-signal ⟨wire⟩)</code><br><code>(set-signal! ⟨wire⟩ ⟨new value⟩)</code><br><code>(add-action! ⟨wire⟩ ⟨procedure of no arguments⟩)</code></p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">inverter</span> input output)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">invert-input</span>)</span><br><span class="line">    (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">new-value</span> (<span class="name">logical-not</span> (<span class="name">get-signal</span> input))))</span><br><span class="line">      (<span class="name">after-delay</span> inverter-delay</span><br><span class="line">                   (<span class="name"><span class="builtin-name">lambda</span></span> () (<span class="name">set-signal!</span> output new-value)))))</span><br><span class="line">  (<span class="name">add-action!</span> input invert-input)</span><br><span class="line">  <span class="symbol">'ok</span>)</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">logical-not</span> s)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">=</span></span> s <span class="number">0</span>) <span class="number">1</span>)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">=</span></span> s <span class="number">1</span>) <span class="number">0</span>)</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Invalid signal"</span> s))))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;; *following uses logical-and -- see ch3support.scm</span></span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">and-gate</span> a1 a2 output)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">and-action-procedure</span>)</span><br><span class="line">    (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">new-value</span></span><br><span class="line">           (<span class="name">logical-and</span> (<span class="name">get-signal</span> a1) (<span class="name">get-signal</span> a2))))</span><br><span class="line">      (<span class="name">after-delay</span> and-gate-delay</span><br><span class="line">                   (<span class="name"><span class="builtin-name">lambda</span></span> () (<span class="name">set-signal!</span> output new-value)))))</span><br><span class="line">  (<span class="name">add-action!</span> a1 and-action-procedure)</span><br><span class="line">  (<span class="name">add-action!</span> a2 and-action-procedure)</span><br><span class="line">  <span class="symbol">'ok</span>)</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">logical-and</span> s1 s2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name"><span class="builtin-name">=</span></span> s1 <span class="number">1</span>) (<span class="name"><span class="builtin-name">=</span></span> s2 <span class="number">1</span>)) <span class="number">1</span>)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name"><span class="builtin-name">=</span></span> s1 <span class="number">0</span>) (<span class="name"><span class="builtin-name">=</span></span> s2 <span class="number">1</span>)) <span class="number">0</span>)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name"><span class="builtin-name">=</span></span> s1 <span class="number">1</span>) (<span class="name"><span class="builtin-name">=</span></span> s2 <span class="number">0</span>)) <span class="number">0</span>)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name"><span class="builtin-name">=</span></span> s1 <span class="number">0</span>) (<span class="name"><span class="builtin-name">=</span></span> s2 <span class="number">0</span>)) <span class="number">0</span>)</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Invalid signal"</span> s))))</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-3-28"><a href="#Exercise-3-28" class="headerlink" title="Exercise 3.28"></a>Exercise 3.28</h4><p>Define an <strong>or-gate</strong> as a primitive function box. Your <strong>or-gate</strong> constructor should be similar to <strong>and-gate</strong>.</p>
<h4 id="Exercise-3-29"><a href="#Exercise-3-29" class="headerlink" title="Exercise 3.29"></a>Exercise 3.29</h4><p>Another way to construct an <strong>or-gate</strong> is as a compound digital logic device, built from and-gates and inverters. Define a procedure <strong>or-gate</strong> that accomplishes this. What is the delay time of the <strong>or-gate</strong> in terms of <strong>and-gate-delay</strong> and <strong>inverter-delay</strong>?</p>
<h4 id="Exercise-3-30"><a href="#Exercise-3-30" class="headerlink" title="Exercise 3.30"></a>Exercise 3.30</h4><p>Figure 3.27 shows a <em>ripple-carry adder</em> formed by stringing together n full-adders. This is the simplest form of parallel adder for adding two n-bit binary numbers. The inputs A1, A2, A3, …, An and B1, B2, B3, …, Bn are the two binary numbers to be added (each Ak and Bk is a 0 or a 1). The circuit generates S1, S2, S3, …, Sn, the n bits of the sum, and C, the carry from the addition. Write a procedure <strong>ripple-carry-adder</strong> that generates this circuit. The procedure should take as arguments three lists of n wires each – the Ak, the Bk, and the Sk – and also another wire C. The major drawback of the ripple-carry adder is the need to wait for the carry signals to propagate. What is the delay needed to obtain the complete output from an n-bit ripple-carry adder, expressed in terms of the delays for and-gates, or-gates, and inverters?<br><img src="/images/sicp/Figure_3.27.png" alt></p>
<h3 id="导线的表示-Representing-wires"><a href="#导线的表示-Representing-wires" class="headerlink" title="导线的表示(Representing wires)"></a>导线的表示(Representing wires)</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-wire</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">signal-value</span> <span class="number">0</span>) (<span class="name">action-procedures</span> '()))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">set-my-signal!</span> new-value)</span><br><span class="line">      (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">not</span></span> (<span class="name"><span class="builtin-name">=</span></span> signal-value new-value))</span><br><span class="line">          (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> signal-value new-value)</span><br><span class="line">                 (<span class="name">call-each</span> action-procedures))</span><br><span class="line">          <span class="symbol">'done</span>))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">accept-action-procedure!</span> proc)</span><br><span class="line">      (<span class="name"><span class="builtin-name">set!</span></span> action-procedures (<span class="name"><span class="builtin-name">cons</span></span> proc action-procedures))</span><br><span class="line">      (<span class="name">proc</span>))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m)</span><br><span class="line">      (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'get-signal</span>) signal-value)</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'set-signal!</span>) set-my-signal!)</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'add-action!</span>) accept-action-procedure!)</span><br><span class="line">            (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown operation -- WIRE"</span> m))))</span><br><span class="line">    dispatch))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">call-each</span> procedures)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> procedures)</span><br><span class="line">      <span class="symbol">'done</span></span><br><span class="line">      (<span class="name"><span class="builtin-name">begin</span></span></span><br><span class="line">        ((<span class="name"><span class="builtin-name">car</span></span> procedures))</span><br><span class="line">        (<span class="name">call-each</span> (<span class="name"><span class="builtin-name">cdr</span></span> procedures)))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">get-signal</span> wire)</span><br><span class="line">  (<span class="name">wire</span> <span class="symbol">'get-signal</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">set-signal!</span> wire new-value)</span><br><span class="line">  ((<span class="name">wire</span> <span class="symbol">'set-signal!</span>) new-value))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">add-action!</span> wire action-procedure)</span><br><span class="line">  ((<span class="name">wire</span> <span class="symbol">'add-action!</span>) action-procedure))</span><br></pre></td></tr></table></figure>
<h3 id="待处理表-The-agenda"><a href="#待处理表-The-agenda" class="headerlink" title="待处理表(The agenda)"></a>待处理表(The agenda)</h3><p>需定义以下操作：</p>
<ul>
<li>(make-agenda) returns a new empty agenda.</li>
<li>(empty-agenda? ⟨agenda⟩) is true if the specified agenda is empty.</li>
<li>(first-agenda-item ⟨agenda⟩) returns the first item on the agenda.</li>
<li>(remove-first-agenda-item! ⟨agenda⟩) modifies the agenda by removing the first item.</li>
<li>(add-to-agenda! ⟨time⟩ ⟨action⟩ ⟨agenda⟩) modifies the agenda by adding the given action procedure to be run at the specified time.</li>
<li>(current-time ⟨agenda⟩) returns the current simulation time.</li>
</ul>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; after-delay过程，向待处理表中加入一个新元素</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">after-delay</span> delay action)</span><br><span class="line">  (<span class="name">add-to-agenda!</span> (<span class="name"><span class="builtin-name">+</span></span> delay (<span class="name">current-time</span> the-agenda))</span><br><span class="line">                  action</span><br><span class="line">                  the-agenda))</span><br><span class="line"><span class="comment">; 定义过程propagate, 用来顺序执行待处理表中的过程</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">propagate</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">empty-agenda?</span> the-agenda)</span><br><span class="line">      <span class="symbol">'done</span></span><br><span class="line">      (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">first-item</span> (<span class="name">first-agenda-item</span> the-agenda)))</span><br><span class="line">        (<span class="name">first-item</span>)</span><br><span class="line">        (<span class="name">remove-first-agenda-item!</span> the-agenda)</span><br><span class="line">        (<span class="name">propagate</span>))))</span><br></pre></td></tr></table></figure>
<h3 id="一个模拟示例-A-sample-simulation"><a href="#一个模拟示例-A-sample-simulation" class="headerlink" title="一个模拟示例(A sample simulation)"></a>一个模拟示例(A sample simulation)</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">probe</span> name wire)</span><br><span class="line">  (<span class="name">add-action!</span> wire</span><br><span class="line">               (<span class="name"><span class="builtin-name">lambda</span></span> ()      </span><br><span class="line">                 (<span class="name"><span class="builtin-name">newline</span></span>)</span><br><span class="line">                 (<span class="name"><span class="builtin-name">display</span></span> name)</span><br><span class="line">                 (<span class="name"><span class="builtin-name">display</span></span> <span class="string">" "</span>)</span><br><span class="line">                 (<span class="name"><span class="builtin-name">display</span></span> (<span class="name">current-time</span> the-agenda))</span><br><span class="line">                 (<span class="name"><span class="builtin-name">display</span></span> <span class="string">"  New-value = "</span>)</span><br><span class="line">                 (<span class="name"><span class="builtin-name">display</span></span> (<span class="name">get-signal</span> wire)))))</span><br><span class="line"></span><br><span class="line"><span class="comment">;;; Sample simulation</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;: (define the-agenda (make-agenda))</span></span><br><span class="line"><span class="comment">;: (define inverter-delay 2)</span></span><br><span class="line"><span class="comment">;: (define and-gate-delay 3)</span></span><br><span class="line"><span class="comment">;: (define or-gate-delay 5)</span></span><br><span class="line"><span class="comment">;:</span></span><br><span class="line"><span class="comment">;: (define input-1 (make-wire))</span></span><br><span class="line"><span class="comment">;: (define input-2 (make-wire))</span></span><br><span class="line"><span class="comment">;: (define sum (make-wire))</span></span><br><span class="line"><span class="comment">;: (define carry (make-wire))</span></span><br><span class="line"><span class="comment">;:</span></span><br><span class="line"><span class="comment">;: (probe 'sum sum)</span></span><br><span class="line"><span class="comment">;: (probe 'carry carry)</span></span><br><span class="line"><span class="comment">;:</span></span><br><span class="line"><span class="comment">;: (half-adder input-1 input-2 sum carry)</span></span><br><span class="line"><span class="comment">;: (set-signal! input-1 1)</span></span><br><span class="line"><span class="comment">;: (propagate)</span></span><br><span class="line"><span class="comment">;:</span></span><br><span class="line"><span class="comment">;: (set-signal! input-2 1)</span></span><br><span class="line"><span class="comment">;: (propagate)</span></span><br></pre></td></tr></table></figure>
<h4 id="Exercise-3-31"><a href="#Exercise-3-31" class="headerlink" title="Exercise 3.31"></a>Exercise 3.31</h4><p>The internal procedure accept-action-procedure! defined in make-wire specifies that when a new action procedure is added to a wire, the procedure is immediately run. Explain why this initialization is necessary. In particular, trace through the half-adder example in the paragraphs above and say how the system’s response would differ if we had defined accept-action-procedure! as<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">accept-action-procedure!</span> proc)</span><br><span class="line">  (<span class="name"><span class="builtin-name">set!</span></span> action-procedures (<span class="name"><span class="builtin-name">cons</span></span> proc action-procedures)))</span><br></pre></td></tr></table></figure></p>
<h3 id="待处理表的实现-Implementing-agenda"><a href="#待处理表的实现-Implementing-agenda" class="headerlink" title="待处理表的实现(Implementing agenda)"></a>待处理表的实现(Implementing agenda)</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-time-segment</span> time queue)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cons</span></span> time queue))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">segment-time</span> s) (<span class="name"><span class="builtin-name">car</span></span> s))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">segment-queue</span> s) (<span class="name"><span class="builtin-name">cdr</span></span> s))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-agenda</span>) (<span class="name"><span class="builtin-name">list</span></span> <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">current-time</span> agenda) (<span class="name"><span class="builtin-name">car</span></span> agenda))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">set-current-time!</span> agenda time)</span><br><span class="line">  (<span class="name"><span class="builtin-name">set-car!</span></span> agenda time))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">segments</span> agenda) (<span class="name"><span class="builtin-name">cdr</span></span> agenda))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">set-segments!</span> agenda segments)</span><br><span class="line">  (<span class="name"><span class="builtin-name">set-cdr!</span></span> agenda segments))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">first-segment</span> agenda) (<span class="name"><span class="builtin-name">car</span></span> (<span class="name">segments</span> agenda)))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">rest-segments</span> agenda) (<span class="name"><span class="builtin-name">cdr</span></span> (<span class="name">segments</span> agenda)))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">empty-agenda?</span> agenda)</span><br><span class="line">  (<span class="name"><span class="builtin-name">null?</span></span> (<span class="name">segments</span> agenda)))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">add-to-agenda!</span> time action agenda)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">belongs-before?</span> segments)</span><br><span class="line">    (<span class="name"><span class="builtin-name">or</span></span> (<span class="name"><span class="builtin-name">null?</span></span> segments)</span><br><span class="line">        (<span class="name"><span class="builtin-name">&lt;</span></span> time (<span class="name">segment-time</span> (<span class="name"><span class="builtin-name">car</span></span> segments)))))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-new-time-segment</span> time action)</span><br><span class="line">    (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">q</span> (<span class="name">make-queue</span>)))</span><br><span class="line">      (<span class="name">insert-queue!</span> q action)</span><br><span class="line">      (<span class="name">make-time-segment</span> time q)))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">add-to-segments!</span> segments)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> (<span class="name">segment-time</span> (<span class="name"><span class="builtin-name">car</span></span> segments)) time)</span><br><span class="line">        (<span class="name">insert-queue!</span> (<span class="name">segment-queue</span> (<span class="name"><span class="builtin-name">car</span></span> segments))</span><br><span class="line">                       action)</span><br><span class="line">        (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">rest</span> (<span class="name"><span class="builtin-name">cdr</span></span> segments)))</span><br><span class="line">          (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">belongs-before?</span> rest)</span><br><span class="line">              (<span class="name"><span class="builtin-name">set-cdr!</span></span></span><br><span class="line">               segments</span><br><span class="line">               (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name">make-new-time-segment</span> time action)</span><br><span class="line">                     (<span class="name"><span class="builtin-name">cdr</span></span> segments)))</span><br><span class="line">              (<span class="name">add-to-segments!</span> rest)))))</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">segments</span> (<span class="name">segments</span> agenda)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">belongs-before?</span> segments)</span><br><span class="line">        (<span class="name">set-segments!</span></span><br><span class="line">         agenda</span><br><span class="line">         (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name">make-new-time-segment</span> time action)</span><br><span class="line">               segments))</span><br><span class="line">        (<span class="name">add-to-segments!</span> segments))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">remove-first-agenda-item!</span> agenda)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">q</span> (<span class="name">segment-queue</span> (<span class="name">first-segment</span> agenda))))</span><br><span class="line">    (<span class="name">delete-queue!</span> q)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">empty-queue?</span> q)</span><br><span class="line">        (<span class="name">set-segments!</span> agenda (<span class="name">rest-segments</span> agenda)))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">first-agenda-item</span> agenda)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">empty-agenda?</span> agenda)</span><br><span class="line">      (<span class="name">error</span> <span class="string">"Agenda is empty -- FIRST-AGENDA-ITEM"</span>)</span><br><span class="line">      (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">first-seg</span> (<span class="name">first-segment</span> agenda)))</span><br><span class="line">        (<span class="name">set-current-time!</span> agenda (<span class="name">segment-time</span> first-seg))</span><br><span class="line">        (<span class="name">front-queue</span> (<span class="name">segment-queue</span> first-seg)))))</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-3-32"><a href="#Exercise-3-32" class="headerlink" title="Exercise 3.32"></a>Exercise 3.32</h4><p>The procedures to be run during each time segment of the agenda are kept in a queue. Thus, the procedures for each segment are called in the order in which they were added to the agenda (first in, first out). Explain why this order must be used. In particular, trace the behavior of an and-gate whose inputs change from 0,1 to 1,0 in the same segment and say how the behavior would differ if we stored a segment’s procedures in an ordinary list, adding and removing procedures only at the front (last in, first out).</p>
<h2 id="约束的传递"><a href="#约束的传递" class="headerlink" title="约束的传递"></a>约束的传递</h2><p>(3.3.5 Propagation of Constraints)</p>
<h3 id="约束系统的使用-Using-the-constraint-system"><a href="#约束系统的使用-Using-the-constraint-system" class="headerlink" title="约束系统的使用(Using the constraint system)"></a>约束系统的使用(Using the constraint system)</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;: (define C (make-connector))</span></span><br><span class="line"><span class="comment">;: (define F (make-connector))</span></span><br><span class="line"><span class="comment">;: (celsius-fahrenheit-converter C F)</span></span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">celsius-fahrenheit-converter</span> c f)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">u</span> (<span class="name">make-connector</span>))</span><br><span class="line">        (<span class="name">v</span> (<span class="name">make-connector</span>))</span><br><span class="line">        (<span class="name">w</span> (<span class="name">make-connector</span>))</span><br><span class="line">        (<span class="name">x</span> (<span class="name">make-connector</span>))</span><br><span class="line">        (<span class="name">y</span> (<span class="name">make-connector</span>)))</span><br><span class="line">    (<span class="name">multiplier</span> c w u)</span><br><span class="line">    (<span class="name">multiplier</span> v x u)</span><br><span class="line">    (<span class="name">adder</span> v y f)</span><br><span class="line">    (<span class="name">constant</span> <span class="number">9</span> w)</span><br><span class="line">    (<span class="name">constant</span> <span class="number">5</span> x)</span><br><span class="line">    (<span class="name">constant</span> <span class="number">32</span> y)</span><br><span class="line">    <span class="symbol">'ok</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">;: (probe "Celsius temp" C)</span></span><br><span class="line"><span class="comment">;: (probe "Fahrenheit temp" F)</span></span><br><span class="line"><span class="comment">;: (set-value! C 25 'user)</span></span><br><span class="line"><span class="comment">;: (set-value! F 212 'user)</span></span><br><span class="line"><span class="comment">;: (forget-value! C 'user)</span></span><br><span class="line"><span class="comment">;: (set-value! F 212 'user)</span></span><br></pre></td></tr></table></figure>
<h3 id="约束系统的实现-Implementing-the-constraint-system"><a href="#约束系统的实现-Implementing-the-constraint-system" class="headerlink" title="约束系统的实现(Implementing the constraint system)"></a>约束系统的实现(Implementing the constraint system)</h3><p>连接器的基本操作：</p>
<ul>
<li>(has-value? ⟨connector⟩) tells whether the connector has a value.</li>
<li>(get-value ⟨connector⟩) returns the connector’s current value.</li>
<li>(set-value! ⟨connector⟩ ⟨new-value⟩ ⟨informant⟩) indicates that the informant is requesting the connector to set its value to the new value.</li>
<li>(forget-value! ⟨connector⟩ ⟨retractor⟩) tells the connector that the retractor is requesting it to forget its value.</li>
<li>(connect ⟨connector⟩ ⟨new-constraint⟩) tells the connector to participate in the new constraint.</li>
</ul>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">adder</span> a1 a2 sum)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">process-new-value</span>)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name">has-value?</span> a1) (<span class="name">has-value?</span> a2))</span><br><span class="line">           (<span class="name">set-value!</span> sum</span><br><span class="line">                       (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">get-value</span> a1) (<span class="name">get-value</span> a2))</span><br><span class="line">                       me))</span><br><span class="line">          ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name">has-value?</span> a1) (<span class="name">has-value?</span> sum))</span><br><span class="line">           (<span class="name">set-value!</span> a2</span><br><span class="line">                       (<span class="name"><span class="builtin-name">-</span></span> (<span class="name">get-value</span> sum) (<span class="name">get-value</span> a1))</span><br><span class="line">                       me))</span><br><span class="line">          ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name">has-value?</span> a2) (<span class="name">has-value?</span> sum))</span><br><span class="line">           (<span class="name">set-value!</span> a1</span><br><span class="line">                       (<span class="name"><span class="builtin-name">-</span></span> (<span class="name">get-value</span> sum) (<span class="name">get-value</span> a2))</span><br><span class="line">                       me))))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">process-forget-value</span>)</span><br><span class="line">    (<span class="name">forget-value!</span> sum me)</span><br><span class="line">    (<span class="name">forget-value!</span> a1 me)</span><br><span class="line">    (<span class="name">forget-value!</span> a2 me)</span><br><span class="line">    (<span class="name">process-new-value</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">me</span> request)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> request <span class="symbol">'I-have-a-value</span>)</span><br><span class="line">           (<span class="name">process-new-value</span>))</span><br><span class="line">          ((<span class="name"><span class="builtin-name">eq?</span></span> request <span class="symbol">'I-lost-my-value</span>)</span><br><span class="line">           (<span class="name">process-forget-value</span>))</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span></span><br><span class="line">           (<span class="name">error</span> <span class="string">"Unknown request -- ADDER"</span> request))))</span><br><span class="line">  (<span class="name">connect</span> a1 me)</span><br><span class="line">  (<span class="name">connect</span> a2 me)</span><br><span class="line">  (<span class="name">connect</span> sum me)</span><br><span class="line">  me)</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">inform-about-value</span> constraint)</span><br><span class="line">  (<span class="name">constraint</span> <span class="symbol">'I-have-a-value</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">inform-about-no-value</span> constraint)</span><br><span class="line">  (<span class="name">constraint</span> <span class="symbol">'I-lost-my-value</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">multiplier</span> m1 m2 product)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">process-new-value</span>)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">or</span></span> (<span class="name"><span class="builtin-name">and</span></span> (<span class="name">has-value?</span> m1) (<span class="name"><span class="builtin-name">=</span></span> (<span class="name">get-value</span> m1) <span class="number">0</span>))</span><br><span class="line">               (<span class="name"><span class="builtin-name">and</span></span> (<span class="name">has-value?</span> m2) (<span class="name"><span class="builtin-name">=</span></span> (<span class="name">get-value</span> m2) <span class="number">0</span>)))</span><br><span class="line">           (<span class="name">set-value!</span> product <span class="number">0</span> me))</span><br><span class="line">          ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name">has-value?</span> m1) (<span class="name">has-value?</span> m2))</span><br><span class="line">           (<span class="name">set-value!</span> product</span><br><span class="line">                       (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">get-value</span> m1) (<span class="name">get-value</span> m2))</span><br><span class="line">                       me))</span><br><span class="line">          ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name">has-value?</span> product) (<span class="name">has-value?</span> m1))</span><br><span class="line">           (<span class="name">set-value!</span> m2</span><br><span class="line">                       (<span class="name"><span class="builtin-name">/</span></span> (<span class="name">get-value</span> product) (<span class="name">get-value</span> m1))</span><br><span class="line">                       me))</span><br><span class="line">          ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name">has-value?</span> product) (<span class="name">has-value?</span> m2))</span><br><span class="line">           (<span class="name">set-value!</span> m1</span><br><span class="line">                       (<span class="name"><span class="builtin-name">/</span></span> (<span class="name">get-value</span> product) (<span class="name">get-value</span> m2))</span><br><span class="line">                       me))))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">process-forget-value</span>)</span><br><span class="line">    (<span class="name">forget-value!</span> product me)</span><br><span class="line">    (<span class="name">forget-value!</span> m1 me)</span><br><span class="line">    (<span class="name">forget-value!</span> m2 me)</span><br><span class="line">    (<span class="name">process-new-value</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">me</span> request)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> request <span class="symbol">'I-have-a-value</span>)</span><br><span class="line">           (<span class="name">process-new-value</span>))</span><br><span class="line">          ((<span class="name"><span class="builtin-name">eq?</span></span> request <span class="symbol">'I-lost-my-value</span>)</span><br><span class="line">           (<span class="name">process-forget-value</span>))</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span></span><br><span class="line">           (<span class="name">error</span> <span class="string">"Unknown request -- MULTIPLIER"</span> request))))</span><br><span class="line">  (<span class="name">connect</span> m1 me)</span><br><span class="line">  (<span class="name">connect</span> m2 me)</span><br><span class="line">  (<span class="name">connect</span> product me)</span><br><span class="line">  me)</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">constant</span> value connector)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">me</span> request)</span><br><span class="line">    (<span class="name">error</span> <span class="string">"Unknown request -- CONSTANT"</span> request))</span><br><span class="line">  (<span class="name">connect</span> connector me)</span><br><span class="line">  (<span class="name">set-value!</span> connector value me)</span><br><span class="line">  me)</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">probe</span> name connector)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">print-probe</span> value)</span><br><span class="line">    (<span class="name"><span class="builtin-name">newline</span></span>)</span><br><span class="line">    (<span class="name"><span class="builtin-name">display</span></span> <span class="string">"Probe: "</span>)</span><br><span class="line">    (<span class="name"><span class="builtin-name">display</span></span> name)</span><br><span class="line">    (<span class="name"><span class="builtin-name">display</span></span> <span class="string">" = "</span>)</span><br><span class="line">    (<span class="name"><span class="builtin-name">display</span></span> value))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">process-new-value</span>)</span><br><span class="line">    (<span class="name">print-probe</span> (<span class="name">get-value</span> connector)))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">process-forget-value</span>)</span><br><span class="line">    (<span class="name">print-probe</span> <span class="string">"?"</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">me</span> request)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> request <span class="symbol">'I-have-a-value</span>)</span><br><span class="line">           (<span class="name">process-new-value</span>))</span><br><span class="line">          ((<span class="name"><span class="builtin-name">eq?</span></span> request <span class="symbol">'I-lost-my-value</span>)</span><br><span class="line">           (<span class="name">process-forget-value</span>))</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span></span><br><span class="line">           (<span class="name">error</span> <span class="string">"Unknown request -- PROBE"</span> request))))</span><br><span class="line">  (<span class="name">connect</span> connector me)</span><br><span class="line">  me)</span><br></pre></td></tr></table></figure>
<h3 id="连接器的表示-Representing-connectors"><a href="#连接器的表示-Representing-connectors" class="headerlink" title="连接器的表示(Representing connectors)"></a>连接器的表示(Representing connectors)</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-connector</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">value</span> false) (<span class="name">informant</span> false) (<span class="name">constraints</span> '()))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">set-my-value</span> newval setter)</span><br><span class="line">      (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">not</span></span> (<span class="name">has-value?</span> me))</span><br><span class="line">             (<span class="name"><span class="builtin-name">set!</span></span> value newval)</span><br><span class="line">             (<span class="name"><span class="builtin-name">set!</span></span> informant setter)</span><br><span class="line">             (<span class="name">for-each-except</span> setter</span><br><span class="line">                              inform-about-value</span><br><span class="line">                              constraints))</span><br><span class="line">            ((<span class="name"><span class="builtin-name">not</span></span> (<span class="name"><span class="builtin-name">=</span></span> value newval))</span><br><span class="line">             (<span class="name">error</span> <span class="string">"Contradiction"</span> (<span class="name"><span class="builtin-name">list</span></span> value newval)))</span><br><span class="line">            (<span class="name"><span class="builtin-name">else</span></span> <span class="symbol">'ignored</span>)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">forget-my-value</span> retractor)</span><br><span class="line">      (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">eq?</span></span> retractor informant)</span><br><span class="line">          (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> informant false)</span><br><span class="line">                 (<span class="name">for-each-except</span> retractor</span><br><span class="line">                                  inform-about-no-value</span><br><span class="line">                                  constraints))</span><br><span class="line">          <span class="symbol">'ignored</span>))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">connect</span> new-constraint)</span><br><span class="line">      (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">not</span></span> (<span class="name"><span class="builtin-name">memq</span></span> new-constraint constraints))</span><br><span class="line">          (<span class="name"><span class="builtin-name">set!</span></span> constraints</span><br><span class="line">                (<span class="name"><span class="builtin-name">cons</span></span> new-constraint constraints)))</span><br><span class="line">      (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">has-value?</span> me)</span><br><span class="line">          (<span class="name">inform-about-value</span> new-constraint))</span><br><span class="line">      <span class="symbol">'done</span>)</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">me</span> request)</span><br><span class="line">      (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> request <span class="symbol">'has-value?</span>)</span><br><span class="line">             (<span class="name"><span class="builtin-name">if</span></span> informant true false))</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> request <span class="symbol">'value</span>) value)</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> request <span class="symbol">'set-value!</span>) set-my-value)</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> request <span class="symbol">'forget</span>) forget-my-value)</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> request <span class="symbol">'connect</span>) connect)</span><br><span class="line">            (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown operation -- CONNECTOR"</span></span><br><span class="line">                         request))))</span><br><span class="line">    me))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">for-each-except</span> exception procedure list)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">loop</span> items)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">null?</span></span> items) <span class="symbol">'done</span>)</span><br><span class="line">          ((<span class="name"><span class="builtin-name">eq?</span></span> (<span class="name"><span class="builtin-name">car</span></span> items) exception) (<span class="name">loop</span> (<span class="name"><span class="builtin-name">cdr</span></span> items)))</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">procedure</span> (<span class="name"><span class="builtin-name">car</span></span> items))</span><br><span class="line">                (<span class="name">loop</span> (<span class="name"><span class="builtin-name">cdr</span></span> items)))))</span><br><span class="line">  (<span class="name">loop</span> list))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">has-value?</span> connector)</span><br><span class="line">  (<span class="name">connector</span> <span class="symbol">'has-value?</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">get-value</span> connector)</span><br><span class="line">  (<span class="name">connector</span> <span class="symbol">'value</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">set-value!</span> connector new-value informant)</span><br><span class="line">  ((<span class="name">connector</span> <span class="symbol">'set-value!</span>) new-value informant))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">forget-value!</span> connector retractor)</span><br><span class="line">  ((<span class="name">connector</span> <span class="symbol">'forget</span>) retractor))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">connect</span> connector new-constraint)</span><br><span class="line">  ((<span class="name">connector</span> <span class="symbol">'connect</span>) new-constraint))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-33"><a href="#Exercise-3-33" class="headerlink" title="Exercise 3.33"></a>Exercise 3.33</h3><p>Using primitive multiplier, adder, and constant constraints, define a procedure averager that takes three connectors a, b, and c as inputs and establishes the constraint that the value of c is the average of the values of a and b.</p>
<h3 id="Exercise-3-34"><a href="#Exercise-3-34" class="headerlink" title="Exercise 3.34"></a>Exercise 3.34</h3><p>Louis Reasoner wants to build a squarer, a constraint device with two terminals such that the value of connector b on the second terminal will always be the square of the value a on the first terminal. He proposes the following simple device made from a multiplier:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">squarer</span> a b)</span><br><span class="line">  (<span class="name">multiplier</span> a a b))</span><br></pre></td></tr></table></figure></p>
<p>There is a serious flaw in this idea. Explain.</p>
<h3 id="Exercise-3-35"><a href="#Exercise-3-35" class="headerlink" title="Exercise 3.35"></a>Exercise 3.35</h3><p>Ben Bitdiddle tells Louis that one way to avoid the trouble in exercise 3.34 is to define a squarer as a new primitive constraint. Fill in the missing portions in Ben’s outline for a procedure to implement such a constraint:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">squarer</span> a b)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">process-new-value</span>)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">has-value?</span> b)</span><br><span class="line">        (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&lt;</span></span> (<span class="name">get-value</span> b) <span class="number">0</span>)</span><br><span class="line">            (<span class="name">error</span> <span class="string">"square less than 0 -- SQUARER"</span> (<span class="name">get-value</span> b))</span><br><span class="line">            &lt;alternative1&gt;)</span><br><span class="line">        &lt;alternative2&gt;))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">process-forget-value</span>) &lt;body1&gt;)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">me</span> request) &lt;body2&gt;)</span><br><span class="line">  &lt;rest of definition&gt;</span><br><span class="line">  me)</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-3-36"><a href="#Exercise-3-36" class="headerlink" title="Exercise 3.36"></a>Exercise 3.36</h3><p>Suppose we evaluate the following sequence of expressions in the global environment:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> a (<span class="name">make-connector</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> b (<span class="name">make-connector</span>))</span><br><span class="line">(<span class="name">set-value!</span> a <span class="number">10</span> <span class="symbol">'user</span>)</span><br></pre></td></tr></table></figure></p>
<p>At some time during evaluation of the set-value!, the following expression from the connector’s local procedure is evaluated:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(for-each-except setter inform-about-value constraints)</span><br></pre></td></tr></table></figure></p>
<p>Draw an environment diagram showing the environment in which the above expression is evaluated.</p>
<h3 id="Exercise-3-37"><a href="#Exercise-3-37" class="headerlink" title="Exercise 3.37"></a>Exercise 3.37</h3><p>The celsius-fahrenheit-converter procedure is cumbersome when compared with a more expression-oriented style of definition, such as<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">celsius-fahrenheit-converter</span> x)</span><br><span class="line">  (<span class="name">c+</span> (<span class="name">c*</span> (<span class="name">c/</span> (<span class="name">cv</span> <span class="number">9</span>) (<span class="name">cv</span> <span class="number">5</span>))</span><br><span class="line">          x)</span><br><span class="line">      (<span class="name">cv</span> <span class="number">32</span>)))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> C (<span class="name">make-connector</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> F (<span class="name">celsius-fahrenheit-converter</span> C))</span><br></pre></td></tr></table></figure></p>
<p>Here c+, c*, etc. are the “constraint” versions of the arithmetic operations. For example, c+ takes two connectors as arguments and returns a connector that is related to these by an adder constraint:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">c+</span> x y)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">z</span> (<span class="name">make-connector</span>)))</span><br><span class="line">    (<span class="name">adder</span> x y z)</span><br><span class="line">    z))</span><br></pre></td></tr></table></figure></p>
<p>Define analogous procedures c-, c*, c/, and cv (constant value) that enable us to define compound constraints as in the converter example above.
</p>
<h2 id="并发：时间是一个本质问题"><a href="#并发：时间是一个本质问题" class="headerlink" title="并发：时间是一个本质问题"></a>并发：时间是一个本质问题</h2><p>(3.4 Concurrency: Time Is of the Essence)<br>;;;**Need parallel-execute, available for MIT Scheme</p>
<h2 id="并发系统中时间的性质"><a href="#并发系统中时间的性质" class="headerlink" title="并发系统中时间的性质"></a>并发系统中时间的性质</h2><p>(3.4.1 The Nature of Time in Concurrent Systems)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">withdraw</span> amount)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">      (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">             balance)</span><br><span class="line">      <span class="string">"Insufficient funds"</span>))</span><br></pre></td></tr></table></figure>
<h3 id="Correct-behavior-of-concurrent-programs"><a href="#Correct-behavior-of-concurrent-programs" class="headerlink" title="Correct behavior of concurrent programs"></a>Correct behavior of concurrent programs</h3><h3 id="Exercise-3-38"><a href="#Exercise-3-38" class="headerlink" title="Exercise 3.38"></a>Exercise 3.38</h3><p>Suppose that Peter, Paul, and Mary share a joint bank account that initially contains $100. Concurrently, Peter deposits $10, Paul withdraws $20, and Mary withdraws half the money in the account, by executing the following commands:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Peter:    (set! balance (+ balance 10))</span><br><span class="line">Paul:    (set! balance (- balance 20))</span><br><span class="line">Mary:    (set! balance (- balance (/ balance 2)))</span><br></pre></td></tr></table></figure></p>
<p>a. List all the different possible values for balance after these three transactions have been completed, assuming that the banking system forces the three processes to run sequentially in some order.<br>b. What are some other values that could be produced if the system allows the processes to be interleaved? Draw timing diagrams like the one in figure 3.29 to explain how these values can occur.</p>
<h2 id="控制并发的机制"><a href="#控制并发的机制" class="headerlink" title="控制并发的机制"></a>控制并发的机制</h2><p>(3.4.2 Mechanisms for Controlling Concurrency)</p>
<h3 id="Serializing-access-to-shared-state"><a href="#Serializing-access-to-shared-state" class="headerlink" title="Serializing access to shared state"></a>Serializing access to shared state</h3><h3 id="Serializers-in-Scheme"><a href="#Serializers-in-Scheme" class="headerlink" title="Serializers in Scheme"></a>Serializers in Scheme</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;: (define x 10)</span></span><br><span class="line"><span class="comment">;: (parallel-execute (lambda () (set! x (* x x)))</span></span><br><span class="line"><span class="comment">;:                   (lambda () (set! x (+ x 1))))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;: (define x 10)</span></span><br><span class="line"><span class="comment">;: (define s (make-serializer))</span></span><br><span class="line"><span class="comment">;: (parallel-execute (s (lambda () (set! x (* x x))))</span></span><br><span class="line"><span class="comment">;:                   (s (lambda () (set! x (+ x 1)))))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-account</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">withdraw</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">        (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">               balance)</span><br><span class="line">        <span class="string">"Insufficient funds"</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deposit</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">+</span></span> balance amount))</span><br><span class="line">    balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">protected</span> (<span class="name">make-serializer</span>)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m)</span><br><span class="line">      (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'withdraw</span>) (<span class="name">protected</span> withdraw))</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'deposit</span>) (<span class="name">protected</span> deposit))</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'balance</span>) balance)</span><br><span class="line">            (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown request -- MAKE-ACCOUNT"</span></span><br><span class="line">                         m))))</span><br><span class="line">    dispatch))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-39"><a href="#Exercise-3-39" class="headerlink" title="Exercise 3.39"></a>Exercise 3.39</h3><p>Which of the five possibilities in the parallel execution shown above remain if we instead serialize execution as follows:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> x <span class="number">10</span>)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> s (<span class="name">make-serializer</span>))</span><br><span class="line">(<span class="name">parallel-execute</span> (<span class="name"><span class="builtin-name">lambda</span></span> () (<span class="name"><span class="builtin-name">set!</span></span> x ((<span class="name">s</span> (<span class="name"><span class="builtin-name">lambda</span></span> () (<span class="name"><span class="builtin-name">*</span></span> x x))))))</span><br><span class="line">                  (<span class="name">s</span> (<span class="name"><span class="builtin-name">lambda</span></span> () (<span class="name"><span class="builtin-name">set!</span></span> x (<span class="name"><span class="builtin-name">+</span></span> x <span class="number">1</span>)))))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-3-40"><a href="#Exercise-3-40" class="headerlink" title="Exercise 3.40"></a>Exercise 3.40</h3><p>Give all possible values of x that can result from executing<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> x <span class="number">10</span>)</span><br><span class="line">(<span class="name">parallel-execute</span> (<span class="name"><span class="builtin-name">lambda</span></span> () (<span class="name"><span class="builtin-name">set!</span></span> x (<span class="name"><span class="builtin-name">*</span></span> x x)))</span><br><span class="line">                  (<span class="name"><span class="builtin-name">lambda</span></span> () (<span class="name"><span class="builtin-name">set!</span></span> x (<span class="name"><span class="builtin-name">*</span></span> x x x))))</span><br></pre></td></tr></table></figure></p>
<p>Which of these possibilities remain if we instead use serialized procedures:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> x <span class="number">10</span>)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> s (<span class="name">make-serializer</span>))</span><br><span class="line">(<span class="name">parallel-execute</span> (<span class="name">s</span> (<span class="name"><span class="builtin-name">lambda</span></span> () (<span class="name"><span class="builtin-name">set!</span></span> x (<span class="name"><span class="builtin-name">*</span></span> x x))))</span><br><span class="line">                  (<span class="name">s</span> (<span class="name"><span class="builtin-name">lambda</span></span> () (<span class="name"><span class="builtin-name">set!</span></span> x (<span class="name"><span class="builtin-name">*</span></span> x x x)))))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-3-41"><a href="#Exercise-3-41" class="headerlink" title="Exercise 3.41"></a>Exercise 3.41</h3><p>Ben Bitdiddle worries that it would be better to implement the bank account as follows (where the commented line has been changed):<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-account</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">withdraw</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">        (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">               balance)</span><br><span class="line">        <span class="string">"Insufficient funds"</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deposit</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">+</span></span> balance amount))</span><br><span class="line">    balance)</span><br><span class="line">  <span class="comment">;; continued on next page</span></span><br><span class="line"></span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">protected</span> (<span class="name">make-serializer</span>)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m)</span><br><span class="line">      (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'withdraw</span>) (<span class="name">protected</span> withdraw))</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'deposit</span>) (<span class="name">protected</span> deposit))</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'balance</span>)</span><br><span class="line">             ((<span class="name">protected</span> (<span class="name"><span class="builtin-name">lambda</span></span> () balance)))) <span class="comment">; serialized</span></span><br><span class="line">            (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown request -- MAKE-ACCOUNT"</span></span><br><span class="line">                         m))))</span><br><span class="line">    dispatch))</span><br></pre></td></tr></table></figure></p>
<p>because allowing unserialized access to the bank balance can result in anomalous behavior. Do you agree? Is there any scenario that demonstrates Ben’s concern?</p>
<h3 id="Exercise-3-42"><a href="#Exercise-3-42" class="headerlink" title="Exercise 3.42"></a>Exercise 3.42</h3><p>Ben Bitdiddle suggests that it’s a waste of time to create a new serialized procedure in response to every withdraw and deposit message. He says that make-account could be changed so that the calls to protected are done outside the dispatch procedure. That is, an account would return the same serialized procedure (which was created at the same time as the account) each time it is asked for a withdrawal procedure.<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-account</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">withdraw</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">        (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">               balance)</span><br><span class="line">        <span class="string">"Insufficient funds"</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deposit</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">+</span></span> balance amount))</span><br><span class="line">    balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">protected</span> (<span class="name">make-serializer</span>)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">protected-withdraw</span> (<span class="name">protected</span> withdraw))</span><br><span class="line">          (<span class="name">protected-deposit</span> (<span class="name">protected</span> deposit)))</span><br><span class="line">      (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m)</span><br><span class="line">        (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'withdraw</span>) protected-withdraw)</span><br><span class="line">              ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'deposit</span>) protected-deposit)</span><br><span class="line">              ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'balance</span>) balance)</span><br><span class="line">              (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown request -- MAKE-ACCOUNT"</span></span><br><span class="line">                           m))))</span><br><span class="line">      dispatch)))</span><br></pre></td></tr></table></figure></p>
<p>Is this a safe change to make? In particular, is there any difference in what concurrency is allowed by these two versions of make-account ?</p>
<h3 id="Complexity-of-using-multiple-shared-resources"><a href="#Complexity-of-using-multiple-shared-resources" class="headerlink" title="Complexity of using multiple shared resources"></a>Complexity of using multiple shared resources</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">exchange</span> account1 account2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">difference</span> (<span class="name"><span class="builtin-name">-</span></span> (<span class="name">account1</span> <span class="symbol">'balance</span>)</span><br><span class="line">                       (<span class="name">account2</span> <span class="symbol">'balance</span>))))</span><br><span class="line">    ((<span class="name">account1</span> <span class="symbol">'withdraw</span>) difference)</span><br><span class="line">    ((<span class="name">account2</span> <span class="symbol">'deposit</span>) difference)))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-account-and-serializer</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">withdraw</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">        (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">               balance)</span><br><span class="line">        <span class="string">"Insufficient funds"</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deposit</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">+</span></span> balance amount))</span><br><span class="line">    balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">balance-serializer</span> (<span class="name">make-serializer</span>)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m)</span><br><span class="line">      (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'withdraw</span>) withdraw)</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'deposit</span>) deposit)</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'balance</span>) balance)</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'serializer</span>) balance-serializer)</span><br><span class="line">            (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown request -- MAKE-ACCOUNT"</span></span><br><span class="line">                         m))))</span><br><span class="line">    dispatch))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deposit</span> account amount)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">s</span> (<span class="name">account</span> <span class="symbol">'serializer</span>))</span><br><span class="line">        (<span class="name">d</span> (<span class="name">account</span> <span class="symbol">'deposit</span>)))</span><br><span class="line">    ((<span class="name">s</span> d) amount)))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">serialized-exchange</span> account1 account2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">serializer1</span> (<span class="name">account1</span> <span class="symbol">'serializer</span>))</span><br><span class="line">        (<span class="name">serializer2</span> (<span class="name">account2</span> <span class="symbol">'serializer</span>)))</span><br><span class="line">    ((<span class="name">serializer1</span> (<span class="name">serializer2</span> exchange))</span><br><span class="line">     account1</span><br><span class="line">     account2)))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-43"><a href="#Exercise-3-43" class="headerlink" title="Exercise 3.43"></a>Exercise 3.43</h3><p>Suppose that the balances in three accounts start out as $10, $20, and $30, and that multiple processes run, exchanging the balances in the accounts. Argue that if the processes are run sequentially, after any number of concurrent exchanges, the account balances should be $10, $20, and $30 in some order. Draw a timing diagram like the one in figure 3.29 to show how this condition can be violated if the exchanges are implemented using the first version of the account-exchange program in this section. On the other hand, argue that even with this exchange program, the sum of the balances in the accounts will be preserved. Draw a timing diagram to show how even this condition would be violated if we did not serialize the transactions on individual accounts.</p>
<h3 id="Exercise-3-44"><a href="#Exercise-3-44" class="headerlink" title="Exercise 3.44"></a>Exercise 3.44</h3><p>Consider the problem of transferring an amount from one account to another. Ben Bitdiddle claims that this can be accomplished with the following procedure, even if there are multiple people concurrently transferring money among multiple accounts, using any account mechanism that serializes deposit and withdrawal transactions, for example, the version of make-account in the text above.<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">transfer</span> from-account to-account amount)</span><br><span class="line">  ((<span class="name">from-account</span> <span class="symbol">'withdraw</span>) amount)</span><br><span class="line">  ((<span class="name">to-account</span> <span class="symbol">'deposit</span>) amount))</span><br></pre></td></tr></table></figure></p>
<p>Louis Reasoner claims that there is a problem here, and that we need to use a more sophisticated method, such as the one required for dealing with the exchange problem. Is Louis right? If not, what is the essential difference between the transfer problem and the exchange problem? (You should assume that the balance in from-account is at least amount.)</p>
<h3 id="Exercise-3-45"><a href="#Exercise-3-45" class="headerlink" title="Exercise 3.45"></a>Exercise 3.45</h3><p>Louis Reasoner thinks our bank-account system is unnecessarily complex and error-prone now that deposits and withdrawals aren’t automatically serialized. He suggests that make-account-and-serializer should have exported the serializer (for use by such procedures as serialized-exchange) in addition to (rather than instead of) using it to serialize accounts and deposits as make-account did. He proposes to redefine accounts as follows:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-account-and-serializer</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">withdraw</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">        (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">               balance)</span><br><span class="line">        <span class="string">"Insufficient funds"</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deposit</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">+</span></span> balance amount))</span><br><span class="line">    balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">balance-serializer</span> (<span class="name">make-serializer</span>)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m)</span><br><span class="line">      (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'withdraw</span>) (<span class="name">balance-serializer</span> withdraw))</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'deposit</span>) (<span class="name">balance-serializer</span> deposit))</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'balance</span>) balance)</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'serializer</span>) balance-serializer)</span><br><span class="line">            (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown request -- MAKE-ACCOUNT"</span></span><br><span class="line">                         m))))</span><br><span class="line">    dispatch))</span><br></pre></td></tr></table></figure></p>
<p>Then deposits are handled as with the original make-account:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deposit</span> account amount)</span><br><span class="line"> ((<span class="name">account</span> <span class="symbol">'deposit</span>) amount))</span><br></pre></td></tr></table></figure></p>
<p>Explain what is wrong with Louis’s reasoning. In particular, consider what happens when serialized-exchange is called.</p>
<h3 id="Implementing-serializers"><a href="#Implementing-serializers" class="headerlink" title="Implementing serializers"></a>Implementing serializers</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-serializer</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">mutex</span> (<span class="name">make-mutex</span>)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">lambda</span></span> (p)</span><br><span class="line">      (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">serialized-p</span> . args)</span><br><span class="line">        (<span class="name">mutex</span> <span class="symbol">'acquire</span>)</span><br><span class="line">        (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">val</span> (<span class="name"><span class="builtin-name">apply</span></span> p args)))</span><br><span class="line">          (<span class="name">mutex</span> <span class="symbol">'release</span>)</span><br><span class="line">          val))</span><br><span class="line">      serialized-p)))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-mutex</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">cell</span> (<span class="name"><span class="builtin-name">list</span></span> false)))          </span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">the-mutex</span> m)</span><br><span class="line">      (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'acquire</span>)</span><br><span class="line">             (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">test-and-set!</span> cell)</span><br><span class="line">                 (<span class="name">the-mutex</span> <span class="symbol">'acquire</span>)))</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'release</span>) (<span class="name">clear!</span> cell))))</span><br><span class="line">    the-mutex))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">clear!</span> cell)</span><br><span class="line">  (<span class="name"><span class="builtin-name">set-car!</span></span> cell false))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">test-and-set!</span> cell)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">car</span></span> cell)</span><br><span class="line">      true</span><br><span class="line">      (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set-car!</span></span> cell true)</span><br><span class="line">             false)))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-46"><a href="#Exercise-3-46" class="headerlink" title="Exercise 3.46"></a>Exercise 3.46</h3><p>Suppose that we implement test-and-set! using an ordinary procedure as shown in the text, without attempting to make the operation atomic. Draw a timing diagram like the one in figure 3.29 to demonstrate how the mutex implementation can fail by allowing two processes to acquire the mutex at the same time.</p>
<h3 id="Exercise-3-47"><a href="#Exercise-3-47" class="headerlink" title="Exercise 3.47"></a>Exercise 3.47</h3><p>A semaphore (of size n) is a generalization of a mutex. Like a mutex, a semaphore supports acquire and release operations, but it is more general in that up to n processes can acquire it concurrently. Additional processes that attempt to acquire the semaphore must wait for release operations. Give implementations of semaphores<br>a. in terms of mutexes<br>b. in terms of atomic test-and-set! operations.</p>
<h3 id="Deadlock"><a href="#Deadlock" class="headerlink" title="Deadlock"></a>Deadlock</h3><h3 id="Exercise-3-48"><a href="#Exercise-3-48" class="headerlink" title="Exercise 3.48"></a>Exercise 3.48</h3><p>Explain in detail why the deadlock-avoidance method described above, (i.e., the accounts are numbered, and each process attempts to acquire the smaller-numbered account first) avoids deadlock in the exchange problem. Rewrite serialized-exchange to incorporate this idea. (You will also need to modify make-account so that each account is created with a number, which can be accessed by sending an appropriate message.)</p>
<h3 id="Exercise-3-49"><a href="#Exercise-3-49" class="headerlink" title="Exercise 3.49"></a>Exercise 3.49</h3><p>Give a scenario where the deadlock-avoidance mechanism described above does not work. (Hint: In the exchange problem, each process knows in advance which accounts it will need to get access to. Consider a situation where a process must get access to some shared resources before it can know which additional shared resources it will require.)</p>
<h3 id="Concurrency-time-and-communication"><a href="#Concurrency-time-and-communication" class="headerlink" title="Concurrency, time, and communication"></a>Concurrency, time, and communication</h3><h2 id="流"><a href="#流" class="headerlink" title="流"></a>流</h2><p>(3.5 Streams)</p>
<h2 id="流作为延时的表"><a href="#流作为延时的表" class="headerlink" title="流作为延时的表"></a>流作为延时的表</h2><p>(3.5.1 Streams Are Delayed Lists)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sum-primes</span> a b)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">iter</span> count accum)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">&gt;</span></span> count b) accum)</span><br><span class="line">          ((<span class="name">prime?</span> count) (<span class="name">iter</span> (<span class="name"><span class="builtin-name">+</span></span> count <span class="number">1</span>) (<span class="name"><span class="builtin-name">+</span></span> count accum)))</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">iter</span> (<span class="name"><span class="builtin-name">+</span></span> count <span class="number">1</span>) accum))))</span><br><span class="line">  (<span class="name">iter</span> a <span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sum-primes</span> a b)</span><br><span class="line">  (<span class="name">accumulate</span> +</span><br><span class="line">              <span class="number">0</span></span><br><span class="line">              (<span class="name">filter</span> prime? (<span class="name">enumerate-interval</span> a b))))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">car</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> (<span class="name">filter</span> prime?</span><br><span class="line">                  (<span class="name">enumerate-interval</span> <span class="number">10000</span> <span class="number">1000000</span>))))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">stream-ref</span> s n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> n <span class="number">0</span>)</span><br><span class="line">      (<span class="name">stream-car</span> s)</span><br><span class="line">      (<span class="name">stream-ref</span> (<span class="name">stream-cdr</span> s) (<span class="name"><span class="builtin-name">-</span></span> n <span class="number">1</span>))))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">stream-map</span> proc s)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">stream-null?</span> s)</span><br><span class="line">      the-empty-stream</span><br><span class="line">      (<span class="name">cons-stream</span> (<span class="name">proc</span> (<span class="name">stream-car</span> s))</span><br><span class="line">                   (<span class="name">stream-map</span> proc (<span class="name">stream-cdr</span> s)))))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">stream-for-each</span> proc s)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">stream-null?</span> s)</span><br><span class="line">      <span class="symbol">'done</span></span><br><span class="line">      (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name">proc</span> (<span class="name">stream-car</span> s))</span><br><span class="line">             (<span class="name">stream-for-each</span> proc (<span class="name">stream-cdr</span> s)))))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">display-stream</span> s)</span><br><span class="line">  (<span class="name">stream-for-each</span> display-line s))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">display-line</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">newline</span></span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">display</span></span> x))</span><br></pre></td></tr></table></figure>
<p>;; stream-car and stream-cdr would normally be built into<br>;;  the stream implementation<br>;: (define (stream-car stream) (car stream))<br>;: (define (stream-cdr stream) (force (cdr stream)))</p>
<h3 id="The-stream-implementation-in-action"><a href="#The-stream-implementation-in-action" class="headerlink" title="The stream implementation in action"></a>The stream implementation in action</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">stream-car</span></span><br><span class="line">(<span class="name">stream-cdr</span></span><br><span class="line">    (<span class="name">stream-filter</span> prime?</span><br><span class="line">                   (<span class="name">stream-enumerate-interval</span> <span class="number">10000</span> <span class="number">1000000</span>))))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">stream-enumerate-interval</span> low high)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;</span></span> low high)</span><br><span class="line">      the-empty-stream</span><br><span class="line">      (<span class="name">cons-stream</span></span><br><span class="line">       low</span><br><span class="line">       (<span class="name">stream-enumerate-interval</span> (<span class="name"><span class="builtin-name">+</span></span> low <span class="number">1</span>) high))))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">stream-filter</span> pred stream)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name">stream-null?</span> stream) the-empty-stream)</span><br><span class="line">        ((<span class="name">pred</span> (<span class="name">stream-car</span> stream))</span><br><span class="line">         (<span class="name">cons-stream</span> (<span class="name">stream-car</span> stream)</span><br><span class="line">                      (<span class="name">stream-filter</span> pred</span><br><span class="line">                                     (<span class="name">stream-cdr</span> stream))))</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">stream-filter</span> pred (<span class="name">stream-cdr</span> stream)))))</span><br></pre></td></tr></table></figure>
<h3 id="Implementing-delay-and-force"><a href="#Implementing-delay-and-force" class="headerlink" title="Implementing delay and force"></a>Implementing delay and force</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;; force would normally be built into</span></span><br><span class="line"><span class="comment">;;  the stream implementation</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">force</span></span> delayed-object)  (<span class="name">delayed-object</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">memo-proc</span> proc)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">already-run?</span> false) (<span class="name">result</span> false))</span><br><span class="line">    (<span class="name"><span class="builtin-name">lambda</span></span> ()</span><br><span class="line">      (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">not</span></span> already-run?)</span><br><span class="line">          (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> result (<span class="name">proc</span>))</span><br><span class="line">                 (<span class="name"><span class="builtin-name">set!</span></span> already-run? true)</span><br><span class="line">                 result)</span><br><span class="line">          result))))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-50"><a href="#Exercise-3-50" class="headerlink" title="Exercise 3.50"></a>Exercise 3.50</h3><p>Complete the following definition, which generalizes stream-map to allow procedures that take multiple arguments, analogous to map in section 2.2.3, footnote 12.<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">stream-map</span> proc . argstreams)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">&lt;??&gt;</span> (<span class="name"><span class="builtin-name">car</span></span> argstreams))</span><br><span class="line">      the-empty-stream</span><br><span class="line">      (<span class="name">&lt;??&gt;</span></span><br><span class="line">       (<span class="name"><span class="builtin-name">apply</span></span> proc (<span class="name"><span class="builtin-name">map</span></span> &lt;??&gt; argstreams))</span><br><span class="line">       (<span class="name"><span class="builtin-name">apply</span></span> stream-map</span><br><span class="line">              (<span class="name"><span class="builtin-name">cons</span></span> proc (<span class="name"><span class="builtin-name">map</span></span> &lt;??&gt; argstreams))))))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-3-51"><a href="#Exercise-3-51" class="headerlink" title="Exercise 3.51"></a>Exercise 3.51</h3><p>In order to take a closer look at delayed evaluation, we will use the following procedure, which simply returns its argument after printing it:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">show</span> x)</span><br><span class="line">  (<span class="name">display-line</span> x)</span><br><span class="line">  x)</span><br></pre></td></tr></table></figure></p>
<p>What does the interpreter print in response to evaluating each expression in the following sequence?<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> x (<span class="name">stream-map</span> show (<span class="name">stream-enumerate-interval</span> <span class="number">0</span> <span class="number">10</span>)))</span><br><span class="line">(<span class="name">stream-ref</span> x <span class="number">5</span>)</span><br><span class="line">(<span class="name">stream-ref</span> x <span class="number">7</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-3-52"><a href="#Exercise-3-52" class="headerlink" title="Exercise 3.52"></a>Exercise 3.52</h3><p>Consider the sequence of expressions<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> sum <span class="number">0</span>)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">accum</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">set!</span></span> sum (<span class="name"><span class="builtin-name">+</span></span> x sum))</span><br><span class="line">  sum)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> seq (<span class="name">stream-map</span> accum (<span class="name">stream-enumerate-interval</span> <span class="number">1</span> <span class="number">20</span>)))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> y (<span class="name">stream-filter</span> even? seq))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> z (<span class="name">stream-filter</span> (<span class="name"><span class="builtin-name">lambda</span></span> (x) (<span class="name"><span class="builtin-name">=</span></span> (<span class="name"><span class="builtin-name">remainder</span></span> x <span class="number">5</span>) <span class="number">0</span>))</span><br><span class="line">                         seq))</span><br><span class="line">(<span class="name">stream-ref</span> y <span class="number">7</span>)</span><br><span class="line">(<span class="name">display-stream</span> z)</span><br></pre></td></tr></table></figure></p>
<p>What is the value of sum after each of the above expressions is evaluated? What is the printed response to evaluating the stream-ref and display-stream expressions? Would these responses differ if we had implemented (delay <exp>) simply as (lambda () <exp>) without using the optimization provided by memo-proc ? Explain.</exp></exp></p>
<h2 id="无穷流"><a href="#无穷流" class="headerlink" title="无穷流"></a>无穷流</h2><p>(3.5.2 Infinite Streams)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">integers-starting-from</span> n)</span><br><span class="line">  (<span class="name">cons-stream</span> n (<span class="name">integers-starting-from</span> (<span class="name"><span class="builtin-name">+</span></span> n <span class="number">1</span>))))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> integers (<span class="name">integers-starting-from</span> <span class="number">1</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">divisible?</span> x y) (<span class="name"><span class="builtin-name">=</span></span> (<span class="name"><span class="builtin-name">remainder</span></span> x y) <span class="number">0</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> no-sevens</span><br><span class="line">  (<span class="name">stream-filter</span> (<span class="name"><span class="builtin-name">lambda</span></span> (x) (<span class="name"><span class="builtin-name">not</span></span> (<span class="name">divisible?</span> x <span class="number">7</span>)))</span><br><span class="line">                 integers))</span><br><span class="line"></span><br><span class="line"><span class="comment">;: (stream-ref no-sevens 100)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">fibgen</span> a b) (<span class="name">cons-stream</span> a (<span class="name">fibgen</span> b (<span class="name"><span class="builtin-name">+</span></span> a b))))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> fibs (<span class="name">fibgen</span> <span class="number">0</span> <span class="number">1</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sieve</span> stream)</span><br><span class="line">  (<span class="name">cons-stream</span></span><br><span class="line">   (<span class="name">stream-car</span> stream)</span><br><span class="line">   (<span class="name">sieve</span> (<span class="name">stream-filter</span></span><br><span class="line">           (<span class="name"><span class="builtin-name">lambda</span></span> (x)</span><br><span class="line">             (<span class="name"><span class="builtin-name">not</span></span> (<span class="name">divisible?</span> x (<span class="name">stream-car</span> stream))))</span><br><span class="line">           (<span class="name">stream-cdr</span> stream)))))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> primes (<span class="name">sieve</span> (<span class="name">integers-starting-from</span> <span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment">;: (stream-ref primes 50)</span></span><br></pre></td></tr></table></figure>
<h3 id="Defining-streams-implicitly"><a href="#Defining-streams-implicitly" class="headerlink" title="Defining streams implicitly"></a>Defining streams implicitly</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> ones (<span class="name">cons-stream</span> <span class="number">1</span> ones))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">add-streams</span> s1 s2)</span><br><span class="line">  (<span class="name">stream-map</span> + s1 s2))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> integers (<span class="name">cons-stream</span> <span class="number">1</span> (<span class="name">add-streams</span> ones integers)))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> fibs</span><br><span class="line">  (<span class="name">cons-stream</span></span><br><span class="line">   <span class="number">0</span></span><br><span class="line">   (<span class="name">cons-stream</span> <span class="number">1</span> (<span class="name">add-streams</span> (<span class="name">stream-cdr</span> fibs) fibs))))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">scale-stream</span> stream factor)</span><br><span class="line">  (<span class="name">stream-map</span> (<span class="name"><span class="builtin-name">lambda</span></span> (x) (<span class="name"><span class="builtin-name">*</span></span> x factor)) stream))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> double (<span class="name">cons-stream</span> <span class="number">1</span> (<span class="name">scale-stream</span> double <span class="number">2</span>)))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> primes</span><br><span class="line">  (<span class="name">cons-stream</span></span><br><span class="line">   <span class="number">2</span></span><br><span class="line">   (<span class="name">stream-filter</span> prime? (<span class="name">integers-starting-from</span> <span class="number">3</span>))))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">prime?</span> n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">iter</span> ps)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">&gt;</span></span> (<span class="name">square</span> (<span class="name">stream-car</span> ps)) n) true)</span><br><span class="line">          ((<span class="name">divisible?</span> n (<span class="name">stream-car</span> ps)) false)</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">iter</span> (<span class="name">stream-cdr</span> ps)))))</span><br><span class="line">  (<span class="name">iter</span> primes))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-53"><a href="#Exercise-3-53" class="headerlink" title="Exercise 3.53"></a>Exercise 3.53</h3><p>Without running the program, describe the elements of the stream defined by</p>
<p>(define s (cons-stream 1 (add-streams s s)))</p>
<h3 id="Exercise-3-54"><a href="#Exercise-3-54" class="headerlink" title="Exercise 3.54"></a>Exercise 3.54</h3><p>Define a procedure mul-streams, analogous to add-streams, that produces the elementwise product of its two input streams. Use this together with the stream of integers to complete the following definition of the stream whose nth element (counting from 0) is n + 1 factorial:</p>
<p>(define factorials (cons-stream 1 (mul-streams &lt;??&gt; &lt;??&gt;)))</p>
<h3 id="Exercise-3-55"><a href="#Exercise-3-55" class="headerlink" title="Exercise 3.55"></a>Exercise 3.55</h3><p>Define a procedure partial-sums that takes as argument a stream S and returns the stream whose elements are S0, S0 + S1, S0 + S1 + S2, …. For example, (partial-sums integers) should be the stream 1, 3, 6, 10, 15, ….</p>
<h3 id="Exercise-3-56"><a href="#Exercise-3-56" class="headerlink" title="Exercise 3.56"></a>Exercise 3.56</h3><p>A famous problem, first raised by R. Hamming, is to enumerate, in ascending order with no repetitions, all positive integers with no prime factors other than 2, 3, or 5. One obvious way to do this is to simply test each integer in turn to see whether it has any factors other than 2, 3, and 5. But this is very inefficient, since, as the integers get larger, fewer and fewer of them fit the requirement. As an alternative, let us call the required stream of numbers S and notice the following facts about it.</p>
<p>S begins with 1.<br>The elements of (scale-stream S 2) are also elements of S.<br>The same is true for (scale-stream S 3) and (scale-stream 5 S).<br>These are all the elements of S.<br>Now all we have to do is combine elements from these sources. For this we define a procedure merge that combines two ordered streams into one ordered result stream, eliminating repetitions:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">merge</span> s1 s2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name">stream-null?</span> s1) s2)</span><br><span class="line">        ((<span class="name">stream-null?</span> s2) s1)</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span></span><br><span class="line">         (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">s1car</span> (<span class="name">stream-car</span> s1))</span><br><span class="line">               (<span class="name">s2car</span> (<span class="name">stream-car</span> s2)))</span><br><span class="line">           (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">&lt;</span></span> s1car s2car)</span><br><span class="line">                  (<span class="name">cons-stream</span> s1car (<span class="name">merge</span> (<span class="name">stream-cdr</span> s1) s2)))</span><br><span class="line">                 ((<span class="name"><span class="builtin-name">&gt;</span></span> s1car s2car)</span><br><span class="line">                  (<span class="name">cons-stream</span> s2car (<span class="name">merge</span> s1 (<span class="name">stream-cdr</span> s2))))</span><br><span class="line">                 (<span class="name"><span class="builtin-name">else</span></span></span><br><span class="line">                  (<span class="name">cons-stream</span> s1car</span><br><span class="line">                               (<span class="name">merge</span> (<span class="name">stream-cdr</span> s1)</span><br><span class="line">                                      (<span class="name">stream-cdr</span> s2)))))))))</span><br></pre></td></tr></table></figure></p>
<p>Then the required stream may be constructed with merge, as follows:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> S (<span class="name">cons-stream</span> <span class="number">1</span> (<span class="name">merge</span> &lt;??&gt; &lt;??&gt;)))</span><br></pre></td></tr></table></figure></p>
<p>Fill in the missing expressions in the places marked &lt;??&gt; above.</p>
<h3 id="Exercise-3-57"><a href="#Exercise-3-57" class="headerlink" title="Exercise 3.57"></a>Exercise 3.57</h3><p>How many additions are performed when we compute the nth Fibonacci number using the definition of fibs based on the add-streams procedure? Show that the number of additions would be exponentially greater if we had implemented (delay <exp>) simply as (lambda () <exp>), without using the optimization provided by the memo-proc procedure described in section 3.5.1.64</exp></exp></p>
<h3 id="Exercise-3-58"><a href="#Exercise-3-58" class="headerlink" title="Exercise 3.58"></a>Exercise 3.58</h3><p>Give an interpretation of the stream computed by the following procedure:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">expand</span> num den radix)</span><br><span class="line">  (<span class="name">cons-stream</span></span><br><span class="line">   (<span class="name"><span class="builtin-name">quotient</span></span> (<span class="name"><span class="builtin-name">*</span></span> num radix) den)</span><br><span class="line">   (<span class="name">expand</span> (<span class="name"><span class="builtin-name">remainder</span></span> (<span class="name"><span class="builtin-name">*</span></span> num radix) den) den radix)))</span><br></pre></td></tr></table></figure></p>
<p>(Quotient is a primitive that returns the integer quotient of two integers.) What are the successive elements produced by (expand 1 7 10) ? What is produced by (expand 3 8 10) ?</p>
<h3 id="Exercise-3-59"><a href="#Exercise-3-59" class="headerlink" title="Exercise 3.59"></a>Exercise 3.59</h3><p>In section 2.5.3 we saw how to implement a polynomial arithmetic system representing polynomials as lists of terms. In a similar way, we can work with power series, such as</p>
<p>represented as infinite streams. We will represent the series a0 + a1 x + a2 x2 + a3 x3 + ··· as the stream whose elements are the coefficients a0, a1, a2, a3, ….</p>
<p>a. The integral of the series a0 + a1 x + a2 x2 + a3 x3 + ··· is the series</p>
<p>where c is any constant. Define a procedure integrate-series that takes as input a stream a0, a1, a2, … representing a power series and returns the stream a0, (1/2)a1, (1/3)a2, … of coefficients of the non-constant terms of the integral of the series. (Since the result has no constant term, it doesn’t represent a power series; when we use integrate-series, we will cons on the appropriate constant.)</p>
<p>b. The function x ex is its own derivative. This implies that ex and the integral of ex are the same series, except for the constant term, which is e0 = 1. Accordingly, we can generate the series for ex as<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> exp-series</span><br><span class="line">  (<span class="name">cons-stream</span> <span class="number">1</span> (<span class="name">integrate-series</span> exp-series)))</span><br></pre></td></tr></table></figure></p>
<p>Show how to generate the series for sine and cosine, starting from the facts that the derivative of sine is cosine and the derivative of cosine is the negative of sine:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> cosine-series</span><br><span class="line">  (<span class="name">cons-stream</span> <span class="number">1</span> &lt;??&gt;))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> sine-series</span><br><span class="line">  (<span class="name">cons-stream</span> <span class="number">0</span> &lt;??&gt;))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-3-60"><a href="#Exercise-3-60" class="headerlink" title="Exercise 3.60"></a>Exercise 3.60</h3><p>With power series represented as streams of coefficients as in exercise 3.59, adding series is implemented by add-streams. Complete the definition of the following procedure for multiplying series:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">mul-series</span> s1 s2)</span><br><span class="line">  (<span class="name">cons-stream</span> &lt;??&gt; (<span class="name">add-streams</span> &lt;??&gt; &lt;??&gt;)))</span><br></pre></td></tr></table></figure></p>
<p>You can test your procedure by verifying that sin2 x + cos2 x = 1, using the series from exercise 3.59.</p>
<h3 id="Exercise-3-61"><a href="#Exercise-3-61" class="headerlink" title="Exercise 3.61"></a>Exercise 3.61</h3><p>Let S be a power series (exercise 3.59) whose constant term is 1. Suppose we want to find the power series 1/S, that is, the series X such that S · X = 1. Write S = 1 + SR where SR is the part of S after the constant term. Then we can solve for X as follows:</p>
<p>In other words, X is the power series whose constant term is 1 and whose higher-order terms are given by the negative of SR times X. Use this idea to write a procedure invert-unit-series that computes 1/S for a power series S with constant term 1. You will need to use mul-series from exercise 3.60.</p>
<h3 id="Exercise-3-62"><a href="#Exercise-3-62" class="headerlink" title="Exercise 3.62"></a>Exercise 3.62</h3><p>Use the results of exercises 3.60 and 3.61 to define a procedure div-series that divides two power series. Div-series should work for any two series, provided that the denominator series begins with a nonzero constant term. (If the denominator has a zero constant term, then div-series should signal an error.) Show how to use div-series together with the result of exercise 3.59 to generate the power series for tangent.</p>
<h2 id="流计算模式的使用"><a href="#流计算模式的使用" class="headerlink" title="流计算模式的使用"></a>流计算模式的使用</h2><p>(3.5.3 Exploiting the Stream Paradigm)</p>
<h3 id="Formulating-iterations-as-stream-processes"><a href="#Formulating-iterations-as-stream-processes" class="headerlink" title="Formulating iterations as stream processes"></a>Formulating iterations as stream processes</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sqrt-improve</span> guess x)</span><br><span class="line">  (<span class="name">average</span> guess (<span class="name"><span class="builtin-name">/</span></span> x guess)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sqrt-stream</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> guesses</span><br><span class="line">    (<span class="name">cons-stream</span> <span class="number">1.0</span></span><br><span class="line">                 (<span class="name">stream-map</span> (<span class="name"><span class="builtin-name">lambda</span></span> (guess)</span><br><span class="line">                               (<span class="name">sqrt-improve</span> guess x))</span><br><span class="line">                             guesses)))</span><br><span class="line">  guesses)</span><br><span class="line"></span><br><span class="line"><span class="comment">;: (display-stream (sqrt-stream 2))</span></span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">pi-summands</span> n)</span><br><span class="line">  (<span class="name">cons-stream</span> (<span class="name"><span class="builtin-name">/</span></span> <span class="number">1.0</span> n)</span><br><span class="line">               (<span class="name">stream-map</span> - (<span class="name">pi-summands</span> (<span class="name"><span class="builtin-name">+</span></span> n <span class="number">2</span>)))))</span><br><span class="line"></span><br><span class="line"><span class="comment">;: (define pi-stream</span></span><br><span class="line"><span class="comment">;:   (scale-stream (partial-sums (pi-summands 1)) 4))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;: (display-stream pi-stream)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">euler-transform</span> s)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">s0</span> (<span class="name">stream-ref</span> s <span class="number">0</span>))</span><br><span class="line">        (<span class="name">s1</span> (<span class="name">stream-ref</span> s <span class="number">1</span>))  </span><br><span class="line">        (<span class="name">s2</span> (<span class="name">stream-ref</span> s <span class="number">2</span>)))</span><br><span class="line">    (<span class="name">cons-stream</span> (<span class="name"><span class="builtin-name">-</span></span> s2 (<span class="name"><span class="builtin-name">/</span></span> (<span class="name">square</span> (<span class="name"><span class="builtin-name">-</span></span> s2 s1))</span><br><span class="line">                          (<span class="name"><span class="builtin-name">+</span></span> s0 (<span class="name"><span class="builtin-name">*</span></span> <span class="number">-2</span> s1) s2)))</span><br><span class="line">                 (<span class="name">euler-transform</span> (<span class="name">stream-cdr</span> s)))))</span><br><span class="line"></span><br><span class="line"><span class="comment">;: (display-stream (euler-transform pi-stream))</span></span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-tableau</span> transform s)</span><br><span class="line">  (<span class="name">cons-stream</span> s</span><br><span class="line">               (<span class="name">make-tableau</span> transform</span><br><span class="line">                             (<span class="name">transform</span> s))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">accelerated-sequence</span> transform s)</span><br><span class="line">  (<span class="name">stream-map</span> stream-car</span><br><span class="line">              (<span class="name">make-tableau</span> transform s)))</span><br><span class="line"></span><br><span class="line"><span class="comment">;: (display-stream (accelerated-sequence euler-transform</span></span><br><span class="line"><span class="comment">;:                                       pi-stream))</span></span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-63"><a href="#Exercise-3-63" class="headerlink" title="Exercise 3.63"></a>Exercise 3.63</h3><p>Louis Reasoner asks why the sqrt-stream procedure was not written in the following more straightforward way, without the local variable guesses:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sqrt-stream</span> x)</span><br><span class="line">  (<span class="name">cons-stream</span> <span class="number">1.0</span></span><br><span class="line">               (<span class="name">stream-map</span> (<span class="name"><span class="builtin-name">lambda</span></span> (guess)</span><br><span class="line">                             (<span class="name">sqrt-improve</span> guess x))</span><br><span class="line">                           (<span class="name">sqrt-stream</span> x))))</span><br></pre></td></tr></table></figure></p>
<p>Alyssa P. Hacker replies that this version of the procedure is considerably less efficient because it performs redundant computation. Explain Alyssa’s answer. Would the two versions still differ in efficiency if our implementation of delay used only (lambda () <exp>) without using the optimization provided by memo-proc (section 3.5.1)?</exp></p>
<h3 id="Exercise-3-64"><a href="#Exercise-3-64" class="headerlink" title="Exercise 3.64"></a>Exercise 3.64</h3><p>Write a procedure stream-limit that takes as arguments a stream and a number (the tolerance). It should examine the stream until it finds two successive elements that differ in absolute value by less than the tolerance, and return the second of the two elements. Using this, we could compute square roots up to a given tolerance by<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">sqrt</span></span> x tolerance)</span><br><span class="line">  (<span class="name">stream-limit</span> (<span class="name">sqrt-stream</span> x) tolerance))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-3-65"><a href="#Exercise-3-65" class="headerlink" title="Exercise 3.65"></a>Exercise 3.65</h3><p>Use the series</p>
<p>to compute three sequences of approximations to the natural logarithm of 2, in the same way we did above for . How rapidly do these sequences converge?</p>
<h3 id="Infinite-streams-of-pairs"><a href="#Infinite-streams-of-pairs" class="headerlink" title="Infinite streams of pairs"></a>Infinite streams of pairs</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;: (stream-filter (lambda (pair)</span></span><br><span class="line"><span class="comment">;:                  (prime? (+ (car pair) (cadr pair))))</span></span><br><span class="line"><span class="comment">;:                int-pairs)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">stream-append</span> s1 s2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">stream-null?</span> s1)</span><br><span class="line">      s2</span><br><span class="line">      (<span class="name">cons-stream</span> (<span class="name">stream-car</span> s1)</span><br><span class="line">                   (<span class="name">stream-append</span> (<span class="name">stream-cdr</span> s1) s2))))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">;: (pairs integers integers)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">interleave</span> s1 s2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">stream-null?</span> s1)</span><br><span class="line">      s2</span><br><span class="line">      (<span class="name">cons-stream</span> (<span class="name">stream-car</span> s1)</span><br><span class="line">                   (<span class="name">interleave</span> s2 (<span class="name">stream-cdr</span> s1)))))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">pairs</span> s t)</span><br><span class="line">  (<span class="name">cons-stream</span></span><br><span class="line">   (<span class="name"><span class="builtin-name">list</span></span> (<span class="name">stream-car</span> s) (<span class="name">stream-car</span> t))</span><br><span class="line">   (<span class="name">interleave</span></span><br><span class="line">    (<span class="name">stream-map</span> (<span class="name"><span class="builtin-name">lambda</span></span> (x) (<span class="name"><span class="builtin-name">list</span></span> (<span class="name">stream-car</span> s) x))</span><br><span class="line">                (<span class="name">stream-cdr</span> t))</span><br><span class="line">    (<span class="name">pairs</span> (<span class="name">stream-cdr</span> s) (<span class="name">stream-cdr</span> t)))))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-66"><a href="#Exercise-3-66" class="headerlink" title="Exercise 3.66"></a>Exercise 3.66</h3><p>Examine the stream (pairs integers integers). Can you make any general comments about the order in which the pairs are placed into the stream? For example, about how many pairs precede the pair (1,100)? the pair (99,100)? the pair (100,100)? (If you can make precise mathematical statements here, all the better. But feel free to give more qualitative answers if you find yourself getting bogged down.)</p>
<h3 id="Exercise-3-67"><a href="#Exercise-3-67" class="headerlink" title="Exercise 3.67"></a>Exercise 3.67</h3><p>Modify the pairs procedure so that (pairs integers integers) will produce the stream of all pairs of integers (i,j) (without the condition i &lt; j). Hint: You will need to mix in an additional stream.</p>
<h3 id="Exercise-3-68"><a href="#Exercise-3-68" class="headerlink" title="Exercise 3.68"></a>Exercise 3.68</h3><p>Louis Reasoner thinks that building a stream of pairs from three parts is unnecessarily complicated. Instead of separating the pair (S0,T0) from the rest of the pairs in the first row, he proposes to work with the whole first row, as follows:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">pairs</span> s t)</span><br><span class="line">  (<span class="name">interleave</span></span><br><span class="line">   (<span class="name">stream-map</span> (<span class="name"><span class="builtin-name">lambda</span></span> (x) (<span class="name"><span class="builtin-name">list</span></span> (<span class="name">stream-car</span> s) x))</span><br><span class="line">               t)</span><br><span class="line">   (<span class="name">pairs</span> (<span class="name">stream-cdr</span> s) (<span class="name">stream-cdr</span> t))))</span><br></pre></td></tr></table></figure></p>
<p>Does this work? Consider what happens if we evaluate (pairs integers integers) using Louis’s definition of pairs.</p>
<h3 id="Exercise-3-69"><a href="#Exercise-3-69" class="headerlink" title="Exercise 3.69"></a>Exercise 3.69</h3><p>Write a procedure triples that takes three infinite streams, S, T, and U, and produces the stream of triples (Si,Tj,Uk) such that i &lt; j &lt; k. Use triples to generate the stream of all Pythagorean triples of positive integers, i.e., the triples (i,j,k) such that i &lt; j and i2 + j2 = k2.</p>
<h3 id="Exercise-3-70"><a href="#Exercise-3-70" class="headerlink" title="Exercise 3.70"></a>Exercise 3.70</h3><p>It would be nice to be able to generate streams in which the pairs appear in some useful order, rather than in the order that results from an ad hoc interleaving process. We can use a technique similar to the merge procedure of exercise 3.56, if we define a way to say that one pair of integers is “less than” another. One way to do this is to define a “weighting function” W(i,j) and stipulate that (i1,j1) is less than (i2,j2) if W(i1,j1) &lt; W(i2,j2). Write a procedure merge-weighted that is like merge, except that merge-weighted takes an additional argument weight, which is a procedure that computes the weight of a pair, and is used to determine the order in which elements should appear in the resulting merged stream.69 Using this, generalize pairs to a procedure weighted-pairs that takes two streams, together with a procedure that computes a weighting function, and generates the stream of pairs, ordered according to weight. Use your procedure to generate</p>
<p>a. the stream of all pairs of positive integers (i,j) with i &lt; j ordered according to the sum i + j<br>b. the stream of all pairs of positive integers (i,j) with i &lt; j, where neither i nor j is divisible by 2, 3, or 5, and the pairs are ordered according to the sum 2 i + 3 j + 5 i j.</p>
<h3 id="Exercise-3-71"><a href="#Exercise-3-71" class="headerlink" title="Exercise 3.71"></a>Exercise 3.71</h3><p>Numbers that can be expressed as the sum of two cubes in more than one way are sometimes called Ramanujan numbers, in honor of the mathematician Srinivasa Ramanujan.70 Ordered streams of pairs provide an elegant solution to the problem of computing these numbers. To find a number that can be written as the sum of two cubes in two different ways, we need only generate the stream of pairs of integers (i,j) weighted according to the sum i3 + j3 (see exercise 3.70), then search the stream for two consecutive pairs with the same weight. Write a procedure to generate the Ramanujan numbers. The first such number is 1,729. What are the next five?</p>
<h3 id="Exercise-3-72"><a href="#Exercise-3-72" class="headerlink" title="Exercise 3.72"></a>Exercise 3.72</h3><p>In a similar way to exercise 3.71 generate a stream of all numbers that can be written as the sum of two squares in three different ways (showing how they can be so written).</p>
<h3 id="Streams-as-signals"><a href="#Streams-as-signals" class="headerlink" title="Streams as signals"></a>Streams as signals</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">integral</span> integrand initial-value dt)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> int</span><br><span class="line">    (<span class="name">cons-stream</span> initial-value</span><br><span class="line">                 (<span class="name">add-streams</span> (<span class="name">scale-stream</span> integrand dt)</span><br><span class="line">                              int)))</span><br><span class="line">  int)</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-74"><a href="#Exercise-3-74" class="headerlink" title="Exercise 3.74"></a>Exercise 3.74</h3><p>Alyssa P. Hacker is designing a system to process signals coming from physical sensors. One important feature she wishes to produce is a signal that describes the zero crossings of the input signal. That is, the resulting signal should be + 1 whenever the input signal changes from negative to positive, - 1 whenever the input signal changes from positive to negative, and 0 otherwise. (Assume that the sign of a 0 input is positive.) For example, a typical input signal with its associated zero-crossing signal would be</p>
<p>…1 2 1.5 1 0.5 -0.1 -2 -3 -2 -0.5 0.2 3 4 …… 0 0 0 0 0 -1 0 0 0 0 1 0 0 …</p>
<p>In Alyssa’s system, the signal from the sensor is represented as a stream sense-data and the stream zero-crossings is the corresponding stream of zero crossings. Alyssa first writes a procedure sign-change-detector that takes two values as arguments and compares the signs of the values to produce an appropriate 0, 1, or - 1. She then constructs her zero-crossing stream as follows:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-zero-crossings</span> input-stream last-value)</span><br><span class="line">  (<span class="name">cons-stream</span></span><br><span class="line">   (<span class="name">sign-change-detector</span> (<span class="name">stream-car</span> input-stream) last-value)</span><br><span class="line">   (<span class="name">make-zero-crossings</span> (<span class="name">stream-cdr</span> input-stream)</span><br><span class="line">                        (<span class="name">stream-car</span> input-stream))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> zero-crossings (<span class="name">make-zero-crossings</span> sense-data <span class="number">0</span>))</span><br></pre></td></tr></table></figure></p>
<p>Alyssa’s boss, Eva Lu Ator, walks by and suggests that this program is approximately equivalent to the following one, which uses the generalized version of stream-map from exercise 3.50:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> zero-crossings</span><br><span class="line">  (<span class="name">stream-map</span> sign-change-detector sense-data &lt;expression&gt;))</span><br></pre></td></tr></table></figure></p>
<p>Complete the program by supplying the indicated <expression>.</expression></p>
<h3 id="Exercise-3-75"><a href="#Exercise-3-75" class="headerlink" title="Exercise 3.75"></a>Exercise 3.75</h3><p>Unfortunately, Alyssa’s zero-crossing detector in exercise 3.74 proves to be insufficient, because the noisy signal from the sensor leads to spurious zero crossings. Lem E. Tweakit, a hardware specialist, suggests that Alyssa smooth the signal to filter out the noise before extracting the zero crossings. Alyssa takes his advice and decides to extract the zero crossings from the signal constructed by averaging each value of the sense data with the previous value. She explains the problem to her assistant, Louis Reasoner, who attempts to implement the idea, altering Alyssa’s program as follows:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-zero-crossings</span> input-stream last-value)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">avpt</span> (<span class="name"><span class="builtin-name">/</span></span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">stream-car</span> input-stream) last-value) <span class="number">2</span>)))</span><br><span class="line">    (<span class="name">cons-stream</span> (<span class="name">sign-change-detector</span> avpt last-value)</span><br><span class="line">                 (<span class="name">make-zero-crossings</span> (<span class="name">stream-cdr</span> input-stream)</span><br><span class="line">                                      avpt))))</span><br></pre></td></tr></table></figure></p>
<p>This does not correctly implement Alyssa’s plan. Find the bug that Louis has installed and fix it without changing the structure of the program. (Hint: You will need to increase the number of arguments to make-zero-crossings.)</p>
<h3 id="Exercise-3-76"><a href="#Exercise-3-76" class="headerlink" title="Exercise 3.76"></a>Exercise 3.76</h3><p>Eva Lu Ator has a criticism of Louis’s approach in exercise 3.75. The program he wrote is not modular, because it intermixes the operation of smoothing with the zero-crossing extraction. For example, the extractor should not have to be changed if Alyssa finds a better way to condition her input signal. Help Louis by writing a procedure smooth that takes a stream as input and produces a stream in which each element is the average of two successive input stream elements. Then use smooth as a component to implement the zero-crossing detector in a more modular style.</p>
<h2 id="流和延时求值"><a href="#流和延时求值" class="headerlink" title="流和延时求值"></a>流和延时求值</h2><p>(3.5.4 Streams and Delayed Evaluation)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> int</span><br><span class="line">  (<span class="name">cons-stream</span></span><br><span class="line">   initial-value</span><br><span class="line">   (<span class="name">add-streams</span> (<span class="name">scale-stream</span> integrand dt)</span><br><span class="line">                int)))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">solve</span> f y0 dt)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> y (<span class="name">integral</span> dy y0 dt))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> dy (<span class="name">stream-map</span> f y))</span><br><span class="line">  y)</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">integral</span> delayed-integrand initial-value dt)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> int</span><br><span class="line">    (<span class="name">cons-stream</span> initial-value</span><br><span class="line">                 (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">integrand</span> (<span class="name"><span class="builtin-name">force</span></span> delayed-integrand)))</span><br><span class="line">                   (<span class="name">add-streams</span> (<span class="name">scale-stream</span> integrand dt)</span><br><span class="line">                                int))))</span><br><span class="line">  int)</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">solve</span> f y0 dt)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> y (<span class="name">integral</span> (<span class="name"><span class="builtin-name">delay</span></span> dy) y0 dt))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> dy (<span class="name">stream-map</span> f y))</span><br><span class="line">  y)</span><br></pre></td></tr></table></figure>
<p>;: (stream-ref (solve (lambda (y) y) 1 0.001) 1000)</p>
<h3 id="Exercise-3-77"><a href="#Exercise-3-77" class="headerlink" title="Exercise 3.77"></a>Exercise 3.77</h3><p>The integral procedure used above was analogous to the “implicit” definition of the infinite stream of integers in section 3.5.2. Alternatively, we can give a definition of integral that is more like integers-starting-from (also in section 3.5.2):<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">integral</span> integrand initial-value dt)</span><br><span class="line">  (<span class="name">cons-stream</span> initial-value</span><br><span class="line">               (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">stream-null?</span> integrand)</span><br><span class="line">                   the-empty-stream</span><br><span class="line">                   (<span class="name">integral</span> (<span class="name">stream-cdr</span> integrand)</span><br><span class="line">                             (<span class="name"><span class="builtin-name">+</span></span> (<span class="name"><span class="builtin-name">*</span></span> dt (<span class="name">stream-car</span> integrand))</span><br><span class="line">                                initial-value)</span><br><span class="line">                             dt))))</span><br></pre></td></tr></table></figure></p>
<p>When used in systems with loops, this procedure has the same problem as does our original version of integral. Modify the procedure so that it expects the integrand as a delayed argument and hence can be used in the solve procedure shown above.</p>
<h3 id="Exercise-3-78"><a href="#Exercise-3-78" class="headerlink" title="Exercise 3.78"></a>Exercise 3.78</h3><p>Figure 3.35: Signal-flow diagram for the solution to a second-order linear differential equation.<br>Consider the problem of designing a signal-processing system to study the homogeneous second-order linear differential equation</p>
<p>The output stream, modeling y, is generated by a network that contains a loop. This is because the value of d2y/dt2 depends upon the values of y and dy/dt and both of these are determined by integrating d2y/dt2. The diagram we would like to encode is shown in figure 3.35. Write a procedure solve-2nd that takes as arguments the constants a, b, and dt and the initial values y0 and dy0 for y and dy/dt and generates the stream of successive values of y.</p>
<h3 id="Exercise-3-79"><a href="#Exercise-3-79" class="headerlink" title="Exercise 3.79"></a>Exercise 3.79</h3><p>Generalize the solve-2nd procedure of exercise 3.78 so that it can be used to solve general second-order differential equations d2 y/dt2 = f(dy/dt, y).</p>
<h3 id="Exercise-3-80"><a href="#Exercise-3-80" class="headerlink" title="Exercise 3.80"></a>Exercise 3.80</h3><p>A series RLC circuit consists of a resistor, a capacitor, and an inductor connected in series, as shown in figure 3.36. If R, L, and C are the resistance, inductance, and capacitance, then the relations between voltage (v) and current (i) for the three components are described by the equations</p>
<p>and the circuit connections dictate the relations</p>
<p>Combining these equations shows that the state of the circuit (summarized by vC, the voltage across the capacitor, and iL, the current in the inductor) is described by the pair of differential equations</p>
<p>The signal-flow diagram representing this system of differential equations is shown in figure 3.37.</p>
<h3 id="Normal-order-evaluation"><a href="#Normal-order-evaluation" class="headerlink" title="Normal-order evaluation"></a>Normal-order evaluation</h3><h2 id="函数式程序的模块化和对象的模块化"><a href="#函数式程序的模块化和对象的模块化" class="headerlink" title="函数式程序的模块化和对象的模块化"></a>函数式程序的模块化和对象的模块化</h2><p>(3.5.5 Modularity of Functional Programs and Modularity of Objects)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;; same as in section 3.1.2</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> rand</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">x</span> random-init))</span><br><span class="line">    (<span class="name"><span class="builtin-name">lambda</span></span> ()</span><br><span class="line">      (<span class="name"><span class="builtin-name">set!</span></span> x (<span class="name">rand-update</span> x))</span><br><span class="line">      x)))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> random-numbers</span><br><span class="line">  (<span class="name">cons-stream</span> random-init</span><br><span class="line">               (<span class="name">stream-map</span> rand-update random-numbers)))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> cesaro-stream</span><br><span class="line">  (<span class="name">map-successive-pairs</span> (<span class="name"><span class="builtin-name">lambda</span></span> (r1 r2) (<span class="name"><span class="builtin-name">=</span></span> (<span class="name"><span class="builtin-name">gcd</span></span> r1 r2) <span class="number">1</span>))</span><br><span class="line">                        random-numbers))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">map-successive-pairs</span> f s)</span><br><span class="line">  (<span class="name">cons-stream</span></span><br><span class="line">   (<span class="name">f</span> (<span class="name">stream-car</span> s) (<span class="name">stream-car</span> (<span class="name">stream-cdr</span> s)))</span><br><span class="line">   (<span class="name">map-successive-pairs</span> f (<span class="name">stream-cdr</span> (<span class="name">stream-cdr</span> s)))))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">monte-carlo</span> experiment-stream passed failed)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">next</span> passed failed)</span><br><span class="line">    (<span class="name">cons-stream</span></span><br><span class="line">     (<span class="name"><span class="builtin-name">/</span></span> passed (<span class="name"><span class="builtin-name">+</span></span> passed failed))</span><br><span class="line">     (<span class="name">monte-carlo</span></span><br><span class="line">      (<span class="name">stream-cdr</span> experiment-stream) passed failed)))</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">stream-car</span> experiment-stream)</span><br><span class="line">      (<span class="name">next</span> (<span class="name"><span class="builtin-name">+</span></span> passed <span class="number">1</span>) failed)</span><br><span class="line">      (<span class="name">next</span> passed (<span class="name"><span class="builtin-name">+</span></span> failed <span class="number">1</span>))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> pi</span><br><span class="line">   (<span class="name">stream-map</span> (<span class="name"><span class="builtin-name">lambda</span></span> (p) (<span class="name"><span class="builtin-name">sqrt</span></span> (<span class="name"><span class="builtin-name">/</span></span> <span class="number">6</span> p)))</span><br><span class="line">               (<span class="name">monte-carlo</span> cesaro-stream <span class="number">0</span> <span class="number">0</span>)))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-81"><a href="#Exercise-3-81" class="headerlink" title="Exercise 3.81"></a>Exercise 3.81</h3><p>Exercise 3.6 discussed generalizing the random-number generator to allow one to reset the random-number sequence so as to produce repeatable sequences of “random” numbers. Produce a stream formulation of this same generator that operates on an input stream of requests to generate a new random number or to reset the sequence to a specified value and that produces the desired stream of random numbers. don’t use assignment in your solution.</p>
<h3 id="Exercise-3-82"><a href="#Exercise-3-82" class="headerlink" title="Exercise 3.82"></a>Exercise 3.82</h3><p>Redo exercise 3.5 on Monte Carlo integration in terms of streams. The stream version of estimate-integral will not have an argument telling how many trials to perform. Instead, it will produce a stream of estimates based on successively more trials.</p>
<h3 id="A-functional-programming-view-of-time"><a href="#A-functional-programming-view-of-time" class="headerlink" title="A functional-programming view of time"></a>A functional-programming view of time</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;; same as in section 3.1.3</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-simplified-withdraw</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">lambda</span></span> (amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">    balance))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">stream-withdraw</span> balance amount-stream)</span><br><span class="line">  (<span class="name">cons-stream</span></span><br><span class="line">   balance</span><br><span class="line">   (<span class="name">stream-withdraw</span> (<span class="name"><span class="builtin-name">-</span></span> balance (<span class="name">stream-car</span> amount-stream))</span><br><span class="line">                    (<span class="name">stream-cdr</span> amount-stream))))</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/28/SICP笔记_02_构造数据抽象/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wangzk1900">
      <meta itemprop="description" content="记录学习总结和思考">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangzk1900's site">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/06/28/SICP笔记_02_构造数据抽象/" class="post-title-link" itemprop="url">02_构造数据抽象</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-06-28 00:00:00" itemprop="dateCreated datePublished" datetime="2019-06-28T00:00:00+08:00">2019-06-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-29 09:08:12" itemprop="dateModified" datetime="2019-07-29T09:08:12+08:00">2019-07-29</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/SICP笔记/" itemprop="url" rel="index"><span itemprop="name">SICP笔记</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>第二章： 构造数据抽象(Building Abstractions with Data)</p>
<h1 id="数据抽象介绍"><a href="#数据抽象介绍" class="headerlink" title="数据抽象介绍"></a>数据抽象介绍</h1><p>(2.1 Introduction to Data Abstraction)</p>
<h2 id="实例：有理数的算术运算"><a href="#实例：有理数的算术运算" class="headerlink" title="实例：有理数的算术运算"></a>实例：有理数的算术运算</h2><p>(2.1.1 Example: Arithmetic Operations for Rational Numbers)</p>
<p>假设下面三个过程是可用的：</p>
<ul>
<li>(make-rat n d) – 构造分子为n，分母为d的的有理数</li>
<li>(numer x) – 返回有理数x的分子</li>
<li>(denom x) – 返回有理数x的分母</li>
</ul>
<p>那么，我们就可以根据下面的关系式来定义有理数的加、减、乘、除和判断是否相等的过程。<br>$$\frac{n_{1}}{d_{1}}+\frac{n_{2}}{d_{2}}=\frac{n_{1}d_{2}+n_{2}d_{1}}{d_{1}d_{2}}$$<br>$$\frac{n_{1}}{d_{1}}-\frac{n_{2}}{d_{2}}=\frac{n_{1}d_{2}-n_{2}d_{1}}{d_{1}d_{2}}$$<br>$$\frac{n_{1}}{d_{1}}*\frac{n_{2}}{d_{2}}=\frac{n_{1}n_{2}}{d_{1}d_{2}}$$<br>$$\frac{n_{1}/d_{1}}{n_{2}/d_{2}}=\frac{n_{1}d_{2}}{n_{2}d_{1}}$$<br>$$\frac{n_{1}}{d_{1}}=\frac{n_{2}}{d_{2}} \text{  if and only if  } n_{1}d_{2}=n_{2}d_{1}$$</p>
<p>下面是实现有理数加减乘除操作的过程：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 加</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">add-rat</span> x y)</span><br><span class="line">  (<span class="name">make-rat</span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">numer</span> x) (<span class="name">denom</span> y))</span><br><span class="line">               (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">numer</span> y) (<span class="name">denom</span> x)))</span><br><span class="line">            (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">denom</span> x) (<span class="name">denom</span> y))))</span><br><span class="line"><span class="comment">; 减</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sub-rat</span> x y)</span><br><span class="line">  (<span class="name">make-rat</span> (<span class="name"><span class="builtin-name">-</span></span> (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">numer</span> x) (<span class="name">denom</span> y))</span><br><span class="line">               (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">numer</span> y) (<span class="name">denom</span> x)))</span><br><span class="line">            (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">denom</span> x) (<span class="name">denom</span> y))))</span><br><span class="line"><span class="comment">; 乘</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">mul-rat</span> x y)</span><br><span class="line">  (<span class="name">make-rat</span> (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">numer</span> x) (<span class="name">numer</span> y))</span><br><span class="line">            (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">denom</span> x) (<span class="name">denom</span> y))))</span><br><span class="line"><span class="comment">; 除</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">div-rat</span> x y)</span><br><span class="line">  (<span class="name">make-rat</span> (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">numer</span> x) (<span class="name">denom</span> y))</span><br><span class="line">            (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">denom</span> x) (<span class="name">numer</span> y))))</span><br><span class="line"><span class="comment">; 测试两个有理数是否相等</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">equal-rat?</span> x y)</span><br><span class="line">  (<span class="name"><span class="builtin-name">=</span></span> (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">numer</span> x) (<span class="name">denom</span> y))</span><br><span class="line">     (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">numer</span> y) (<span class="name">denom</span> x))))</span><br></pre></td></tr></table></figure></p>
<h3 id="序对-Pairs"><a href="#序对-Pairs" class="headerlink" title="序对(Pairs)"></a>序对(Pairs)</h3><p>序对是Scheme提供的一种复合数据结构，可以使用其提供的过程<code>cons</code>进行构建。<br>过程<code>cons</code>接收两个参数构建序对，并且可以使用过程<code>adr</code>和<code>cdr</code>获取序对中的元素。比如下面的例子：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> x (<span class="name"><span class="builtin-name">cons</span></span> <span class="number">1</span> <span class="number">2</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">car</span></span> x)</span><br><span class="line"><span class="number">1</span></span><br><span class="line">(<span class="name"><span class="builtin-name">cdr</span></span> x)</span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure></p>
<p>序对的元素也可以是序对：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> x (<span class="name"><span class="builtin-name">cons</span></span> <span class="number">1</span> <span class="number">2</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> y (<span class="name"><span class="builtin-name">cons</span></span> <span class="number">3</span> <span class="number">4</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> z (<span class="name"><span class="builtin-name">cons</span></span> x y))</span><br><span class="line">(<span class="name"><span class="builtin-name">car</span></span> (<span class="name"><span class="builtin-name">car</span></span> z))</span><br><span class="line"><span class="number">1</span></span><br><span class="line">(<span class="name"><span class="builtin-name">cdr</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> z))</span><br><span class="line"><span class="number">4</span></span><br></pre></td></tr></table></figure></p>
<h3 id="有理数的表示"><a href="#有理数的表示" class="headerlink" title="有理数的表示"></a>有理数的表示</h3><p>序对提供了一种自然的方式来表示有理数，可以使用序对来表示有理数的分子和分母。</p>
<p>使用序对实现在上节中假设的三个过程：<code>make-rat</code>、<code>numer</code>和<code>denom</code><br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-rat</span> n d) (<span class="name"><span class="builtin-name">cons</span></span> n d))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">numer</span> x) (<span class="name"><span class="builtin-name">car</span></span> x))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">denom</span> x) (<span class="name"><span class="builtin-name">cdr</span></span> x))</span><br></pre></td></tr></table></figure></p>
<p>打印有理数的过程<code>print-rat</code>：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">print-rat</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">newline</span></span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">display</span></span> (<span class="name">numer</span> x))</span><br><span class="line">  (<span class="name"><span class="builtin-name">display</span></span> <span class="string">"/"</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">display</span></span> (<span class="name">denom</span> x)))</span><br></pre></td></tr></table></figure></p>
<p>有理数的一些简单计算：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> one-half (<span class="name">make-rat</span> <span class="number">1</span> <span class="number">2</span>))</span><br><span class="line">(<span class="name">print-rat</span> one-half)</span><br><span class="line"><span class="number">1/2</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> one-third (<span class="name">make-rat</span> <span class="number">1</span> <span class="number">3</span>))</span><br><span class="line">(<span class="name">print-rat</span> (<span class="name">add-rat</span> one-half one-third))</span><br><span class="line"><span class="number">5/6</span></span><br><span class="line">(<span class="name">print-rat</span> (<span class="name">mul-rat</span> one-half one-third))</span><br><span class="line"><span class="number">1/6</span></span><br><span class="line">(<span class="name">print-rat</span> (<span class="name">add-rat</span> one-third one-third))</span><br><span class="line"><span class="number">6/9</span></span><br></pre></td></tr></table></figure></p>
<p>过程<code>make-rat</code>构建的有理数，不一定是最简的形式。<br>我们可以使用<code>gcd</code>过程(Section 1.2.5)将有理数化为最简形式：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-rat</span> n d)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">g</span> (<span class="name"><span class="builtin-name">gcd</span></span> n d))) <span class="comment">; 获取n和d的最大公约数</span></span><br><span class="line">    (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">/</span></span> n g) (<span class="name"><span class="builtin-name">/</span></span> d g))))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-1"><a href="#Exercise-2-1" class="headerlink" title="Exercise 2.1"></a>Exercise 2.1</h3><p>Define a better version of <code>make-rat</code> that handles both positive and negative arguments. <code>make-rat</code> should normalize the sign so that if the rational number is positive, both the numerator and denominator are positive, and if the rational number is negative, only the numerator is negative.</p>
<p>分析：<br>当make-rat的参数n和d都是正数时，二者的最大公约数g也是正数，n/g和d/g的结果仍然是正数；<br>当make-rat的参数n和d都是负数时，二者的最大公约数g也是负数，n/g和d/g的结果也是正数（负负得正）；<br>当make-rat的参数n和d符号不相同时，二者的最大公约数g是正数或负数，需要进行处理。</p>
<p><strong>答：</strong><br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-rat</span> n d)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">g</span> (<span class="name"><span class="builtin-name">gcd</span></span> n d)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name"><span class="builtin-name">&gt;</span></span> n <span class="number">0</span>) (<span class="name"><span class="builtin-name">&gt;</span></span> d <span class="number">0</span>)) (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">/</span></span> n g) (<span class="name"><span class="builtin-name">/</span></span> d g)))</span><br><span class="line">          ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name"><span class="builtin-name">&lt;</span></span> n <span class="number">0</span>) (<span class="name"><span class="builtin-name">&lt;</span></span> d <span class="number">0</span>)) (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">/</span></span> n g) (<span class="name"><span class="builtin-name">/</span></span> d g)))</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span> (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">-</span></span> <span class="number">0</span> (<span class="name"><span class="builtin-name">abs</span></span> (<span class="name"><span class="builtin-name">/</span></span> n g))) (<span class="name"><span class="builtin-name">abs</span></span> (<span class="name"><span class="builtin-name">/</span></span> d g))))</span><br><span class="line">     )))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">gcd</span></span> a b)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> b <span class="number">0</span>)</span><br><span class="line">      a</span><br><span class="line">      (<span class="name"><span class="builtin-name">gcd</span></span> b (<span class="name"><span class="builtin-name">remainder</span></span> a b))))</span><br></pre></td></tr></table></figure></p>
<p>测试：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">print-rat</span> (<span class="name">make-rat</span> <span class="number">8</span> <span class="number">18</span>))</span><br><span class="line">(<span class="name">print-rat</span> (<span class="name">make-rat</span> <span class="number">-8</span> <span class="number">-18</span>))</span><br><span class="line">(<span class="name">print-rat</span> (<span class="name">make-rat</span> <span class="number">-8</span> <span class="number">18</span>))</span><br><span class="line">(<span class="name">print-rat</span> (<span class="name">make-rat</span> <span class="number">8</span> <span class="number">-18</span>))</span><br><span class="line">(<span class="name">print-rat</span> (<span class="name">make-rat</span> <span class="number">-18</span> <span class="number">8</span>))</span><br><span class="line">(<span class="name">print-rat</span> (<span class="name">make-rat</span> <span class="number">18</span> <span class="number">-8</span>))</span><br></pre></td></tr></table></figure></p>
<h2 id="抽象屏障"><a href="#抽象屏障" class="headerlink" title="抽象屏障"></a>抽象屏障</h2><p>(2.1.2 Abstraction Barriers)</p>
<p><img src="/images/sicp/Figure_2.1.png" alt><br>分层抽象：易于维护和修改。</p>
<p>但是，复杂的数据结构可以有多种实现方式，当修改实现方式时，可能相关的程序都要修改。<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-rat</span> n d) (<span class="name"><span class="builtin-name">cons</span></span> n d))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">numer</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">g</span> (<span class="name"><span class="builtin-name">gcd</span></span> (<span class="name"><span class="builtin-name">car</span></span> x) (<span class="name"><span class="builtin-name">cdr</span></span> x))))</span><br><span class="line">    (<span class="name"><span class="builtin-name">/</span></span> (<span class="name"><span class="builtin-name">car</span></span> x) g)))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">denom</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">g</span> (<span class="name"><span class="builtin-name">gcd</span></span> (<span class="name"><span class="builtin-name">car</span></span> x) (<span class="name"><span class="builtin-name">cdr</span></span> x))))</span><br><span class="line">    (<span class="name"><span class="builtin-name">/</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> x) g)))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-2"><a href="#Exercise-2-2" class="headerlink" title="Exercise 2.2"></a>Exercise 2.2</h3><p>Consider the problem of representing line segments in a plane. Each segment is represented as a pair of points: a starting point and an ending point. Define a constructor <code>make-segment</code> and selectors <code>start-segment</code> and <code>end-segment</code> that define the representation of segments in terms of points. Furthermore, a point can be represented as a pair of numbers: the x coordinate and the y coordinate. Accordingly, specify a constructor make-point and selectors x-point and y-point that define this representation. Finally, using your selectors and constructors, define a procedure <code>midpoint-segment</code> that takes a line segment as argument and returns its midpoint (the point whose coordinates are the average of the coordinates of the endpoints). To try your procedures, you’ll need a way to print points:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">print-point</span> p)</span><br><span class="line">  (<span class="name"><span class="builtin-name">newline</span></span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">display</span></span> <span class="string">"("</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">display</span></span> (<span class="name">x-point</span> p))</span><br><span class="line">  (<span class="name"><span class="builtin-name">display</span></span> <span class="string">","</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">display</span></span> (<span class="name">y-point</span> p))</span><br><span class="line">  (<span class="name"><span class="builtin-name">display</span></span> <span class="string">")"</span>))</span><br></pre></td></tr></table></figure></p>
<p><strong>答：</strong><br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">point</span> x y) (<span class="name"><span class="builtin-name">cons</span></span> x y))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">x-point</span> p) (<span class="name"><span class="builtin-name">car</span></span> p))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">y-point</span> p) (<span class="name"><span class="builtin-name">cdr</span></span> p))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-segment</span> start end) (<span class="name"><span class="builtin-name">cons</span></span> start end) )</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">start-segment</span> s) (<span class="name"><span class="builtin-name">car</span></span> s))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">end-segment</span> s) (<span class="name"><span class="builtin-name">cdr</span></span> s))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">midpoint-segment</span> s)</span><br><span class="line">  (<span class="name">point</span> (<span class="name"><span class="builtin-name">/</span></span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">x-point</span> (<span class="name">start-segment</span> s)) (<span class="name">x-point</span> (<span class="name">end-segment</span> s))) <span class="number">2</span>)</span><br><span class="line">         (<span class="name"><span class="builtin-name">/</span></span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">y-point</span> (<span class="name">start-segment</span> s)) (<span class="name">y-point</span> (<span class="name">end-segment</span> s))) <span class="number">2</span>)))</span><br></pre></td></tr></table></figure></p>
<p>测试：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> start (<span class="name">point</span> <span class="number">1</span> <span class="number">1</span>)) <span class="comment">; 定义起点</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> end (<span class="name">point</span> <span class="number">3</span> <span class="number">3</span>)) <span class="comment">; 定义终点</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> segment (<span class="name">make-segment</span> start end)) <span class="comment">; 定义线段</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> midpoint (<span class="name">midpoint-segment</span> segment)) <span class="comment">; 求线段的中点</span></span><br><span class="line">(<span class="name">print-point</span> midpoint)</span><br><span class="line">(<span class="name">2</span>,<span class="number">2</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-3"><a href="#Exercise-2-3" class="headerlink" title="Exercise 2.3"></a>Exercise 2.3</h3><p>Implement a representation for rectangles in a plane. (Hint: You may want to make use of Exercise 2.2.) In terms of your constructors and selectors, create procedures that compute the perimeter and the area of a given rectangle. Now implement a different representation for rectangles. Can you design your system with suitable abstraction barriers, so that the same perimeter and area procedures will work using either representation?</p>
<p>分析：<br>矩形有四个点，可以用两个线段来表示（横向的两个线段或者纵向的两个线段）</p>
<p><strong>答：</strong><br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 定义点</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">point</span> x y) (<span class="name"><span class="builtin-name">cons</span></span> x y))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">x-point</span> p) (<span class="name"><span class="builtin-name">car</span></span> p))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">y-point</span> p) (<span class="name"><span class="builtin-name">cdr</span></span> p))</span><br><span class="line"><span class="comment">; 定义线段</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-segment</span> start end) (<span class="name"><span class="builtin-name">cons</span></span> start end) )</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">start-segment</span> s) (<span class="name"><span class="builtin-name">car</span></span> s))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">end-segment</span> s) (<span class="name"><span class="builtin-name">cdr</span></span> s))</span><br><span class="line"><span class="comment">; 定义矩形</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-rect</span> s1 s2) (<span class="name"><span class="builtin-name">cons</span></span> s1 s2))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">s1-rect</span> rect) (<span class="name"><span class="builtin-name">car</span></span> rect))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">s2-rect</span> rect) (<span class="name"><span class="builtin-name">cdr</span></span> rect))</span><br><span class="line"><span class="comment">; 计算周长</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">perimeter-rect</span> rect)</span><br><span class="line">  (<span class="name"><span class="builtin-name">+</span></span> (<span class="name"><span class="builtin-name">*</span></span> (<span class="name"><span class="builtin-name">-</span></span> (<span class="name">x-point</span> (<span class="name">end-segment</span> (<span class="name">s1-rect</span> rect))) (<span class="name">x-point</span> (<span class="name">start-segment</span> (<span class="name">s1-rect</span> rect)))) <span class="number">2</span>)</span><br><span class="line">     (<span class="name"><span class="builtin-name">*</span></span> (<span class="name"><span class="builtin-name">-</span></span> (<span class="name">y-point</span> (<span class="name">end-segment</span> (<span class="name">s1-rect</span> rect))) (<span class="name">y-point</span> (<span class="name">end-segment</span> (<span class="name">s2-rect</span> rect)))) <span class="number">2</span>))</span><br><span class="line">)</span><br><span class="line"><span class="comment">; 计算面积</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">erea-rect</span> rect)</span><br><span class="line">  (<span class="name"><span class="builtin-name">*</span></span> (<span class="name"><span class="builtin-name">-</span></span> (<span class="name">x-point</span> (<span class="name">end-segment</span> (<span class="name">s1-rect</span> rect))) (<span class="name">x-point</span> (<span class="name">start-segment</span> (<span class="name">s1-rect</span> rect))))</span><br><span class="line">     (<span class="name"><span class="builtin-name">-</span></span> (<span class="name">y-point</span> (<span class="name">end-segment</span> (<span class="name">s1-rect</span> rect))) (<span class="name">y-point</span> (<span class="name">end-segment</span> (<span class="name">s2-rect</span> rect)))))</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>测试：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> x1 (<span class="name">point</span> <span class="number">0</span> <span class="number">3</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> y1 (<span class="name">point</span> <span class="number">4</span> <span class="number">3</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> x2 (<span class="name">point</span> <span class="number">0</span> <span class="number">0</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> y2 (<span class="name">point</span> <span class="number">4</span> <span class="number">0</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> s1 (<span class="name">make-segment</span> x1 y1))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> s2 (<span class="name">make-segment</span> x2 y2))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> rect (<span class="name">make-rect</span> s1 s2))</span><br><span class="line">(<span class="name">perimeter-rect</span> rect)</span><br><span class="line">(<span class="name">erea-rect</span> rect)</span><br></pre></td></tr></table></figure></p>
<h2 id="数据意味着什么"><a href="#数据意味着什么" class="headerlink" title="数据意味着什么"></a>数据意味着什么</h2><p>(2.1.3 What Is Meant by Data?)</p>
<p>不使用任何数据结构实现<code>cons</code>，<code>adr</code>和<code>cdr</code>：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">cons</span></span> x y)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">=</span></span> m <span class="number">0</span>) x)</span><br><span class="line">          ((<span class="name"><span class="builtin-name">=</span></span> m <span class="number">1</span>) y)</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Argument not 0 or 1: CONS"</span> m))))</span><br><span class="line">  dispatch) <span class="comment">;返回dispatch过程</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">car</span></span> z) (<span class="name">z</span> <span class="number">0</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> z) (<span class="name">z</span> <span class="number">1</span>))</span><br></pre></td></tr></table></figure></p>
<p>在Scheme和Lisp中，序对是直接实现的，并不是采用上面的方式。<br>虽然采用上面的方式效率低，但是这种方式确实是可以工作的。</p>
<p>message passing？？？</p>
<h3 id="Exercise-2-4"><a href="#Exercise-2-4" class="headerlink" title="Exercise 2.4"></a>Exercise 2.4</h3><p>Here is an alternative procedural representation of pairs. For this representation, verify that (car (cons x y)) yields x for any objects x and y.<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">cons</span></span> x y)</span><br><span class="line">  (<span class="name"><span class="builtin-name">lambda</span></span> (m) (<span class="name">m</span> x y)))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">car</span></span> z)</span><br><span class="line">  (<span class="name">z</span> (<span class="name"><span class="builtin-name">lambda</span></span> (p q) p)))</span><br></pre></td></tr></table></figure></p>
<p>What is the corresponding definition of <code>cdr</code>? (Hint: To verify that this works, make use of the substitution model of Section 1.1.5.)<br><strong>答：</strong><br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> z)</span><br><span class="line">  (<span class="name">z</span> (<span class="name"><span class="builtin-name">lambda</span></span> (p q) q)))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-5"><a href="#Exercise-2-5" class="headerlink" title="Exercise 2.5"></a>Exercise 2.5</h3><p>Show that we can represent pairs of nonnegative integers using only numbers and arithmetic operations if we represent the pair a and b as the integer that is the product 2^a3^b . Give the corresponding definitions of the procedures <code>cons</code>, <code>car</code>, and <code>cdr</code>.</p>
<h3 id="Exercise-2-6"><a href="#Exercise-2-6" class="headerlink" title="Exercise 2.6"></a>Exercise 2.6</h3><p>In case representing pairs as procedures wasn’t mind-boggling enough, consider that, in a language that can manipulate procedures, we can get by without numbers (at least insofar as nonnegative integers are concerned) by<br>implementing 0 and the operation of adding 1 as<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> zero (<span class="name"><span class="builtin-name">lambda</span></span> (f) (<span class="name"><span class="builtin-name">lambda</span></span> (x) x)))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">add-1</span> n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">lambda</span></span> (f) (<span class="name"><span class="builtin-name">lambda</span></span> (x) (<span class="name">f</span> ((<span class="name">n</span> f) x)))))</span><br></pre></td></tr></table></figure></p>
<p>This representation is known as Church numerals, after its inventor, Alonzo Church, the logician who invented the λ-calculus.<br>Define one and two directly (not in terms of zero and add-1). (Hint: Use substitution to evaluate (add-1 zero)). Give a direct definition of the addition procedure + (not in terms of repeated application of add-1).</p>
<h2 id="扩展练习：区间算术"><a href="#扩展练习：区间算术" class="headerlink" title="扩展练习：区间算术"></a>扩展练习：区间算术</h2><p>(2.1.4 Extended Exercise: Interval Arithmetic)</p>
<h3 id="Exercise-2-7"><a href="#Exercise-2-7" class="headerlink" title="Exercise 2.7"></a>Exercise 2.7</h3><p>Alyssa’s program is incomplete because she has not specified the implementation of the interval abstraction. Here is a definition of the interval constructor:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-interval</span> a b) (<span class="name"><span class="builtin-name">cons</span></span> a b))</span><br></pre></td></tr></table></figure></p>
<p>Define selectors upper-bound and lower-bound to complete the implementation.</p>
<h3 id="Exercise-2-8"><a href="#Exercise-2-8" class="headerlink" title="Exercise 2.8"></a>Exercise 2.8</h3><p>Using reasoning analogous to Alyssa’s, describe how the difference of two intervals may be computed. Define a corresponding subtraction procedure, called sub-interval.</p>
<h3 id="Exercise-2-9"><a href="#Exercise-2-9" class="headerlink" title="Exercise 2.9"></a>Exercise 2.9</h3><p>The width of an interval is half of the difference between its upper and lower bounds. The width is a measure of the uncertainty of the number specified by the interval. For some arithmetic operations the width of the result of combining two intervals is a function only of the widths of the argument intervals, whereas for others the width of the combination is not a function of the widths of the argument intervals. Show that the width of the sum (or difference) of two intervals is a function only of the widths of the intervals being added (or subtracted). Give examples to show that this is not true for multiplication or division.</p>
<h3 id="Exercise-2-10"><a href="#Exercise-2-10" class="headerlink" title="Exercise 2.10"></a>Exercise 2.10</h3><p>Ben Bitdiddle, an expert systems programmer, looks over Alyssa’s shoulder and comments that it is not clear what it means to divide by an interval that spans zero. Modify Alyssa’s code to check for this condition and to signal an error if it occurs.</p>
<h3 id="Exercise-2-11"><a href="#Exercise-2-11" class="headerlink" title="Exercise 2.11"></a>Exercise 2.11</h3><p>In passing, Ben also cryptically comments: “By testing the signs of the endpoints of the intervals, it is possible to break mul-interval into nine cases, only one of which requires more than two multiplications.” Rewrite this procedure using Ben’s suggestion. After debugging her program, Alyssa shows it to a potential user, who complains that her program solves the wrong problem. He wants a program that can deal with numbers represented as a center value and an additive tolerance; for example, he wants to work with intervals such as 3:50:15 rather than [3.35, 3.65]. Alyssa returns to her desk and fixes this problem by supplying an alternate constructor and alternate selectors:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-center-width</span> c w)</span><br><span class="line">  (<span class="name">make-interval</span> (<span class="name"><span class="builtin-name">-</span></span> c w) (<span class="name"><span class="builtin-name">+</span></span> c w)))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">center</span> i)</span><br><span class="line">  (<span class="name"><span class="builtin-name">/</span></span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">lower-bound</span> i) (<span class="name">upper-bound</span> i)) <span class="number">2</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">width</span> i)</span><br><span class="line">  (<span class="name"><span class="builtin-name">/</span></span> (<span class="name"><span class="builtin-name">-</span></span> (<span class="name">upper-bound</span> i) (<span class="name">lower-bound</span> i)) <span class="number">2</span>))</span><br></pre></td></tr></table></figure></p>
<p>Unfortunately, most of Alyssa’s users are engineers. Real engineering situations usually involve measurements with only a small uncertainty, measured as the ratio of the width of the interval to the midpoint of the interval. Engineers usually specify percentage tolerances on the parameters of devices, as in the resistor specifications given earlier.</p>
<h3 id="Exercise-2-12"><a href="#Exercise-2-12" class="headerlink" title="Exercise 2.12"></a>Exercise 2.12</h3><p>Define a constructor <code>make-center-percent</code> that takes a center and a percentage tolerance and produces the desired interval. You must also define a selector percent that produces the percentage tolerance for a given interval. The center selector is the same as the one shown above.</p>
<h3 id="Exercise-2-13"><a href="#Exercise-2-13" class="headerlink" title="Exercise 2.13"></a>Exercise 2.13</h3><p>Show that under the assumption of small percentage tolerances there is a simple formula for the approximate percentage tolerance of the product of two intervals in terms of the tolerances of the factors. You may simplify the problem by assuming that all numbers are positive. After considerable work, Alyssa P. Hacker delivers her finished system. Several years later, After she has forgotten all about it, she gets a frenzied call from an irate user, Lem E. Tweakit. It seems that Lem has noticed that the formula for parallel resistors can be written in two algebraically equivalent<br>ways:<br>R1R2<br>R1 + R2<br>and<br>1<br>1=R1 + 1=R2<br>:<br>He has written the following two programs, each of which<br>computes the parallel-resistors formula differently:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">par1</span> r1 r2)</span><br><span class="line">  (<span class="name">div-interval</span> (<span class="name">mul-interval</span> r1 r2)</span><br><span class="line">                (<span class="name">add-interval</span> r1 r2)))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">par2</span> r1 r2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">one</span> (<span class="name">make-interval</span> <span class="number">1</span> <span class="number">1</span>)))</span><br><span class="line">    (<span class="name">div-interval</span></span><br><span class="line">     one (<span class="name">add-interval</span> (<span class="name">div-interval</span> one r1)</span><br><span class="line">                       (<span class="name">div-interval</span> one r2)))))</span><br></pre></td></tr></table></figure></p>
<p>Lem complains that Alyssa’s program gives different answers for the two ways of computing. This is a serious complaint.</p>
<h3 id="Exercise-2-14"><a href="#Exercise-2-14" class="headerlink" title="Exercise 2.14"></a>Exercise 2.14</h3><p>Demonstrate that Lem is right. Investigate the behavior of the system on a variety of arithmetic expressions. Make some intervals A and B, and use them in computing the expressions A=A and A=B. You will get the most insight by using intervals whose width is a small percentage of the center value. Examine the results of the computation in center-percent form (see Exercise 2.12).</p>
<h3 id="Exercise-2-15"><a href="#Exercise-2-15" class="headerlink" title="Exercise 2.15"></a>Exercise 2.15</h3><p>Eva Lu Ator, another user, has also noticed the different intervals computed by different but lgebraically equivalent expressions. She says that a formula to compute with intervals using Alyssa’s system will produce tighter error bounds if it can be written in such a form that no variable that represents an uncertain number is repeated. Thus, she says, par2 is a “better” program for parallel resistances than par1. Is she right? Why?</p>
<h3 id="Exercise-2-16"><a href="#Exercise-2-16" class="headerlink" title="Exercise 2.16"></a>Exercise 2.16</h3><p>Explain, in general, why equivalent algebraic expressions may lead to different answers. Can you devise an interval-arithmetic package that does not have this shortcoming, or is this task impossible? (Warning: This problem is very difficult.)</p>
<h1 id="层次性数据和闭包性质"><a href="#层次性数据和闭包性质" class="headerlink" title="层次性数据和闭包性质"></a>层次性数据和闭包性质</h1><p>(2.2 Hierarchical Data and the Closure Property)</p>
<p>序对提供了一种通用的模块，使用该模块可以构建任何类型的数据结构。<br><code>cons</code>具有闭包属性，即：通过<code>cons</code>构造的组合式也可以作为<code>cons</code>的参数。</p>
<p>Scheme的术语”闭包”来自抽象代数。在抽象代数里，一集元素称为在某个运算（操作）之下封闭，如果将该运算应用于这一集合中的元素，产生出的仍然是该集合里的元素。</p>
<p>为什么提出”闭包”的概念？<br>还有那些过程（procedure）满足闭包性质？</p>
<h2 id="序列的表示"><a href="#序列的表示" class="headerlink" title="序列的表示"></a>序列的表示</h2><p>(2.2.1 Representing Sequences)</p>
<p>基于序对可以有多种方式表示序列，其中最直接的一种方式如下图所示：<br><img src="/images/sicp/Figure_2.4.png" alt="基于序对的序列"></p>
<p><code>car</code>：用来获取序列中的元素<br><code>cdr</code>：用来获取序列中的下一个序对(pair)</p>
<p>最后一个序对的<code>cdr</code>是一个特殊的值(nil)，用来标志序对的结束。<br>本质上这种序列是由序对层层嵌套而成，在Scheme中称之为列表(list)。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(cons 1</span><br><span class="line">      (cons 2</span><br><span class="line">            (cons 3</span><br><span class="line">                  (cons 4 nil))))</span><br></pre></td></tr></table></figure></p>
<p>Scheme提供了基本的过程<code>list</code>用来构造列表，语法结构如下：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">list</span></span> &lt;a1&gt; &lt;a2&gt; : : : &lt;an&gt;)</span><br></pre></td></tr></table></figure></p>
<p>该种方式与下面的方式是等价的<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">cons</span></span> &lt;a1&gt;</span><br><span class="line">      (<span class="name"><span class="builtin-name">cons</span></span> &lt;a2&gt;</span><br><span class="line">            (<span class="name"><span class="builtin-name">cons</span></span> : : :</span><br><span class="line">                 (<span class="name"><span class="builtin-name">cons</span></span> &lt;an&gt;</span><br><span class="line">                       nil): : :)))</span><br></pre></td></tr></table></figure></p>
<p>示例：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="列表操作-List-operations"><a href="#列表操作-List-operations" class="headerlink" title="列表操作(List operations)"></a>列表操作(List operations)</h3><p>1、获取列表中的第n个元素<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">list-ref</span></span> items n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> n <span class="number">0</span>)</span><br><span class="line">      (<span class="name"><span class="builtin-name">car</span></span> items)</span><br><span class="line">      (<span class="name"><span class="builtin-name">list-ref</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> items) (<span class="name"><span class="builtin-name">-</span></span> n <span class="number">1</span>))))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> squares (<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> <span class="number">4</span> <span class="number">9</span> <span class="number">16</span> <span class="number">25</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">list-ref</span></span> squares <span class="number">3</span>)</span><br><span class="line"><span class="number">16</span></span><br></pre></td></tr></table></figure></p>
<p>Scheme提供了谓词<code>null?</code>，可用来判断列表是否为空。<br>完善后的<code>list-ref</code>过程：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">list-ref</span></span> items n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> items)</span><br><span class="line">      (<span class="name">error</span> <span class="string">"list is null or 'n' is out of index of the list"</span>)</span><br><span class="line">      (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> n <span class="number">0</span>)</span><br><span class="line">          (<span class="name"><span class="builtin-name">car</span></span> items)</span><br><span class="line">          (<span class="name"><span class="builtin-name">list-ref</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> items) (<span class="name"><span class="builtin-name">-</span></span> n <span class="number">1</span>)))))</span><br></pre></td></tr></table></figure></p>
<p>2、获取列表的长度<br>1) 递归方式<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">length</span></span> items)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> items) <span class="comment">; null?是scheme提过的一个基本谓词(predicate)，用来判断列表是否为空</span></span><br><span class="line">  <span class="number">0</span></span><br><span class="line">  (<span class="name"><span class="builtin-name">+</span></span> <span class="number">1</span> (<span class="name"><span class="builtin-name">length</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> items))))) <span class="comment">; items列表的长度 = 1 + (cdr items)的长度</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> odds (<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> <span class="number">3</span> <span class="number">5</span> <span class="number">7</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">length</span></span> odds)</span><br><span class="line"><span class="number">4</span></span><br></pre></td></tr></table></figure></p>
<p>2) 迭代方式<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">length</span></span> items)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">length-iter</span> a count)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> a)</span><br><span class="line">        count</span><br><span class="line">        (<span class="name">length-iter</span> (<span class="name"><span class="builtin-name">cdr</span></span> a) (<span class="name"><span class="builtin-name">+</span></span> <span class="number">1</span> count))))</span><br><span class="line">  (<span class="name">length-iter</span> items <span class="number">0</span>))</span><br></pre></td></tr></table></figure></p>
<p>3、追加列表<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">append</span></span> list1 list2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> list1)</span><br><span class="line">  list2</span><br><span class="line">  (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">car</span></span> list1) (<span class="name"><span class="builtin-name">append</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> list1) list2))))</span><br></pre></td></tr></table></figure></p>
<p>4、对列表的映射(Mapping over lists)<br>基于给定的factor，改变list中的所有元素。<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">scale-list</span> items factor)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> items)</span><br><span class="line">      nil</span><br><span class="line">      (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">*</span></span> (<span class="name"><span class="builtin-name">car</span></span> items) factor)</span><br><span class="line">            (<span class="name">scale-list</span> (<span class="name"><span class="builtin-name">cdr</span></span> items) factor))))</span><br><span class="line">(<span class="name">scale-list</span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span>) <span class="number">10</span>)</span><br><span class="line">(<span class="name">10</span> <span class="number">20</span> <span class="number">30</span> <span class="number">40</span> <span class="number">50</span>)</span><br></pre></td></tr></table></figure></p>
<p><code>map</code>是Scheme提供的一个高阶过程，它的参数包括一个过程和一个列表。<br>它将过程应用到列表中的每个元素，并返回一个新的列表。<br><code>map</code>的定义大概如下：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">map</span></span> proc items)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> items)</span><br><span class="line">      nil</span><br><span class="line">      (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name">proc</span> (<span class="name"><span class="builtin-name">car</span></span> items))</span><br><span class="line">            (<span class="name"><span class="builtin-name">map</span></span> proc (<span class="name"><span class="builtin-name">cdr</span></span> items)))))</span><br></pre></td></tr></table></figure></p>
<p>在Scheme中，<code>map</code>不必自定义，可以直接使用。<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">map</span></span> abs (<span class="name"><span class="builtin-name">list</span></span> <span class="number">-10</span> <span class="number">2.5</span> <span class="number">-11.6</span> <span class="number">17</span>))</span><br><span class="line">(<span class="name">10</span> <span class="number">2.5</span> <span class="number">11.6</span> <span class="number">17</span>)</span><br><span class="line">(<span class="name"><span class="builtin-name">map</span></span> (<span class="name"><span class="builtin-name">lambda</span></span> (x) (<span class="name"><span class="builtin-name">*</span></span> x x)) (<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span>))</span><br><span class="line">(<span class="name">1</span> <span class="number">4</span> <span class="number">9</span> <span class="number">16</span>)</span><br><span class="line"><span class="comment">;map过程可以指定多个列表</span></span><br><span class="line">(<span class="name"><span class="builtin-name">map</span></span> + (<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span>) (<span class="name"><span class="builtin-name">list</span></span> <span class="number">40</span> <span class="number">50</span> <span class="number">60</span>) (<span class="name"><span class="builtin-name">list</span></span> <span class="number">700</span> <span class="number">800</span> <span class="number">900</span>))</span><br><span class="line">(<span class="name">741</span> <span class="number">852</span> <span class="number">963</span>)</span><br></pre></td></tr></table></figure></p>
<p>重新定义<code>scale-list</code>：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">scale-list</span> items factor)</span><br><span class="line">  (<span class="name"><span class="builtin-name">map</span></span> (<span class="name"><span class="builtin-name">lambda</span></span> (x) (<span class="name"><span class="builtin-name">*</span></span> x factor))</span><br><span class="line">       items))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-17"><a href="#Exercise-2-17" class="headerlink" title="Exercise 2.17"></a>Exercise 2.17</h3><p>Define a procedure last-pair that returns the list that contains only the last element of a given (nonempty) list:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">last-pair</span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">23</span> <span class="number">72</span> <span class="number">149</span> <span class="number">34</span>))</span><br><span class="line">(<span class="name">34</span>)</span><br></pre></td></tr></table></figure></p>
<p>思路一：<br>利用已有的过程list-ref和length（缺点：进行了两次递归）<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">last-pair</span> items)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">length</span></span> items)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> items)</span><br><span class="line">    <span class="number">0</span></span><br><span class="line">    (<span class="name"><span class="builtin-name">+</span></span> <span class="number">1</span> (<span class="name"><span class="builtin-name">length</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> items)))))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">list-ref</span></span> items n)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> n <span class="number">0</span>)</span><br><span class="line">        (<span class="name"><span class="builtin-name">car</span></span> items)</span><br><span class="line">        (<span class="name"><span class="builtin-name">list-ref</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> items) (<span class="name"><span class="builtin-name">-</span></span> n <span class="number">1</span>))))</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> items)</span><br><span class="line">      (<span class="name">error</span> <span class="string">"list is empty"</span>)</span><br><span class="line">      (list-ref items (- (length items) 1)))))</span><br></pre></td></tr></table></figure></p>
<p>思路二：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">last-pair</span> items)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">null?</span></span> items) (<span class="name">error</span> <span class="string">"list is empty"</span>)) <span class="comment">;若itmes为空，则返回错误信息</span></span><br><span class="line">        ((<span class="name"><span class="builtin-name">null?</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> items)) items) <span class="comment">;若itmes只剩一个元素，则返回items</span></span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">last-pair</span> (<span class="name"><span class="builtin-name">cdr</span></span> items)))))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-18"><a href="#Exercise-2-18" class="headerlink" title="Exercise 2.18"></a>Exercise 2.18</h3><p>Define a procedure reverse that takes a list as argument and returns a list of the same elements in reverse order:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">reverse</span></span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> <span class="number">4</span> <span class="number">9</span> <span class="number">16</span> <span class="number">25</span>))</span><br><span class="line">(<span class="name">25</span> <span class="number">16</span> <span class="number">9</span> <span class="number">4</span> <span class="number">1</span>)</span><br></pre></td></tr></table></figure></p>
<p>思路一：<br>利用已有的过程list-ref和length<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">reverse</span></span> items)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">length</span></span> items)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> items)</span><br><span class="line">    <span class="number">0</span></span><br><span class="line">    (<span class="name"><span class="builtin-name">+</span></span> <span class="number">1</span> (<span class="name"><span class="builtin-name">length</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> items)))))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">list-ref</span></span> items n)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> n <span class="number">0</span>)</span><br><span class="line">        (<span class="name"><span class="builtin-name">car</span></span> items)</span><br><span class="line">        (<span class="name"><span class="builtin-name">list-ref</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> items) (<span class="name"><span class="builtin-name">-</span></span> n <span class="number">1</span>))))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">reverse-iter</span> items result n)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> n (<span class="name"><span class="builtin-name">length</span></span> items))</span><br><span class="line">        result</span><br><span class="line">        (<span class="name">reverse-iter</span> items (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">list-ref</span></span> items n) result) (<span class="name"><span class="builtin-name">+</span></span> n <span class="number">1</span>))))</span><br><span class="line">  (<span class="name">reverse-iter</span> items (<span class="name"><span class="builtin-name">list</span></span>) <span class="number">0</span>))</span><br></pre></td></tr></table></figure></p>
<p>思路二：<br>直接使用car和cdr<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">reverse</span></span> items)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">reverse-iter</span> remaind-items result)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> remaind-items)</span><br><span class="line">        result</span><br><span class="line">        (<span class="name">reverse-iter</span> (<span class="name"><span class="builtin-name">cdr</span></span> remaind-items) (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">car</span></span> remaind-items) result))))</span><br><span class="line">  (<span class="name">reverse-iter</span> items (<span class="name"><span class="builtin-name">list</span></span>)))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-19"><a href="#Exercise-2-19" class="headerlink" title="Exercise 2.19"></a>Exercise 2.19</h3><p>Consider the change-counting program of Section 1.2.2. It would be nice to be able to easily change the currency used by the program, so that we could compute the number of ways to change a British pound, for example. As the program is written, the knowledge of the currency is distributed partly into the procedure <code>first-denomination</code> and partly into the procedure <code>count-change</code> (which knows that there are five kinds of U.S. coins). It would be nicer to be able to supply a list of coins to be used for making change.<br>We want to rewrite the procedure cc so that its second argument is a list of the values of the coins to use rather than an integer specifying which coins to use. We could then have lists that defined each kind of currency:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> us-coins (<span class="name"><span class="builtin-name">list</span></span> <span class="number">50</span> <span class="number">25</span> <span class="number">10</span> <span class="number">5</span> <span class="number">1</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> uk-coins (<span class="name"><span class="builtin-name">list</span></span> <span class="number">100</span> <span class="number">50</span> <span class="number">20</span> <span class="number">10</span> <span class="number">5</span> <span class="number">2</span> <span class="number">1</span> <span class="number">0.5</span>))</span><br></pre></td></tr></table></figure></p>
<p>We could then call cc as follows:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">cc</span> <span class="number">100</span> us-coins)</span><br><span class="line"><span class="number">292</span></span><br></pre></td></tr></table></figure></p>
<p>To do this will require changing the program cc somewhat. It will still have the same form, but it will access its second argument differently, as follows:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">cc</span> amount coin-values)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">=</span></span> amount <span class="number">0</span>) <span class="number">1</span>)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">or</span></span> (<span class="name"><span class="builtin-name">&lt;</span></span> amount <span class="number">0</span>) (<span class="name">no-more?</span> coin-values)) <span class="number">0</span>)</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span></span><br><span class="line">          (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">cc</span> amount</span><br><span class="line">                 (<span class="name">except-first-denomination</span></span><br><span class="line">                 coin-values))</span><br><span class="line">             (<span class="name">cc</span> (<span class="name"><span class="builtin-name">-</span></span> amount</span><br><span class="line">                    (<span class="name">first-denomination</span></span><br><span class="line">                    coin-values))</span><br><span class="line">                 coin-values)))))</span><br></pre></td></tr></table></figure></p>
<p>Define the procedures <code>first-denomination</code>, <code>except-firstdenomination</code>, and <code>no-more?</code> in terms of primitive operations on list structures. Does the order of the list coinvalues affect the answer produced by cc? Why or why not?</p>
<h3 id="Exercise-2-20"><a href="#Exercise-2-20" class="headerlink" title="Exercise 2.20"></a>Exercise 2.20</h3><p>The procedures +, *, and list take arbitrary numbers of arguments. One way to define such procedures is to use define with dotted-tail notation. In a procedure definition, a parameter list that has a dot before the last parameter name indicates that, when the procedure is called, the initial parameters (if any) will have as values the initial arguments, as usual, but the final parameter’s value will be<br>a list of any remaining arguments. For instance, given the definition<br>(define (f x y . z) ⟨body⟩)<br>the procedure f can be called with two or more arguments.<br>If we evaluate<br>(f 1 2 3 4 5 6)<br>then in the body of f, x will be 1, y will be 2, and z will be the list (3 4 5 6). Given the definition<br>(define (g . w) ⟨body⟩)<br>the procedure g can be called with zero or more arguments.<br>If we evaluate<br>(g 1 2 3 4 5 6)<br>then in the body of g, w will be the list (1 2 3 4 5 6). Use this notation to write a procedure same-parity that takes one or more integers and returns a list of all the arguments that have the same even-odd parity as the first argument. For example,<br>(same-parity 1 2 3 4 5 6 7)<br>(1 3 5 7)<br>(same-parity 2 3 4 5 6 7)<br>(2 4 6)</p>
<h3 id="Exercise-2-21"><a href="#Exercise-2-21" class="headerlink" title="Exercise 2.21"></a>Exercise 2.21</h3><p>The procedure square-list takes a list of numbers as argument and returns a list of the squares of those numbers.<br>(square-list (list 1 2 3 4))<br>(1 4 9 16)<br>Here are two different definitions of square-list. Complete both of them by filling in the missing expressions:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">square-list</span> items)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> items)</span><br><span class="line">      nil</span><br><span class="line">      (<span class="name"><span class="builtin-name">cons</span></span> ⟨??⟩ ⟨??⟩)))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">square-list</span> items)</span><br><span class="line">  (<span class="name"><span class="builtin-name">map</span></span> ⟨??⟩ ⟨??⟩))</span><br></pre></td></tr></table></figure></p>
<p><strong>答：</strong><br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">square-list</span> items)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> items)</span><br><span class="line">      nil <span class="comment">;Unbound variable: nil</span></span><br><span class="line">      (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name">square</span> (<span class="name"><span class="builtin-name">car</span></span> items)) (<span class="name">square-list</span> (<span class="name"><span class="builtin-name">cdr</span></span> items)))))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">square-list</span> items)</span><br><span class="line">  (<span class="name"><span class="builtin-name">map</span></span> square items))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-22"><a href="#Exercise-2-22" class="headerlink" title="Exercise 2.22"></a>Exercise 2.22</h3><p>Louis Reasoner tries to rewrite the first squarelist procedure of Exercise 2.21 so that it evolves an iterative process:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">square-list</span> items)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">iter</span> things answer)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> things)</span><br><span class="line">        answer</span><br><span class="line">        (<span class="name">iter</span> (<span class="name"><span class="builtin-name">cdr</span></span> things)</span><br><span class="line">              (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name">square</span> (<span class="name"><span class="builtin-name">car</span></span> things))</span><br><span class="line">                    answer))))</span><br><span class="line">  (<span class="name">iter</span> items nil))</span><br></pre></td></tr></table></figure></p>
<p>Unfortunately, defining <code>square-list</code> this way produces the answer list in the reverse order of the one desired. Why?<br>Louis then tries to fix his bug by interchanging the arguments to cons:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">square-list</span> items)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">iter</span> things answer)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> things)</span><br><span class="line">        answer</span><br><span class="line">        (<span class="name">iter</span> (<span class="name"><span class="builtin-name">cdr</span></span> things)</span><br><span class="line">              (<span class="name"><span class="builtin-name">cons</span></span> answer</span><br><span class="line">                    (<span class="name">square</span> (<span class="name"><span class="builtin-name">car</span></span> things))))))</span><br><span class="line">(<span class="name">iter</span> items nil))</span><br></pre></td></tr></table></figure></p>
<p>This doesn’t work either. Explain.</p>
<h3 id="Exercise-2-23"><a href="#Exercise-2-23" class="headerlink" title="Exercise 2.23"></a>Exercise 2.23</h3><p>The procedure for-each is similar to map. It takes as arguments a procedure and a list of elements. However, rather than forming a list of the results, for-each just applies the procedure to each of the elements in turn, from left to right. The values returned by applying the procedure to the elements are not used at all—for-each is used with procedures that perform an action, such as printing. For example,<br>(for-each (lambda (x)<br>            (newline)<br>            (display x))<br>          (list 57 321 88))<br>57<br>321<br>88<br>The value returned by the call to for-each (not illustrated above) can be something arbitrary, such as true. Give an implementation of for-each.</p>
<h2 id="层次性结构"><a href="#层次性结构" class="headerlink" title="层次性结构"></a>层次性结构</h2><p>(2.2.2 Hierarchical Structures)</p>
<p>过程<code>length</code>和<code>count-leaves</code>对比：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> x (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> <span class="number">2</span>) (<span class="name"><span class="builtin-name">list</span></span> <span class="number">3</span> <span class="number">4</span>)))</span><br><span class="line">(<span class="name"><span class="builtin-name">length</span></span> x)</span><br><span class="line"><span class="number">3</span></span><br><span class="line">(<span class="name">count-leaves</span> x)</span><br><span class="line"><span class="number">4</span></span><br><span class="line">(<span class="name"><span class="builtin-name">list</span></span> x x)</span><br><span class="line">(((<span class="name">1</span> <span class="number">2</span>) <span class="number">3</span> <span class="number">4</span>) ((<span class="name">1</span> <span class="number">2</span>) <span class="number">3</span> <span class="number">4</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">length</span></span> (<span class="name"><span class="builtin-name">list</span></span> x x))</span><br><span class="line"><span class="number">2</span></span><br><span class="line">(<span class="name">count-leaves</span> (<span class="name"><span class="builtin-name">list</span></span> x x))</span><br><span class="line"><span class="number">8</span></span><br></pre></td></tr></table></figure></p>
<p>Scheme提供了一个基础谓词<code>pair?</code>，用来判断某个数据是否是序对：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">count-leaves</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">null?</span></span> x) <span class="number">0</span>)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">not</span></span> (<span class="name"><span class="builtin-name">pair?</span></span> x)) <span class="number">1</span>)</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">count-leaves</span> (<span class="name"><span class="builtin-name">car</span></span> x))</span><br><span class="line">                 (<span class="name">count-leaves</span> (<span class="name"><span class="builtin-name">cdr</span></span> x))))))</span><br></pre></td></tr></table></figure></p>
<p><code>对树的映射(Mapping over trees)</code></p>
<p>过程<code>scale-tree</code>的实现。</p>
<p>实现一：递归<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">scale-tree</span> tree factor)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">null?</span></span> tree) nil)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">not</span></span> (<span class="name"><span class="builtin-name">pair?</span></span> tree)) (<span class="name"><span class="builtin-name">*</span></span> tree factor))</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name">scale-tree</span> (<span class="name"><span class="builtin-name">car</span></span> tree) factor)</span><br><span class="line">                    (<span class="name">scale-tree</span> (<span class="name"><span class="builtin-name">cdr</span></span> tree) factor)))))</span><br><span class="line">(<span class="name">scale-tree</span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">2</span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">3</span> <span class="number">4</span>) <span class="number">5</span>) (<span class="name"><span class="builtin-name">list</span></span> <span class="number">6</span> <span class="number">7</span>)) <span class="number">10</span>)</span><br></pre></td></tr></table></figure></p>
<p>实现二：将树看成是由子树构成的序列，并使用<code>map</code><br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">scale-tree</span> tree factor)</span><br><span class="line">  (<span class="name"><span class="builtin-name">map</span></span> (<span class="name"><span class="builtin-name">lambda</span></span> (sub-tree)</span><br><span class="line">         (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">pair?</span></span> sub-tree)</span><br><span class="line">             (<span class="name">scale-tree</span> sub-tree factor)</span><br><span class="line">             (<span class="name"><span class="builtin-name">*</span></span> sub-tree factor)))</span><br><span class="line">        tree))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-24"><a href="#Exercise-2-24" class="headerlink" title="Exercise 2.24"></a>Exercise 2.24</h3><p>Suppose we evaluate the expression (list 1 (list 2 (list 3 4))). Give the result printed by the interpreter, the corresponding box-and-pointer structure, and the interpretation of this as a tree (as in Figure 2.6).</p>
<p><img src="/images/sicp/Exercise_2.24.png" alt></p>
<h3 id="Exercise-2-25"><a href="#Exercise-2-25" class="headerlink" title="Exercise 2.25"></a>Exercise 2.25</h3><p>Give combinations of cars and cdrs that will pick 7 from each of the following lists:<br>(1 3 (5 7) 9)<br>((7))<br>(1 (2 (3 (4 (5 (6 7))))))</p>
<p><strong>答：</strong><br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> li (<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> <span class="number">3</span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">5</span> <span class="number">7</span>) <span class="number">9</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">cdr</span></span> (<span class="name"><span class="builtin-name">car</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> li))))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> li (<span class="name"><span class="builtin-name">list</span></span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">7</span>)))</span><br><span class="line">(<span class="name"><span class="builtin-name">car</span></span> li)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> li (<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">2</span> ( list <span class="number">3</span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">4</span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">5</span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">6</span> <span class="number">7</span>)))))))</span><br><span class="line">(<span class="name"><span class="builtin-name">cdr</span></span> (<span class="name"><span class="builtin-name">car</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> (<span class="name"><span class="builtin-name">car</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> (<span class="name"><span class="builtin-name">car</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> (<span class="name"><span class="builtin-name">car</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> (<span class="name"><span class="builtin-name">car</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> li)))))))))))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-26"><a href="#Exercise-2-26" class="headerlink" title="Exercise 2.26"></a>Exercise 2.26</h3><p>Suppose we define x and y to be two lists:<br>(define x (list 1 2 3))<br>(define y (list 4 5 6))<br>What result is printed by the interpreter in response to evaluating each of the following expressions:<br>(append x y)<br>(cons x y)<br>(list x y)</p>
<p><strong>答：</strong><br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span>)</span><br><span class="line">((<span class="name">1</span> <span class="number">2</span> <span class="number">3</span>) <span class="number">4</span> <span class="number">5</span> <span class="number">6</span>) <span class="comment">;???</span></span><br><span class="line">((<span class="name">1</span> <span class="number">2</span> <span class="number">3</span>) (<span class="name">4</span> <span class="number">5</span> <span class="number">6</span>))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-27"><a href="#Exercise-2-27" class="headerlink" title="Exercise 2.27"></a>Exercise 2.27</h3><p>Modify your reverse procedure of Exercise 2.18 to produce a deep-reverse procedure that takes a list as argument and returns as its value the list with its elements reversed and with all sublists deep-reversed as well.<br>For example,<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> x (<span class="name"><span class="builtin-name">list</span></span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> <span class="number">2</span>) (<span class="name"><span class="builtin-name">list</span></span> <span class="number">3</span> <span class="number">4</span>)))</span><br><span class="line">x</span><br><span class="line">((<span class="name">1</span> <span class="number">2</span>) (<span class="name">3</span> <span class="number">4</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">reverse</span></span> x)</span><br><span class="line">((<span class="name">3</span> <span class="number">4</span>) (<span class="name">1</span> <span class="number">2</span>))</span><br><span class="line">(<span class="name">deep-reverse</span> x)</span><br><span class="line">((<span class="name">4</span> <span class="number">3</span>) (<span class="name">2</span> <span class="number">1</span>))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-28"><a href="#Exercise-2-28" class="headerlink" title="Exercise 2.28"></a>Exercise 2.28</h3><p>Write a procedure fringe that takes as argument a tree (represented as a list) and returns a list whose elements are all the leaves of the tree arranged in left-to-right order. For example,<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> x (<span class="name"><span class="builtin-name">list</span></span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> <span class="number">2</span>) (<span class="name"><span class="builtin-name">list</span></span> <span class="number">3</span> <span class="number">4</span>)))</span><br><span class="line">(<span class="name">fringe</span> x)</span><br><span class="line">(<span class="name">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span>)</span><br><span class="line">(<span class="name">fringe</span> (<span class="name"><span class="builtin-name">list</span></span> x x))</span><br><span class="line">(<span class="name">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-29"><a href="#Exercise-2-29" class="headerlink" title="Exercise 2.29"></a>Exercise 2.29</h3><p>A binary mobile consists of two branches,a left branch and a right branch. Each branch is a rod of a certain length, from which hangs either a weight or another binary mobile. We can represent a binary mobile using compound data by constructing it from two branches (for example, using list):<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-mobile</span> left right)</span><br><span class="line">  (<span class="name"><span class="builtin-name">list</span></span> left right))</span><br></pre></td></tr></table></figure></p>
<p>A branch is constructed from a length (which must be a number) together with a structure, which may be either a number (representing a simple weight) or another mobile:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-branch</span> length structure)</span><br><span class="line">  (<span class="name"><span class="builtin-name">list</span></span> length structure))</span><br></pre></td></tr></table></figure></p>
<p>a. Write the corresponding selectors <code>left-branch</code> and <code>right-branch</code>, which return the branches of a mobile, and <code>branch-length</code> and <code>branch-structure</code>, which return he components of a branch.<br>b. Using your selectors, define a procedure <code>total-weight</code> that returns the total weight of a mobile.<br>c. A mobile is said to be balanced if the torque applied by its top-left branch is equal to that applied by its top-right branch (that is, if the length of the left rod multiplied by the weight hanging from that rod is equal to the corresponding product for the right side) and if each of the submobiles hanging off its branches is balanced. Design a predicate that tests whether a binary obile is balanced.<br>d. Suppose we change the representation of mobiles so that the constructors are<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-mobile</span> left right) (<span class="name"><span class="builtin-name">cons</span></span> left right))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-branch</span> length structure)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cons</span></span> length structure))</span><br></pre></td></tr></table></figure></p>
<p>How much do you need to change your programs to convert to the new representation?</p>
<h3 id="Exercise-2-30"><a href="#Exercise-2-30" class="headerlink" title="Exercise 2.30"></a>Exercise 2.30</h3><p>Define a procedure square-tree analogous to the square-list procedure of Exercise 2.21. That is, squaretree should behave as follows:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">square-tree</span></span><br><span class="line">  (<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span></span><br><span class="line">        (<span class="name"><span class="builtin-name">list</span></span> <span class="number">2</span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">3</span> <span class="number">4</span>) <span class="number">5</span>)</span><br><span class="line">        (<span class="name"><span class="builtin-name">list</span></span> <span class="number">6</span> <span class="number">7</span>)))</span><br><span class="line">(<span class="name">1</span> (<span class="name">4</span> (<span class="name">9</span> <span class="number">16</span>) <span class="number">25</span>) (<span class="name">36</span> <span class="number">49</span>))</span><br></pre></td></tr></table></figure></p>
<p>Define square-tree both directly (i.e., without using any higher-order procedures) and also by using map and recursion.</p>
<h3 id="Exercise-2-31"><a href="#Exercise-2-31" class="headerlink" title="Exercise 2.31"></a>Exercise 2.31</h3><p>Abstract your answer to Exercise 2.30 to produce a procedure tree-map with the property that squaretree<br>could be defined as<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">square-tree</span> tree) (<span class="name">tree-map</span> square tree))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-32"><a href="#Exercise-2-32" class="headerlink" title="Exercise 2.32"></a>Exercise 2.32</h3><p>We can represent a set as a list of distinct elements, and we can represent the set of all subsets of the set as a list of lists. For example, if the set is (1 2 3), then the set of all subsets is (() (3) (2) (2 3) (1) (1 3) (1 2) (1 2 3)). Complete the following definition of a procedure that generates the set of subsets of a set and give a clear explanation of why it works:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">subsets</span> s)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> s)</span><br><span class="line">      (<span class="name"><span class="builtin-name">list</span></span> nil)</span><br><span class="line">      (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">rest</span> (<span class="name">subsets</span> (<span class="name"><span class="builtin-name">cdr</span></span> s))))</span><br><span class="line">        (<span class="name"><span class="builtin-name">append</span></span> rest (<span class="name"><span class="builtin-name">map</span></span> ⟨??⟩ rest)))))</span><br></pre></td></tr></table></figure></p>
<h2 id="序列作为一种约定的接口"><a href="#序列作为一种约定的接口" class="headerlink" title="序列作为一种约定的接口"></a>序列作为一种约定的接口</h2><p>(2.2.3 Sequences as Conventional Interfaces)</p>
<p>强大的设计原则：约定的接口。</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 计算奇数叶子的平方和</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sum-odd-squares</span> tree)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">null?</span></span> tree) <span class="number">0</span>)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">not</span></span> (<span class="name"><span class="builtin-name">pair?</span></span> tree))</span><br><span class="line">         (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">odd?</span></span> tree) (<span class="name">square</span> tree) <span class="number">0</span>))</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">sum-odd-squares</span> (<span class="name"><span class="builtin-name">car</span></span> tree))</span><br><span class="line">                 (<span class="name">sum-odd-squares</span> (<span class="name"><span class="builtin-name">cdr</span></span> tree))))))</span><br><span class="line"></span><br><span class="line"><span class="comment">; 构造斐波纳契数列中偶数的列表</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">even-fibs</span> n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">next</span> k)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;</span></span> k n)</span><br><span class="line">        nil</span><br><span class="line">        (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">f</span> (<span class="name">fib</span> k)))</span><br><span class="line">          (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">even?</span></span> f)</span><br><span class="line">              (<span class="name"><span class="builtin-name">cons</span></span> f (<span class="name">next</span> (<span class="name"><span class="builtin-name">+</span></span> k <span class="number">1</span>)))</span><br><span class="line">              (<span class="name">next</span> (<span class="name"><span class="builtin-name">+</span></span> k <span class="number">1</span>))))))</span><br><span class="line">  (<span class="name">next</span> <span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<p>从表面上看，上面两个过程并没有相同之处。但是，两个过程的处理步骤却有相似之处，如下图所示：<br><img src="/images/sicp/Figure_2.7.png" alt><br>信号流结构<br>但是两个过程的逻辑并不是这样清晰的划分为四个步骤，而是混在一起的。如果我们能够按照图中的逻辑来编程，那么程序将会更清晰易懂。</p>
<p><strong>序列操作(Sequence operations)</strong><br>若要按照信号流结构来编程，关键是在”信号”上。假如我们使用列表用作信号，即每个步骤的输入和输出都是一个列表。那么，我们就可以使用列表的相关操作来实现每个步骤。<br><img src="/images/sicp/list-flow.png" alt></p>
<p><code>map</code>过程：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">map</span></span> square (<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span>))</span><br></pre></td></tr></table></figure></p>
<p>Scheme提供了<code>map</code>过程，我们不用额外定义。</p>
<p><code>filter</code>过程：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 根据指定的谓词过滤一个序列</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> nil ()) <span class="comment">; nil需要定义？？？</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">filter</span> predicate sequence)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">null?</span></span> sequence) nil)</span><br><span class="line">        ((<span class="name">predicate</span> (<span class="name"><span class="builtin-name">car</span></span> sequence))</span><br><span class="line">         (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">car</span></span> sequence)</span><br><span class="line">               (<span class="name">filter</span> predicate (<span class="name"><span class="builtin-name">cdr</span></span> sequence))))</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">filter</span> predicate (<span class="name"><span class="builtin-name">cdr</span></span> sequence)))))</span><br><span class="line">(<span class="name">filter</span> odd? (<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span>))</span><br></pre></td></tr></table></figure></p>
<p><code>accumulate</code>过程：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">accumulate</span> op initial sequence)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> sequence)</span><br><span class="line">      initial</span><br><span class="line">      (<span class="name">op</span> (<span class="name"><span class="builtin-name">car</span></span> sequence)</span><br><span class="line">          (<span class="name">accumulate</span> op initial (<span class="name"><span class="builtin-name">cdr</span></span> sequence)))))</span><br><span class="line"></span><br><span class="line">(<span class="name">accumulate</span> + <span class="number">0</span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span>))</span><br><span class="line">(<span class="name">accumulate</span> * <span class="number">1</span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span>))</span><br><span class="line">(<span class="name">accumulate</span> cons nil (<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span>))</span><br></pre></td></tr></table></figure></p>
<p><code>enumerate</code>过程：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 生成给定区间内的整数序列</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">enumerate-interval</span> low high)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;</span></span> low high)</span><br><span class="line">      nil</span><br><span class="line">      (<span class="name"><span class="builtin-name">cons</span></span> low (<span class="name">enumerate-interval</span> (<span class="name"><span class="builtin-name">+</span></span> low <span class="number">1</span>) high))))</span><br><span class="line">(<span class="name">enumerate-interval</span> <span class="number">2</span> <span class="number">7</span>)</span><br><span class="line"><span class="comment">; 列举树的所有叶子节点</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">enumerate-tree</span> tree)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">null?</span></span> tree) nil)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">not</span></span> (<span class="name"><span class="builtin-name">pair?</span></span> tree)) (<span class="name"><span class="builtin-name">list</span></span> tree))</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name"><span class="builtin-name">append</span></span> (<span class="name">enumerate-tree</span> (<span class="name"><span class="builtin-name">car</span></span> tree))</span><br><span class="line">                      (<span class="name">enumerate-tree</span> (<span class="name"><span class="builtin-name">cdr</span></span> tree))))))</span><br><span class="line">(<span class="name">enumerate-tree</span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">2</span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">3</span> <span class="number">4</span>)) <span class="number">5</span>))</span><br></pre></td></tr></table></figure></p>
<p>重新定义：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 重新定义sum-odd-squares</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sum-odd-squares</span> tree)</span><br><span class="line">  (<span class="name">accumulate</span></span><br><span class="line">   + <span class="number">0</span> (<span class="name"><span class="builtin-name">map</span></span> square (<span class="name">filter</span> odd? (<span class="name">enumerate-tree</span> tree)))))</span><br><span class="line"><span class="comment">; 重新定义even-fibs</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">even-fibs</span> n)</span><br><span class="line">  (<span class="name">accumulate</span> cons</span><br><span class="line">              nil</span><br><span class="line">              (<span class="name">filter</span> even? (<span class="name"><span class="builtin-name">map</span></span> fib (<span class="name">enumerate-interval</span> <span class="number">0</span> n)))))</span><br></pre></td></tr></table></figure></p>
<p>在工程设计中，结构模块化是一种用来控制程序复杂性的强大策略。<br>在实际应用开发中，这些定义的”模块”可以复用。例如下面的例子：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 前n+1斐波纳契数的平方和</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">list-fib-squares</span> n)</span><br><span class="line">  (<span class="name">accumulate</span> cons</span><br><span class="line">              nil</span><br><span class="line">              (<span class="name"><span class="builtin-name">map</span></span> square (<span class="name"><span class="builtin-name">map</span></span> fib (<span class="name">enumerate-interval</span> <span class="number">0</span> n)))))</span><br><span class="line">(<span class="name">list-fib-squares</span> <span class="number">10</span>)</span><br><span class="line">(<span class="name">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">4</span> <span class="number">9</span> <span class="number">25</span> <span class="number">64</span> <span class="number">169</span> <span class="number">441</span> <span class="number">1156</span> <span class="number">3025</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">; 序列中所有奇数平方之积</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">product-of-squares-of-odd-elements</span> sequence)</span><br><span class="line">  (<span class="name">accumulate</span> * <span class="number">1</span> (<span class="name"><span class="builtin-name">map</span></span> square (<span class="name">filter</span> odd? sequence))))</span><br><span class="line">(<span class="name">product-of-squares-of-odd-elements</span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span>))</span><br><span class="line"><span class="number">255</span></span><br></pre></td></tr></table></figure></p>
<p>; 找出程序员的最高工资<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">salary-of-highest-paid-programmer</span> records)</span><br><span class="line">  (<span class="name">accumulate</span> max <span class="number">0</span> (<span class="name"><span class="builtin-name">map</span></span> salary (<span class="name">filter</span> programmer? records))))</span><br></pre></td></tr></table></figure></p>
<p><strong>嵌套映射(Nested mappings)</strong><br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">accumulate</span> append</span><br><span class="line">            nil</span><br><span class="line">            (<span class="name"><span class="builtin-name">map</span></span> (<span class="name"><span class="builtin-name">lambda</span></span> (i)</span><br><span class="line">                   (<span class="name"><span class="builtin-name">map</span></span> (<span class="name"><span class="builtin-name">lambda</span></span> (j) (<span class="name"><span class="builtin-name">list</span></span> i j))</span><br><span class="line">                        (<span class="name">enumerate-interval</span> <span class="number">1</span> (<span class="name"><span class="builtin-name">-</span></span> i <span class="number">1</span>))))</span><br><span class="line">                 (<span class="name">enumerate-interval</span> <span class="number">1</span> n)))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">flatmap</span> proc seq)</span><br><span class="line">  (<span class="name">accumulate</span> append nil (<span class="name"><span class="builtin-name">map</span></span> proc seq)))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">prime-sum?</span> pair)</span><br><span class="line">  (<span class="name">prime?</span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name"><span class="builtin-name">car</span></span> pair) (<span class="name"><span class="builtin-name">cadr</span></span> pair))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-pair-sum</span> pair)</span><br><span class="line">  (<span class="name"><span class="builtin-name">list</span></span> (<span class="name"><span class="builtin-name">car</span></span> pair) (<span class="name"><span class="builtin-name">cadr</span></span> pair) (<span class="name"><span class="builtin-name">+</span></span> (<span class="name"><span class="builtin-name">car</span></span> pair) (<span class="name"><span class="builtin-name">cadr</span></span> pair))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">prime-sum-pairs</span> n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">map</span></span> make-pair-sum</span><br><span class="line">       (<span class="name">filter</span> prime-sum?</span><br><span class="line">               (<span class="name">flatmap</span></span><br><span class="line">                (<span class="name"><span class="builtin-name">lambda</span></span> (i)</span><br><span class="line">                  (<span class="name"><span class="builtin-name">map</span></span> (<span class="name"><span class="builtin-name">lambda</span></span> (j) (<span class="name"><span class="builtin-name">list</span></span> i j))</span><br><span class="line">                       (<span class="name">enumerate-interval</span> <span class="number">1</span> (<span class="name"><span class="builtin-name">-</span></span> i <span class="number">1</span>))))</span><br><span class="line">                (<span class="name">enumerate-interval</span> <span class="number">1</span> n)))))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">permutations</span> s)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> s)                         <span class="comment">; empty set?</span></span><br><span class="line">      (<span class="name"><span class="builtin-name">list</span></span> nil)                        <span class="comment">; sequence containing empty set</span></span><br><span class="line">      (<span class="name">flatmap</span> (<span class="name"><span class="builtin-name">lambda</span></span> (x)</span><br><span class="line">                 (<span class="name"><span class="builtin-name">map</span></span> (<span class="name"><span class="builtin-name">lambda</span></span> (p) (<span class="name"><span class="builtin-name">cons</span></span> x p))</span><br><span class="line">                      (<span class="name">permutations</span> (<span class="name">remove</span> x s))))</span><br><span class="line">               s)))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">remove</span> item sequence)</span><br><span class="line">  (<span class="name">filter</span> (<span class="name"><span class="builtin-name">lambda</span></span> (x) (<span class="name"><span class="builtin-name">not</span></span> (<span class="name"><span class="builtin-name">=</span></span> x item)))</span><br><span class="line">          sequence))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-33"><a href="#Exercise-2-33" class="headerlink" title="Exercise 2.33"></a>Exercise 2.33</h3><p>Fill in the missing expressions to complete the following definitions of some basic list-manipulation operations as accumulations:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">map</span></span> p sequence)</span><br><span class="line">  (<span class="name">accumulate</span> (<span class="name"><span class="builtin-name">lambda</span></span> (x y) ⟨??⟩) nil sequence))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">append</span></span> seq1 seq2)</span><br><span class="line">  (<span class="name">accumulate</span> cons ⟨??⟩ ⟨??⟩))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">length</span></span> sequence)</span><br><span class="line">  (<span class="name">accumulate</span> ⟨??⟩ <span class="number">0</span> sequence))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-34"><a href="#Exercise-2-34" class="headerlink" title="Exercise 2.34"></a>Exercise 2.34</h3><p>Evaluating a polynomial in x at a given value of x can be formulated as an accumulation. We evaluate the polynomial<br>anxn + an􀀀1xn􀀀1 +    + a1x + a0<br>using a well-known algorithm called Horner’s rule, which structures the computation as<br>(: : : (anx + an􀀀1)x +    + a1)x + a0:<br>In other words, we start with an, multiply by x, add an􀀀1, multiply by x, and so on, until we reach a0.<br>Fill in the following template to produce a procedure that evaluates a polynomial using Horner’s rule. Assume that<br>the coefficients of the polynomial are arranged in a sequence, from a0 through an.<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">horner-eval</span> x coefficient-sequence)</span><br><span class="line">  (<span class="name">accumulate</span> (<span class="name"><span class="builtin-name">lambda</span></span> (this-coeff higher-terms) ⟨??⟩)</span><br><span class="line">              <span class="number">0</span></span><br><span class="line">              coefficient-sequence))</span><br></pre></td></tr></table></figure></p>
<p>For example, to compute 1+3x +5x3 +x5 at x = 2 you would evaluate<br>(horner-eval 2 (list 1 3 0 5 0 1))</p>
<h3 id="Exercise-2-35"><a href="#Exercise-2-35" class="headerlink" title="Exercise 2.35"></a>Exercise 2.35</h3><p>Redefine count-leaves from Section 2.2.2 as an accumulation:<br>(define (count-leaves t)<br>  (accumulate ⟨??⟩ ⟨??⟩ (map ⟨??⟩ ⟨??⟩)))</p>
<h3 id="Exercise-2-36"><a href="#Exercise-2-36" class="headerlink" title="Exercise 2.36"></a>Exercise 2.36</h3><p>The procedure <code>accumulate-n</code> is similar to accumulate except that it takes as its third argument a sequence of sequences, which are all assumed to have the same number of elements. It applies the designated accumulation procedure to combine all the first elements of the sequences, all the second elements of the sequences, and so on, and returns a sequence of the results. For instance, if s is a sequence containing four sequences, ((1 2 3) (4 5 6) (7 8 9) (10 11 12)), then the value of (accumulate-n + 0 s) should be the sequence (22 26 30). Fill in the missing expressions in the following definition of accumulate-n:<br>(define (accumulate-n op init seqs)<br>  (if (null? (car seqs))<br>      nil<br>      (cons (accumulate op init ⟨??⟩)<br>            (accumulate-n op init ⟨??⟩))))</p>
<h3 id="Exercise-2-37"><a href="#Exercise-2-37" class="headerlink" title="Exercise 2.37"></a>Exercise 2.37</h3><p>Suppose we represent vectors v = (vi ) as sequences of numbers, and matrices m = (mij ) as sequences<br>of vectors (the rows of the matrix). For example, the matrix<br>0BBBBBBBB@<br>1 2 3 4<br>4 5 6 6<br>6 7 8 9<br>1CCCCCCCCA<br>is represented as the sequence ((1 2 3 4) (4 5 6 6) (6 7 8 9)). With this representation, we can use sequence operations to concisely express the basic matrix and vector operations. ese operations (which are described in any book on matrix algebra) are the following:<br>(dot-product v w) returns the sum iviwi ;<br>(matrix-<em>-vector m v) returns the vector t;<br>where ti = jmijvj ;<br>(matrix-</em>-matrix m n) returns the matrix p;<br>where pij = kmiknkj ;<br>(transpose m) returns the matrix n;<br>where nij = mji :</p>
<p>We can define the dot product as<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dot-product</span> v w)</span><br><span class="line">  (<span class="name">accumulate</span> + <span class="number">0</span> (<span class="name"><span class="builtin-name">map</span></span> * v w)))</span><br></pre></td></tr></table></figure></p>
<p>Fill in the missing expressions in the following procedures for computing the other matrix operations. (The procedure <code>accumulate-n</code> is defined in Exercise 2.36.)<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">matrix-*-vector</span> m v)</span><br><span class="line">  (<span class="name"><span class="builtin-name">map</span></span> ⟨??⟩ m))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">transpose</span> mat)</span><br><span class="line">  (<span class="name">accumulate-n</span> ⟨??⟩ ⟨??⟩ mat))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">matrix-*-matrix</span> m n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">cols</span> (<span class="name">transpose</span> n)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">map</span></span> ⟨??⟩ m)))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-38"><a href="#Exercise-2-38" class="headerlink" title="Exercise 2.38"></a>Exercise 2.38</h3><p>The accumulate procedure is also known as fold-right, because it combines the first element of the sequence with the result of combining all the elements to the right. There is also a fold-left, which is similar to foldright, except that it combines elements working in the opposite direction:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">fold-left</span> op initial sequence)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">iter</span> result rest)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> rest)</span><br><span class="line">    result</span><br><span class="line">    (<span class="name">iter</span> (<span class="name">op</span> result (<span class="name"><span class="builtin-name">car</span></span> rest))</span><br><span class="line">          (<span class="name"><span class="builtin-name">cdr</span></span> rest))))</span><br><span class="line">  (<span class="name">iter</span> initial sequence))</span><br></pre></td></tr></table></figure></p>
<p>What are the values of<br>(fold-right / 1 (list 1 2 3))<br>(fold-left / 1 (list 1 2 3))<br>(fold-right list nil (list 1 2 3))<br>(fold-left list nil (list 1 2 3))<br>Give a property that op should satisfy to guarantee that fold-right and fold-left will produce the same values for any sequence.</p>
<h3 id="Exercise-2-39"><a href="#Exercise-2-39" class="headerlink" title="Exercise 2.39"></a>Exercise 2.39</h3><p>Complete the following definitions of reverse (Exercise 2.18) in terms of fold-right and fold-left from Exercise 2.38<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">reverse</span></span> sequence)</span><br><span class="line">  (<span class="name">fold-right</span> (<span class="name"><span class="builtin-name">lambda</span></span> (x y) ⟨??⟩) nil sequence))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">reverse</span></span> sequence)</span><br><span class="line">  (<span class="name">fold-left</span> (<span class="name"><span class="builtin-name">lambda</span></span> (x y) ⟨??⟩) nil sequence))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-40"><a href="#Exercise-2-40" class="headerlink" title="Exercise 2.40"></a>Exercise 2.40</h3><p>Define a procedure unique-pairs that, given an integer n, generates the sequence of pairs (i, j) with 1 &lt;= j &lt; i &lt;= n. Use unique-pairs to simplify the definition of <code>prime-sum-pairs</code> given above.</p>
<h3 id="Exercise-2-41"><a href="#Exercise-2-41" class="headerlink" title="Exercise 2.41"></a>Exercise 2.41</h3><p>Write a procedure to find all ordered triples of distinct positive integers i, j, and k less than or equal to a given integer n that sum to a given integer s.</p>
<h3 id="Exercise-2-42"><a href="#Exercise-2-42" class="headerlink" title="Exercise 2.42"></a>Exercise 2.42</h3><p>The “eight-queens puzzle” asks how to place eight queens on a chessboard so that no queen is in check from any other (i.e., no two queens are in the same row, column, or diagonal). One possible solution is shown in Figure 2.8. One way to solve the puzzle is to work across the board, placing a queen in each column. Once we have placed k 􀀀1 queens, we must place the kth queen in a position where it does not check any of the queens already on the board. We can formulate this approach recursively: Assume that we<br><img src="/images/sicp/Figure_2.8.png" alt><br>have already generated the sequence of all possible ways to place k 􀀀1 queens in the first k 􀀀1 columns of the board. For each of these ways, generate an extended set of positions by placing a queen in each row of the kth column. Now filter these, keeping only the positions for which the queen in the kth column is safe with respect to the other queens. This produces the sequence of all ways to place k queens in the first k columns. By continuing this process, we will produce not only one solution, but all solutions to<br>the puzzle.<br>We implement this solution as a procedure queens, which returns a sequence of all solutions to the problem of placing n queens on an n  n chessboard. queens has an internal procedure queen-cols that returns the sequence of all ways to place queens in the first k columns of the board.<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">queens</span> board-size)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">queen-cols</span> k)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> k <span class="number">0</span>)</span><br><span class="line">    (<span class="name"><span class="builtin-name">list</span></span> empty-board)</span><br><span class="line">    (<span class="name">filter</span></span><br><span class="line">      (<span class="name"><span class="builtin-name">lambda</span></span> (positions) (<span class="name">safe?</span> k positions))</span><br><span class="line">      (<span class="name">flatmap</span></span><br><span class="line">        (<span class="name"><span class="builtin-name">lambda</span></span> (rest-of-queens)</span><br><span class="line">          (<span class="name"><span class="builtin-name">map</span></span> (<span class="name"><span class="builtin-name">lambda</span></span> (new-row)</span><br><span class="line">                 (<span class="name">adjoin-position</span></span><br><span class="line">                 new-row k rest-of-queens))</span><br><span class="line">               (<span class="name">enumerate-interval</span> <span class="number">1</span> board-size)))</span><br><span class="line">        (<span class="name">queen-cols</span> (<span class="name"><span class="builtin-name">-</span></span> k <span class="number">1</span>))))))</span><br><span class="line">(<span class="name">queen-cols</span> board-size))</span><br></pre></td></tr></table></figure></p>
<p>In this procedure rest-of-queens is a way to place k 􀀀 1 queens in the first k􀀀1 columns, and new-row is a proposed row in which to place the queen for the kth column. Complete the program by implementing the representation for sets of board positions, including the procedure adjoinposition, which adjoins a new row-column position to a set of positions, and <code>empty-board</code>, which represents an empty set of positions. You must also write the procedure <code>safe?</code>, which determines for a set of positions, whether the queen in the kth column is safe with respect to the others. (Note that we need only check whether the new queen is safe—the other queens are  already guaranteed safe with respect to each other.)</p>
<h3 id="Exercise-2-43"><a href="#Exercise-2-43" class="headerlink" title="Exercise 2.43"></a>Exercise 2.43</h3><p>Louis Reasoner is having a terrible time doing Exercise 2.42. His queens procedure seems to work, but it runs extremely slowly. (Louis never does manage to wait long enough for it to solve even the 6  6 case.) When Louis asks Eva Lu Ator for help, she points out that he has interchanged the order of the nested mappings in the flatmap, writing it as<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">flatmap</span></span><br><span class="line">  (<span class="name"><span class="builtin-name">lambda</span></span> (new-row)</span><br><span class="line">    (<span class="name"><span class="builtin-name">map</span></span> (<span class="name"><span class="builtin-name">lambda</span></span> (rest-of-queens)</span><br><span class="line">           (<span class="name">adjoin-position</span> new-row k rest-of-queens))</span><br><span class="line">           (<span class="name">queen-cols</span> (<span class="name"><span class="builtin-name">-</span></span> k <span class="number">1</span>))))</span><br><span class="line">(<span class="name">enumerate-interval</span> <span class="number">1</span> board-size))</span><br></pre></td></tr></table></figure></p>
<p>Explain why this interchange makes the program run slowly. Estimate how long it will take Louis’s program to solve the eight-queens puzzle, assuming that the program in Exercise 2.42 solves the puzzle in time T .</p>
<h2 id="实例：一个图形语言"><a href="#实例：一个图形语言" class="headerlink" title="实例：一个图形语言"></a>实例：一个图形语言</h2><p>(2.2.4 Example: A Picture Language)</p>
<p>;: (define wave2 (beside wave (flip-vert wave)))<br>;: (define wave4 (below wave2 wave2))</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">flipped-pairs</span> painter)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">painter2</span> (<span class="name">beside</span> painter (<span class="name">flip-vert</span> painter))))</span><br><span class="line">    (<span class="name">below</span> painter2 painter2)))</span><br></pre></td></tr></table></figure>
<p>;: (define wave4 (flipped-pairs wave))</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">right-split</span> painter n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> n <span class="number">0</span>)</span><br><span class="line">      painter</span><br><span class="line">      (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">smaller</span> (<span class="name">right-split</span> painter (<span class="name"><span class="builtin-name">-</span></span> n <span class="number">1</span>))))</span><br><span class="line">        (<span class="name">beside</span> painter (<span class="name">below</span> smaller smaller)))))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">corner-split</span> painter n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> n <span class="number">0</span>)</span><br><span class="line">      painter</span><br><span class="line">      (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">up</span> (<span class="name">up-split</span> painter (<span class="name"><span class="builtin-name">-</span></span> n <span class="number">1</span>)))</span><br><span class="line">            (<span class="name">right</span> (<span class="name">right-split</span> painter (<span class="name"><span class="builtin-name">-</span></span> n <span class="number">1</span>))))</span><br><span class="line">        (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">top-left</span> (<span class="name">beside</span> up up))</span><br><span class="line">              (<span class="name">bottom-right</span> (<span class="name">below</span> right right))</span><br><span class="line">              (<span class="name">corner</span> (<span class="name">corner-split</span> painter (<span class="name"><span class="builtin-name">-</span></span> n <span class="number">1</span>))))</span><br><span class="line">          (<span class="name">beside</span> (<span class="name">below</span> painter top-left)</span><br><span class="line">                  (<span class="name">below</span> bottom-right corner))))))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">square-limit</span> painter n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">quarter</span> (<span class="name">corner-split</span> painter n)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">half</span> (<span class="name">beside</span> (<span class="name">flip-horiz</span> quarter) quarter)))</span><br><span class="line">      (<span class="name">below</span> (<span class="name">flip-vert</span> half) half))))</span><br></pre></td></tr></table></figure>
<p>;; Higher-order operations<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">square-of-four</span> tl tr bl br)</span><br><span class="line">  (<span class="name"><span class="builtin-name">lambda</span></span> (painter)</span><br><span class="line">    (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">top</span> (<span class="name">beside</span> (<span class="name">tl</span> painter) (<span class="name">tr</span> painter)))</span><br><span class="line">          (<span class="name">bottom</span> (<span class="name">beside</span> (<span class="name">bl</span> painter) (<span class="name">br</span> painter))))</span><br><span class="line">      (<span class="name">below</span> bottom top))))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">flipped-pairs</span> painter)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">combine4</span> (<span class="name">square-of-four</span> identity flip-vert</span><br><span class="line">                                  identity flip-vert)))</span><br><span class="line">    (<span class="name">combine4</span> painter)))</span><br></pre></td></tr></table></figure></p>
<p>; footnote<br>;: (define flipped-pairs<br>;:   (square-of-four identity flip-vert identity flip-vert))</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">square-limit</span> painter n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">combine4</span> (<span class="name">square-of-four</span> flip-horiz identity</span><br><span class="line">                                  rotate180 flip-vert)))</span><br><span class="line">    (<span class="name">combine4</span> (<span class="name">corner-split</span> painter n))))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-2-44"><a href="#Exercise-2-44" class="headerlink" title="Exercise 2.44"></a>Exercise 2.44</h3><p>Define the procedure up-split used by cornersplit. It is similar to right-split, except that it switches the roles of below and beside.</p>
<h3 id="Exercise-2-45"><a href="#Exercise-2-45" class="headerlink" title="Exercise 2.45"></a>Exercise 2.45</h3><p>right-split and up-split can be expressed as instances of a general splitting operation. Define a procedure split with the property that evaluating<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> right-split (<span class="name">split</span> beside below))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> up-split (<span class="name">split</span> below beside))</span><br></pre></td></tr></table></figure></p>
<p>produces procedures right-split and up-split with the same behaviors as the ones already defined.</p>
<h1 id="符号数据"><a href="#符号数据" class="headerlink" title="符号数据"></a>符号数据</h1><p>(2.3 Symbolic Data)</p>
<h2 id="引号"><a href="#引号" class="headerlink" title="引号"></a>引号</h2><p>(2.3.1 Quotation)<br>使用单引号来标识符号来引用符号本身。<br>在Scheme中使用一个单引号来标识符号（字符）。</p>
<p>示例：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> a <span class="number">1</span>)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> b <span class="number">2</span>)</span><br><span class="line">(<span class="name"><span class="builtin-name">list</span></span> a b)</span><br><span class="line">(<span class="name">1</span> <span class="number">2</span>)</span><br><span class="line">(<span class="name"><span class="builtin-name">list</span></span> <span class="symbol">'a</span> <span class="symbol">'b</span>)</span><br><span class="line">(<span class="name">a</span> b)</span><br><span class="line">(<span class="name"><span class="builtin-name">list</span></span> <span class="symbol">'a</span> b)</span><br><span class="line">(<span class="name">a</span> <span class="number">2</span>)</span><br></pre></td></tr></table></figure></p>
<p>单引号除了可以标识符号（字符）之外，还可以用在list上，标识这个list是一个字符列表。<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">car</span></span> '(a b c))</span><br><span class="line">a</span><br><span class="line">(<span class="name"><span class="builtin-name">cdr</span></span> '(a b c))</span><br><span class="line">(<span class="name">b</span> c)</span><br></pre></td></tr></table></figure></p>
<p>Scheme提供了基本的谓词<code>eq?</code>，用来测试两个符号是否相同。</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 判断item列表的元素是否包含x</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">memq</span></span> item x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">null?</span></span> x) false)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">eq?</span></span> item (<span class="name"><span class="builtin-name">car</span></span> x)) x)</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name"><span class="builtin-name">memq</span></span> item (<span class="name"><span class="builtin-name">cdr</span></span> x)))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">memq</span></span> <span class="symbol">'apple</span> '(pear banana prune))</span><br><span class="line">#f</span><br><span class="line">(<span class="name"><span class="builtin-name">memq</span></span> <span class="symbol">'apple</span> '(x (apple sauce) y apple pear))</span><br><span class="line">(<span class="name">apple</span> pear)</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-2-53"><a href="#Exercise-2-53" class="headerlink" title="Exercise 2.53"></a>Exercise 2.53</h3><p>What would the interpreter print in response to evaluating each of the following expressions?<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">list</span></span> <span class="symbol">'a</span> <span class="symbol">'b</span> <span class="symbol">'c</span>) <span class="comment">;(a b c)</span></span><br><span class="line">(<span class="name"><span class="builtin-name">list</span></span> (<span class="name"><span class="builtin-name">list</span></span> <span class="symbol">'george</span>)) <span class="comment">;((george))</span></span><br><span class="line">(<span class="name"><span class="builtin-name">cdr</span></span> '((x1 x2) (y1 y2))) <span class="comment">;((y1 y2))</span></span><br><span class="line">(<span class="name"><span class="builtin-name">cadr</span></span> '((x1 x2) (y1 y2))) <span class="comment">;(y1 y2) ???</span></span><br><span class="line">(<span class="name"><span class="builtin-name">pair?</span></span> (<span class="name"><span class="builtin-name">car</span></span> '(a short list))) <span class="comment">;#f</span></span><br><span class="line">(<span class="name"><span class="builtin-name">memq</span></span> <span class="symbol">'red</span> '((red shoes) (blue socks))) <span class="comment">;#f</span></span><br><span class="line">(<span class="name"><span class="builtin-name">memq</span></span> <span class="symbol">'red</span> '(red shoes blue socks)) <span class="comment">;(red shoes blue socks)</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-54"><a href="#Exercise-2-54" class="headerlink" title="Exercise 2.54"></a>Exercise 2.54</h3><p>Two lists are said to be <code>equal?</code> if they contain equal elements arranged in the same order. For example,<br><code>(equal? &#39;(this is a list) &#39;(this is a list))</code><br>is true, but<br><code>(equal? &#39;(this is a list) &#39;(this (is a) list))</code><br>is false. To be more precise, we can define <code>equal?</code> recursively in terms of the basic <strong>eq?</strong> equality of symbols by saying that a and b are <code>equal?</code> if they are both symbols and the symbols are <strong>eq?</strong>, or if they are both lists such that (car a) is <code>equal?</code> to (car b) and (cdr a) is <code>equal?</code> to (cdr b). Using this idea, implement equal? as a procedure.</p>
<p><strong>答：</strong><br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">equal?</span></span> a b)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name"><span class="builtin-name">null?</span></span> a) (<span class="name"><span class="builtin-name">null?</span></span> b)) true)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">or</span></span> (<span class="name"><span class="builtin-name">null?</span></span> a) (<span class="name"><span class="builtin-name">null?</span></span> b)) false) <span class="comment">;列表长度不相等，返回false</span></span><br><span class="line">        ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name"><span class="builtin-name">pair?</span></span> (<span class="name"><span class="builtin-name">car</span></span> a)) (<span class="name"><span class="builtin-name">pair?</span></span> (<span class="name"><span class="builtin-name">car</span></span> b))) (<span class="name"><span class="builtin-name">and</span></span> (<span class="name"><span class="builtin-name">equal?</span></span> (<span class="name"><span class="builtin-name">car</span></span> a) (<span class="name"><span class="builtin-name">car</span></span> b)) (<span class="name"><span class="builtin-name">equal?</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> a) (<span class="name"><span class="builtin-name">cdr</span></span> b))))</span><br><span class="line">        ((<span class="name"><span class="builtin-name">eq?</span></span> (<span class="name"><span class="builtin-name">car</span></span> a) (<span class="name"><span class="builtin-name">car</span></span> b)) (<span class="name"><span class="builtin-name">equal?</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> a) (<span class="name"><span class="builtin-name">cdr</span></span> b))) <span class="comment">;若两个字符相同，则继续进行比较剩余部分；否则返回false</span></span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> false)))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-55"><a href="#Exercise-2-55" class="headerlink" title="Exercise 2.55"></a>Exercise 2.55</h3><p>Eva Lu Ator types to the interpreter the expression<br><code>(car &#39;&#39;abracadabra)</code><br>To her surprise, the interpreter prints back <code>quote</code>. Explain.</p>
<h2 id="实例：符号求导"><a href="#实例：符号求导" class="headerlink" title="实例：符号求导"></a>实例：符号求导</h2><p>(2.3.2 Example: Symbolic Differentiation)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deriv</span> exp var)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">number?</span></span> exp) <span class="number">0</span>)</span><br><span class="line">        ((<span class="name">variable?</span> exp)</span><br><span class="line">         (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">same-variable?</span> exp var) <span class="number">1</span> <span class="number">0</span>))</span><br><span class="line">        ((<span class="name">sum?</span> exp)</span><br><span class="line">         (<span class="name">make-sum</span> (<span class="name">deriv</span> (<span class="name">addend</span> exp) var)</span><br><span class="line">                   (<span class="name">deriv</span> (<span class="name">augend</span> exp) var)))</span><br><span class="line">        ((<span class="name">product?</span> exp)</span><br><span class="line">         (<span class="name">make-sum</span></span><br><span class="line">           (<span class="name">make-product</span> (<span class="name">multiplier</span> exp)</span><br><span class="line">                         (<span class="name">deriv</span> (<span class="name">multiplicand</span> exp) var))</span><br><span class="line">           (<span class="name">make-product</span> (<span class="name">deriv</span> (<span class="name">multiplier</span> exp) var)</span><br><span class="line">                         (<span class="name">multiplicand</span> exp))))</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span></span><br><span class="line">         (<span class="name">error</span> <span class="string">"unknown expression type -- DERIV"</span> exp))))</span><br></pre></td></tr></table></figure>
<p>;; representing algebraic expressions</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">variable?</span> x) (<span class="name"><span class="builtin-name">symbol?</span></span> x))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">same-variable?</span> v1 v2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">and</span></span> (<span class="name">variable?</span> v1) (<span class="name">variable?</span> v2) (<span class="name"><span class="builtin-name">eq?</span></span> v1 v2)))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-sum</span> a1 a2) (<span class="name"><span class="builtin-name">list</span></span> <span class="symbol">'+</span> a1 a2))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-product</span> m1 m2) (<span class="name"><span class="builtin-name">list</span></span> <span class="symbol">'*</span> m1 m2))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sum?</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">and</span></span> (<span class="name"><span class="builtin-name">pair?</span></span> x) (<span class="name"><span class="builtin-name">eq?</span></span> (<span class="name"><span class="builtin-name">car</span></span> x) <span class="symbol">'+</span>)))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">addend</span> s) (<span class="name"><span class="builtin-name">cadr</span></span> s))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">augend</span> s) (<span class="name">caddr</span> s))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">product?</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">and</span></span> (<span class="name"><span class="builtin-name">pair?</span></span> x) (<span class="name"><span class="builtin-name">eq?</span></span> (<span class="name"><span class="builtin-name">car</span></span> x) <span class="symbol">'*</span>)))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">multiplier</span> p) (<span class="name"><span class="builtin-name">cadr</span></span> p))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">multiplicand</span> p) (<span class="name">caddr</span> p))</span><br></pre></td></tr></table></figure>
<p>;: (deriv ‘(+ x 3) ‘x)<br>;: (deriv ‘(<em> x y) ‘x)<br>;: (deriv ‘(</em> (* x y) (+ x 3)) ‘x)</p>
<p>;; With simplification<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-sum</span> a1 a2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name">=number?</span> a1 <span class="number">0</span>) a2)</span><br><span class="line">        ((<span class="name">=number?</span> a2 <span class="number">0</span>) a1)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name"><span class="builtin-name">number?</span></span> a1) (<span class="name"><span class="builtin-name">number?</span></span> a2)) (<span class="name"><span class="builtin-name">+</span></span> a1 a2))</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name"><span class="builtin-name">list</span></span> <span class="symbol">'+</span> a1 a2))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">=number?</span> exp num)</span><br><span class="line">  (<span class="name"><span class="builtin-name">and</span></span> (<span class="name"><span class="builtin-name">number?</span></span> exp) (<span class="name"><span class="builtin-name">=</span></span> exp num)))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-product</span> m1 m2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">or</span></span> (<span class="name">=number?</span> m1 <span class="number">0</span>) (<span class="name">=number?</span> m2 <span class="number">0</span>)) <span class="number">0</span>)</span><br><span class="line">        ((<span class="name">=number?</span> m1 <span class="number">1</span>) m2)</span><br><span class="line">        ((<span class="name">=number?</span> m2 <span class="number">1</span>) m1)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name"><span class="builtin-name">number?</span></span> m1) (<span class="name"><span class="builtin-name">number?</span></span> m2)) (<span class="name"><span class="builtin-name">*</span></span> m1 m2))</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name"><span class="builtin-name">list</span></span> <span class="symbol">'*</span> m1 m2))))</span><br></pre></td></tr></table></figure></p>
<p>;: (deriv ‘(+ x 3) ‘x)<br>;: (deriv ‘(<em> x y) ‘x)<br>;: (deriv ‘(</em> (* x y) (+ x 3)) ‘x)</p>
<h2 id="实例：集合的表示"><a href="#实例：集合的表示" class="headerlink" title="实例：集合的表示"></a>实例：集合的表示</h2><p>(2.3.3 Example: Representing Sets)</p>
<p><strong>集合作为无序列表(Sets as unordered lists)</strong></p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 判断x是否是集合set中的元素</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">element-of-set?</span> x set)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">null?</span></span> set) false)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">equal?</span></span> x (<span class="name"><span class="builtin-name">car</span></span> set)) true)</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">element-of-set?</span> x (<span class="name"><span class="builtin-name">cdr</span></span> set)))))</span><br><span class="line"><span class="comment">; 将x添加到集合set中</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">adjoin-set</span> x set)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">element-of-set?</span> x set)</span><br><span class="line">      set</span><br><span class="line">      (<span class="name"><span class="builtin-name">cons</span></span> x set)))</span><br><span class="line"><span class="comment">; 取集合set1和set2的交集</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">intersection-set</span> set1 set2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">or</span></span> (<span class="name"><span class="builtin-name">null?</span></span> set1) (<span class="name"><span class="builtin-name">null?</span></span> set2)) '())</span><br><span class="line">        ((<span class="name">element-of-set?</span> (<span class="name"><span class="builtin-name">car</span></span> set1) set2)</span><br><span class="line">         (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">car</span></span> set1) (<span class="name">intersection-set</span> (<span class="name"><span class="builtin-name">cdr</span></span> set1) set2)))</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">intersection-set</span> (<span class="name"><span class="builtin-name">cdr</span></span> set1) set2))))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-2-59"><a href="#Exercise-2-59" class="headerlink" title="Exercise 2.59"></a>Exercise 2.59</h3><p>Implement the <code>union-set</code> operation for the unordered-list representation of sets.</p>
<p><strong>答：</strong><br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">union-set</span> set1 set2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">null?</span></span> set1) set2)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">null?</span></span> set2) set1)</span><br><span class="line">        ((<span class="name">element-of-set?</span> (<span class="name"><span class="builtin-name">car</span></span> set1) set2)</span><br><span class="line">          (<span class="name">union-set</span> (<span class="name"><span class="builtin-name">cdr</span></span> set1) set2))</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">car</span></span> set1) (<span class="name">union-set</span> (<span class="name"><span class="builtin-name">cdr</span></span> set1) set2)))))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-60"><a href="#Exercise-2-60" class="headerlink" title="Exercise 2.60"></a>Exercise 2.60</h3><p>We specified that a set would be represented as a list with no duplicates. Now suppose we allow duplicates. For instance, the set {1; 2; 3} could be represented as the list (2 3 2 1 3 2 2). Design procedures <code>elementof-set?</code>, <code>adjoin-set</code>, <code>union-set</code>, and <code>intersection-set</code> that operate on this representation. How does the efficiency of each compare with the corresponding procedure for the non-duplicate representation? Are there applications for which you would use this representation in preference to the nonduplicate one?</p>
<p><strong>集合作为有序列表(Sets as ordered lists)</strong></p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 判断x是否是集合set中的元素</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">element-of-set?</span> x set)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">null?</span></span> set) false)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">=</span></span> x (<span class="name"><span class="builtin-name">car</span></span> set)) true)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">&lt;</span></span> x (<span class="name"><span class="builtin-name">car</span></span> set)) false)</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">element-of-set?</span> x (<span class="name"><span class="builtin-name">cdr</span></span> set)))))</span><br><span class="line"><span class="comment">; 取集合set1和set2的交集</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">intersection-set</span> set1 set2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">or</span></span> (<span class="name"><span class="builtin-name">null?</span></span> set1) (<span class="name"><span class="builtin-name">null?</span></span> set2))</span><br><span class="line">      '()</span><br><span class="line">      (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">x1</span> (<span class="name"><span class="builtin-name">car</span></span> set1)) (<span class="name">x2</span> (<span class="name"><span class="builtin-name">car</span></span> set2)))</span><br><span class="line">        (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">=</span></span> x1 x2)</span><br><span class="line">               (<span class="name"><span class="builtin-name">cons</span></span> x1 (<span class="name">intersection-set</span> (<span class="name"><span class="builtin-name">cdr</span></span> set1) (<span class="name"><span class="builtin-name">cdr</span></span> set2))))</span><br><span class="line">              ((<span class="name"><span class="builtin-name">&lt;</span></span> x1 x2)</span><br><span class="line">               (<span class="name">intersection-set</span> (<span class="name"><span class="builtin-name">cdr</span></span> set1) set2))</span><br><span class="line">              ((<span class="name"><span class="builtin-name">&lt;</span></span> x2 x1)</span><br><span class="line">               (<span class="name">intersection-set</span> set1 (<span class="name"><span class="builtin-name">cdr</span></span> set2)))))))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-2-61"><a href="#Exercise-2-61" class="headerlink" title="Exercise 2.61"></a>Exercise 2.61</h3><p>Give an implementation of <code>adjoin-set</code> using the ordered representation. By analogy with <code>elementof-set?</code> show how to take advantage of the ordering to produce a procedure that requires on the average about half as many steps as with the unordered representation.</p>
<p><strong>答：</strong><br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">adjoin-set</span> x set)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">null?</span></span> set) (<span class="name"><span class="builtin-name">cons</span></span> x set))</span><br><span class="line">        ((<span class="name"><span class="builtin-name">&lt;</span></span> x (<span class="name"><span class="builtin-name">car</span></span> set)) (<span class="name"><span class="builtin-name">cons</span></span> x set))</span><br><span class="line">        ((<span class="name"><span class="builtin-name">=</span></span> x (<span class="name"><span class="builtin-name">car</span></span> set)) set)</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">car</span></span> set) (<span class="name">adjoin-set</span> x (<span class="name"><span class="builtin-name">cdr</span></span> set))))))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-62"><a href="#Exercise-2-62" class="headerlink" title="Exercise 2.62"></a>Exercise 2.62</h3><p>Give a Θ(n) implementation of <code>union-set</code> for sets represented as ordered lists.</p>
<p><strong>答：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(define (union-set set1 set2)</span><br><span class="line">  (cond ((null? set1) set2)</span><br><span class="line">        ((null? set2) set1)</span><br><span class="line">        ((&lt; (car set1) (car set2)) (cons (car set1) (union-set (cdr set1) set2)))</span><br><span class="line">        ((= (car set1) (car set2)) (union-set set1 (cdr set2)))</span><br><span class="line">        (else (cons (car set2) (union-set (cdr set2) set1)))))</span><br></pre></td></tr></table></figure></p>
<p><strong>集合作为二叉树(Sets as binary trees)</strong></p>
<p><img src="/images/sicp/Figure_2.16.png" alt></p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">entry</span> tree) (<span class="name"><span class="builtin-name">car</span></span> tree))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">left-branch</span> tree) (<span class="name"><span class="builtin-name">cadr</span></span> tree))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">right-branch</span> tree) (<span class="name">caddr</span> tree))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-tree</span> entry left right)</span><br><span class="line">  (<span class="name"><span class="builtin-name">list</span></span> entry left right))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 判断x是否是集合set中的元素</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">element-of-set?</span> x set)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">null?</span></span> set) false)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">=</span></span> x (<span class="name">entry</span> set)) true)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">&lt;</span></span> x (<span class="name">entry</span> set))</span><br><span class="line">         (<span class="name">element-of-set?</span> x (<span class="name">left-branch</span> set)))</span><br><span class="line">        ((<span class="name"><span class="builtin-name">&gt;</span></span> x (<span class="name">entry</span> set))</span><br><span class="line">         (<span class="name">element-of-set?</span> x (<span class="name">right-branch</span> set)))))</span><br><span class="line"></span><br><span class="line"><span class="comment">; 将x添加到集合set中</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">adjoin-set</span> x set)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">null?</span></span> set) (<span class="name">make-tree</span> x '() '()))</span><br><span class="line">        ((<span class="name"><span class="builtin-name">=</span></span> x (<span class="name">entry</span> set)) set)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">&lt;</span></span> x (<span class="name">entry</span> set))</span><br><span class="line">         (<span class="name">make-tree</span> (<span class="name">entry</span> set)</span><br><span class="line">                    (<span class="name">adjoin-set</span> x (<span class="name">left-branch</span> set))</span><br><span class="line">                    (<span class="name">right-branch</span> set)))</span><br><span class="line">        ((<span class="name"><span class="builtin-name">&gt;</span></span> x (<span class="name">entry</span> set))</span><br><span class="line">         (<span class="name">make-tree</span> (<span class="name">entry</span> set)</span><br><span class="line">                    (<span class="name">left-branch</span> set)</span><br><span class="line">                    (<span class="name">adjoin-set</span> x (<span class="name">right-branch</span> set))))))</span><br><span class="line"></span><br><span class="line"><span class="comment">;; 测试element-of-set? 和 adjoin-set</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> t1 (<span class="name">make-tree</span> <span class="number">2</span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> () ()) (<span class="name"><span class="builtin-name">list</span></span> <span class="number">3</span> () ())))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> t2 (<span class="name">make-tree</span> <span class="number">6</span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">5</span> () ()) (<span class="name"><span class="builtin-name">list</span></span> <span class="number">7</span> () ())))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> t (<span class="name">make-tree</span> <span class="number">4</span> t1 t2))</span><br><span class="line">(<span class="name">element-of-set?</span> <span class="number">8</span> t)</span><br><span class="line">#f</span><br><span class="line">(<span class="name">element-of-set?</span> <span class="number">6</span> t)</span><br><span class="line">#t</span><br><span class="line">(<span class="name">adjoin-set</span> <span class="number">8</span> t)</span><br><span class="line">(<span class="name">4</span> (<span class="name">2</span> (<span class="name">1</span> () ()) (<span class="name">1</span> () ())) (<span class="name">6</span> (<span class="name">5</span> () ()) (<span class="name">7</span> () (<span class="name">8</span> () ()))))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-2-63"><a href="#Exercise-2-63" class="headerlink" title="Exercise 2.63"></a>Exercise 2.63</h3><p>Each of the following two procedures converts a binary tree to a list.<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">tree-&gt;list-1</span> tree)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> tree)</span><br><span class="line">      '()</span><br><span class="line">      (<span class="name"><span class="builtin-name">append</span></span> (<span class="name">tree-&gt;list-1</span> (<span class="name">left-branch</span> tree))</span><br><span class="line">              (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name">entry</span> tree)</span><br><span class="line">                    (<span class="name">tree-&gt;list-1</span></span><br><span class="line">                      (<span class="name">right-branch</span> tree))))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">tree-&gt;list-2</span> tree)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">copy-to-list</span> tree result-list)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> tree)</span><br><span class="line">        result-list</span><br><span class="line">        (<span class="name">copy-to-list</span> (<span class="name">left-branch</span> tree)</span><br><span class="line">                      (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name">entry</span> tree)</span><br><span class="line">                            (<span class="name">copy-to-list</span></span><br><span class="line">                              (<span class="name">right-branch</span> tree)</span><br><span class="line">                              result-list)))))</span><br><span class="line">  (<span class="name">copy-to-list</span> tree '()))</span><br></pre></td></tr></table></figure></p>
<p>a. Do the two procedures produce the same result for every tree? If not, how do the results differ? What lists do the two procedures produce for the trees in Figure 2.16?<br>b. Do the two procedures have the same order of growth in the number of steps required to convert a balanced tree with n elements to a list? If not, which one grows more slowly?</p>
<p><strong>答：</strong><br>a. 二者的结果相同，都是：(1 3 5 7 9 11)<br>测试：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> t1 (<span class="name">make-tree</span> <span class="number">3</span> (<span class="name"><span class="builtin-name">list</span></span> <span class="number">1</span> () ()) (<span class="name"><span class="builtin-name">list</span></span> <span class="number">5</span> () ())))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> t2 (<span class="name">make-tree</span> <span class="number">9</span> () (<span class="name"><span class="builtin-name">list</span></span> <span class="number">11</span> () ())))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> t (<span class="name">make-tree</span> <span class="number">7</span> t1 t2))</span><br><span class="line">(<span class="name">tree-&gt;list-1</span> t)</span><br><span class="line">(<span class="name">tree-&gt;list-2</span> t)</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-64"><a href="#Exercise-2-64" class="headerlink" title="Exercise 2.64"></a>Exercise 2.64</h3><p>The following procedure <code>list-&gt;tree</code> converts an ordered list to a balanced binary tree. The helper procedure <code>partial-tree</code> takes as arguments an integer n and list of at least n elements and constructs a balanced tree containing the first n elements of the list. The result returned by <code>partial-tree</code> is a pair (formed with cons) whose <code>car</code> is the constructed tree and whose <code>cdr</code> is the list of elements not included in the tree.<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">list-&gt;tree</span> elements)</span><br><span class="line">  (<span class="name"><span class="builtin-name">car</span></span> (<span class="name">partial-tree</span> elements (<span class="name"><span class="builtin-name">length</span></span> elements))))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">partial-tree</span> elts n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> n <span class="number">0</span>)</span><br><span class="line">      (<span class="name"><span class="builtin-name">cons</span></span> '() elts)</span><br><span class="line">      (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">left-size</span> (<span class="name"><span class="builtin-name">quotient</span></span> (<span class="name"><span class="builtin-name">-</span></span> n <span class="number">1</span>) <span class="number">2</span>)))</span><br><span class="line">        (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">left-result</span></span><br><span class="line">              (<span class="name">partial-tree</span> elts left-size)))</span><br><span class="line">          (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">left-tree</span> (<span class="name"><span class="builtin-name">car</span></span> left-result))</span><br><span class="line">                (<span class="name">non-left-elts</span> (<span class="name"><span class="builtin-name">cdr</span></span> left-result))</span><br><span class="line">                (<span class="name">right-size</span> (<span class="name"><span class="builtin-name">-</span></span> n (<span class="name"><span class="builtin-name">+</span></span> left-size <span class="number">1</span>))))</span><br><span class="line">            (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">this-entry</span> (<span class="name"><span class="builtin-name">car</span></span> non-left-elts))</span><br><span class="line">                  (<span class="name">right-result</span></span><br><span class="line">                  (<span class="name">partial-tree</span></span><br><span class="line">                   (<span class="name"><span class="builtin-name">cdr</span></span> non-left-elts)</span><br><span class="line">                    right-size)))</span><br><span class="line">              (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">right-tree</span> (<span class="name"><span class="builtin-name">car</span></span> right-result))</span><br><span class="line">                    (<span class="name">remaining-elts</span> (<span class="name"><span class="builtin-name">cdr</span></span> right-result)))</span><br><span class="line">                (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name">make-tree</span> this-entry</span><br><span class="line">                                 left-tree</span><br><span class="line">                                 right-tree)</span><br><span class="line">                      remaining-elts))))))))</span><br></pre></td></tr></table></figure></p>
<p>a. Write a short paragraph explaining as clearly as you can how partial-tree works. Draw the tree produced<br>by <code>list-&gt;tree</code> for the list (1 3 5 7 9 11).<br>b. What is the order of growth in the number of steps required by <code>list-&gt;tree</code> to convert a list of n elements?</p>
<h3 id="Exercise-2-65"><a href="#Exercise-2-65" class="headerlink" title="Exercise 2.65"></a>Exercise 2.65</h3><p>Use the results of Exercise 2.63 and Exercise 2.64 to give Θ(n) implementations of <code>union-set</code> and <code>intersection-set</code> for sets implemented as (balanced) binary trees.</p>
<p><strong>集合和数据检索(Sets and information retrieval)</strong></p>
<p>在集合中检索数据：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">lookup</span> given-key set-of-records)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">null?</span></span> set-of-records) false)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">equal?</span></span> given-key (<span class="name">key</span> (<span class="name"><span class="builtin-name">car</span></span> set-of-records)))</span><br><span class="line">         (<span class="name"><span class="builtin-name">car</span></span> set-of-records))</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">lookup</span> given-key (<span class="name"><span class="builtin-name">cdr</span></span> set-of-records)))))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-66"><a href="#Exercise-2-66" class="headerlink" title="Exercise 2.66"></a>Exercise 2.66</h3><p>Implement the <code>lookup</code> procedure for the case where the set of records is structured as a binary tree, ordered by the numerical values of the keys.</p>
<p><strong>答：</strong><br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">lookup</span> given-key set-of-records)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">curr-key</span> (<span class="name">key</span> (<span class="name">entry</span> set-of-records))))</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">null?</span></span> set) false)</span><br><span class="line">          ((<span class="name"><span class="builtin-name">=</span></span> given-key curr-key) (<span class="name">entry</span> set-of-records))</span><br><span class="line">          ((<span class="name"><span class="builtin-name">&lt;</span></span> given-key curr-key)</span><br><span class="line">           (<span class="name">lookup</span> given-key (<span class="name">left-branch</span> set-of-records)))</span><br><span class="line">          ((<span class="name"><span class="builtin-name">&gt;</span></span> given-key curr-key)</span><br><span class="line">           (<span class="name">lookup</span> given-key (<span class="name">right-branch</span> set-of-records))))))</span><br></pre></td></tr></table></figure></p>
<h2 id="实例：Huffman-编码树"><a href="#实例：Huffman-编码树" class="headerlink" title="实例：Huffman 编码树"></a>实例：Huffman 编码树</h2><p>(2.3.4 Example: Huffman Encoding Trees)</p>
<p><code>BACADAEAFABBAAAGAH</code></p>
<p>定长编码<br><code>A 000 C 010 E 100 G 110</code><br><code>B 001 D 011 F 101 H 111</code><br><code>001000010000011000100000101000001001000000000110000111</code></p>
<p>变长编码<br><code>A 0 C 1010 E 1100 G 1110</code><br><code>B 100 D 1011 F 1101 H 1111</code><br><code>100010100101101100011010100100000111001111</code></p>
<p><img src="/images/sicp/Figure_2.18.png" alt></p>
<p><strong>生成 Huffman 树(Generating Huffman trees)</strong></p>
<blockquote>
<p>Initial leaves {(A 8) (B 3) (C 1) (D 1) (E 1) (F 1) (G 1) (H 1)}<br>Merge {(A 8) (B 3) ({C D} 2) (E 1) (F 1) (G 1) (H 1)}<br>Merge {(A 8) (B 3) ({C D} 2) ({E F} 2) (G 1) (H 1)}<br>Merge {(A 8) (B 3) ({C D} 2) ({E F} 2) ({G H} 2)}<br>Merge {(A 8) (B 3) ({C D} 2) ({E F G H} 4)}<br>Merge {(A 8) ({B C D} 5) ({E F G H} 4)}<br>Merge {(A 8) ({B C D E F G H} 9)}<br>Final merge {({A B C D E F G H} 17)}</p>
</blockquote>
<p><strong>Huffman 树的表示(Representing Huffman trees)</strong></p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 叶子结点</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-leaf</span> symbol weight)</span><br><span class="line">  (<span class="name"><span class="builtin-name">list</span></span> <span class="symbol">'leaf</span> symbol weight))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">leaf?</span> object)</span><br><span class="line">  (<span class="name"><span class="builtin-name">eq?</span></span> (<span class="name"><span class="builtin-name">car</span></span> object) <span class="symbol">'leaf</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">symbol-leaf</span> x) (<span class="name"><span class="builtin-name">cadr</span></span> x))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">weight-leaf</span> x) (<span class="name">caddr</span> x))</span><br><span class="line"><span class="comment">; 构造器</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-code-tree</span> left right)</span><br><span class="line">  (<span class="name"><span class="builtin-name">list</span></span> left</span><br><span class="line">        right</span><br><span class="line">        (<span class="name"><span class="builtin-name">append</span></span> (<span class="name">symbols</span> left) (<span class="name">symbols</span> right))</span><br><span class="line">        (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">weight</span> left) (<span class="name">weight</span> right))))</span><br><span class="line"><span class="comment">; 选择器</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">left-branch</span> tree) (<span class="name"><span class="builtin-name">car</span></span> tree))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">right-branch</span> tree) (<span class="name"><span class="builtin-name">cadr</span></span> tree))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">symbols</span> tree)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">leaf?</span> tree)</span><br><span class="line">      (<span class="name"><span class="builtin-name">list</span></span> (<span class="name">symbol-leaf</span> tree))</span><br><span class="line">      (<span class="name">caddr</span> tree)))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">weight</span> tree)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">leaf?</span> tree)</span><br><span class="line">      (<span class="name">weight-leaf</span> tree)</span><br><span class="line">      (<span class="name">cadddr</span> tree)))</span><br></pre></td></tr></table></figure>
<p><strong>解码过程(The decoding procedure)</strong></p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">decode</span> bits tree)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">decode-1</span> bits current-branch)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> bits)</span><br><span class="line">        '()</span><br><span class="line">        (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">next-branch</span></span><br><span class="line">               (<span class="name">choose-branch</span> (<span class="name"><span class="builtin-name">car</span></span> bits) current-branch)))</span><br><span class="line">          (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">leaf?</span> next-branch)</span><br><span class="line">              (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name">symbol-leaf</span> next-branch)</span><br><span class="line">                    (<span class="name">decode-1</span> (<span class="name"><span class="builtin-name">cdr</span></span> bits) tree))</span><br><span class="line">              (<span class="name">decode-1</span> (<span class="name"><span class="builtin-name">cdr</span></span> bits) next-branch)))))</span><br><span class="line">  (<span class="name">decode-1</span> bits tree))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">choose-branch</span> bit branch)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">=</span></span> bit <span class="number">0</span>) (<span class="name">left-branch</span> branch))</span><br><span class="line">        ((<span class="name"><span class="builtin-name">=</span></span> bit <span class="number">1</span>) (<span class="name">right-branch</span> branch))</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"bad bit -- CHOOSE-BRANCH"</span> bit))))</span><br></pre></td></tr></table></figure>
<p><strong>带权重元素的集合(Sets of weighted elements)</strong></p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">adjoin-set</span> x set)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">null?</span></span> set) (<span class="name"><span class="builtin-name">list</span></span> x))</span><br><span class="line">        ((<span class="name"><span class="builtin-name">&lt;</span></span> (<span class="name">weight</span> x) (<span class="name">weight</span> (<span class="name"><span class="builtin-name">car</span></span> set))) (<span class="name"><span class="builtin-name">cons</span></span> x set))</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">car</span></span> set)</span><br><span class="line">                    (<span class="name">adjoin-set</span> x (<span class="name"><span class="builtin-name">cdr</span></span> set))))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-leaf-set</span> pairs)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> pairs)</span><br><span class="line">      '()</span><br><span class="line">      (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">pair</span> (<span class="name"><span class="builtin-name">car</span></span> pairs)))</span><br><span class="line">        (<span class="name">adjoin-set</span> (<span class="name">make-leaf</span> (<span class="name"><span class="builtin-name">car</span></span> pair)</span><br><span class="line">                               (<span class="name"><span class="builtin-name">cadr</span></span> pair))</span><br><span class="line">                    (<span class="name">make-leaf-set</span> (<span class="name"><span class="builtin-name">cdr</span></span> pairs))))))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-2-67"><a href="#Exercise-2-67" class="headerlink" title="Exercise 2.67"></a>Exercise 2.67</h3><p>Define an encoding tree and a sample message:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> sample-tree</span><br><span class="line">  (<span class="name">make-code-tree</span> (<span class="name">make-leaf</span> <span class="symbol">'A</span> <span class="number">4</span>)</span><br><span class="line">                  (<span class="name">make-code-tree</span></span><br><span class="line">                    (<span class="name">make-leaf</span> <span class="symbol">'B</span> <span class="number">2</span>)</span><br><span class="line">                    (<span class="name">make-code-tree</span></span><br><span class="line">                      (<span class="name">make-leaf</span> <span class="symbol">'D</span> <span class="number">1</span>)</span><br><span class="line">                      (<span class="name">make-leaf</span> <span class="symbol">'C</span> <span class="number">1</span>)))))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> sample-message '(<span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span>))</span><br></pre></td></tr></table></figure></p>
<p>Use the <code>decode</code> procedure to decode the message, and give the result.</p>
<h3 id="Exercise-2-68"><a href="#Exercise-2-68" class="headerlink" title="Exercise 2.68"></a>Exercise 2.68</h3><p>The <code>encode</code> procedure takes as arguments a message and a tree and produces the list of bits that gives the encoded message.<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">encode</span> message tree)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> message)</span><br><span class="line">      '()</span><br><span class="line">      (<span class="name"><span class="builtin-name">append</span></span> (<span class="name">encode-symbol</span> (<span class="name"><span class="builtin-name">car</span></span> message) tree)</span><br><span class="line">              (<span class="name">encode</span> (<span class="name"><span class="builtin-name">cdr</span></span> message) tree))))</span><br></pre></td></tr></table></figure></p>
<p><code>encode-symbol</code> is a procedure, which you must write, that returns the list of bits that encodes a given symbol according to a given tree. You should design <code>encode-symbol</code> so that it signals an error if the symbol is not in the tree at all. Test your procedure by encoding the result you obtained in Exercise 2.67 with the sample tree and seeing whether it is the same as the original sample message.</p>
<h3 id="Exercise-2-69"><a href="#Exercise-2-69" class="headerlink" title="Exercise 2.69"></a>Exercise 2.69</h3><p>The following procedure takes as its argument a list of symbol-frequency pairs (where no symbol appears in more than one pair) and generates a Huffman encoding tree according to the Huffman algorithm.<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">generate-huffman-tree</span> pairs)</span><br><span class="line">  (<span class="name">successive-merge</span> (<span class="name">make-leaf-set</span> pairs)))</span><br></pre></td></tr></table></figure></p>
<p><code>make-leaf-set</code> is the procedure given above that transforms the list of pairs into an ordered set of leaves. successivemerge is the procedure you must write, using <code>make-codetree</code> to successively merge the smallest-weight elements of the set until there is only one element left, which is the desired Huffman tree. (This procedure is slightly tricky, but not really complicated. If you find yourself designing a complex procedure, then you are almost certainly doing something wrong. You can take significant advantage of the fact that we are using an ordered set representation.)</p>
<h3 id="Exercise-2-70"><a href="#Exercise-2-70" class="headerlink" title="Exercise 2.70"></a>Exercise 2.70</h3><p>The following eight-symbol alphabet with associated relative frequencies was designed to efficiently encode the lyrics of 1950s rock songs. (Note that the “symbols” of an “alphabet” need not be individual letters.)<br><code>A 2 GET 2 SHA 3 WAH 1</code><br><code>BOOM 1 JOB 2 NA 16 YIP 9</code><br>Use <code>generate-huffman-tree</code> (Exercise 2.69) to generate a corresponding Huffman tree, and use encode (Exercise 2.68) to encode the following message:<br><code>Get a job</code><br><code>Sha na na na na na na na na</code><br><code>Get a job</code><br><code>Sha na na na na na na na na</code><br><code>Wah yip yip yip yip yip yip yip yip yip</code><br><code>Sha boom</code><br>How many bits are required for the encoding? What is the smallest number of bits that would be needed to encode this song if we used a fixed-length code for the eight-symbol alphabet?</p>
<h3 id="Exercise-2-71"><a href="#Exercise-2-71" class="headerlink" title="Exercise 2.71"></a>Exercise 2.71</h3><p>Suppose we have a Huffman tree for an alphabet of n symbols, and that the relative frequencies of the symbols are $1, 2, 4; … , 2_{n-1}$. Sketch the tree for n = 5; for n = 10. In such a tree (for general n) how many bits are required to encode the most frequent symbol? The least frequent symbol?</p>
<h3 id="Exercise-2-72"><a href="#Exercise-2-72" class="headerlink" title="Exercise 2.72"></a>Exercise 2.72</h3><p>Consider the encoding procedure that you designed in Exercise 2.68. What is the order of growth in the number of steps needed to encode a symbol? Be sure to include the number of steps needed to search the symbol list at each node encountered. To answer this question in general is difficult. Consider the special case where the relative frequencies of the n symbols are as described in Exercise 2.71, and give the order of growth (as a function of n) of the number of steps needed to encode the most frequent and least frequent symbols in the alphabet.</p>
<h1 id="抽象数据的多重表示"><a href="#抽象数据的多重表示" class="headerlink" title="抽象数据的多重表示"></a>抽象数据的多重表示</h1><p>(2.4 Multiple Representations for Abstract Data)</p>
<p>复数的表示有两种形式：直角坐标形式和极坐标形式</p>
<h2 id="复数的表示"><a href="#复数的表示" class="headerlink" title="复数的表示"></a>复数的表示</h2><p>(2.4.1 Representations for Complex Numbers)</p>
<p>;: (make-from-real-imag (real-part z) (imag-part z))</p>
<p>;: (make-from-mag-ang (magnitude z) (angle z))<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">add-complex</span> z1 z2)</span><br><span class="line">  (<span class="name">make-from-real-imag</span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name"><span class="builtin-name">real-part</span></span> z1) (<span class="name"><span class="builtin-name">real-part</span></span> z2))</span><br><span class="line">                       (<span class="name"><span class="builtin-name">+</span></span> (<span class="name"><span class="builtin-name">imag-part</span></span> z1) (<span class="name"><span class="builtin-name">imag-part</span></span> z2))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sub-complex</span> z1 z2)</span><br><span class="line">  (<span class="name">make-from-real-imag</span> (<span class="name"><span class="builtin-name">-</span></span> (<span class="name"><span class="builtin-name">real-part</span></span> z1) (<span class="name"><span class="builtin-name">real-part</span></span> z2))</span><br><span class="line">                       (<span class="name"><span class="builtin-name">-</span></span> (<span class="name"><span class="builtin-name">imag-part</span></span> z1) (<span class="name"><span class="builtin-name">imag-part</span></span> z2))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">mul-complex</span> z1 z2)</span><br><span class="line">  (<span class="name">make-from-mag-ang</span> (<span class="name"><span class="builtin-name">*</span></span> (<span class="name"><span class="builtin-name">magnitude</span></span> z1) (<span class="name"><span class="builtin-name">magnitude</span></span> z2))</span><br><span class="line">                     (<span class="name"><span class="builtin-name">+</span></span> (<span class="name"><span class="builtin-name">angle</span></span> z1) (<span class="name"><span class="builtin-name">angle</span></span> z2))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">div-complex</span> z1 z2)</span><br><span class="line">  (<span class="name">make-from-mag-ang</span> (<span class="name"><span class="builtin-name">/</span></span> (<span class="name"><span class="builtin-name">magnitude</span></span> z1) (<span class="name"><span class="builtin-name">magnitude</span></span> z2))</span><br><span class="line">                     (<span class="name"><span class="builtin-name">-</span></span> (<span class="name"><span class="builtin-name">angle</span></span> z1) (<span class="name"><span class="builtin-name">angle</span></span> z2))))</span><br></pre></td></tr></table></figure></p>
<p>;; Ben (rectangular)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">real-part</span></span> z) (<span class="name"><span class="builtin-name">car</span></span> z))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">imag-part</span></span> z) (<span class="name"><span class="builtin-name">cdr</span></span> z))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">magnitude</span></span> z)</span><br><span class="line">  (<span class="name"><span class="builtin-name">sqrt</span></span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">square</span> (<span class="name"><span class="builtin-name">real-part</span></span> z)) (<span class="name">square</span> (<span class="name"><span class="builtin-name">imag-part</span></span> z)))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">angle</span></span> z)</span><br><span class="line">  (<span class="name"><span class="builtin-name">atan</span></span> (<span class="name"><span class="builtin-name">imag-part</span></span> z) (<span class="name"><span class="builtin-name">real-part</span></span> z)))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-from-real-imag</span> x y) (<span class="name"><span class="builtin-name">cons</span></span> x y))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-from-mag-ang</span> r a)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">*</span></span> r (<span class="name"><span class="builtin-name">cos</span></span> a)) (<span class="name"><span class="builtin-name">*</span></span> r (<span class="name"><span class="builtin-name">sin</span></span> a))))</span><br></pre></td></tr></table></figure>
<p>;; Alyssa (polar)<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">real-part</span></span> z)</span><br><span class="line">  (<span class="name"><span class="builtin-name">*</span></span> (<span class="name"><span class="builtin-name">magnitude</span></span> z) (<span class="name"><span class="builtin-name">cos</span></span> (<span class="name"><span class="builtin-name">angle</span></span> z))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">imag-part</span></span> z)</span><br><span class="line">  (<span class="name"><span class="builtin-name">*</span></span> (<span class="name"><span class="builtin-name">magnitude</span></span> z) (<span class="name"><span class="builtin-name">sin</span></span> (<span class="name"><span class="builtin-name">angle</span></span> z))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">magnitude</span></span> z) (<span class="name"><span class="builtin-name">car</span></span> z))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">angle</span></span> z) (<span class="name"><span class="builtin-name">cdr</span></span> z))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-from-real-imag</span> x y)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">sqrt</span></span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">square</span> x) (<span class="name">square</span> y)))</span><br><span class="line">        (<span class="name"><span class="builtin-name">atan</span></span> y x)))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-from-mag-ang</span> r a) (<span class="name"><span class="builtin-name">cons</span></span> r a))</span><br></pre></td></tr></table></figure></p>
<h2 id="带标志数据"><a href="#带标志数据" class="headerlink" title="带标志数据"></a>带标志数据</h2><p>(2.4.2 Tagged data)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">attach-tag</span> type-tag contents)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cons</span></span> type-tag contents))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">type-tag</span> datum)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">pair?</span></span> datum)</span><br><span class="line">      (<span class="name"><span class="builtin-name">car</span></span> datum)</span><br><span class="line">      (<span class="name">error</span> <span class="string">"Bad tagged datum -- TYPE-TAG"</span> datum)))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">contents</span> datum)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">pair?</span></span> datum)</span><br><span class="line">      (<span class="name"><span class="builtin-name">cdr</span></span> datum)</span><br><span class="line">      (<span class="name">error</span> <span class="string">"Bad tagged datum -- CONTENTS"</span> datum)))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">rectangular?</span> z)</span><br><span class="line">  (<span class="name"><span class="builtin-name">eq?</span></span> (<span class="name">type-tag</span> z) <span class="symbol">'rectangular</span>))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">polar?</span> z)</span><br><span class="line">  (<span class="name"><span class="builtin-name">eq?</span></span> (<span class="name">type-tag</span> z) <span class="symbol">'polar</span>))</span><br></pre></td></tr></table></figure>
<p>;; Ben (rectangular)<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">real-part-rectangular</span> z) (<span class="name"><span class="builtin-name">car</span></span> z))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">imag-part-rectangular</span> z) (<span class="name"><span class="builtin-name">cdr</span></span> z))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">magnitude-rectangular</span> z)</span><br><span class="line">  (<span class="name"><span class="builtin-name">sqrt</span></span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">square</span> (<span class="name">real-part-rectangular</span> z))</span><br><span class="line">           (<span class="name">square</span> (<span class="name">imag-part-rectangular</span> z)))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">angle-rectangular</span> z)</span><br><span class="line">  (<span class="name"><span class="builtin-name">atan</span></span> (<span class="name">imag-part-rectangular</span> z)</span><br><span class="line">        (<span class="name">real-part-rectangular</span> z)))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-from-real-imag-rectangular</span> x y)</span><br><span class="line">  (<span class="name">attach-tag</span> <span class="symbol">'rectangular</span> (<span class="name"><span class="builtin-name">cons</span></span> x y)))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-from-mag-ang-rectangular</span> r a)</span><br><span class="line">  (<span class="name">attach-tag</span> <span class="symbol">'rectangular</span></span><br><span class="line">              (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">*</span></span> r (<span class="name"><span class="builtin-name">cos</span></span> a)) (<span class="name"><span class="builtin-name">*</span></span> r (<span class="name"><span class="builtin-name">sin</span></span> a)))))</span><br></pre></td></tr></table></figure></p>
<p>;; Alyssa (polar)<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">real-part-polar</span> z)</span><br><span class="line">  (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">magnitude-polar</span> z) (<span class="name"><span class="builtin-name">cos</span></span> (<span class="name">angle-polar</span> z))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">imag-part-polar</span> z)</span><br><span class="line">  (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">magnitude-polar</span> z) (<span class="name"><span class="builtin-name">sin</span></span> (<span class="name">angle-polar</span> z))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">magnitude-polar</span> z) (<span class="name"><span class="builtin-name">car</span></span> z))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">angle-polar</span> z) (<span class="name"><span class="builtin-name">cdr</span></span> z))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-from-real-imag-polar</span> x y)</span><br><span class="line">  (<span class="name">attach-tag</span> <span class="symbol">'polar</span></span><br><span class="line">               (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">sqrt</span></span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">square</span> x) (<span class="name">square</span> y)))</span><br><span class="line">                     (<span class="name"><span class="builtin-name">atan</span></span> y x))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-from-mag-ang-polar</span> r a)</span><br><span class="line">  (<span class="name">attach-tag</span> <span class="symbol">'polar</span> (<span class="name"><span class="builtin-name">cons</span></span> r a)))</span><br></pre></td></tr></table></figure></p>
<p>;; Generic selectors<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">real-part</span></span> z)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name">rectangular?</span> z)</span><br><span class="line">         (<span class="name">real-part-rectangular</span> (<span class="name">contents</span> z)))</span><br><span class="line">        ((<span class="name">polar?</span> z)</span><br><span class="line">         (<span class="name">real-part-polar</span> (<span class="name">contents</span> z)))</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown type -- REAL-PART"</span> z))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">imag-part</span></span> z)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name">rectangular?</span> z)</span><br><span class="line">         (<span class="name">imag-part-rectangular</span> (<span class="name">contents</span> z)))</span><br><span class="line">        ((<span class="name">polar?</span> z)</span><br><span class="line">         (<span class="name">imag-part-polar</span> (<span class="name">contents</span> z)))</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown type -- IMAG-PART"</span> z))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">magnitude</span></span> z)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name">rectangular?</span> z)</span><br><span class="line">         (<span class="name">magnitude-rectangular</span> (<span class="name">contents</span> z)))</span><br><span class="line">        ((<span class="name">polar?</span> z)</span><br><span class="line">         (<span class="name">magnitude-polar</span> (<span class="name">contents</span> z)))</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown type -- MAGNITUDE"</span> z))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">angle</span></span> z)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name">rectangular?</span> z)</span><br><span class="line">         (<span class="name">angle-rectangular</span> (<span class="name">contents</span> z)))</span><br><span class="line">        ((<span class="name">polar?</span> z)</span><br><span class="line">         (<span class="name">angle-polar</span> (<span class="name">contents</span> z)))</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown type -- ANGLE"</span> z))))</span><br></pre></td></tr></table></figure></p>
<p>;; same as before<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">add-complex</span> z1 z2)</span><br><span class="line">  (<span class="name">make-from-real-imag</span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name"><span class="builtin-name">real-part</span></span> z1) (<span class="name"><span class="builtin-name">real-part</span></span> z2))</span><br><span class="line">                       (<span class="name"><span class="builtin-name">+</span></span> (<span class="name"><span class="builtin-name">imag-part</span></span> z1) (<span class="name"><span class="builtin-name">imag-part</span></span> z2))))</span><br></pre></td></tr></table></figure></p>
<p>;; Constructors for complex numbers<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-from-real-imag</span> x y)</span><br><span class="line">  (<span class="name">make-from-real-imag-rectangular</span> x y))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-from-mag-ang</span> r a)</span><br><span class="line">  (<span class="name">make-from-mag-ang-polar</span> r a))</span><br></pre></td></tr></table></figure></p>
<h2 id="数据导向的程序设计的可加性"><a href="#数据导向的程序设计的可加性" class="headerlink" title="数据导向的程序设计的可加性"></a>数据导向的程序设计的可加性</h2><p>(2.4.3 Data-Directed Programming and Additivity)</p>
<p>;; uses get/put (from 3.3.3) – see ch2support.scm<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">install-rectangular-package</span>)</span><br><span class="line">  <span class="comment">;; internal procedures</span></span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">real-part</span></span> z) (<span class="name"><span class="builtin-name">car</span></span> z))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">imag-part</span></span> z) (<span class="name"><span class="builtin-name">cdr</span></span> z))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-from-real-imag</span> x y) (<span class="name"><span class="builtin-name">cons</span></span> x y))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">magnitude</span></span> z)</span><br><span class="line">    (<span class="name"><span class="builtin-name">sqrt</span></span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">square</span> (<span class="name"><span class="builtin-name">real-part</span></span> z))</span><br><span class="line">             (<span class="name">square</span> (<span class="name"><span class="builtin-name">imag-part</span></span> z)))))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">angle</span></span> z)</span><br><span class="line">    (<span class="name"><span class="builtin-name">atan</span></span> (<span class="name"><span class="builtin-name">imag-part</span></span> z) (<span class="name"><span class="builtin-name">real-part</span></span> z)))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-from-mag-ang</span> r a)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">*</span></span> r (<span class="name"><span class="builtin-name">cos</span></span> a)) (<span class="name"><span class="builtin-name">*</span></span> r (<span class="name"><span class="builtin-name">sin</span></span> a))))</span><br><span class="line"></span><br><span class="line">  <span class="comment">;; interface to the rest of the system</span></span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">tag</span> x) (<span class="name">attach-tag</span> <span class="symbol">'rectangular</span> x))</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'real-part</span> '(rectangular) real-part)</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'imag-part</span> '(rectangular) imag-part)</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'magnitude</span> '(rectangular) magnitude)</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'angle</span> '(rectangular) angle)</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'make-from-real-imag</span> <span class="symbol">'rectangular</span></span><br><span class="line">       (<span class="name"><span class="builtin-name">lambda</span></span> (x y) (<span class="name">tag</span> (<span class="name">make-from-real-imag</span> x y))))</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'make-from-mag-ang</span> <span class="symbol">'rectangular</span></span><br><span class="line">       (<span class="name"><span class="builtin-name">lambda</span></span> (r a) (<span class="name">tag</span> (<span class="name">make-from-mag-ang</span> r a))))</span><br><span class="line">  <span class="symbol">'done</span>)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">install-polar-package</span>)</span><br><span class="line">  <span class="comment">;; internal procedures</span></span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">magnitude</span></span> z) (<span class="name"><span class="builtin-name">car</span></span> z))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">angle</span></span> z) (<span class="name"><span class="builtin-name">cdr</span></span> z))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-from-mag-ang</span> r a) (<span class="name"><span class="builtin-name">cons</span></span> r a))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">real-part</span></span> z)</span><br><span class="line">    (<span class="name"><span class="builtin-name">*</span></span> (<span class="name"><span class="builtin-name">magnitude</span></span> z) (<span class="name"><span class="builtin-name">cos</span></span> (<span class="name"><span class="builtin-name">angle</span></span> z))))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">imag-part</span></span> z)</span><br><span class="line">    (<span class="name"><span class="builtin-name">*</span></span> (<span class="name"><span class="builtin-name">magnitude</span></span> z) (<span class="name"><span class="builtin-name">sin</span></span> (<span class="name"><span class="builtin-name">angle</span></span> z))))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-from-real-imag</span> x y)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">sqrt</span></span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">square</span> x) (<span class="name">square</span> y)))</span><br><span class="line">          (<span class="name"><span class="builtin-name">atan</span></span> y x)))</span><br><span class="line"></span><br><span class="line">  <span class="comment">;; interface to the rest of the system</span></span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">tag</span> x) (<span class="name">attach-tag</span> <span class="symbol">'polar</span> x))</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'real-part</span> '(polar) real-part)</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'imag-part</span> '(polar) imag-part)</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'magnitude</span> '(polar) magnitude)</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'angle</span> '(polar) angle)</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'make-from-real-imag</span> <span class="symbol">'polar</span></span><br><span class="line">       (<span class="name"><span class="builtin-name">lambda</span></span> (x y) (<span class="name">tag</span> (<span class="name">make-from-real-imag</span> x y))))</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'make-from-mag-ang</span> <span class="symbol">'polar</span></span><br><span class="line">       (<span class="name"><span class="builtin-name">lambda</span></span> (r a) (<span class="name">tag</span> (<span class="name">make-from-mag-ang</span> r a))))</span><br><span class="line">  <span class="symbol">'done</span>)</span><br></pre></td></tr></table></figure>
<p>;;footnote<br>;: (apply + (list 1 2 3 4))</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">apply-generic</span> op . args)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">type-tags</span> (<span class="name"><span class="builtin-name">map</span></span> type-tag args)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">proc</span> (<span class="name">get</span> op type-tags)))</span><br><span class="line">      (<span class="name"><span class="builtin-name">if</span></span> proc</span><br><span class="line">          (<span class="name"><span class="builtin-name">apply</span></span> proc (<span class="name"><span class="builtin-name">map</span></span> contents args))</span><br><span class="line">          (<span class="name">error</span></span><br><span class="line">            <span class="string">"No method for these types -- APPLY-GENERIC"</span></span><br><span class="line">            (<span class="name"><span class="builtin-name">list</span></span> op type-tags))))))</span><br></pre></td></tr></table></figure>
<p>;; Generic selectors<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">real-part</span></span> z) (<span class="name">apply-generic</span> <span class="symbol">'real-part</span> z))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">imag-part</span></span> z) (<span class="name">apply-generic</span> <span class="symbol">'imag-part</span> z))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">magnitude</span></span> z) (<span class="name">apply-generic</span> <span class="symbol">'magnitude</span> z))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">angle</span></span> z) (<span class="name">apply-generic</span> <span class="symbol">'angle</span> z))</span><br></pre></td></tr></table></figure></p>
<p>;; Constructors for complex numbers<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-from-real-imag</span> x y)</span><br><span class="line">  ((<span class="name">get</span> <span class="symbol">'make-from-real-imag</span> <span class="symbol">'rectangular</span>) x y))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-from-mag-ang</span> r a)</span><br><span class="line">  ((<span class="name">get</span> <span class="symbol">'make-from-mag-ang</span> <span class="symbol">'polar</span>) r a))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-73"><a href="#Exercise-2-73" class="headerlink" title="Exercise 2.73"></a>Exercise 2.73</h3><p>Section 2.3.2 described a program that performs symbolic differentiation:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deriv</span> exp var)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">number?</span></span> exp) <span class="number">0</span>)</span><br><span class="line">        ((<span class="name">variable?</span> exp)</span><br><span class="line">         (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">same-variable?</span> exp var) <span class="number">1</span> <span class="number">0</span>))</span><br><span class="line">        ((<span class="name">sum?</span> exp)</span><br><span class="line">         (<span class="name">make-sum</span> (<span class="name">deriv</span> (<span class="name">addend</span> exp) var)</span><br><span class="line">                   (<span class="name">deriv</span> (<span class="name">augend</span> exp) var)))</span><br><span class="line">        ((<span class="name">product?</span> exp)</span><br><span class="line">         (<span class="name">make-sum</span> (<span class="name">make-product</span></span><br><span class="line">                    (<span class="name">multiplier</span> exp)</span><br><span class="line">                    (<span class="name">deriv</span> (<span class="name">multiplicand</span> exp) var))</span><br><span class="line">                   (<span class="name">make-product</span></span><br><span class="line">                    (<span class="name">deriv</span> (<span class="name">multiplier</span> exp) var)</span><br><span class="line">                    (<span class="name">multiplicand</span> exp))))</span><br><span class="line">        &lt;more rules can be added here&gt;</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"unknown expression type: DERIV"</span> exp))))</span><br></pre></td></tr></table></figure></p>
<p>We can regard this program as performing a dispatch on the type of the expression to be differentiated. In this situation the “type tag” of the datum is the algebraic operator symbol (such as +) and the operation being performed is <code>deriv</code>. We can transform this program into data-directed style by rewriting the basic derivative procedure as<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deriv</span> exp var)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">number?</span></span> exp) <span class="number">0</span>)</span><br><span class="line">        ((<span class="name">variable?</span> exp) (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">same-variable?</span> exp var) <span class="number">1</span> <span class="number">0</span>))</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> ((<span class="name">get</span> <span class="symbol">'deriv</span> (<span class="name">operator</span> exp))</span><br><span class="line">               (<span class="name">operands</span> exp) var))))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">operator</span> exp) (<span class="name"><span class="builtin-name">car</span></span> exp))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">operands</span> exp) (<span class="name"><span class="builtin-name">cdr</span></span> exp))</span><br></pre></td></tr></table></figure></p>
<p>a. Explain what was done above. Why can’t we assimilate the predicates <code>number?</code> and <code>variable?</code> into the data-directed dispatch?<br>b. Write the procedures for derivatives of sums and products, and the auxiliary code required to install them in the table used by the program above.<br>c. Choose any additional differentiation rule that you like, such as the one for exponents (Exercise 2.56), and install it in this data-directed system.<br>d. In this simple algebraic manipulator the type of an expression is the algebraic operator that binds it together. Suppose, however, we indexed the procedures in the opposite way, so that the dispatch line in <code>deriv</code> looked like<br><code>((get (operator exp) &#39;deriv) (operands exp) var)</code><br>What corresponding changes to the derivative system are required?</p>
<h3 id="Exercise-2-74"><a href="#Exercise-2-74" class="headerlink" title="Exercise 2.74"></a>Exercise 2.74</h3><p>Insatiable Enterprises, Inc., is a highly decentralized conglomerate company consisting of a large number of independent divisions located all over the world. The company’s computer facilities have just been interconnected by means of a clever network-interfacing scheme that makes the entire network appear to any user to be a single computer. Insatiable’s president, in her first attempt to exploit the ability of the network to extract administrative information from division files, is dismayed to discover that, although all the division files have been implemented as data structures in Scheme, the particular data structure used varies from division to division. A meeting of division managers is hastily called to search for a strategy to integrate the files that will satisfy headquarters’ needs while preserving the existing autonomy of the divisions.<br>Show how such a strategy can be implemented with datadirected programming. As an example, suppose that each division’s personnel records consist of a single file, which contains a set of records keyed on employees’ names. The structure of the set varies from division to division. Furthermore, each employee’s record is itself a set (structured differently from division to division) that contains information keyed under identifiers such as address and salary. In particular:<br>a. Implement for headquarters a <code>get-record</code> procedure that retrieves a specified employee’s record from a specified personnel file. The procedure should be applicable to any division’s file. Explain how the individual divisions’ files should be structured. In particular, what type information must be supplied?<br>b. Implement for headquarters a <code>get-salary</code> procedure that returns the salary information from a given employee’s record from any division’s personnel file. How should the record be structured in order to make this operation work?<br>c. Implement for headquarters a <code>find-employee-record</code> procedure. This should search all the divisions’ files for the record of a given employee and return the record. Assume that this procedure takes as arguments an employee’s name and a list of all the divisions’ files.<br>d. When Insatiable takes over a new company, what changes must be made in order to incorporate the new personnel information into the central system?</p>
<h3 id="Exercise-2-75"><a href="#Exercise-2-75" class="headerlink" title="Exercise 2.75"></a>Exercise 2.75</h3><p>Implement the constructor <code>make-from-magang</code> in message-passing style. This procedure should be analogous to the <code>make-from-real-imag</code> procedure given above.</p>
<h3 id="Exercise-2-76"><a href="#Exercise-2-76" class="headerlink" title="Exercise 2.76"></a>Exercise 2.76</h3><p>As a large system with generic operations evolves, new types of data objects or new operations may be needed. For each of the three strategies—generic operations with explicit dispatch, data-directed style, and messagepassing- style—describe the changes that must be made to a system in order to add new types or new operations. Which organization would be most appropriate for a system in which new types must often be added? Which would be most appropriate for a system in which new operations must often be added?</p>
<h1 id="带有通用型操作的系统"><a href="#带有通用型操作的系统" class="headerlink" title="带有通用型操作的系统"></a>带有通用型操作的系统</h1><p>(2.5 Systems with Generic Operations)</p>
<h2 id="通用型算术运算"><a href="#通用型算术运算" class="headerlink" title="通用型算术运算"></a>通用型算术运算</h2><p>(2.5.1 Generic Arithmetic Operations)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">add</span> x y) (<span class="name">apply-generic</span> <span class="symbol">'add</span> x y))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sub</span> x y) (<span class="name">apply-generic</span> <span class="symbol">'sub</span> x y))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">mul</span> x y) (<span class="name">apply-generic</span> <span class="symbol">'mul</span> x y))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">div</span> x y) (<span class="name">apply-generic</span> <span class="symbol">'div</span> x y))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">install-scheme-number-package</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">tag</span> x)</span><br><span class="line">    (<span class="name">attach-tag</span> <span class="symbol">'scheme-number</span> x))</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'add</span> '(scheme-number scheme-number)</span><br><span class="line">       (<span class="name"><span class="builtin-name">lambda</span></span> (x y) (<span class="name">tag</span> (<span class="name"><span class="builtin-name">+</span></span> x y))))</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'sub</span> '(scheme-number scheme-number)</span><br><span class="line">       (<span class="name"><span class="builtin-name">lambda</span></span> (x y) (<span class="name">tag</span> (<span class="name"><span class="builtin-name">-</span></span> x y))))</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'mul</span> '(scheme-number scheme-number)</span><br><span class="line">       (<span class="name"><span class="builtin-name">lambda</span></span> (x y) (<span class="name">tag</span> (<span class="name"><span class="builtin-name">*</span></span> x y))))</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'div</span> '(scheme-number scheme-number)</span><br><span class="line">       (<span class="name"><span class="builtin-name">lambda</span></span> (x y) (<span class="name">tag</span> (<span class="name"><span class="builtin-name">/</span></span> x y))))</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'make</span> <span class="symbol">'scheme-number</span></span><br><span class="line">       (<span class="name"><span class="builtin-name">lambda</span></span> (x) (<span class="name">tag</span> x)))</span><br><span class="line">  <span class="symbol">'done</span>)</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-scheme-number</span> n)</span><br><span class="line">  ((<span class="name">get</span> <span class="symbol">'make</span> <span class="symbol">'scheme-number</span>) n))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">install-rational-package</span>)</span><br><span class="line">  <span class="comment">;; internal procedures</span></span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">numer</span> x) (<span class="name"><span class="builtin-name">car</span></span> x))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">denom</span> x) (<span class="name"><span class="builtin-name">cdr</span></span> x))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-rat</span> n d)</span><br><span class="line">    (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">g</span> (<span class="name"><span class="builtin-name">gcd</span></span> n d)))</span><br><span class="line">      (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">/</span></span> n g) (<span class="name"><span class="builtin-name">/</span></span> d g))))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">add-rat</span> x y)</span><br><span class="line">    (<span class="name">make-rat</span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">numer</span> x) (<span class="name">denom</span> y))</span><br><span class="line">                 (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">numer</span> y) (<span class="name">denom</span> x)))</span><br><span class="line">              (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">denom</span> x) (<span class="name">denom</span> y))))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sub-rat</span> x y)</span><br><span class="line">    (<span class="name">make-rat</span> (<span class="name"><span class="builtin-name">-</span></span> (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">numer</span> x) (<span class="name">denom</span> y))</span><br><span class="line">                 (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">numer</span> y) (<span class="name">denom</span> x)))</span><br><span class="line">              (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">denom</span> x) (<span class="name">denom</span> y))))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">mul-rat</span> x y)</span><br><span class="line">    (<span class="name">make-rat</span> (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">numer</span> x) (<span class="name">numer</span> y))</span><br><span class="line">              (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">denom</span> x) (<span class="name">denom</span> y))))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">div-rat</span> x y)</span><br><span class="line">    (<span class="name">make-rat</span> (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">numer</span> x) (<span class="name">denom</span> y))</span><br><span class="line">              (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">denom</span> x) (<span class="name">numer</span> y))))</span><br><span class="line">  <span class="comment">;; interface to rest of the system</span></span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">tag</span> x) (<span class="name">attach-tag</span> <span class="symbol">'rational</span> x))</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'add</span> '(rational rational)</span><br><span class="line">       (<span class="name"><span class="builtin-name">lambda</span></span> (x y) (<span class="name">tag</span> (<span class="name">add-rat</span> x y))))</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'sub</span> '(rational rational)</span><br><span class="line">       (<span class="name"><span class="builtin-name">lambda</span></span> (x y) (<span class="name">tag</span> (<span class="name">sub-rat</span> x y))))</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'mul</span> '(rational rational)</span><br><span class="line">       (<span class="name"><span class="builtin-name">lambda</span></span> (x y) (<span class="name">tag</span> (<span class="name">mul-rat</span> x y))))</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'div</span> '(rational rational)</span><br><span class="line">       (<span class="name"><span class="builtin-name">lambda</span></span> (x y) (<span class="name">tag</span> (<span class="name">div-rat</span> x y))))</span><br><span class="line"></span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'make</span> <span class="symbol">'rational</span></span><br><span class="line">       (<span class="name"><span class="builtin-name">lambda</span></span> (n d) (<span class="name">tag</span> (<span class="name">make-rat</span> n d))))</span><br><span class="line">  <span class="symbol">'done</span>)</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-rational</span> n d)</span><br><span class="line">  ((<span class="name">get</span> <span class="symbol">'make</span> <span class="symbol">'rational</span>) n d))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">install-complex-package</span>)</span><br><span class="line">  <span class="comment">;; imported procedures from rectangular and polar packages</span></span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-from-real-imag</span> x y)</span><br><span class="line">    ((<span class="name">get</span> <span class="symbol">'make-from-real-imag</span> <span class="symbol">'rectangular</span>) x y))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-from-mag-ang</span> r a)</span><br><span class="line">    ((<span class="name">get</span> <span class="symbol">'make-from-mag-ang</span> <span class="symbol">'polar</span>) r a))</span><br><span class="line">  <span class="comment">;; internal procedures</span></span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">add-complex</span> z1 z2)</span><br><span class="line">    (<span class="name">make-from-real-imag</span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name"><span class="builtin-name">real-part</span></span> z1) (<span class="name"><span class="builtin-name">real-part</span></span> z2))</span><br><span class="line">                         (<span class="name"><span class="builtin-name">+</span></span> (<span class="name"><span class="builtin-name">imag-part</span></span> z1) (<span class="name"><span class="builtin-name">imag-part</span></span> z2))))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sub-complex</span> z1 z2)</span><br><span class="line">    (<span class="name">make-from-real-imag</span> (<span class="name"><span class="builtin-name">-</span></span> (<span class="name"><span class="builtin-name">real-part</span></span> z1) (<span class="name"><span class="builtin-name">real-part</span></span> z2))</span><br><span class="line">                         (<span class="name"><span class="builtin-name">-</span></span> (<span class="name"><span class="builtin-name">imag-part</span></span> z1) (<span class="name"><span class="builtin-name">imag-part</span></span> z2))))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">mul-complex</span> z1 z2)</span><br><span class="line">    (<span class="name">make-from-mag-ang</span> (<span class="name"><span class="builtin-name">*</span></span> (<span class="name"><span class="builtin-name">magnitude</span></span> z1) (<span class="name"><span class="builtin-name">magnitude</span></span> z2))</span><br><span class="line">                       (<span class="name"><span class="builtin-name">+</span></span> (<span class="name"><span class="builtin-name">angle</span></span> z1) (<span class="name"><span class="builtin-name">angle</span></span> z2))))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">div-complex</span> z1 z2)</span><br><span class="line">    (<span class="name">make-from-mag-ang</span> (<span class="name"><span class="builtin-name">/</span></span> (<span class="name"><span class="builtin-name">magnitude</span></span> z1) (<span class="name"><span class="builtin-name">magnitude</span></span> z2))</span><br><span class="line">                       (<span class="name"><span class="builtin-name">-</span></span> (<span class="name"><span class="builtin-name">angle</span></span> z1) (<span class="name"><span class="builtin-name">angle</span></span> z2))))</span><br><span class="line"></span><br><span class="line">  <span class="comment">;; interface to rest of the system</span></span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">tag</span> z) (<span class="name">attach-tag</span> <span class="symbol">'complex</span> z))</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'add</span> '(complex complex)</span><br><span class="line">       (<span class="name"><span class="builtin-name">lambda</span></span> (z1 z2) (<span class="name">tag</span> (<span class="name">add-complex</span> z1 z2))))</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'sub</span> '(complex complex)</span><br><span class="line">       (<span class="name"><span class="builtin-name">lambda</span></span> (z1 z2) (<span class="name">tag</span> (<span class="name">sub-complex</span> z1 z2))))</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'mul</span> '(complex complex)</span><br><span class="line">       (<span class="name"><span class="builtin-name">lambda</span></span> (z1 z2) (<span class="name">tag</span> (<span class="name">mul-complex</span> z1 z2))))</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'div</span> '(complex complex)</span><br><span class="line">       (<span class="name"><span class="builtin-name">lambda</span></span> (z1 z2) (<span class="name">tag</span> (<span class="name">div-complex</span> z1 z2))))</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'make-from-real-imag</span> <span class="symbol">'complex</span></span><br><span class="line">       (<span class="name"><span class="builtin-name">lambda</span></span> (x y) (<span class="name">tag</span> (<span class="name">make-from-real-imag</span> x y))))</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'make-from-mag-ang</span> <span class="symbol">'complex</span></span><br><span class="line">       (<span class="name"><span class="builtin-name">lambda</span></span> (r a) (<span class="name">tag</span> (<span class="name">make-from-mag-ang</span> r a))))</span><br><span class="line">  <span class="symbol">'done</span>)</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-complex-from-real-imag</span> x y)</span><br><span class="line">  ((<span class="name">get</span> <span class="symbol">'make-from-real-imag</span> <span class="symbol">'complex</span>) x y))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-complex-from-mag-ang</span> r a)</span><br><span class="line">  ((<span class="name">get</span> <span class="symbol">'make-from-mag-ang</span> <span class="symbol">'complex</span>) r a))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-2-77"><a href="#Exercise-2-77" class="headerlink" title="Exercise 2.77"></a>Exercise 2.77</h3><p>Louis Reasoner tries to evaluate the expression (magnitude z) where z is the object shown in Figure 2.24. To his surprise, instead of the answer 5 he gets an error message from <code>apply-generic</code>, saying there is no method for the operation magnitude on the types (complex). He shows this interaction to Alyssa P. Hacker, who says “The problem is that the <code>complex-number</code> selectors were never defined for complex numbers, just for polar and rectangular numbers. All you have to do to make this work is add the following to the complex package:”<br>(put ‘real-part ‘(complex) real-part)<br>(put ‘imag-part ‘(complex) imag-part)<br>(put ‘magnitude ‘(complex) magnitude)<br>(put ‘angle ‘(complex) angle)<br>Describe in detail why this works. As an example, trace through all the procedures called in evaluating the expression (magnitude z) where z is the object shown in Figure 2.24. In particular, how many times is <code>apply-generic</code> invoked? What procedure is dispatched to in each case?</p>
<h3 id="Exercise-2-78"><a href="#Exercise-2-78" class="headerlink" title="Exercise 2.78"></a>Exercise 2.78</h3><p>The internal procedures in the scheme-number package are essentially nothing more than calls to the primitive procedures +, -, etc. It was not possible to use the primitives of the language directly because our type-tag system requires that each data object have a type attached to it. In fact, however, all Lisp implementations do have a type system, which they use internally. Primitive predicates such as <code>symbol?</code> and <code>number?</code> determine whether data objects have particular types. Modify the definitions of <code>type-tag</code>, <code>contents</code>, and <code>attach-tag</code> from Section 2.4.2 so that our generic system takes advantage of Scheme’s internal type system. That is to say, the system should work as before except that ordinary numbers should be represented simply as Scheme numbers rather than as pairs whose car is the symbol scheme-number.</p>
<h3 id="Exercise-2-79"><a href="#Exercise-2-79" class="headerlink" title="Exercise 2.79"></a>Exercise 2.79</h3><p>Define a generic equality predicate equ? that tests the equality of two numbers, and install it in the generic arithmetic package. This operation should work for ordinary numbers, rational numbers, and complex numbers.</p>
<h3 id="Exercise-2-80"><a href="#Exercise-2-80" class="headerlink" title="Exercise 2.80"></a>Exercise 2.80</h3><p>Define a generic predicate <code>=zero?</code> that tests if its argument is zero, and install it in the generic arithmetic package. This operation should work for ordinary numbers, rational numbers, and complex numbers.</p>
<h2 id="不同类型数据的组合"><a href="#不同类型数据的组合" class="headerlink" title="不同类型数据的组合"></a>不同类型数据的组合</h2><p>(2.5.2 Combining Data of Different Types)</p>
<p>;; to be included in the complex package<br>;: (define (add-complex-to-schemenum z x)<br>;:   (make-from-real-imag (+ (real-part z) x)<br>;:                        (imag-part z)))<br>;:<br>;: (put ‘add ‘(complex scheme-number)<br>;:      (lambda (z x) (tag (add-complex-to-schemenum z x))))</p>
<p>;; Coercion<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">scheme-number-&gt;complex</span> n)</span><br><span class="line">  (<span class="name">make-complex-from-real-imag</span> (<span class="name">contents</span> n) <span class="number">0</span>))</span><br></pre></td></tr></table></figure></p>
<p>;: (put-coercion ‘scheme-number ‘complex scheme-number-&gt;complex)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">apply-generic</span> op . args)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">type-tags</span> (<span class="name"><span class="builtin-name">map</span></span> type-tag args)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">proc</span> (<span class="name">get</span> op type-tags)))</span><br><span class="line">      (<span class="name"><span class="builtin-name">if</span></span> proc</span><br><span class="line">          (<span class="name"><span class="builtin-name">apply</span></span> proc (<span class="name"><span class="builtin-name">map</span></span> contents args))</span><br><span class="line">          (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> (<span class="name"><span class="builtin-name">length</span></span> args) <span class="number">2</span>)</span><br><span class="line">              (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">type1</span> (<span class="name"><span class="builtin-name">car</span></span> type-tags))</span><br><span class="line">                    (<span class="name">type2</span> (<span class="name"><span class="builtin-name">cadr</span></span> type-tags))</span><br><span class="line">                    (<span class="name">a1</span> (<span class="name"><span class="builtin-name">car</span></span> args))</span><br><span class="line">                    (<span class="name">a2</span> (<span class="name"><span class="builtin-name">cadr</span></span> args)))</span><br><span class="line">                (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">t1-&gt;t2</span> (<span class="name">get-coercion</span> type1 type2))</span><br><span class="line">                      (<span class="name">t2-&gt;t1</span> (<span class="name">get-coercion</span> type2 type1)))</span><br><span class="line">                  (<span class="name"><span class="builtin-name">cond</span></span> (<span class="name">t1-&gt;t2</span></span><br><span class="line">                         (<span class="name">apply-generic</span> op (<span class="name">t1-&gt;t2</span> a1) a2))</span><br><span class="line">                        (<span class="name">t2-&gt;t1</span></span><br><span class="line">                         (<span class="name">apply-generic</span> op a1 (<span class="name">t2-&gt;t1</span> a2)))</span><br><span class="line">                        (<span class="name"><span class="builtin-name">else</span></span></span><br><span class="line">                         (<span class="name">error</span> <span class="string">"No method for these types"</span></span><br><span class="line">                                (<span class="name"><span class="builtin-name">list</span></span> op type-tags))))))</span><br><span class="line">              (<span class="name">error</span> <span class="string">"No method for these types"</span></span><br><span class="line">                     (<span class="name"><span class="builtin-name">list</span></span> op type-tags)))))))</span><br></pre></td></tr></table></figure>
<h2 id="实例：符号代数"><a href="#实例：符号代数" class="headerlink" title="实例：符号代数"></a>实例：符号代数</h2><p>(2.5.3 Example: Symbolic Algebra)</p>
<p>;;; ALL procedures in 2.5.3 except make-polynomial<br>;;; should be inserted in install-polynomial-package, as indicated<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">add-poly</span> p1 p2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">same-variable?</span> (<span class="name">variable</span> p1) (<span class="name">variable</span> p2))</span><br><span class="line">      (<span class="name">make-poly</span> (<span class="name">variable</span> p1)</span><br><span class="line">                 (<span class="name">add-terms</span> (<span class="name">term-list</span> p1)</span><br><span class="line">                            (<span class="name">term-list</span> p2)))</span><br><span class="line">      (<span class="name">error</span> <span class="string">"Polys not in same var -- ADD-POLY"</span></span><br><span class="line">             (<span class="name"><span class="builtin-name">list</span></span> p1 p2))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">mul-poly</span> p1 p2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">same-variable?</span> (<span class="name">variable</span> p1) (<span class="name">variable</span> p2))</span><br><span class="line">      (<span class="name">make-poly</span> (<span class="name">variable</span> p1)</span><br><span class="line">                 (<span class="name">mul-terms</span> (<span class="name">term-list</span> p1)</span><br><span class="line">                            (<span class="name">term-list</span> p2)))</span><br><span class="line">      (<span class="name">error</span> <span class="string">"Polys not in same var -- MUL-POLY"</span></span><br><span class="line">             (<span class="name"><span class="builtin-name">list</span></span> p1 p2))))</span><br></pre></td></tr></table></figure></p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;; *incomplete* skeleton of package</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">install-polynomial-package</span>)</span><br><span class="line">  <span class="comment">;; internal procedures</span></span><br><span class="line">  <span class="comment">;; representation of poly</span></span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-poly</span> variable term-list)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cons</span></span> variable term-list))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">variable</span> p) (<span class="name"><span class="builtin-name">car</span></span> p))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">term-list</span> p) (<span class="name"><span class="builtin-name">cdr</span></span> p))</span><br><span class="line">  <span class="comment">;;[procedures same-variable? and variable? from section 2.3.2]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">;; representation of terms and term lists</span></span><br><span class="line">  <span class="comment">;;[procedures adjoin-term ... coeff from text below]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">;;(define (add-poly p1 p2) ... )</span></span><br><span class="line">  <span class="comment">;;[procedures used by add-poly]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">;;(define (mul-poly p1 p2) ... )</span></span><br><span class="line">  <span class="comment">;;[procedures used by mul-poly]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">;; interface to rest of the system</span></span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">tag</span> p) (<span class="name">attach-tag</span> <span class="symbol">'polynomial</span> p))</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'add</span> '(polynomial polynomial)</span><br><span class="line">       (<span class="name"><span class="builtin-name">lambda</span></span> (p1 p2) (<span class="name">tag</span> (<span class="name">add-poly</span> p1 p2))))</span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'mul</span> '(polynomial polynomial)</span><br><span class="line">       (<span class="name"><span class="builtin-name">lambda</span></span> (p1 p2) (<span class="name">tag</span> (<span class="name">mul-poly</span> p1 p2))))</span><br><span class="line"></span><br><span class="line">  (<span class="name">put</span> <span class="symbol">'make</span> <span class="symbol">'polynomial</span></span><br><span class="line">       (<span class="name"><span class="builtin-name">lambda</span></span> (var terms) (<span class="name">tag</span> (<span class="name">make-poly</span> var terms))))</span><br><span class="line">  <span class="symbol">'done</span>)</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">add-terms</span> L1 L2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name">empty-termlist?</span> L1) L2)</span><br><span class="line">        ((<span class="name">empty-termlist?</span> L2) L1)</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span></span><br><span class="line">         (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">t1</span> (<span class="name">first-term</span> L1)) (<span class="name">t2</span> (<span class="name">first-term</span> L2)))</span><br><span class="line">           (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">&gt;</span></span> (<span class="name">order</span> t1) (<span class="name">order</span> t2))</span><br><span class="line">                  (<span class="name">adjoin-term</span></span><br><span class="line">                   t1 (<span class="name">add-terms</span> (<span class="name">rest-terms</span> L1) L2)))</span><br><span class="line">                 ((<span class="name"><span class="builtin-name">&lt;</span></span> (<span class="name">order</span> t1) (<span class="name">order</span> t2))</span><br><span class="line">                  (<span class="name">adjoin-term</span></span><br><span class="line">                   t2 (<span class="name">add-terms</span> L1 (<span class="name">rest-terms</span> L2))))</span><br><span class="line">                 (<span class="name"><span class="builtin-name">else</span></span></span><br><span class="line">                  (<span class="name">adjoin-term</span></span><br><span class="line">                   (<span class="name">make-term</span> (<span class="name">order</span> t1)</span><br><span class="line">                              (<span class="name">add</span> (<span class="name">coeff</span> t1) (<span class="name">coeff</span> t2)))</span><br><span class="line">                   (<span class="name">add-terms</span> (<span class="name">rest-terms</span> L1)</span><br><span class="line">                              (<span class="name">rest-terms</span> L2)))))))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">mul-terms</span> L1 L2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">empty-termlist?</span> L1)</span><br><span class="line">      (<span class="name">the-empty-termlist</span>)</span><br><span class="line">      (<span class="name">add-terms</span> (<span class="name">mul-term-by-all-terms</span> (<span class="name">first-term</span> L1) L2)</span><br><span class="line">                 (<span class="name">mul-terms</span> (<span class="name">rest-terms</span> L1) L2))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">mul-term-by-all-terms</span> t1 L)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">empty-termlist?</span> L)</span><br><span class="line">      (<span class="name">the-empty-termlist</span>)</span><br><span class="line">      (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">t2</span> (<span class="name">first-term</span> L)))</span><br><span class="line">        (<span class="name">adjoin-term</span></span><br><span class="line">         (<span class="name">make-term</span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">order</span> t1) (<span class="name">order</span> t2))</span><br><span class="line">                    (<span class="name">mul</span> (<span class="name">coeff</span> t1) (<span class="name">coeff</span> t2)))</span><br><span class="line">         (<span class="name">mul-term-by-all-terms</span> t1 (<span class="name">rest-terms</span> L))))))</span><br></pre></td></tr></table></figure>
<p>;; Representing term lists<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">adjoin-term</span> term term-list)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">=zero?</span> (<span class="name">coeff</span> term))</span><br><span class="line">      term-list</span><br><span class="line">      (<span class="name"><span class="builtin-name">cons</span></span> term term-list)))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">the-empty-termlist</span>) '())</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">first-term</span> term-list) (<span class="name"><span class="builtin-name">car</span></span> term-list))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">rest-terms</span> term-list) (<span class="name"><span class="builtin-name">cdr</span></span> term-list))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">empty-termlist?</span> term-list) (<span class="name"><span class="builtin-name">null?</span></span> term-list))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-term</span> order coeff) (<span class="name"><span class="builtin-name">list</span></span> order coeff))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">order</span> term) (<span class="name"><span class="builtin-name">car</span></span> term))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">coeff</span> term) (<span class="name"><span class="builtin-name">cadr</span></span> term))</span><br></pre></td></tr></table></figure></p>
<p>;; Constructor<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-polynomial</span> var terms)</span><br><span class="line">  ((<span class="name">get</span> <span class="symbol">'make</span> <span class="symbol">'polynomial</span>) var terms))</span><br></pre></td></tr></table></figure></p>
<p>;; Rational functions<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">gcd</span></span> a b)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> b <span class="number">0</span>)</span><br><span class="line">      a</span><br><span class="line">      (<span class="name"><span class="builtin-name">gcd</span></span> b (<span class="name"><span class="builtin-name">remainder</span></span> a b))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">gcd-terms</span> a b)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">empty-termlist?</span> b)</span><br><span class="line">      a</span><br><span class="line">      (<span class="name">gcd-terms</span> b (<span class="name">remainder-terms</span> a b))))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-2-81"><a href="#Exercise-2-81" class="headerlink" title="Exercise 2.81"></a>Exercise 2.81</h3><p>Louis Reasoner has noticed that apply-generic may try to coerce the arguments to each other’s type even if they already have the same type. Therefore, he reasons, we need to put procedures in the coercion table to coerce arguments of each type to their own type. For example, in addition to the <code>scheme-number-&gt;complex</code> coercion shown above, he would do:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">scheme-number-&gt;scheme-number</span> n) n)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">complex-&gt;complex</span> z) z)</span><br><span class="line">(<span class="name">put-coercion</span> <span class="symbol">'scheme-number</span></span><br><span class="line">              <span class="symbol">'scheme-number</span></span><br><span class="line">              scheme-number-&gt;scheme-number)</span><br><span class="line">(<span class="name">put-coercion</span> <span class="symbol">'complex</span> <span class="symbol">'complex</span> complex-&gt;complex)</span><br></pre></td></tr></table></figure></p>
<p>a. With Louis’s coercion procedures installed, what happens if <code>apply-generic</code> is called with two arguments of type <code>scheme-number</code> or two arguments of type <code>complex</code> for an operation that is not found in the table for those types? For example, assume that we’ve defined a generic<br>exponentiation operation:<br><code>(define (exp x y) (apply-generic &#39;exp x y))</code><br>and have put a procedure for exponentiation in the Scheme-number package but not in any other package:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;; following added to Scheme-number package</span></span><br><span class="line">(<span class="name">put</span> <span class="symbol">'exp</span> '(scheme-number scheme-number)</span><br><span class="line">(<span class="name"><span class="builtin-name">lambda</span></span> (x y) (<span class="name">tag</span> (<span class="name"><span class="builtin-name">expt</span></span> x y))))</span><br><span class="line"><span class="comment">; using primitive expt</span></span><br></pre></td></tr></table></figure></p>
<p>What happens if we call <code>exp</code> with two complex numbers as arguments?<br>b. Is Louis correct that something had to be done about coercion with arguments of the same type, or does <code>apply-generic</code> work correctly as is?<br>c. Modify <code>apply-generic</code> so that it doesn’t try coercion if the two arguments have the same type.</p>
<h3 id="Exercise-2-82"><a href="#Exercise-2-82" class="headerlink" title="Exercise 2.82"></a>Exercise 2.82</h3><p>Show how to generalize apply-generic to handle coercion in the general case of multiple arguments. One strategy is to attempt to coerce all the arguments to the type of the first argument, then to the type of the second argument, and so on. Give an example of a situation where this strategy (and likewise the two-argument version given above) is not sufficiently general. (Hint: Consider the case where there are some suitable mixed-type operations present in the table that will not be tried.)</p>
<h3 id="Exercise-2-83"><a href="#Exercise-2-83" class="headerlink" title="Exercise 2.83"></a>Exercise 2.83</h3><p>Suppose you are designing a generic arithmetic system for dealing with the tower of types shown in Figure 2.25: integer, rational, real, complex. For each type (except complex), design a procedure that raises objects of that type one level in the tower. Show how to install a generic raise operation that will work for each type (except complex).</p>
<h3 id="Exercise-2-84"><a href="#Exercise-2-84" class="headerlink" title="Exercise 2.84"></a>Exercise 2.84</h3><p>Using the raise operation of Exercise 2.83, modify the <code>apply-generic</code> procedure so that it coerces its arguments to have the same type by the method of successive raising, as discussed in this section. You will need to devise a way to test which of two types is higher in the tower. Do this in a manner that is “compatible” with the rest of the system and will not lead to problems in adding new levels to the tower.</p>
<h3 id="Exercise-2-85"><a href="#Exercise-2-85" class="headerlink" title="Exercise 2.85"></a>Exercise 2.85</h3><p>This section mentioned a method for “simplifying” a data object by lowering it in the tower of types as far as possible. Design a procedure drop that accomplishes this for the tower described in Exercise 2.83. The key is to decide, in some general way, whether an object can be lowered. For example, the complex number 1: 5 + 0i can be lowered as far as real, the complex number 1 + 0i can be lowered as far as integer, and the complex number 2 + 3i cannot be lowered at all. Here is a plan for determining whether an object can be lowered: Begin by defining a generic operation project that “pushes” an object down in the tower. For example, projecting a complex number would involve throwing away the imaginary part. Then a number can be dropped if, when we <code>project</code> it and <code>raise</code> the result back to the type we started with, we end up with something equal to what we started with. Show how to implement this idea in detail, by writing a drop procedure that drops an object as far as possible. You will need to design the various projection operations53 and install <code>project</code> as a generic operation in the system. You will also need to make use of a generic equality predicate, such as described in Exercise 2.79. Finally, use <code>drop</code> to rewrite <code>apply-generic</code> from Exercise 2.84 so that it “simplifies” its answers.</p>
<h3 id="Exercise-2-86"><a href="#Exercise-2-86" class="headerlink" title="Exercise 2.86"></a>Exercise 2.86</h3><p>Suppose we want to handle complex numbers whose real parts, imaginary parts, magnitudes, and angles can be either ordinary numbers, rational numbers, or other numbers we might wish to add to the system. Describe and implement the changes to the system needed to accommodate this. You will have to define operations such as sine and cosine that are generic over ordinary numbers and rational numbers. </p>
<h3 id="Exercise-2-87"><a href="#Exercise-2-87" class="headerlink" title="Exercise 2.87"></a>Exercise 2.87</h3><p>Install <code>=zero?</code> for polynomials in the generic arithmetic package. This will allow <code>adjoin-term</code> to work for polynomials with coefficients that are themselves polynomials.</p>
<h3 id="Exercise-2-88"><a href="#Exercise-2-88" class="headerlink" title="Exercise 2.88"></a>Exercise 2.88</h3><p>Extend the polynomial system to include subtraction of polynomials. (Hint: You may find it helpful to define a generic negation operation.)</p>
<h3 id="Exercise-2-89"><a href="#Exercise-2-89" class="headerlink" title="Exercise 2.89"></a>Exercise 2.89</h3><p>Define procedures that implement the termlist representation described above as appropriate for dense polynomials.</p>
<h3 id="Exercise-2-90"><a href="#Exercise-2-90" class="headerlink" title="Exercise 2.90"></a>Exercise 2.90</h3><p>Suppose we want to have a polynomial system that is efficient for both sparse and dense polynomials. One way to do this is to allow both kinds of term-list representations in our system. The situation is analogous to the complex-number example of Section 2.4, where we allowed both rectangular and polar representations. To do this we must distinguish different types of term lists and make the operations on term lists generic. Redesign the polynomial system to implement this generalization. This is a major effort, not a local change.</p>
<h3 id="Exercise-2-91"><a href="#Exercise-2-91" class="headerlink" title="Exercise 2.91"></a>Exercise 2.91</h3><p>A univariate polynomial can be divided by another one to produce a polynomial quotient and a polynomial remainder. For example,<br>$$\frac{x^{5}-1}{x^{2}-1}=x^{3}+x,\text{ remainder }x-1$$<br>Division can be performed via long division. That is, divide the highest-order term of the dividend by the highest-order term of the divisor. The result is the first term of the quotient. Next, multiply the result by the divisor, subtract that from the dividend, and produce the rest of the answer by recursively dividing the difference by the divisor. Stop when the order of the divisor exceeds the order of the dividend and declare the dividend to be the remainder. Also, if the dividend ever becomes zero, return zero as both quotient and remainder.<br>We can design a <code>div-poly</code> procedure on the model of addpoly and <code>mul-poly</code>. The procedure checks to see if the two polys have the same variable. If so, <code>div-poly</code> strips off the variable and passes the problem to div-terms, which performs the division operation on term lists. <code>div-poly</code> finally reattaches the variable to the result supplied by <code>div-terms</code>. It is convenient to design <code>div-terms</code> to compute both the quotient and the remainder of a division. <code>div-terms</code> can take two term lists as arguments and return a list of the quotient term list and the remainder term list.<br>Complete the following definition of div-terms by filling in the missing expressions. Use this to implement div-poly, which takes two polys as arguments and returns a list of the quotient and remainder polys.<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">div-terms</span> L1 L2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">empty-termlist?</span> L1)</span><br><span class="line">    (<span class="name"><span class="builtin-name">list</span></span> (<span class="name">the-empty-termlist</span>) (<span class="name">the-empty-termlist</span>))</span><br><span class="line">    (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">t1</span> (<span class="name">first-term</span> L1))</span><br><span class="line">          (<span class="name">t2</span> (<span class="name">first-term</span> L2)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;</span></span> (<span class="name">order</span> t2) (<span class="name">order</span> t1))</span><br><span class="line">        (<span class="name"><span class="builtin-name">list</span></span> (<span class="name">the-empty-termlist</span>) L1)</span><br><span class="line">        (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">new-c</span> (<span class="name">div</span> (<span class="name">coeff</span> t1) (<span class="name">coeff</span> t2)))</span><br><span class="line">              (<span class="name">new-o</span> (<span class="name"><span class="builtin-name">-</span></span> (<span class="name">order</span> t1) (<span class="name">order</span> t2))))</span><br><span class="line">          (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">rest-of-result</span></span><br><span class="line">                 &lt;compute rest of result recursively&gt; ))</span><br><span class="line">             &lt;form complete result&gt; ))))))</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">wangzk1900</p>
              <div class="site-description motion-element" itemprop="description">记录学习总结和思考</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/wangzk1900" title="GitHub &rarr; https://github.com/wangzk1900" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:wangzk1900@gmail.com" title="E-Mail &rarr; mailto:wangzk1900@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wangzk1900</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.1.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.1"></script>

  <script src="/js/motion.js?v=7.1.1"></script>



  
  


  <script src="/js/affix.js?v=7.1.1"></script>

  <script src="/js/schemes/pisces.js?v=7.1.1"></script>




  

  


  <script src="/js/next-boot.js?v=7.1.1"></script>


  

  

  

  



  




  

  

  
  

  
  
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  

  
    
      <script type="text/x-mathjax-config">
  

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });
  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') { next = next.nextSibling }
        if (next && next.nodeName.toLowerCase() === 'br') { next.parentNode.removeChild(next) }
      }
    });
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      document.getElementById(all[i].inputID + '-Frame').parentNode.className += ' has-jax';
    }
  });
</script>
<script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=default"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

    
  


  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
