<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.1.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="对于构建复杂的系统，前两章介绍的抽象方法是不够用的。本章将介绍两种方法：基于对象的方法和流处理方法。 赋值和局部状态(3.1 Assignment and Local State) 我们通常将世界看作是由众多相互独立的“对象”组成，每个“对象”都有自己的状态，并且状态是随着时间在变化的。同样地，在编程时我们可以采用这种方式来组织各种计算性对象。每个计算性对象必须包含自己的局部状态变量，用这些变量来">
<meta property="og:type" content="article">
<meta property="og:title" content="03_模块化、对象和状态">
<meta property="og:url" content="http://yoursite.com/2019/07/08/SICP笔记_03_模块化、对象和状态/index.html">
<meta property="og:site_name" content="wangzk1900&#39;s site">
<meta property="og:description" content="对于构建复杂的系统，前两章介绍的抽象方法是不够用的。本章将介绍两种方法：基于对象的方法和流处理方法。 赋值和局部状态(3.1 Assignment and Local State) 我们通常将世界看作是由众多相互独立的“对象”组成，每个“对象”都有自己的状态，并且状态是随着时间在变化的。同样地，在编程时我们可以采用这种方式来组织各种计算性对象。每个计算性对象必须包含自己的局部状态变量，用这些变量来">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/images/sicp/Figure_3.4.png">
<meta property="og:image" content="http://yoursite.com/images/sicp/Figure_3.22.png">
<meta property="og:image" content="http://yoursite.com/images/sicp/Figure_3.23.png">
<meta property="og:image" content="http://yoursite.com/images/sicp/Figure_3.24.png">
<meta property="og:image" content="http://yoursite.com/images/sicp/Figure_3.25.png">
<meta property="og:image" content="http://yoursite.com/images/sicp/Figure_3.26.png">
<meta property="og:image" content="http://yoursite.com/images/sicp/Figure_3.27.png">
<meta property="og:updated_time" content="2019-07-16T02:16:36.425Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="03_模块化、对象和状态">
<meta name="twitter:description" content="对于构建复杂的系统，前两章介绍的抽象方法是不够用的。本章将介绍两种方法：基于对象的方法和流处理方法。 赋值和局部状态(3.1 Assignment and Local State) 我们通常将世界看作是由众多相互独立的“对象”组成，每个“对象”都有自己的状态，并且状态是随着时间在变化的。同样地，在编程时我们可以采用这种方式来组织各种计算性对象。每个计算性对象必须包含自己的局部状态变量，用这些变量来">
<meta name="twitter:image" content="http://yoursite.com/images/sicp/Figure_3.4.png">





  
  
  <link rel="canonical" href="http://yoursite.com/2019/07/08/SICP笔记_03_模块化、对象和状态/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>03_模块化、对象和状态 | wangzk1900's site</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">wangzk1900's site</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">我的小站</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/08/SICP笔记_03_模块化、对象和状态/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wangzk1900">
      <meta itemprop="description" content="记录学习总结和思考">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangzk1900's site">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">03_模块化、对象和状态

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-08 00:00:00" itemprop="dateCreated datePublished" datetime="2019-07-08T00:00:00+08:00">2019-07-08</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-16 10:16:36" itemprop="dateModified" datetime="2019-07-16T10:16:36+08:00">2019-07-16</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/SICP笔记/" itemprop="url" rel="index"><span itemprop="name">SICP笔记</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>对于构建复杂的系统，前两章介绍的抽象方法是不够用的。<br>本章将介绍两种方法：基于对象的方法和流处理方法。</p>
<h1 id="赋值和局部状态"><a href="#赋值和局部状态" class="headerlink" title="赋值和局部状态"></a>赋值和局部状态</h1><p>(3.1 Assignment and Local State)</p>
<p>我们通常将世界看作是由众多相互独立的“对象”组成，每个“对象”都有自己的状态，并且状态是随着时间在变化的。<br>同样地，在编程时我们可以采用这种方式来组织各种计算性对象。每个计算性对象必须包含自己的局部状态变量，用这些变量来描述其对应的现实世界中的的东西。</p>
<h2 id="局部状态变量"><a href="#局部状态变量" class="headerlink" title="局部状态变量"></a>局部状态变量</h2><p>(3.1.1 Local State Variables)</p>
<p>假设使用过程<code>withdraw</code>表示从账户中取钱，若账户中的钱充足，则返回账户余额，否则提示余额不足。<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">withdraw</span> <span class="number">25</span>)</span><br><span class="line"><span class="number">75</span></span><br><span class="line">(<span class="name">withdraw</span> <span class="number">25</span>)</span><br><span class="line"><span class="number">50</span></span><br><span class="line">(<span class="name">withdraw</span> <span class="number">60</span>)</span><br><span class="line"><span class="string">"Insufficient funds"</span></span><br><span class="line">(<span class="name">withdraw</span> <span class="number">15</span>)</span><br><span class="line"><span class="number">35</span></span><br></pre></td></tr></table></figure></p>
<p>为了实现<code>withdraw</code>，首先需要定义一个变量<code>balance</code>表示账户中的余额。<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> balance <span class="number">100</span>)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">withdraw</span> amount)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">      (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">             balance)</span><br><span class="line">      <span class="string">"Insufficient funds"</span>))</span><br></pre></td></tr></table></figure></p>
<p>其中，<code>set!</code>是Scheme提供的操作符，用来给变量赋值：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(set! ⟨name⟩ ⟨new-value⟩)</span><br></pre></td></tr></table></figure></p>
<p><code>begin</code>后的表达式会依次被计算，并返回最后一个表达式的值：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(begin ⟨exp1⟩ ⟨exp2⟩ ... ⟨expk⟩)</span><br></pre></td></tr></table></figure></p>
<p>在上面的<code>withdraw</code>定义中，变量<code>balance</code>是定义在全局环境中的，可以被其它过程自由访问。这明显是不合适的。<br>重新定义<code>new-withdraw</code>过程，将<code>balance</code>定义为局部变量：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> new-withdraw</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">balance</span> <span class="number">100</span>))</span><br><span class="line">    (<span class="name"><span class="builtin-name">lambda</span></span> (amount)</span><br><span class="line">      (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">          (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">                 balance)</span><br><span class="line">          <span class="string">"Insufficient funds"</span>))))</span><br></pre></td></tr></table></figure></p>
<p>定义过程<code>make-withdraw</code>，通过参数<code>balance</code>来初始化账户余额：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-withdraw</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">lambda</span></span> (amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">        (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">               balance)</span><br><span class="line">        <span class="string">"Insufficient funds"</span>)))</span><br><span class="line"><span class="comment">; 然后定义两个对象</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> W1 (<span class="name">make-withdraw</span> <span class="number">100</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> W2 (<span class="name">make-withdraw</span> <span class="number">100</span>))</span><br><span class="line">(<span class="name">W1</span> <span class="number">50</span>)</span><br><span class="line"><span class="number">50</span></span><br><span class="line">(<span class="name">W2</span> <span class="number">70</span>)</span><br><span class="line"><span class="number">30</span></span><br><span class="line">(<span class="name">W2</span> <span class="number">40</span>)</span><br><span class="line"><span class="string">"Insufficient funds"</span></span><br><span class="line">(<span class="name">W1</span> <span class="number">40</span>)</span><br><span class="line"><span class="number">10</span></span><br></pre></td></tr></table></figure></p>
<p>很容易观察出，上面两个对象是相互独立的。</p>
<p>对帐户而言，不止有取款操作，还有存款操作。因此，我们可以定义一个对象，并将这个对象和取款存款过程绑定在一起。<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-account</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">withdraw</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">        (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">               balance)</span><br><span class="line">        <span class="string">"Insufficient funds"</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deposit</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">+</span></span> balance amount))</span><br><span class="line">    balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'withdraw</span>) withdraw)</span><br><span class="line">          ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'deposit</span>) deposit)</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown request -- MAKE-ACCOUNT"</span></span><br><span class="line">                       m))))</span><br><span class="line">  dispatch)</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> acc (<span class="name">make-account</span> <span class="number">100</span>))</span><br><span class="line">((<span class="name">acc</span> <span class="symbol">'withdraw</span>) <span class="number">50</span>)</span><br><span class="line"><span class="number">50</span></span><br><span class="line">((<span class="name">acc</span> <span class="symbol">'withdraw</span>) <span class="number">60</span>)</span><br><span class="line"><span class="string">"Insufficient funds"</span></span><br><span class="line">((<span class="name">acc</span> <span class="symbol">'deposit</span>) <span class="number">40</span>)</span><br><span class="line"><span class="number">90</span></span><br><span class="line">((<span class="name">acc</span> <span class="symbol">'withdraw</span>) <span class="number">60</span>)</span><br><span class="line"><span class="number">30</span></span><br></pre></td></tr></table></figure></p>
<p>疑问：局部状态变量会保存多久？</p>
<h3 id="Exercise-3-1"><a href="#Exercise-3-1" class="headerlink" title="Exercise 3.1"></a>Exercise 3.1</h3><p>An <em>accumulator</em> is a procedure that is called repeatedly with a single numeric argument and accumulates its arguments into a sum. Each time it is called, it returns the currently accumulated sum. Write a procedure <strong>make-accumulator</strong> that generates accumulators,each maintaining an independent sum. The input to <strong>make-accumulator</strong> should specify the initial value of the sum; for example<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> A (<span class="name">make-accumulator</span> <span class="number">5</span>))</span><br><span class="line">(<span class="name">A</span> <span class="number">10</span>)</span><br><span class="line"><span class="number">15</span></span><br><span class="line">(<span class="name">A</span> <span class="number">10</span>)</span><br><span class="line"><span class="number">25</span></span><br></pre></td></tr></table></figure></p>
<p>我的答案：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-accumulator</span> sum)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-sum</span> n)</span><br><span class="line">    (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> sum (<span class="name"><span class="builtin-name">+</span></span> sum n)) sum))</span><br><span class="line">  make-sum)</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-3-2"><a href="#Exercise-3-2" class="headerlink" title="Exercise 3.2"></a>Exercise 3.2</h3><p>In software-testing applications, it is useful to be able to count the number of times a given procedure is called during the course of a computation. Write a procedure <strong>make-monitored</strong> that takes as input a procedure, <strong>f</strong> , that itself takes one input. The result returned by make-monitored is a third procedure, say <strong>mf</strong>, that keeps track of the number of times it has been called by maintaining an internal counter. If the input to <strong>mf</strong> is the special symbol <strong>how-many-calls?</strong>, then <strong>mf</strong> returns the value of the counter. If the input is the special symbol <strong>reset-count</strong> , then <strong>mf</strong> resets the counter to zero. For any other input, <strong>mf</strong> returns the result of calling <strong>f</strong> on that input and increments the counter. For instance, we could make a monitored version of the <strong>sqrt</strong> procedure:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> s (<span class="name">make-monitored</span> sqrt))</span><br><span class="line">(<span class="name">s</span> <span class="number">100</span>)</span><br><span class="line"><span class="number">10</span></span><br><span class="line">(<span class="name">s</span> <span class="symbol">'how-many-calls?</span>)</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p>我的答案：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-monitored</span> f)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> times <span class="number">0</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">mf</span> arg)</span><br><span class="line">     (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> arg <span class="symbol">'how-many-calls?</span>) times)</span><br><span class="line">           ((<span class="name"><span class="builtin-name">eq?</span></span> arg <span class="symbol">'reset-count</span>) (<span class="name"><span class="builtin-name">set!</span></span> times <span class="number">0</span>))</span><br><span class="line">           (<span class="name"><span class="builtin-name">else</span></span> (<span class="name"><span class="builtin-name">set!</span></span> times (<span class="name"><span class="builtin-name">+</span></span> times <span class="number">1</span>)) (<span class="name">f</span> arg))))</span><br><span class="line">  mf)</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-3-3"><a href="#Exercise-3-3" class="headerlink" title="Exercise 3.3"></a>Exercise 3.3</h3><p>Modify the <strong>make-account</strong> procedure so that it creates password-protected accounts.That is, <strong>make-account</strong> should take a symbol as an additional argument, as in<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> acc (<span class="name">make-account</span> <span class="number">100</span> <span class="symbol">'secret-password</span>))</span><br></pre></td></tr></table></figure></p>
<p>The resulting account object should process a request only if it is accompanied by the password with which the account was created,and should otherwise return a complaint:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">((<span class="name">acc</span> <span class="symbol">'secret-password</span> <span class="symbol">'withdraw</span>) <span class="number">40</span>)</span><br><span class="line"><span class="number">60</span></span><br><span class="line">((<span class="name">acc</span> <span class="symbol">'some-other-password</span> <span class="symbol">'deposit</span>) <span class="number">50</span>)</span><br><span class="line"><span class="string">"Incorrect password"</span></span><br></pre></td></tr></table></figure></p>
<p>我的答案：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-account</span> balance password)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">withdraw</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">        (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">               balance)</span><br><span class="line">        <span class="string">"Insufficient funds"</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deposit</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">+</span></span> balance amount))</span><br><span class="line">    balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> p m)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">eq?</span></span> p password)</span><br><span class="line">        (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'withdraw</span>) withdraw)</span><br><span class="line">              ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'deposit</span>) deposit)</span><br><span class="line">              (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown request -- MAKE-ACCOUNT"</span></span><br><span class="line">                           m)))</span><br><span class="line">        (<span class="name">error</span> <span class="string">"Incorrect password"</span>)))</span><br><span class="line">  dispatch)</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-3-4"><a href="#Exercise-3-4" class="headerlink" title="Exercise 3.4"></a>Exercise 3.4</h3><p>Modify the make-account procedure of Exercise 3.3 by adding another local state variable so that, if an account is accessed more than seven consecutive times with an incorrect password,it invokes the procedure <strong>call-the-cops</strong></p>
<p>我的答案：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-account</span> balance password)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> error_num <span class="number">0</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">withdraw</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">        (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">               balance)</span><br><span class="line">        <span class="string">"Insufficient funds"</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deposit</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">+</span></span> balance amount))</span><br><span class="line">    balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">call-the-cops</span>)</span><br><span class="line">    (<span class="name"><span class="builtin-name">display</span></span> <span class="string">"Call the cops"</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> p m)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">eq?</span></span> p password)</span><br><span class="line">        (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'withdraw</span>) withdraw)</span><br><span class="line">              ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'deposit</span>) deposit)</span><br><span class="line">              (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown request -- MAKE-ACCOUNT"</span></span><br><span class="line">                           m)))</span><br><span class="line">        (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&lt;</span></span> error_num <span class="number">7</span>)</span><br><span class="line">            (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> error_num (<span class="name"><span class="builtin-name">+</span></span> error_num <span class="number">1</span>)) (<span class="name">error</span> <span class="string">"Incorrect password"</span> error_num))</span><br><span class="line">            (<span class="name"><span class="builtin-name">lambda</span></span> (x) (<span class="name">call-the-cops</span>)))))</span><br><span class="line">  dispatch)</span><br><span class="line"><span class="comment">; 测试</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> acc (<span class="name">make-account</span> <span class="number">100</span> <span class="symbol">'a</span>))</span><br><span class="line">((<span class="name">acc</span> <span class="symbol">'b</span> <span class="symbol">'withdraw</span>) <span class="number">10</span>)</span><br></pre></td></tr></table></figure></p>
<h2 id="引进赋值带来的利益"><a href="#引进赋值带来的利益" class="headerlink" title="引进赋值带来的利益"></a>引进赋值带来的利益</h2><p>(3.1.2 The Benefits of Introducing Assignment)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;; *following uses rand-update -- see ch3support.scm</span></span><br><span class="line"><span class="comment">;; *also must set random-init to some value</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> random-init <span class="number">7</span>)            <span class="comment">;**not in book**</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> rand</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">x</span> random-init))</span><br><span class="line">    (<span class="name"><span class="builtin-name">lambda</span></span> ()</span><br><span class="line">      (<span class="name"><span class="builtin-name">set!</span></span> x (<span class="name">rand-update</span> x))</span><br><span class="line">      x)))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">estimate-pi</span> trials)</span><br><span class="line">  (<span class="name"><span class="builtin-name">sqrt</span></span> (<span class="name"><span class="builtin-name">/</span></span> <span class="number">6</span> (<span class="name">monte-carlo</span> trials cesaro-test))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">cesaro-test</span>)</span><br><span class="line">   (<span class="name"><span class="builtin-name">=</span></span> (<span class="name"><span class="builtin-name">gcd</span></span> (<span class="name">rand</span>) (<span class="name">rand</span>)) <span class="number">1</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">monte-carlo</span> trials experiment)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">iter</span> trials-remaining trials-passed)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">=</span></span> trials-remaining <span class="number">0</span>)</span><br><span class="line">           (<span class="name"><span class="builtin-name">/</span></span> trials-passed trials))</span><br><span class="line">          ((<span class="name">experiment</span>)</span><br><span class="line">           (<span class="name">iter</span> (<span class="name"><span class="builtin-name">-</span></span> trials-remaining <span class="number">1</span>) (<span class="name"><span class="builtin-name">+</span></span> trials-passed <span class="number">1</span>)))</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span></span><br><span class="line">           (<span class="name">iter</span> (<span class="name"><span class="builtin-name">-</span></span> trials-remaining <span class="number">1</span>) trials-passed))))</span><br><span class="line">  (<span class="name">iter</span> trials <span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;; second version (no assignment)</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">estimate-pi</span> trials)</span><br><span class="line">  (<span class="name"><span class="builtin-name">sqrt</span></span> (<span class="name"><span class="builtin-name">/</span></span> <span class="number">6</span> (<span class="name">random-gcd-test</span> trials random-init))))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">random-gcd-test</span> trials initial-x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">iter</span> trials-remaining trials-passed x)</span><br><span class="line">    (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">x1</span> (<span class="name">rand-update</span> x)))</span><br><span class="line">      (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">x2</span> (<span class="name">rand-update</span> x1)))</span><br><span class="line">        (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">=</span></span> trials-remaining <span class="number">0</span>) </span><br><span class="line">               (<span class="name"><span class="builtin-name">/</span></span> trials-passed trials))</span><br><span class="line">              ((<span class="name"><span class="builtin-name">=</span></span> (<span class="name"><span class="builtin-name">gcd</span></span> x1 x2) <span class="number">1</span>)</span><br><span class="line">               (<span class="name">iter</span> (<span class="name"><span class="builtin-name">-</span></span> trials-remaining <span class="number">1</span>)</span><br><span class="line">                     (<span class="name"><span class="builtin-name">+</span></span> trials-passed <span class="number">1</span>)</span><br><span class="line">                     x2))</span><br><span class="line">              (<span class="name"><span class="builtin-name">else</span></span></span><br><span class="line">               (<span class="name">iter</span> (<span class="name"><span class="builtin-name">-</span></span> trials-remaining <span class="number">1</span>)</span><br><span class="line">                     trials-passed</span><br><span class="line">                     x2))))))</span><br><span class="line">  (<span class="name">iter</span> trials <span class="number">0</span> initial-x))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-5"><a href="#Exercise-3-5" class="headerlink" title="Exercise 3.5"></a>Exercise 3.5</h3><p>Monte Carlo integration is a method of estimatingdefinite integrals by means of Monte Carlo simulation.Consider computing the area of a region of space describedby a predicate P(x ; y) that is true for points (x ; y)in the region and false for points not in the region. Forexample, the region contained within a circle of radius 3centered at (5, 7) is described by the predicate that testswhether $[Math Processing Error]x−5^{2}+[Math Processing Error]y−7^{2}\leq3^{2}$. To estimate the area of theregion described by such a predicate, begin by choosing arectangle that contains the region. For example, a rectanglewith diagonally opposite corners at (2, 4) and (8, 10) containsthe circle above. The desired integral is the area ofthat portion of the rectangle that lies in the region. We canestimate the integral by picking, at random, points (x ; y)that lie in the rectangle, and testing P(x ; y) for each pointto determine whether the point lies in the region. If we trythis with many points, then the fraction of points that fallin the region should give an estimate of the proportion ofthe rectangle that lies in the region. Hence, multiplying thisfraction by the area of the entire rectangle should producean estimate of the integral.<br>Implement Monte Carlo integration as a procedure estimateintegralthat takes as arguments a predicate P, upper andlower bounds x1, x2, y1, and y2 for the rectangle, and thenumber of trials to perform in order to produce the estimate.Your procedure should use the same monte-carlo procedure that was used above to estimate π. Use your estimateintegralto produce an estimate of π by measuring thearea of a unit circle.<br>You will find it useful to have a procedure that returns a number chosen at random from a given range. The following random-in-range procedure implements this in terms of the random procedure used in Section 1.2.6, which returns a nonnegative number less than its input.<br>(define (random-in-range low high)<br>  (let ((range (- high low)))<br>    (+ low (random range))))</p>
<h3 id="Exercise-3-6"><a href="#Exercise-3-6" class="headerlink" title="Exercise 3.6"></a>Exercise 3.6</h3><p>It is useful to be able to reset a random-numbergenerator to produce a sequence starting from a given value.Design a new rand procedure that is called with an argumentthat is either the symbol generate or the symbol reset and behaves as follows: (rand ‘generate) producesa new random number; ((rand ‘reset) ⟨new-value⟩) resetsthe internal state variable to the designated ⟨new-value⟩.Thus, by resetting the state, one can generate repeatable sequences.These are very handy to have when testing anddebugging programs that use random numbers.</p>
<h2 id="引进赋值的代价"><a href="#引进赋值的代价" class="headerlink" title="引进赋值的代价"></a>引进赋值的代价</h2><p>(3.1.3 The Costs of Introducing Assignment)</p>
<p>代换模型将不再适用。<br>前两章介绍的是函数式编程，不需要保存状态。</p>
<p>简化版的<code>make-simplified-withdraw</code>过程：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-simplified-withdraw</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">lambda</span></span> (amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">    balance))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> W (<span class="name">make-simplified-withdraw</span> <span class="number">25</span>))</span><br><span class="line">(<span class="name">W</span> <span class="number">20</span>)</span><br><span class="line"><span class="number">5</span></span><br><span class="line">(<span class="name">W</span> <span class="number">10</span>)</span><br><span class="line"><span class="number">-5</span></span><br></pre></td></tr></table></figure></p>
<p>不使用<code>set!</code>：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-decrementer</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">lambda</span></span> (amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">-</span></span> balance amount)))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> D (<span class="name">make-decrementer</span> <span class="number">25</span>))</span><br><span class="line">(<span class="name">D</span> <span class="number">20</span>)</span><br><span class="line"><span class="number">5</span></span><br><span class="line">(<span class="name">D</span> <span class="number">10</span>)</span><br><span class="line"><span class="number">15</span></span><br></pre></td></tr></table></figure></p>
<p>使用代换模型分析<code>make-decrementer</code><br>(D 20)<br>((make-decrementer 25) 20)<br>((lambda (amount) (- 25 amount)) 20)<br>(- 25 20)<br>5</p>
<p>使用代换模型分析<code>make-simplified-withdraw</code><br>(W 20)<br>((make-simplified-withdraw 25) 20)<br>((lambda (amount) (set! balance (- 25 amount)) 25) 20)<br>(set! balance (- 25 20)) 25</p>
<p>引入<code>set!</code>之后，变量不再是一个简单的名字了，它更像是一个可以存放数值的地方，并且保存在那的数值是可以改变的。</p>
<p><strong>同一和变化(Sameness and change)</strong></p>
<p>D1和D2可以看作是相同的<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> D1 (<span class="name">make-decrementer</span> <span class="number">25</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> D2 (<span class="name">make-decrementer</span> <span class="number">25</span>))</span><br></pre></td></tr></table></figure></p>
<p>但是W1和W2却是不同的，它们有自己单独的状态<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> W1 (<span class="name">make-simplified-withdraw</span> <span class="number">25</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> W2 (<span class="name">make-simplified-withdraw</span> <span class="number">25</span>))</span><br><span class="line">(<span class="name">W1</span> <span class="number">20</span>)</span><br><span class="line"><span class="number">5</span></span><br><span class="line">(<span class="name">W1</span> <span class="number">20</span>)</span><br><span class="line"><span class="number">-15</span></span><br><span class="line">(<span class="name">W2</span> <span class="number">20</span>)</span><br><span class="line"><span class="number">5</span></span><br></pre></td></tr></table></figure></p>
<p>;: (define peter-acc (make-account 100))<br>;: (define paul-acc (make-account 100))<br>;:<br>;: (define peter-acc (make-account 100))<br>;: (define paul-acc peter-acc)</p>
<p><strong>命令式程序设计的缺陷(Pitfalls of imperative programming)</strong></p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">factorial</span> n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">iter</span> product counter)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;</span></span> counter n)</span><br><span class="line">        product</span><br><span class="line">        (<span class="name">iter</span> (<span class="name"><span class="builtin-name">*</span></span> counter product)</span><br><span class="line">              (<span class="name"><span class="builtin-name">+</span></span> counter <span class="number">1</span>))))</span><br><span class="line">  (<span class="name">iter</span> <span class="number">1</span> <span class="number">1</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">factorial</span> n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">product</span> <span class="number">1</span>)</span><br><span class="line">        (<span class="name">counter</span> <span class="number">1</span>))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">iter</span>)</span><br><span class="line">      (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;</span></span> counter n)</span><br><span class="line">          product</span><br><span class="line">          (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> product (<span class="name"><span class="builtin-name">*</span></span> counter product))</span><br><span class="line">                 (<span class="name"><span class="builtin-name">set!</span></span> counter (<span class="name"><span class="builtin-name">+</span></span> counter <span class="number">1</span>))</span><br><span class="line">                 (<span class="name">iter</span>))))</span><br><span class="line">    (<span class="name">iter</span>)))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-7"><a href="#Exercise-3-7" class="headerlink" title="Exercise 3.7"></a>Exercise 3.7</h3><p>Consider the bank account objects created by <strong>make-account</strong>, with the password modification described in Exercise 3.3. Suppose that our banking system requires the ability to make joint accounts. Define a procedure <strong>make-joint</strong> that accomplishes this. <strong>make-joint</strong> should take three arguments. The first is a password-protected account. The second argument must match the password with which the account was defined in order for the <strong>make-joint</strong> operation to proceed. The third argument is a new password. <strong>make-jointis</strong> to create an additional access to the original accountusing the new password. For example, if peter-accis a bank account with password <strong>open-sesame</strong>, then<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> paul-acc</span><br><span class="line">  (<span class="name">make-joint</span> peter-acc <span class="symbol">'open-sesame</span> <span class="symbol">'rosebud</span>))</span><br></pre></td></tr></table></figure></p>
<p>will allow one to make transactions on <strong>peter-acc</strong> using the name paul-acc and the password rosebud. You may wish to modify your solution to Exercise 3.3 to accommodate this new feature.
</p>
<h3 id="Exercise-3-8"><a href="#Exercise-3-8" class="headerlink" title="Exercise 3.8"></a>Exercise 3.8</h3><p>When we defined the evaluation model in Section 1.1.3, we said that the first step in evaluating an expression is to evaluate its subexpressions. But we never specified the order in which the subexpressions should be evaluated (e.g., left to right or right to left). When we introduce assignment, the order in which the arguments to a procedure are evaluated can make a difference to the result. Define a simple procedure f such that evaluating<br><code>(+ (f 0) (f 1))</code><br>will return 0 if the arguments to + are evaluated from left to right but will return 1 if the arguments are evaluated from right to left.</p>
<h1 id="求值的环境模型"><a href="#求值的环境模型" class="headerlink" title="求值的环境模型"></a>求值的环境模型</h1><p>(3.2 The Environment Model of Evaluation)</p>
<h2 id="求值的规则"><a href="#求值的规则" class="headerlink" title="求值的规则"></a>求值的规则</h2><p>(3.2.1 The Rules for Evaluation)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">square</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">*</span></span> x x))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> square</span><br><span class="line">  (<span class="name"><span class="builtin-name">lambda</span></span> (x) (<span class="name"><span class="builtin-name">*</span></span> x x)))</span><br></pre></td></tr></table></figure>
<h2 id="简单过程的应用"><a href="#简单过程的应用" class="headerlink" title="简单过程的应用"></a>简单过程的应用</h2><p>(3.2.2 Applying Simple Procedures)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">square</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">*</span></span> x x))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sum-of-squares</span> x y)</span><br><span class="line">  (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">square</span> x) (<span class="name">square</span> y)))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">f</span> a)</span><br><span class="line">  (<span class="name">sum-of-squares</span> (<span class="name"><span class="builtin-name">+</span></span> a <span class="number">1</span>) (<span class="name"><span class="builtin-name">*</span></span> a <span class="number">2</span>)))</span><br></pre></td></tr></table></figure>
<p>我们也可以使用环境模型来分析上面的三个过程。<br><img src="/images/sicp/Figure_3.4.png" alt></p>
<p>;: (sum-of-squares (+ a 1) (* a 2))</p>
<h3 id="Exercise-3-9"><a href="#Exercise-3-9" class="headerlink" title="Exercise 3.9"></a>Exercise 3.9</h3><p>In Section1.2.1 we used the substitution model to analyze two procedures for computing factorials,arecursive version<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">factorial</span> n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> n <span class="number">1</span>) <span class="number">1</span> (<span class="name"><span class="builtin-name">*</span></span> n (<span class="name">factorial</span> (<span class="name"><span class="builtin-name">-</span></span> n <span class="number">1</span>)))))</span><br></pre></td></tr></table></figure></p>
<p>and an iterative version<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(define (factorial n) (fact-iter 1 1 n))</span><br><span class="line">(define (fact-iter product counter max-count)</span><br><span class="line">  (if (&gt; counter max-count)</span><br><span class="line">      product</span><br><span class="line">      (fact-iter (* counter product)</span><br><span class="line">                 (+ counter 1)</span><br><span class="line">                 max-count)))</span><br></pre></td></tr></table></figure></p>
<p>Show the environment structures created by evaluating (factorial 6) using each version of the factorial procedure.</p>
<h2 id="Frames作为局部状态的存储库"><a href="#Frames作为局部状态的存储库" class="headerlink" title="Frames作为局部状态的存储库"></a>Frames作为局部状态的存储库</h2><p>(3.2.3 Frames as the Repository of Local State)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-withdraw</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">lambda</span></span> (amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">        (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">               balance)</span><br><span class="line">        <span class="string">"Insufficient funds"</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment">;: (define W1 (make-withdraw 100))</span></span><br><span class="line"><span class="comment">;: (W1 50)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;: (define W2 (make-withdraw 100))</span></span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-10"><a href="#Exercise-3-10" class="headerlink" title="Exercise 3.10"></a>Exercise 3.10</h3><p>In the <strong>make-withdraw</strong> procedure, the local variable balance is created as aparameter of <strong>make-withdraw</strong>. We could also create the local state variable explicitly, using let , as follows:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-withdraw</span> initial-amount)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">balance</span> initial-amount))</span><br><span class="line">    (<span class="name"><span class="builtin-name">lambda</span></span> (amount)</span><br><span class="line">      (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">          (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">                 balance)</span><br><span class="line">          <span class="string">"Insufficient funds"</span>))))</span><br></pre></td></tr></table></figure></p>
<p>Recall from Section 1.3.2 that let is simply syntactic sugar for a procedure call:<br><code>(let (( ⟨ var ⟩ ⟨ exp ⟩ )) ⟨ body ⟩ )</code><br>is interpreted as an alternate syntax for<br><code>((lambda ( ⟨ var ⟩ ) ⟨ body ⟩ ) ⟨ exp ⟩ )</code><br>Use the environment model to analyze this alternate version of <strong>make-withdraw</strong>, drawing figures like the ones above to illustrate the interactions<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> W1 (<span class="name">make-withdraw</span> <span class="number">100</span>))</span><br><span class="line">(<span class="name">W1</span> <span class="number">50</span>)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> W2 (<span class="name">make-withdraw</span> <span class="number">100</span>))</span><br></pre></td></tr></table></figure></p>
<p>Show that the two versions of make-withdraw create objects with the same behavior. How do the environment structures differ for the two versions?</p>
<h2 id="内部定义"><a href="#内部定义" class="headerlink" title="内部定义"></a>内部定义</h2><p>(3.2.4 Internal Definitions)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">;; same as in section 1.1.8</span><br><span class="line">(define (sqrt x)</span><br><span class="line">  (define (good-enough? guess)</span><br><span class="line">    (&lt; (abs (- (square guess) x)) 0.001))</span><br><span class="line">  (define (improve guess)</span><br><span class="line">    (average guess (/ x guess)))</span><br><span class="line">  (define (sqrt-iter guess)</span><br><span class="line">    (if (good-enough? guess)</span><br><span class="line">        guess</span><br><span class="line">        (sqrt-iter (improve guess))))</span><br><span class="line">  (sqrt-iter 1.0))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-3-11"><a href="#Exercise-3-11" class="headerlink" title="Exercise 3.11"></a>Exercise 3.11</h3><p>In Section 3.2.3 we saw how the environment model described the behavior of procedures with local state. Now we have seen how internal definitions work. A typical message-passing procedure contains both of  these aspects. Consider the bank account procedure of Section 3.1.1:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-account</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">withdraw</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">        (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">               balance)</span><br><span class="line">        <span class="string">"Insufficient funds"</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deposit</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">+</span></span> balance amount))</span><br><span class="line">    balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'withdraw</span>) withdraw)</span><br><span class="line">          ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'deposit</span>) deposit)</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown request -- MAKE-ACCOUNT"</span></span><br><span class="line">                       m))))</span><br><span class="line">  dispatch)</span><br></pre></td></tr></table></figure></p>
<p>Show the environment structure generated by these quence of interactions<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> acc (<span class="name">make-account</span> <span class="number">50</span>))</span><br><span class="line">((<span class="name">acc</span> <span class="symbol">'deposit</span>) <span class="number">40</span>)</span><br><span class="line"><span class="number">90</span></span><br><span class="line">((<span class="name">acc</span> <span class="symbol">'withdraw</span>) <span class="number">60</span>)</span><br><span class="line"><span class="number">30</span></span><br></pre></td></tr></table></figure></p>
<p>Where is the local state for acc kept? Suppose we define another account<br><code>(define acc (make-account 50))</code><br>How are the local states for the two accounts kept distinct? Which parts of the environment structure are shared between acc and acc2 ?</p>
<h1 id="用可变数据做模拟"><a href="#用可变数据做模拟" class="headerlink" title="用可变数据做模拟"></a>用可变数据做模拟</h1><p>(3.3 Modeling with Mutable Data)</p>
<h2 id="可变列表结构"><a href="#可变列表结构" class="headerlink" title="可变列表结构"></a>可变列表结构</h2><p>(3.3.1 Mutable List Structure)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">cons</span></span> x y)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">new</span> (<span class="name">get-new-pair</span>)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">set-car!</span></span> new x)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set-cdr!</span></span> new y)</span><br><span class="line">    new))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-12"><a href="#Exercise-3-12" class="headerlink" title="Exercise 3.12"></a>Exercise 3.12</h3><p>The following procedure for appending lists was introduced in Section 2.2.1:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">append</span></span> x y)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> x)</span><br><span class="line">      y</span><br><span class="line">      (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">car</span></span> x) (<span class="name"><span class="builtin-name">append</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> x) y))))</span><br></pre></td></tr></table></figure></p>
<p>append forms a new list by successively cons ing the elements of x onto y. The procedure <strong>append!</strong> is similar to append , but it is a mutator rather than a constructor. It appends the lists by splicing them together, modifying the final pair of x so that its cdr is now y . (It is an error to call <strong>append!</strong> with an empty x .)<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">append!</span> x y)</span><br><span class="line">  (<span class="name"><span class="builtin-name">set-cdr!</span></span> (<span class="name">last-pair</span> x) y)</span><br><span class="line">  x)</span><br></pre></td></tr></table></figure></p>
<p>Here <strong>last-pair</strong> is a procedure that returns the last pair in its argument:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">last-pair</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> x)) x (<span class="name">last-pair</span> (<span class="name"><span class="builtin-name">cdr</span></span> x))))</span><br></pre></td></tr></table></figure></p>
<p>Consider the interaction<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> x (<span class="name"><span class="builtin-name">list</span></span> <span class="symbol">'a</span> <span class="symbol">'b</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> y (<span class="name"><span class="builtin-name">list</span></span> <span class="symbol">'c</span> <span class="symbol">'d</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> z (<span class="name"><span class="builtin-name">append</span></span> x y))</span><br><span class="line">z</span><br><span class="line">(<span class="name">a</span> b c d)</span><br><span class="line">(<span class="name"><span class="builtin-name">cdr</span></span> x)</span><br><span class="line">⟨response⟩</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> w (<span class="name">append!</span> x y))</span><br><span class="line">w</span><br><span class="line">(<span class="name">a</span> b c d)</span><br><span class="line">(<span class="name"><span class="builtin-name">cdr</span></span> x)</span><br><span class="line">⟨response⟩</span><br></pre></td></tr></table></figure></p>
<p>What are the missing ⟨response⟩s? Draw box-and-pointer diagrams to explain your answer.</p>
<p>答案：<br>(b)<br>(b c d)</p>
<h3 id="Exercise-3-13"><a href="#Exercise-3-13" class="headerlink" title="Exercise 3.13"></a>Exercise 3.13</h3><p>Consider the following <strong>make-cycle procedure</strong>, which uses the <strong>last-pair</strong> procedure defined in Exercise 3.12:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-cycle</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">set-cdr!</span></span> (<span class="name">last-pair</span> x) x)</span><br><span class="line">  x)</span><br></pre></td></tr></table></figure></p>
<p>Draw a box-and-pointer diagram that shows the structure z created by<br>(define z (make-cycle (list ‘a ‘b ‘c)))<br>What happens if we try to compute (last-pair z) ?</p>
<p>答案：<br>进入死循环</p>
<h3 id="Exercise-3-14"><a href="#Exercise-3-14" class="headerlink" title="Exercise 3.14"></a>Exercise 3.14</h3><p>The following procedure is quite useful, although obscure:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">mystery</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">loop</span> x y)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> x)</span><br><span class="line">        y</span><br><span class="line">        (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">temp</span> (<span class="name"><span class="builtin-name">cdr</span></span> x)))</span><br><span class="line">          (<span class="name"><span class="builtin-name">set-cdr!</span></span> x y)</span><br><span class="line">          (<span class="name">loop</span> temp x))))</span><br><span class="line">  (<span class="name">loop</span> x '()))</span><br></pre></td></tr></table></figure></p>
<p><strong>loop</strong> uses the “temporary” variable temp to hold the old value of the <strong>cdr</strong> of x , since the <strong>set-cdr!</strong> on the next line destroys the <strong>cdr</strong> . Explain what <strong>mystery</strong> does in general. Suppose v is defined by <code>(define v (list &#39;a &#39;b &#39;c &#39;d))</code> . Draw the box-and-pointer diagram that represents the list to which v is bound. Suppose that we now evaluate <code>(define w (mystery v))</code> . Draw box-and-pointer diagrams that show the structures v and w after evaluating this expression. What would be printed as the values of v and w?</p>
<p>答案：<br>v (a)<br>w (d c b c)</p>
<h3 id="Sharing-and-identity"><a href="#Sharing-and-identity" class="headerlink" title="Sharing and identity"></a>Sharing and identity</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> x (<span class="name"><span class="builtin-name">list</span></span> <span class="symbol">'a</span> <span class="symbol">'b</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> z1 (<span class="name"><span class="builtin-name">cons</span></span> x x))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> z2 (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">list</span></span> <span class="symbol">'a</span> <span class="symbol">'b</span>) (<span class="name"><span class="builtin-name">list</span></span> <span class="symbol">'a</span> <span class="symbol">'b</span>)))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">set-to-wow!</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">set-car!</span></span> (<span class="name"><span class="builtin-name">car</span></span> x) <span class="symbol">'wow</span>)</span><br><span class="line">  x)</span><br></pre></td></tr></table></figure>
<p>;: z1<br>;: (set-to-wow! z1)<br>;: z2<br>;: (set-to-wow! z2)</p>
<p>判断两个对象是否是相同：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">eq?</span></span> (<span class="name"><span class="builtin-name">car</span></span> z1) (<span class="name"><span class="builtin-name">cdr</span></span> z1))</span><br><span class="line"><span class="comment">;Value: #t</span></span><br><span class="line">(<span class="name"><span class="builtin-name">eq?</span></span> (<span class="name"><span class="builtin-name">car</span></span> z2) (<span class="name"><span class="builtin-name">cdr</span></span> z2))</span><br><span class="line"><span class="comment">;Value: #f</span></span><br></pre></td></tr></table></figure></p>
<h4 id="Exercise-3-15"><a href="#Exercise-3-15" class="headerlink" title="Exercise 3.15"></a>Exercise 3.15</h4><p>Draw box-and-pointer diagrams to explain the effect of <strong>set-to-wow!</strong> on the structures z1 and z2 above.</p>
<h4 id="Exercise-3-16"><a href="#Exercise-3-16" class="headerlink" title="Exercise 3.16"></a>Exercise 3.16</h4><p>Ben Bitdiddle decides to write a procedure to count the number of pairs in any list structure. “It’s easy,” he reasons. “The number of pairs in any structure is the number in the car plus the number in the cdr plus one more to count the current pair.” So Ben writes the following procedure:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">count-pairs</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">not</span></span> (<span class="name"><span class="builtin-name">pair?</span></span> x))</span><br><span class="line">      <span class="number">0</span></span><br><span class="line">      (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">count-pairs</span> (<span class="name"><span class="builtin-name">car</span></span> x))</span><br><span class="line">         (<span class="name">count-pairs</span> (<span class="name"><span class="builtin-name">cdr</span></span> x))</span><br><span class="line">         <span class="number">1</span>)))</span><br></pre></td></tr></table></figure></p>
<p>Show that this procedure is not correct. In particular, draw box-and-pointer diagrams representing lists tructures made up of exactly three pairs for which Ben’s procedure would return 3; return 4; return 7; never return at all.</p>
<h4 id="Exercise3-17"><a href="#Exercise3-17" class="headerlink" title="Exercise3.17"></a>Exercise3.17</h4><p>Devise a correct version of the <strong>count-pairs</strong> procedure of Exercise 3.16 that returns the number of distinct pairs in any structure. (Hint: Traverse the structure, maintaining an auxiliary data structure that is used to keep track of which pairs have already been counted.)</p>
<h4 id="Exercise-3-18"><a href="#Exercise-3-18" class="headerlink" title="Exercise 3.18"></a>Exercise 3.18</h4><p>Write a procedure that examines a list and determines whether it contains a cycle, that is, whether a program that tried to find the end of the list by taking successive cdrs would go into an infinite loop. Exercise 3.13 constructed such lists.</p>
<h4 id="Exercise-3-19"><a href="#Exercise-3-19" class="headerlink" title="Exercise 3.19"></a>Exercise 3.19</h4><p>Redo Exercise 3.18 using an algorithm that takes only a constant amount of space.(This requires a very clever idea.)</p>
<h3 id="Mutation-as-assignment"><a href="#Mutation-as-assignment" class="headerlink" title="Mutation as assignment"></a>Mutation as assignment</h3><p>序对可以存粹使用过程来表示(Section 2.1.3)：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">cons</span></span> x y)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'car</span>) x)</span><br><span class="line">          ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'cdr</span>) y)</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Undefined operation -- CONS"</span> m))))</span><br><span class="line">  dispatch)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">car</span></span> z) (<span class="name">z</span> <span class="symbol">'car</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> z) (<span class="name">z</span> <span class="symbol">'cdr</span>))</span><br></pre></td></tr></table></figure></p>
<p>可将其进行扩展，使其支持<code>set-car!</code>和<code>set-cdr!</code>：<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">cons</span></span> x y)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">set-x!</span> v) (<span class="name"><span class="builtin-name">set!</span></span> x v))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">set-y!</span> v) (<span class="name"><span class="builtin-name">set!</span></span> y v))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'car</span>) x)</span><br><span class="line">          ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'cdr</span>) y)</span><br><span class="line">          ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'set-car!</span>) set-x!)</span><br><span class="line">          ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'set-cdr!</span>) set-y!)</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Undefined operation -- CONS"</span> m))))</span><br><span class="line">  dispatch)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">car</span></span> z) (<span class="name">z</span> <span class="symbol">'car</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> z) (<span class="name">z</span> <span class="symbol">'cdr</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">set-car!</span></span> z new-value)</span><br><span class="line">  ((<span class="name">z</span> <span class="symbol">'set-car!</span>) new-value) z)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">set-cdr!</span></span> z new-value)</span><br><span class="line">  ((<span class="name">z</span> <span class="symbol">'set-cdr!</span>) new-value) z)</span><br></pre></td></tr></table></figure></p>
<h4 id="Exercise-3-20"><a href="#Exercise-3-20" class="headerlink" title="Exercise 3.20"></a>Exercise 3.20</h4><p>Draw environment diagrams to illustrate the evaluation of the sequence of expressions<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> x (<span class="name"><span class="builtin-name">cons</span></span> <span class="number">1</span> <span class="number">2</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> z (<span class="name"><span class="builtin-name">cons</span></span> x x))</span><br><span class="line">(<span class="name"><span class="builtin-name">set-car!</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> z) <span class="number">17</span>)</span><br><span class="line">(<span class="name"><span class="builtin-name">car</span></span> x)</span><br></pre></td></tr></table></figure></p>
<p>using the procedural implementation of pairs given above. (Compare Exercise 3.11.)</p>
<h2 id="队列的表示"><a href="#队列的表示" class="headerlink" title="队列的表示"></a>队列的表示</h2><p>(3.3.2 Representing Queues)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 头结点和尾结点的指针</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">front-ptr</span> queue) (<span class="name"><span class="builtin-name">car</span></span> queue))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">rear-ptr</span> queue) (<span class="name"><span class="builtin-name">cdr</span></span> queue))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">set-front-ptr!</span> queue item) (<span class="name"><span class="builtin-name">set-car!</span></span> queue item))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">set-rear-ptr!</span> queue item) (<span class="name"><span class="builtin-name">set-cdr!</span></span> queue item))</span><br><span class="line"><span class="comment">; 判断队列是否为空</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">empty-queue?</span> queue) (<span class="name"><span class="builtin-name">null?</span></span> (<span class="name">front-ptr</span> queue)))</span><br><span class="line"><span class="comment">; 队列构造器</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-queue</span>) (<span class="name"><span class="builtin-name">cons</span></span> '() '()))</span><br><span class="line"><span class="comment">; 头结点</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">front-queue</span> queue)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">empty-queue?</span> queue)</span><br><span class="line">      (<span class="name">error</span> <span class="string">"FRONT called with an empty queue"</span> queue)</span><br><span class="line">      (<span class="name"><span class="builtin-name">car</span></span> (<span class="name">front-ptr</span> queue))))</span><br><span class="line"><span class="comment">; 入队</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">insert-queue!</span> queue item)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">new-pair</span> (<span class="name"><span class="builtin-name">cons</span></span> item '())))</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name">empty-queue?</span> queue)</span><br><span class="line">           (<span class="name">set-front-ptr!</span> queue new-pair)</span><br><span class="line">           (<span class="name">set-rear-ptr!</span> queue new-pair)</span><br><span class="line">           queue)</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span></span><br><span class="line">           (<span class="name"><span class="builtin-name">set-cdr!</span></span> (<span class="name">rear-ptr</span> queue) new-pair)</span><br><span class="line">           (<span class="name">set-rear-ptr!</span> queue new-pair)</span><br><span class="line">           queue))))</span><br><span class="line"><span class="comment">; 出队</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">delete-queue!</span> queue)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name">empty-queue?</span> queue)</span><br><span class="line">         (<span class="name">error</span> <span class="string">"DELETE! called with an empty queue"</span> queue))</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span></span><br><span class="line">         (<span class="name">set-front-ptr!</span> queue (<span class="name"><span class="builtin-name">cdr</span></span> (<span class="name">front-ptr</span> queue)))</span><br><span class="line">         queue)))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-21"><a href="#Exercise-3-21" class="headerlink" title="Exercise 3.21"></a>Exercise 3.21</h3><p>Ben Bitdiddle decides to test the queue implementation described above. He types in the procedures to the Lisp interpreter and proceeds to try them out:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> q1 (<span class="name">make-queue</span>))</span><br><span class="line">(<span class="name">insert-queue!</span> q1 <span class="symbol">'a</span>)</span><br><span class="line">(<span class="name">insert-queue!</span> q1 <span class="symbol">'b</span>)</span><br><span class="line">(<span class="name">delete-queue!</span> q1)</span><br><span class="line">(<span class="name">delete-queue!</span> q1)</span><br></pre></td></tr></table></figure></p>
<p>“It’s all wrong!” he complains. “The interpreter’s response shows that the last item is inserted into the queue twice. And when I delete both items, the second b is still there, so the queue isn’t empty, even though it’s supposed to be.” Eva Lu Ator suggests that Ben has misunderstood what is happening. “It’s not that the items are going into the queue twice,” she explains. “It’s just that the standard Lisp printer doesn’t know how to make sense of the queue representa- tion. If you want to see the queue printed correctly, you’ll have to define your own print procedure for queues.” Explain what Eva Lu is talking about. In particular, show why Ben’s examples produce the printed results that they do. Define a procedure <strong>print-queue</strong> that takes a queue as input and prints the sequence of items in the queue.</p>
<h3 id="Exercise-3-22"><a href="#Exercise-3-22" class="headerlink" title="Exercise 3.22"></a>Exercise 3.22</h3><p>Instead of representing a queue as a pair of pointers, we can build a queue as a procedure with local state. The local state will consist of pointers to the beginning and the end of an ordinary list. us, the <strong>make-queue</strong> procedure will have the form<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-queue</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">front-ptr</span> .. . )</span><br><span class="line">    (<span class="name">rear-ptr</span> .. . ))</span><br><span class="line">  ⟨ definitions of internal procedures ⟩</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m) .. . )</span><br><span class="line">  dispatch))</span><br></pre></td></tr></table></figure></p>
<p>Complete the definition of <strong>make-queue</strong> and provide implementations of the queue operations using this representation.</p>
<h3 id="Exercise-3-23"><a href="#Exercise-3-23" class="headerlink" title="Exercise 3.23"></a>Exercise 3.23</h3><p>A deque (“double-endedqueue”)isasequence in which items can be inserted and deleted at either the front or the rear. Operations on deques are the constructor <strong>make-deque</strong> , the predicate <strong>empty-deque?</strong> , selectors <strong>front-deque</strong> and <strong>rear-deque</strong> , mutators <strong>front-insert-deque!</strong> , <strong>rear-insert-deque!</strong> , <strong>front-delete-deque!</strong> ,and <strong>rear-delete- deque!</strong> . Show how to represent deques using pairs, and give implementations of the operations. 23 All operations should be accomplished in Θ(1) steps.</p>
<h2 id="表的表示"><a href="#表的表示" class="headerlink" title="表的表示"></a>表的表示</h2><p>(3.3.3 Representing Tables)</p>
<p>一维表可以使用序对的列表进行表示：<br><img src="/images/sicp/Figure_3.22.png" alt><br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 查找 key 所对应的 value</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">lookup</span> key table)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">record</span> (<span class="name"><span class="builtin-name">assoc</span></span> key (<span class="name"><span class="builtin-name">cdr</span></span> table))))</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> record</span><br><span class="line">        (<span class="name"><span class="builtin-name">cdr</span></span> record)</span><br><span class="line">        false)))</span><br><span class="line"><span class="comment">; 查找 key 所对应的记录</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">assoc</span></span> key records)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">null?</span></span> records) false)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">equal?</span></span> key (<span class="name"><span class="builtin-name">caar</span></span> records)) (<span class="name"><span class="builtin-name">car</span></span> records))</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name"><span class="builtin-name">assoc</span></span> key (<span class="name"><span class="builtin-name">cdr</span></span> records)))))</span><br><span class="line"><span class="comment">; 插入新的键值对</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">insert!</span> key value table)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">record</span> (<span class="name"><span class="builtin-name">assoc</span></span> key (<span class="name"><span class="builtin-name">cdr</span></span> table))))</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> record</span><br><span class="line">        (<span class="name"><span class="builtin-name">set-cdr!</span></span> record value)</span><br><span class="line">        (<span class="name"><span class="builtin-name">set-cdr!</span></span> table</span><br><span class="line">                  (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">cons</span></span> key value) (<span class="name"><span class="builtin-name">cdr</span></span> table)))))</span><br><span class="line">  <span class="symbol">'ok</span>)</span><br><span class="line"><span class="comment">; 表的构造器</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-table</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">list</span></span> <span class="symbol">'*table*</span>))</span><br></pre></td></tr></table></figure></p>
<h3 id="二维表-Two-dimensional-tables"><a href="#二维表-Two-dimensional-tables" class="headerlink" title="二维表(Two-dimensional tables)"></a>二维表(Two-dimensional tables)</h3><p>在二维表中，一个值由两个键索引。<br>可以使用一维表进行表示，将一维表的每个键指向一个子表。如下图所示：<br><img src="/images/sicp/Figure_3.23.png" alt></p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 查找两个键对应的值，若未找到则返回false</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">lookup</span> key-1 key-2 table)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">subtable</span> (<span class="name"><span class="builtin-name">assoc</span></span> key-1 (<span class="name"><span class="builtin-name">cdr</span></span> table))))</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> subtable</span><br><span class="line">        (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">record</span> (<span class="name"><span class="builtin-name">assoc</span></span> key-2 (<span class="name"><span class="builtin-name">cdr</span></span> subtable))))</span><br><span class="line">          (<span class="name"><span class="builtin-name">if</span></span> record</span><br><span class="line">              (<span class="name"><span class="builtin-name">cdr</span></span> record)</span><br><span class="line">              false))</span><br><span class="line">        false)))</span><br><span class="line"><span class="comment">; 插入新的键值对</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">insert!</span> key-1 key-2 value table)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">subtable</span> (<span class="name"><span class="builtin-name">assoc</span></span> key-1 (<span class="name"><span class="builtin-name">cdr</span></span> table))))</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> subtable</span><br><span class="line">        (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">record</span> (<span class="name"><span class="builtin-name">assoc</span></span> key-2 (<span class="name"><span class="builtin-name">cdr</span></span> subtable))))</span><br><span class="line">          (<span class="name"><span class="builtin-name">if</span></span> record</span><br><span class="line">              (<span class="name"><span class="builtin-name">set-cdr!</span></span> record value)</span><br><span class="line">              (<span class="name"><span class="builtin-name">set-cdr!</span></span> subtable</span><br><span class="line">                        (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">cons</span></span> key-2 value)</span><br><span class="line">                              (<span class="name"><span class="builtin-name">cdr</span></span> subtable)))))</span><br><span class="line">        (<span class="name"><span class="builtin-name">set-cdr!</span></span> table</span><br><span class="line">                  (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">list</span></span> key-1</span><br><span class="line">                              (<span class="name"><span class="builtin-name">cons</span></span> key-2 value))</span><br><span class="line">                        (<span class="name"><span class="builtin-name">cdr</span></span> table)))))</span><br><span class="line">  <span class="symbol">'ok</span>)</span><br></pre></td></tr></table></figure>
<h3 id="创建局部表-Creating-local-tables"><a href="#创建局部表-Creating-local-tables" class="headerlink" title="创建局部表(Creating local tables)"></a>创建局部表(Creating local tables)</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-table</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">local-table</span> (<span class="name"><span class="builtin-name">list</span></span> <span class="symbol">'*table*</span>)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">lookup</span> key-1 key-2)</span><br><span class="line">      (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">subtable</span> (<span class="name"><span class="builtin-name">assoc</span></span> key-1 (<span class="name"><span class="builtin-name">cdr</span></span> local-table))))</span><br><span class="line">        (<span class="name"><span class="builtin-name">if</span></span> subtable</span><br><span class="line">            (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">record</span> (<span class="name"><span class="builtin-name">assoc</span></span> key-2 (<span class="name"><span class="builtin-name">cdr</span></span> subtable))))</span><br><span class="line">              (<span class="name"><span class="builtin-name">if</span></span> record</span><br><span class="line">                  (<span class="name"><span class="builtin-name">cdr</span></span> record)</span><br><span class="line">                  false))</span><br><span class="line">            false)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">insert!</span> key-1 key-2 value)</span><br><span class="line">      (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">subtable</span> (<span class="name"><span class="builtin-name">assoc</span></span> key-1 (<span class="name"><span class="builtin-name">cdr</span></span> local-table))))</span><br><span class="line">        (<span class="name"><span class="builtin-name">if</span></span> subtable</span><br><span class="line">            (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">record</span> (<span class="name"><span class="builtin-name">assoc</span></span> key-2 (<span class="name"><span class="builtin-name">cdr</span></span> subtable))))</span><br><span class="line">              (<span class="name"><span class="builtin-name">if</span></span> record</span><br><span class="line">                  (<span class="name"><span class="builtin-name">set-cdr!</span></span> record value)</span><br><span class="line">                  (<span class="name"><span class="builtin-name">set-cdr!</span></span> subtable</span><br><span class="line">                            (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">cons</span></span> key-2 value)</span><br><span class="line">                                  (<span class="name"><span class="builtin-name">cdr</span></span> subtable)))))</span><br><span class="line">            (<span class="name"><span class="builtin-name">set-cdr!</span></span> local-table</span><br><span class="line">                      (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name"><span class="builtin-name">list</span></span> key-1</span><br><span class="line">                                  (<span class="name"><span class="builtin-name">cons</span></span> key-2 value))</span><br><span class="line">                            (<span class="name"><span class="builtin-name">cdr</span></span> local-table)))))</span><br><span class="line">      <span class="symbol">'ok</span>)  </span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m)</span><br><span class="line">      (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'lookup-proc</span>) lookup)</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'insert-proc!</span>) insert!)</span><br><span class="line">            (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown operation -- TABLE"</span> m))))</span><br><span class="line">    dispatch))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> operation-table (<span class="name">make-table</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> get (<span class="name">operation-table</span> <span class="symbol">'lookup-proc</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> put (<span class="name">operation-table</span> <span class="symbol">'insert-proc!</span>))</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-3-24"><a href="#Exercise-3-24" class="headerlink" title="Exercise 3.24"></a>Exercise 3.24</h4><p>In the table implementations above,the keys are tested for equality using <strong>equal?</strong> (called by assoc ). This is not always the appropriate test. For instance, we might have a table with numeric keys in which we don’t need an exact match to the number we’re looking up, but only a number within some tolerance of it. Design a table constructor <strong>make-table</strong> that takes as an argument a <strong>same-key?</strong> procedure that will be used to test “equality” of keys. <strong>make-table</strong> should return a dispatch procedure that can be used to access appropriate <strong>lookup</strong> and <strong>insert!</strong> procedures for a local table.</p>
<h4 id="Exercise-3-25"><a href="#Exercise-3-25" class="headerlink" title="Exercise 3.25"></a>Exercise 3.25</h4><p>Generalizing one- and two-dimensional tables, show how to implement a table in which values are stored under an arbitrary number of keys and different values may be stored under different numbers of keys. The <strong>lookup</strong> and <strong>insert!</strong> procedures should take as input a list of keys used to access the table.</p>
<h4 id="Exercise-3-26"><a href="#Exercise-3-26" class="headerlink" title="Exercise 3.26"></a>Exercise 3.26</h4><p>To search a table as implemented above,one needs to scan through the list of records. This is basically the unordered list representation of Section 2.3.3. For large tables,it may be more efficient to structure the table in a different manner. Describe a table implementation where the 367 (key, value) records are organized using a binary tree, assuming that keys can be ordered in some way (e.g., numerically or alphabetically). (Compare Exercise 2.66 of Chapter 2.)</p>
<h4 id="Exercise-3-27"><a href="#Exercise-3-27" class="headerlink" title="Exercise 3.27"></a>Exercise 3.27</h4><p>Memoization (alsocalled tabulation )is a technique that enables a procedure to record, in a local table, values that have previously been computed. This technique can make a vast difference in the performance of aprogram. A memoized procedure maintains a table in which values of previous calls are stored using as keys the arguments that produced the values. When the memoized procedure is asked to compute a value, it first checks the table to see if the value is already the reand,if so,just returns that value. Otherwise, it computes the new value in the ordinary way and stores this in the table. As an example of memoization, recall from Section 1.2.2 the exponential process for computing Fibonacci numbers:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">fib</span> n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">=</span></span> n <span class="number">0</span>) <span class="number">0</span>)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">=</span></span> n <span class="number">1</span>) <span class="number">1</span>)</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">fib</span> (<span class="name"><span class="builtin-name">-</span></span> n <span class="number">1</span>))</span><br><span class="line">                 (<span class="name">fib</span> (<span class="name"><span class="builtin-name">-</span></span> n <span class="number">2</span>))))))</span><br></pre></td></tr></table></figure></p>
<p>The memoized version of the same procedure is<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> memo-fib</span><br><span class="line">  (<span class="name">memoize</span> (<span class="name"><span class="builtin-name">lambda</span></span> (n)</span><br><span class="line">             (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">=</span></span> n <span class="number">0</span>) <span class="number">0</span>)</span><br><span class="line">                   ((<span class="name"><span class="builtin-name">=</span></span> n <span class="number">1</span>) <span class="number">1</span>)</span><br><span class="line">                   (<span class="name"><span class="builtin-name">else</span></span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">memo-fib</span> (<span class="name"><span class="builtin-name">-</span></span> n <span class="number">1</span>))</span><br><span class="line">                            (<span class="name">memo-fib</span> (<span class="name"><span class="builtin-name">-</span></span> n <span class="number">2</span>))))))))</span><br></pre></td></tr></table></figure></p>
<p>where the memoizer is defined as<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">memoize</span> f)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">table</span> (<span class="name">make-table</span>)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">lambda</span></span> (x)</span><br><span class="line">      (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">previously-computed-result</span> (<span class="name">lookup</span> x table)))</span><br><span class="line">        (<span class="name"><span class="builtin-name">or</span></span> previously-computed-result</span><br><span class="line">            (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">result</span> (<span class="name">f</span> x)))</span><br><span class="line">              (<span class="name">insert!</span> x result table)</span><br><span class="line">              result))))))</span><br></pre></td></tr></table></figure></p>
<p>Draw an environment diagram to analyze the computation of (memo-fib 3). Explain why memo-fib computes the nth Fibonacci number in a number of steps proportional to n. Would the scheme still work if we had simply defined <strong>memo-fib</strong> to be (memoize fib)?
</p>
<h2 id="数字电路模拟器"><a href="#数字电路模拟器" class="headerlink" title="数字电路模拟器"></a>数字电路模拟器</h2><p>(3.3.4 A Simulator for Digital Circuits)</p>
<p>逻辑电路中的非门、与门和或门：<br><img src="/images/sicp/Figure_3.24.png" alt></p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 导线</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> a (<span class="name">make-wire</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> b (<span class="name">make-wire</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> c (<span class="name">make-wire</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> d (<span class="name">make-wire</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> e (<span class="name">make-wire</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> s (<span class="name">make-wire</span>))</span><br><span class="line"><span class="comment">; 逻辑门</span></span><br><span class="line">(<span class="name">or-gate</span> a b d)</span><br><span class="line">(<span class="name">and-gate</span> a b c)</span><br><span class="line">(<span class="name">inverter</span> c e)</span><br><span class="line">(<span class="name">and-gate</span> d e s)</span><br></pre></td></tr></table></figure>
<p>半加法电路：<br><img src="/images/sicp/Figure_3.25.png" alt><br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;;NB. To use half-adder, need or-gate from exercise 3.28</span></span><br><span class="line"><span class="comment">; 定义半加法器</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">half-adder</span> a b s c)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">d</span> (<span class="name">make-wire</span>)) (<span class="name">e</span> (<span class="name">make-wire</span>)))</span><br><span class="line">    (<span class="name">or-gate</span> a b d)</span><br><span class="line">    (<span class="name">and-gate</span> a b c)</span><br><span class="line">    (<span class="name">inverter</span> c e)</span><br><span class="line">    (<span class="name">and-gate</span> d e s)</span><br><span class="line">    <span class="symbol">'ok</span>))</span><br></pre></td></tr></table></figure></p>
<p>全加法电路：<br><img src="/images/sicp/Figure_3.26.png" alt></p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; 定义全加法器</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">full-adder</span> a b c-in sum c-out)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">s</span> (<span class="name">make-wire</span>)) (<span class="name">c1</span> (<span class="name">make-wire</span>)) (<span class="name">c2</span> (<span class="name">make-wire</span>)))</span><br><span class="line">    (<span class="name">half-adder</span> b c-in s c1)</span><br><span class="line">    (<span class="name">half-adder</span> a s sum c2)</span><br><span class="line">    (<span class="name">or-gate</span> c1 c2 c-out)</span><br><span class="line">    <span class="symbol">'ok</span>))</span><br></pre></td></tr></table></figure>
<h3 id="基本功能块-Primitive-function-boxes"><a href="#基本功能块-Primitive-function-boxes" class="headerlink" title="基本功能块(Primitive function boxes)"></a>基本功能块(Primitive function boxes)</h3><p>在导线上的操作：<br><code>(get-signal ⟨wire⟩)</code><br><code>(set-signal! ⟨wire⟩ ⟨new value⟩)</code><br><code>(add-action! ⟨wire⟩ ⟨procedure of no arguments⟩)</code></p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">inverter</span> input output)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">invert-input</span>)</span><br><span class="line">    (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">new-value</span> (<span class="name">logical-not</span> (<span class="name">get-signal</span> input))))</span><br><span class="line">      (<span class="name">after-delay</span> inverter-delay</span><br><span class="line">                   (<span class="name"><span class="builtin-name">lambda</span></span> () (<span class="name">set-signal!</span> output new-value)))))</span><br><span class="line">  (<span class="name">add-action!</span> input invert-input)</span><br><span class="line">  <span class="symbol">'ok</span>)</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">logical-not</span> s)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">=</span></span> s <span class="number">0</span>) <span class="number">1</span>)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">=</span></span> s <span class="number">1</span>) <span class="number">0</span>)</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Invalid signal"</span> s))))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;; *following uses logical-and -- see ch3support.scm</span></span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">and-gate</span> a1 a2 output)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">and-action-procedure</span>)</span><br><span class="line">    (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">new-value</span></span><br><span class="line">           (<span class="name">logical-and</span> (<span class="name">get-signal</span> a1) (<span class="name">get-signal</span> a2))))</span><br><span class="line">      (<span class="name">after-delay</span> and-gate-delay</span><br><span class="line">                   (<span class="name"><span class="builtin-name">lambda</span></span> () (<span class="name">set-signal!</span> output new-value)))))</span><br><span class="line">  (<span class="name">add-action!</span> a1 and-action-procedure)</span><br><span class="line">  (<span class="name">add-action!</span> a2 and-action-procedure)</span><br><span class="line">  <span class="symbol">'ok</span>)</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">logical-and</span> s1 s2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name"><span class="builtin-name">=</span></span> s1 <span class="number">1</span>) (<span class="name"><span class="builtin-name">=</span></span> s2 <span class="number">1</span>)) <span class="number">1</span>)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name"><span class="builtin-name">=</span></span> s1 <span class="number">0</span>) (<span class="name"><span class="builtin-name">=</span></span> s2 <span class="number">1</span>)) <span class="number">0</span>)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name"><span class="builtin-name">=</span></span> s1 <span class="number">1</span>) (<span class="name"><span class="builtin-name">=</span></span> s2 <span class="number">0</span>)) <span class="number">0</span>)</span><br><span class="line">        ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name"><span class="builtin-name">=</span></span> s1 <span class="number">0</span>) (<span class="name"><span class="builtin-name">=</span></span> s2 <span class="number">0</span>)) <span class="number">0</span>)</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Invalid signal"</span> s))))</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-3-28"><a href="#Exercise-3-28" class="headerlink" title="Exercise 3.28"></a>Exercise 3.28</h4><p>Define an <strong>or-gate</strong> as a primitive function box. Your <strong>or-gate</strong> constructor should be similar to <strong>and-gate</strong>.</p>
<h4 id="Exercise-3-29"><a href="#Exercise-3-29" class="headerlink" title="Exercise 3.29"></a>Exercise 3.29</h4><p>Another way to construct an <strong>or-gate</strong> is as a compound digital logic device, built from and-gates and inverters. Define a procedure <strong>or-gate</strong> that accomplishes this. What is the delay time of the <strong>or-gate</strong> in terms of <strong>and-gate-delay</strong> and <strong>inverter-delay</strong>?</p>
<h4 id="Exercise-3-30"><a href="#Exercise-3-30" class="headerlink" title="Exercise 3.30"></a>Exercise 3.30</h4><p>Figure 3.27 shows a <em>ripple-carry adder</em> formed by stringing together n full-adders. This is the simplest form of parallel adder for adding two n-bit binary numbers. The inputs A1, A2, A3, …, An and B1, B2, B3, …, Bn are the two binary numbers to be added (each Ak and Bk is a 0 or a 1). The circuit generates S1, S2, S3, …, Sn, the n bits of the sum, and C, the carry from the addition. Write a procedure <strong>ripple-carry-adder</strong> that generates this circuit. The procedure should take as arguments three lists of n wires each – the Ak, the Bk, and the Sk – and also another wire C. The major drawback of the ripple-carry adder is the need to wait for the carry signals to propagate. What is the delay needed to obtain the complete output from an n-bit ripple-carry adder, expressed in terms of the delays for and-gates, or-gates, and inverters?<br><img src="/images/sicp/Figure_3.27.png" alt></p>
<h3 id="导线的表示-Representing-wires"><a href="#导线的表示-Representing-wires" class="headerlink" title="导线的表示(Representing wires)"></a>导线的表示(Representing wires)</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-wire</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">signal-value</span> <span class="number">0</span>) (<span class="name">action-procedures</span> '()))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">set-my-signal!</span> new-value)</span><br><span class="line">      (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">not</span></span> (<span class="name"><span class="builtin-name">=</span></span> signal-value new-value))</span><br><span class="line">          (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> signal-value new-value)</span><br><span class="line">                 (<span class="name">call-each</span> action-procedures))</span><br><span class="line">          <span class="symbol">'done</span>))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">accept-action-procedure!</span> proc)</span><br><span class="line">      (<span class="name"><span class="builtin-name">set!</span></span> action-procedures (<span class="name"><span class="builtin-name">cons</span></span> proc action-procedures))</span><br><span class="line">      (<span class="name">proc</span>))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m)</span><br><span class="line">      (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'get-signal</span>) signal-value)</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'set-signal!</span>) set-my-signal!)</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'add-action!</span>) accept-action-procedure!)</span><br><span class="line">            (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown operation -- WIRE"</span> m))))</span><br><span class="line">    dispatch))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">call-each</span> procedures)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">null?</span></span> procedures)</span><br><span class="line">      <span class="symbol">'done</span></span><br><span class="line">      (<span class="name"><span class="builtin-name">begin</span></span></span><br><span class="line">        ((<span class="name"><span class="builtin-name">car</span></span> procedures))</span><br><span class="line">        (<span class="name">call-each</span> (<span class="name"><span class="builtin-name">cdr</span></span> procedures)))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">get-signal</span> wire)</span><br><span class="line">  (<span class="name">wire</span> <span class="symbol">'get-signal</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">set-signal!</span> wire new-value)</span><br><span class="line">  ((<span class="name">wire</span> <span class="symbol">'set-signal!</span>) new-value))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">add-action!</span> wire action-procedure)</span><br><span class="line">  ((<span class="name">wire</span> <span class="symbol">'add-action!</span>) action-procedure))</span><br></pre></td></tr></table></figure>
<h3 id="待处理表-The-agenda"><a href="#待处理表-The-agenda" class="headerlink" title="待处理表(The agenda)"></a>待处理表(The agenda)</h3><p>需定义以下操作：</p>
<ul>
<li>(make-agenda) returns a new empty agenda.</li>
<li>(empty-agenda? ⟨agenda⟩) is true if the specified agenda is empty.</li>
<li>(first-agenda-item ⟨agenda⟩) returns the first item on the agenda.</li>
<li>(remove-first-agenda-item! ⟨agenda⟩) modifies the agenda by removing the first item.</li>
<li>(add-to-agenda! ⟨time⟩ ⟨action⟩ ⟨agenda⟩) modifies the agenda by adding the given action procedure to be run at the specified time.</li>
<li>(current-time ⟨agenda⟩) returns the current simulation time.</li>
</ul>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; after-delay过程，向待处理表中加入一个新元素</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">after-delay</span> delay action)</span><br><span class="line">  (<span class="name">add-to-agenda!</span> (<span class="name"><span class="builtin-name">+</span></span> delay (<span class="name">current-time</span> the-agenda))</span><br><span class="line">                  action</span><br><span class="line">                  the-agenda))</span><br><span class="line"><span class="comment">; 定义过程propagate, 用来顺序执行待处理表中的过程</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">propagate</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">empty-agenda?</span> the-agenda)</span><br><span class="line">      <span class="symbol">'done</span></span><br><span class="line">      (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">first-item</span> (<span class="name">first-agenda-item</span> the-agenda)))</span><br><span class="line">        (<span class="name">first-item</span>)</span><br><span class="line">        (<span class="name">remove-first-agenda-item!</span> the-agenda)</span><br><span class="line">        (<span class="name">propagate</span>))))</span><br></pre></td></tr></table></figure>
<h3 id="一个模拟示例-A-sample-simulation"><a href="#一个模拟示例-A-sample-simulation" class="headerlink" title="一个模拟示例(A sample simulation)"></a>一个模拟示例(A sample simulation)</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">probe</span> name wire)</span><br><span class="line">  (<span class="name">add-action!</span> wire</span><br><span class="line">               (<span class="name"><span class="builtin-name">lambda</span></span> ()      </span><br><span class="line">                 (<span class="name"><span class="builtin-name">newline</span></span>)</span><br><span class="line">                 (<span class="name"><span class="builtin-name">display</span></span> name)</span><br><span class="line">                 (<span class="name"><span class="builtin-name">display</span></span> <span class="string">" "</span>)</span><br><span class="line">                 (<span class="name"><span class="builtin-name">display</span></span> (<span class="name">current-time</span> the-agenda))</span><br><span class="line">                 (<span class="name"><span class="builtin-name">display</span></span> <span class="string">"  New-value = "</span>)</span><br><span class="line">                 (<span class="name"><span class="builtin-name">display</span></span> (<span class="name">get-signal</span> wire)))))</span><br><span class="line"></span><br><span class="line"><span class="comment">;;; Sample simulation</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;: (define the-agenda (make-agenda))</span></span><br><span class="line"><span class="comment">;: (define inverter-delay 2)</span></span><br><span class="line"><span class="comment">;: (define and-gate-delay 3)</span></span><br><span class="line"><span class="comment">;: (define or-gate-delay 5)</span></span><br><span class="line"><span class="comment">;:</span></span><br><span class="line"><span class="comment">;: (define input-1 (make-wire))</span></span><br><span class="line"><span class="comment">;: (define input-2 (make-wire))</span></span><br><span class="line"><span class="comment">;: (define sum (make-wire))</span></span><br><span class="line"><span class="comment">;: (define carry (make-wire))</span></span><br><span class="line"><span class="comment">;:</span></span><br><span class="line"><span class="comment">;: (probe 'sum sum)</span></span><br><span class="line"><span class="comment">;: (probe 'carry carry)</span></span><br><span class="line"><span class="comment">;:</span></span><br><span class="line"><span class="comment">;: (half-adder input-1 input-2 sum carry)</span></span><br><span class="line"><span class="comment">;: (set-signal! input-1 1)</span></span><br><span class="line"><span class="comment">;: (propagate)</span></span><br><span class="line"><span class="comment">;:</span></span><br><span class="line"><span class="comment">;: (set-signal! input-2 1)</span></span><br><span class="line"><span class="comment">;: (propagate)</span></span><br></pre></td></tr></table></figure>
<h4 id="Exercise-3-31"><a href="#Exercise-3-31" class="headerlink" title="Exercise 3.31"></a>Exercise 3.31</h4><p>The internal procedure accept-action-procedure! defined in make-wire specifies that when a new action procedure is added to a wire, the procedure is immediately run. Explain why this initialization is necessary. In particular, trace through the half-adder example in the paragraphs above and say how the system’s response would differ if we had defined accept-action-procedure! as<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">accept-action-procedure!</span> proc)</span><br><span class="line">  (<span class="name"><span class="builtin-name">set!</span></span> action-procedures (<span class="name"><span class="builtin-name">cons</span></span> proc action-procedures)))</span><br></pre></td></tr></table></figure></p>
<h3 id="待处理表的实现-Implementing-agenda"><a href="#待处理表的实现-Implementing-agenda" class="headerlink" title="待处理表的实现(Implementing agenda)"></a>待处理表的实现(Implementing agenda)</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-time-segment</span> time queue)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cons</span></span> time queue))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">segment-time</span> s) (<span class="name"><span class="builtin-name">car</span></span> s))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">segment-queue</span> s) (<span class="name"><span class="builtin-name">cdr</span></span> s))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-agenda</span>) (<span class="name"><span class="builtin-name">list</span></span> <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">current-time</span> agenda) (<span class="name"><span class="builtin-name">car</span></span> agenda))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">set-current-time!</span> agenda time)</span><br><span class="line">  (<span class="name"><span class="builtin-name">set-car!</span></span> agenda time))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">segments</span> agenda) (<span class="name"><span class="builtin-name">cdr</span></span> agenda))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">set-segments!</span> agenda segments)</span><br><span class="line">  (<span class="name"><span class="builtin-name">set-cdr!</span></span> agenda segments))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">first-segment</span> agenda) (<span class="name"><span class="builtin-name">car</span></span> (<span class="name">segments</span> agenda)))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">rest-segments</span> agenda) (<span class="name"><span class="builtin-name">cdr</span></span> (<span class="name">segments</span> agenda)))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">empty-agenda?</span> agenda)</span><br><span class="line">  (<span class="name"><span class="builtin-name">null?</span></span> (<span class="name">segments</span> agenda)))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">add-to-agenda!</span> time action agenda)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">belongs-before?</span> segments)</span><br><span class="line">    (<span class="name"><span class="builtin-name">or</span></span> (<span class="name"><span class="builtin-name">null?</span></span> segments)</span><br><span class="line">        (<span class="name"><span class="builtin-name">&lt;</span></span> time (<span class="name">segment-time</span> (<span class="name"><span class="builtin-name">car</span></span> segments)))))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-new-time-segment</span> time action)</span><br><span class="line">    (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">q</span> (<span class="name">make-queue</span>)))</span><br><span class="line">      (<span class="name">insert-queue!</span> q action)</span><br><span class="line">      (<span class="name">make-time-segment</span> time q)))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">add-to-segments!</span> segments)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> (<span class="name">segment-time</span> (<span class="name"><span class="builtin-name">car</span></span> segments)) time)</span><br><span class="line">        (<span class="name">insert-queue!</span> (<span class="name">segment-queue</span> (<span class="name"><span class="builtin-name">car</span></span> segments))</span><br><span class="line">                       action)</span><br><span class="line">        (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">rest</span> (<span class="name"><span class="builtin-name">cdr</span></span> segments)))</span><br><span class="line">          (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">belongs-before?</span> rest)</span><br><span class="line">              (<span class="name"><span class="builtin-name">set-cdr!</span></span></span><br><span class="line">               segments</span><br><span class="line">               (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name">make-new-time-segment</span> time action)</span><br><span class="line">                     (<span class="name"><span class="builtin-name">cdr</span></span> segments)))</span><br><span class="line">              (<span class="name">add-to-segments!</span> rest)))))</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">segments</span> (<span class="name">segments</span> agenda)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">belongs-before?</span> segments)</span><br><span class="line">        (<span class="name">set-segments!</span></span><br><span class="line">         agenda</span><br><span class="line">         (<span class="name"><span class="builtin-name">cons</span></span> (<span class="name">make-new-time-segment</span> time action)</span><br><span class="line">               segments))</span><br><span class="line">        (<span class="name">add-to-segments!</span> segments))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">remove-first-agenda-item!</span> agenda)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">q</span> (<span class="name">segment-queue</span> (<span class="name">first-segment</span> agenda))))</span><br><span class="line">    (<span class="name">delete-queue!</span> q)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">empty-queue?</span> q)</span><br><span class="line">        (<span class="name">set-segments!</span> agenda (<span class="name">rest-segments</span> agenda)))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">first-agenda-item</span> agenda)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">empty-agenda?</span> agenda)</span><br><span class="line">      (<span class="name">error</span> <span class="string">"Agenda is empty -- FIRST-AGENDA-ITEM"</span>)</span><br><span class="line">      (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">first-seg</span> (<span class="name">first-segment</span> agenda)))</span><br><span class="line">        (<span class="name">set-current-time!</span> agenda (<span class="name">segment-time</span> first-seg))</span><br><span class="line">        (<span class="name">front-queue</span> (<span class="name">segment-queue</span> first-seg)))))</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-3-32"><a href="#Exercise-3-32" class="headerlink" title="Exercise 3.32"></a>Exercise 3.32</h4><p>The procedures to be run during each time segment of the agenda are kept in a queue. Thus, the procedures for each segment are called in the order in which they were added to the agenda (first in, first out). Explain why this order must be used. In particular, trace the behavior of an and-gate whose inputs change from 0,1 to 1,0 in the same segment and say how the behavior would differ if we stored a segment’s procedures in an ordinary list, adding and removing procedures only at the front (last in, first out).</p>
<h2 id="约束的传递"><a href="#约束的传递" class="headerlink" title="约束的传递"></a>约束的传递</h2><p>(3.3.5 Propagation of Constraints)</p>
<h3 id="约束系统的使用-Using-the-constraint-system"><a href="#约束系统的使用-Using-the-constraint-system" class="headerlink" title="约束系统的使用(Using the constraint system)"></a>约束系统的使用(Using the constraint system)</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;: (define C (make-connector))</span></span><br><span class="line"><span class="comment">;: (define F (make-connector))</span></span><br><span class="line"><span class="comment">;: (celsius-fahrenheit-converter C F)</span></span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">celsius-fahrenheit-converter</span> c f)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">u</span> (<span class="name">make-connector</span>))</span><br><span class="line">        (<span class="name">v</span> (<span class="name">make-connector</span>))</span><br><span class="line">        (<span class="name">w</span> (<span class="name">make-connector</span>))</span><br><span class="line">        (<span class="name">x</span> (<span class="name">make-connector</span>))</span><br><span class="line">        (<span class="name">y</span> (<span class="name">make-connector</span>)))</span><br><span class="line">    (<span class="name">multiplier</span> c w u)</span><br><span class="line">    (<span class="name">multiplier</span> v x u)</span><br><span class="line">    (<span class="name">adder</span> v y f)</span><br><span class="line">    (<span class="name">constant</span> <span class="number">9</span> w)</span><br><span class="line">    (<span class="name">constant</span> <span class="number">5</span> x)</span><br><span class="line">    (<span class="name">constant</span> <span class="number">32</span> y)</span><br><span class="line">    <span class="symbol">'ok</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">;: (probe "Celsius temp" C)</span></span><br><span class="line"><span class="comment">;: (probe "Fahrenheit temp" F)</span></span><br><span class="line"><span class="comment">;: (set-value! C 25 'user)</span></span><br><span class="line"><span class="comment">;: (set-value! F 212 'user)</span></span><br><span class="line"><span class="comment">;: (forget-value! C 'user)</span></span><br><span class="line"><span class="comment">;: (set-value! F 212 'user)</span></span><br></pre></td></tr></table></figure>
<h3 id="约束系统的实现-Implementing-the-constraint-system"><a href="#约束系统的实现-Implementing-the-constraint-system" class="headerlink" title="约束系统的实现(Implementing the constraint system)"></a>约束系统的实现(Implementing the constraint system)</h3><p>连接器的基本操作：</p>
<ul>
<li>(has-value? ⟨connector⟩) tells whether the connector has a value.</li>
<li>(get-value ⟨connector⟩) returns the connector’s current value.</li>
<li>(set-value! ⟨connector⟩ ⟨new-value⟩ ⟨informant⟩) indicates that the informant is requesting the connector to set its value to the new value.</li>
<li>(forget-value! ⟨connector⟩ ⟨retractor⟩) tells the connector that the retractor is requesting it to forget its value.</li>
<li>(connect ⟨connector⟩ ⟨new-constraint⟩) tells the connector to participate in the new constraint.</li>
</ul>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">adder</span> a1 a2 sum)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">process-new-value</span>)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name">has-value?</span> a1) (<span class="name">has-value?</span> a2))</span><br><span class="line">           (<span class="name">set-value!</span> sum</span><br><span class="line">                       (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">get-value</span> a1) (<span class="name">get-value</span> a2))</span><br><span class="line">                       me))</span><br><span class="line">          ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name">has-value?</span> a1) (<span class="name">has-value?</span> sum))</span><br><span class="line">           (<span class="name">set-value!</span> a2</span><br><span class="line">                       (<span class="name"><span class="builtin-name">-</span></span> (<span class="name">get-value</span> sum) (<span class="name">get-value</span> a1))</span><br><span class="line">                       me))</span><br><span class="line">          ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name">has-value?</span> a2) (<span class="name">has-value?</span> sum))</span><br><span class="line">           (<span class="name">set-value!</span> a1</span><br><span class="line">                       (<span class="name"><span class="builtin-name">-</span></span> (<span class="name">get-value</span> sum) (<span class="name">get-value</span> a2))</span><br><span class="line">                       me))))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">process-forget-value</span>)</span><br><span class="line">    (<span class="name">forget-value!</span> sum me)</span><br><span class="line">    (<span class="name">forget-value!</span> a1 me)</span><br><span class="line">    (<span class="name">forget-value!</span> a2 me)</span><br><span class="line">    (<span class="name">process-new-value</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">me</span> request)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> request <span class="symbol">'I-have-a-value</span>)</span><br><span class="line">           (<span class="name">process-new-value</span>))</span><br><span class="line">          ((<span class="name"><span class="builtin-name">eq?</span></span> request <span class="symbol">'I-lost-my-value</span>)</span><br><span class="line">           (<span class="name">process-forget-value</span>))</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span></span><br><span class="line">           (<span class="name">error</span> <span class="string">"Unknown request -- ADDER"</span> request))))</span><br><span class="line">  (<span class="name">connect</span> a1 me)</span><br><span class="line">  (<span class="name">connect</span> a2 me)</span><br><span class="line">  (<span class="name">connect</span> sum me)</span><br><span class="line">  me)</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">inform-about-value</span> constraint)</span><br><span class="line">  (<span class="name">constraint</span> <span class="symbol">'I-have-a-value</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">inform-about-no-value</span> constraint)</span><br><span class="line">  (<span class="name">constraint</span> <span class="symbol">'I-lost-my-value</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">multiplier</span> m1 m2 product)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">process-new-value</span>)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">or</span></span> (<span class="name"><span class="builtin-name">and</span></span> (<span class="name">has-value?</span> m1) (<span class="name"><span class="builtin-name">=</span></span> (<span class="name">get-value</span> m1) <span class="number">0</span>))</span><br><span class="line">               (<span class="name"><span class="builtin-name">and</span></span> (<span class="name">has-value?</span> m2) (<span class="name"><span class="builtin-name">=</span></span> (<span class="name">get-value</span> m2) <span class="number">0</span>)))</span><br><span class="line">           (<span class="name">set-value!</span> product <span class="number">0</span> me))</span><br><span class="line">          ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name">has-value?</span> m1) (<span class="name">has-value?</span> m2))</span><br><span class="line">           (<span class="name">set-value!</span> product</span><br><span class="line">                       (<span class="name"><span class="builtin-name">*</span></span> (<span class="name">get-value</span> m1) (<span class="name">get-value</span> m2))</span><br><span class="line">                       me))</span><br><span class="line">          ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name">has-value?</span> product) (<span class="name">has-value?</span> m1))</span><br><span class="line">           (<span class="name">set-value!</span> m2</span><br><span class="line">                       (<span class="name"><span class="builtin-name">/</span></span> (<span class="name">get-value</span> product) (<span class="name">get-value</span> m1))</span><br><span class="line">                       me))</span><br><span class="line">          ((<span class="name"><span class="builtin-name">and</span></span> (<span class="name">has-value?</span> product) (<span class="name">has-value?</span> m2))</span><br><span class="line">           (<span class="name">set-value!</span> m1</span><br><span class="line">                       (<span class="name"><span class="builtin-name">/</span></span> (<span class="name">get-value</span> product) (<span class="name">get-value</span> m2))</span><br><span class="line">                       me))))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">process-forget-value</span>)</span><br><span class="line">    (<span class="name">forget-value!</span> product me)</span><br><span class="line">    (<span class="name">forget-value!</span> m1 me)</span><br><span class="line">    (<span class="name">forget-value!</span> m2 me)</span><br><span class="line">    (<span class="name">process-new-value</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">me</span> request)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> request <span class="symbol">'I-have-a-value</span>)</span><br><span class="line">           (<span class="name">process-new-value</span>))</span><br><span class="line">          ((<span class="name"><span class="builtin-name">eq?</span></span> request <span class="symbol">'I-lost-my-value</span>)</span><br><span class="line">           (<span class="name">process-forget-value</span>))</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span></span><br><span class="line">           (<span class="name">error</span> <span class="string">"Unknown request -- MULTIPLIER"</span> request))))</span><br><span class="line">  (<span class="name">connect</span> m1 me)</span><br><span class="line">  (<span class="name">connect</span> m2 me)</span><br><span class="line">  (<span class="name">connect</span> product me)</span><br><span class="line">  me)</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">constant</span> value connector)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">me</span> request)</span><br><span class="line">    (<span class="name">error</span> <span class="string">"Unknown request -- CONSTANT"</span> request))</span><br><span class="line">  (<span class="name">connect</span> connector me)</span><br><span class="line">  (<span class="name">set-value!</span> connector value me)</span><br><span class="line">  me)</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">probe</span> name connector)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">print-probe</span> value)</span><br><span class="line">    (<span class="name"><span class="builtin-name">newline</span></span>)</span><br><span class="line">    (<span class="name"><span class="builtin-name">display</span></span> <span class="string">"Probe: "</span>)</span><br><span class="line">    (<span class="name"><span class="builtin-name">display</span></span> name)</span><br><span class="line">    (<span class="name"><span class="builtin-name">display</span></span> <span class="string">" = "</span>)</span><br><span class="line">    (<span class="name"><span class="builtin-name">display</span></span> value))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">process-new-value</span>)</span><br><span class="line">    (<span class="name">print-probe</span> (<span class="name">get-value</span> connector)))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">process-forget-value</span>)</span><br><span class="line">    (<span class="name">print-probe</span> <span class="string">"?"</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">me</span> request)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> request <span class="symbol">'I-have-a-value</span>)</span><br><span class="line">           (<span class="name">process-new-value</span>))</span><br><span class="line">          ((<span class="name"><span class="builtin-name">eq?</span></span> request <span class="symbol">'I-lost-my-value</span>)</span><br><span class="line">           (<span class="name">process-forget-value</span>))</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span></span><br><span class="line">           (<span class="name">error</span> <span class="string">"Unknown request -- PROBE"</span> request))))</span><br><span class="line">  (<span class="name">connect</span> connector me)</span><br><span class="line">  me)</span><br></pre></td></tr></table></figure>
<h3 id="连接器的表示-Representing-connectors"><a href="#连接器的表示-Representing-connectors" class="headerlink" title="连接器的表示(Representing connectors)"></a>连接器的表示(Representing connectors)</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-connector</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">value</span> false) (<span class="name">informant</span> false) (<span class="name">constraints</span> '()))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">set-my-value</span> newval setter)</span><br><span class="line">      (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">not</span></span> (<span class="name">has-value?</span> me))</span><br><span class="line">             (<span class="name"><span class="builtin-name">set!</span></span> value newval)</span><br><span class="line">             (<span class="name"><span class="builtin-name">set!</span></span> informant setter)</span><br><span class="line">             (<span class="name">for-each-except</span> setter</span><br><span class="line">                              inform-about-value</span><br><span class="line">                              constraints))</span><br><span class="line">            ((<span class="name"><span class="builtin-name">not</span></span> (<span class="name"><span class="builtin-name">=</span></span> value newval))</span><br><span class="line">             (<span class="name">error</span> <span class="string">"Contradiction"</span> (<span class="name"><span class="builtin-name">list</span></span> value newval)))</span><br><span class="line">            (<span class="name"><span class="builtin-name">else</span></span> <span class="symbol">'ignored</span>)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">forget-my-value</span> retractor)</span><br><span class="line">      (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">eq?</span></span> retractor informant)</span><br><span class="line">          (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> informant false)</span><br><span class="line">                 (<span class="name">for-each-except</span> retractor</span><br><span class="line">                                  inform-about-no-value</span><br><span class="line">                                  constraints))</span><br><span class="line">          <span class="symbol">'ignored</span>))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">connect</span> new-constraint)</span><br><span class="line">      (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">not</span></span> (<span class="name"><span class="builtin-name">memq</span></span> new-constraint constraints))</span><br><span class="line">          (<span class="name"><span class="builtin-name">set!</span></span> constraints</span><br><span class="line">                (<span class="name"><span class="builtin-name">cons</span></span> new-constraint constraints)))</span><br><span class="line">      (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">has-value?</span> me)</span><br><span class="line">          (<span class="name">inform-about-value</span> new-constraint))</span><br><span class="line">      <span class="symbol">'done</span>)</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">me</span> request)</span><br><span class="line">      (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> request <span class="symbol">'has-value?</span>)</span><br><span class="line">             (<span class="name"><span class="builtin-name">if</span></span> informant true false))</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> request <span class="symbol">'value</span>) value)</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> request <span class="symbol">'set-value!</span>) set-my-value)</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> request <span class="symbol">'forget</span>) forget-my-value)</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> request <span class="symbol">'connect</span>) connect)</span><br><span class="line">            (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown operation -- CONNECTOR"</span></span><br><span class="line">                         request))))</span><br><span class="line">    me))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">for-each-except</span> exception procedure list)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">loop</span> items)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">null?</span></span> items) <span class="symbol">'done</span>)</span><br><span class="line">          ((<span class="name"><span class="builtin-name">eq?</span></span> (<span class="name"><span class="builtin-name">car</span></span> items) exception) (<span class="name">loop</span> (<span class="name"><span class="builtin-name">cdr</span></span> items)))</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">procedure</span> (<span class="name"><span class="builtin-name">car</span></span> items))</span><br><span class="line">                (<span class="name">loop</span> (<span class="name"><span class="builtin-name">cdr</span></span> items)))))</span><br><span class="line">  (<span class="name">loop</span> list))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">has-value?</span> connector)</span><br><span class="line">  (<span class="name">connector</span> <span class="symbol">'has-value?</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">get-value</span> connector)</span><br><span class="line">  (<span class="name">connector</span> <span class="symbol">'value</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">set-value!</span> connector new-value informant)</span><br><span class="line">  ((<span class="name">connector</span> <span class="symbol">'set-value!</span>) new-value informant))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">forget-value!</span> connector retractor)</span><br><span class="line">  ((<span class="name">connector</span> <span class="symbol">'forget</span>) retractor))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">connect</span> connector new-constraint)</span><br><span class="line">  ((<span class="name">connector</span> <span class="symbol">'connect</span>) new-constraint))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-33"><a href="#Exercise-3-33" class="headerlink" title="Exercise 3.33"></a>Exercise 3.33</h3><p>Using primitive multiplier, adder, and constant constraints, define a procedure averager that takes three connectors a, b, and c as inputs and establishes the constraint that the value of c is the average of the values of a and b.</p>
<h3 id="Exercise-3-34"><a href="#Exercise-3-34" class="headerlink" title="Exercise 3.34"></a>Exercise 3.34</h3><p>Louis Reasoner wants to build a squarer, a constraint device with two terminals such that the value of connector b on the second terminal will always be the square of the value a on the first terminal. He proposes the following simple device made from a multiplier:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">squarer</span> a b)</span><br><span class="line">  (<span class="name">multiplier</span> a a b))</span><br></pre></td></tr></table></figure></p>
<p>There is a serious flaw in this idea. Explain.</p>
<h3 id="Exercise-3-35"><a href="#Exercise-3-35" class="headerlink" title="Exercise 3.35"></a>Exercise 3.35</h3><p>Ben Bitdiddle tells Louis that one way to avoid the trouble in exercise 3.34 is to define a squarer as a new primitive constraint. Fill in the missing portions in Ben’s outline for a procedure to implement such a constraint:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">squarer</span> a b)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">process-new-value</span>)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">has-value?</span> b)</span><br><span class="line">        (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&lt;</span></span> (<span class="name">get-value</span> b) <span class="number">0</span>)</span><br><span class="line">            (<span class="name">error</span> <span class="string">"square less than 0 -- SQUARER"</span> (<span class="name">get-value</span> b))</span><br><span class="line">            &lt;alternative1&gt;)</span><br><span class="line">        &lt;alternative2&gt;))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">process-forget-value</span>) &lt;body1&gt;)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">me</span> request) &lt;body2&gt;)</span><br><span class="line">  &lt;rest of definition&gt;</span><br><span class="line">  me)</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-3-36"><a href="#Exercise-3-36" class="headerlink" title="Exercise 3.36"></a>Exercise 3.36</h3><p>Suppose we evaluate the following sequence of expressions in the global environment:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> a (<span class="name">make-connector</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> b (<span class="name">make-connector</span>))</span><br><span class="line">(<span class="name">set-value!</span> a <span class="number">10</span> <span class="symbol">'user</span>)</span><br></pre></td></tr></table></figure></p>
<p>At some time during evaluation of the set-value!, the following expression from the connector’s local procedure is evaluated:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(for-each-except setter inform-about-value constraints)</span><br></pre></td></tr></table></figure></p>
<p>Draw an environment diagram showing the environment in which the above expression is evaluated.</p>
<h3 id="Exercise-3-37"><a href="#Exercise-3-37" class="headerlink" title="Exercise 3.37"></a>Exercise 3.37</h3><p>The celsius-fahrenheit-converter procedure is cumbersome when compared with a more expression-oriented style of definition, such as<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">celsius-fahrenheit-converter</span> x)</span><br><span class="line">  (<span class="name">c+</span> (<span class="name">c*</span> (<span class="name">c/</span> (<span class="name">cv</span> <span class="number">9</span>) (<span class="name">cv</span> <span class="number">5</span>))</span><br><span class="line">          x)</span><br><span class="line">      (<span class="name">cv</span> <span class="number">32</span>)))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> C (<span class="name">make-connector</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> F (<span class="name">celsius-fahrenheit-converter</span> C))</span><br></pre></td></tr></table></figure></p>
<p>Here c+, c*, etc. are the “constraint” versions of the arithmetic operations. For example, c+ takes two connectors as arguments and returns a connector that is related to these by an adder constraint:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">c+</span> x y)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">z</span> (<span class="name">make-connector</span>)))</span><br><span class="line">    (<span class="name">adder</span> x y z)</span><br><span class="line">    z))</span><br></pre></td></tr></table></figure></p>
<p>Define analogous procedures c-, c*, c/, and cv (constant value) that enable us to define compound constraints as in the converter example above.
</p>
<h2 id="并发：时间是一个本质问题"><a href="#并发：时间是一个本质问题" class="headerlink" title="并发：时间是一个本质问题"></a>并发：时间是一个本质问题</h2><p>(3.4 Concurrency: Time Is of the Essence)<br>;;;**Need parallel-execute, available for MIT Scheme</p>
<h2 id="并发系统中时间的性质"><a href="#并发系统中时间的性质" class="headerlink" title="并发系统中时间的性质"></a>并发系统中时间的性质</h2><p>(3.4.1 The Nature of Time in Concurrent Systems)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">withdraw</span> amount)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">      (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">             balance)</span><br><span class="line">      <span class="string">"Insufficient funds"</span>))</span><br></pre></td></tr></table></figure>
<h3 id="Correct-behavior-of-concurrent-programs"><a href="#Correct-behavior-of-concurrent-programs" class="headerlink" title="Correct behavior of concurrent programs"></a>Correct behavior of concurrent programs</h3><h3 id="Exercise-3-38"><a href="#Exercise-3-38" class="headerlink" title="Exercise 3.38"></a>Exercise 3.38</h3><p>Suppose that Peter, Paul, and Mary share a joint bank account that initially contains $100. Concurrently, Peter deposits $10, Paul withdraws $20, and Mary withdraws half the money in the account, by executing the following commands:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Peter:    (set! balance (+ balance 10))</span><br><span class="line">Paul:    (set! balance (- balance 20))</span><br><span class="line">Mary:    (set! balance (- balance (/ balance 2)))</span><br></pre></td></tr></table></figure></p>
<p>a. List all the different possible values for balance after these three transactions have been completed, assuming that the banking system forces the three processes to run sequentially in some order.<br>b. What are some other values that could be produced if the system allows the processes to be interleaved? Draw timing diagrams like the one in figure 3.29 to explain how these values can occur.</p>
<h2 id="控制并发的机制"><a href="#控制并发的机制" class="headerlink" title="控制并发的机制"></a>控制并发的机制</h2><p>(3.4.2 Mechanisms for Controlling Concurrency)</p>
<h3 id="Serializing-access-to-shared-state"><a href="#Serializing-access-to-shared-state" class="headerlink" title="Serializing access to shared state"></a>Serializing access to shared state</h3><h3 id="Serializers-in-Scheme"><a href="#Serializers-in-Scheme" class="headerlink" title="Serializers in Scheme"></a>Serializers in Scheme</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;: (define x 10)</span></span><br><span class="line"><span class="comment">;: (parallel-execute (lambda () (set! x (* x x)))</span></span><br><span class="line"><span class="comment">;:                   (lambda () (set! x (+ x 1))))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;: (define x 10)</span></span><br><span class="line"><span class="comment">;: (define s (make-serializer))</span></span><br><span class="line"><span class="comment">;: (parallel-execute (s (lambda () (set! x (* x x))))</span></span><br><span class="line"><span class="comment">;:                   (s (lambda () (set! x (+ x 1)))))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-account</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">withdraw</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">        (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">               balance)</span><br><span class="line">        <span class="string">"Insufficient funds"</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deposit</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">+</span></span> balance amount))</span><br><span class="line">    balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">protected</span> (<span class="name">make-serializer</span>)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m)</span><br><span class="line">      (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'withdraw</span>) (<span class="name">protected</span> withdraw))</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'deposit</span>) (<span class="name">protected</span> deposit))</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'balance</span>) balance)</span><br><span class="line">            (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown request -- MAKE-ACCOUNT"</span></span><br><span class="line">                         m))))</span><br><span class="line">    dispatch))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-39"><a href="#Exercise-3-39" class="headerlink" title="Exercise 3.39"></a>Exercise 3.39</h3><p>Which of the five possibilities in the parallel execution shown above remain if we instead serialize execution as follows:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> x <span class="number">10</span>)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> s (<span class="name">make-serializer</span>))</span><br><span class="line">(<span class="name">parallel-execute</span> (<span class="name"><span class="builtin-name">lambda</span></span> () (<span class="name"><span class="builtin-name">set!</span></span> x ((<span class="name">s</span> (<span class="name"><span class="builtin-name">lambda</span></span> () (<span class="name"><span class="builtin-name">*</span></span> x x))))))</span><br><span class="line">                  (<span class="name">s</span> (<span class="name"><span class="builtin-name">lambda</span></span> () (<span class="name"><span class="builtin-name">set!</span></span> x (<span class="name"><span class="builtin-name">+</span></span> x <span class="number">1</span>)))))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-3-40"><a href="#Exercise-3-40" class="headerlink" title="Exercise 3.40"></a>Exercise 3.40</h3><p>Give all possible values of x that can result from executing<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> x <span class="number">10</span>)</span><br><span class="line">(<span class="name">parallel-execute</span> (<span class="name"><span class="builtin-name">lambda</span></span> () (<span class="name"><span class="builtin-name">set!</span></span> x (<span class="name"><span class="builtin-name">*</span></span> x x)))</span><br><span class="line">                  (<span class="name"><span class="builtin-name">lambda</span></span> () (<span class="name"><span class="builtin-name">set!</span></span> x (<span class="name"><span class="builtin-name">*</span></span> x x x))))</span><br></pre></td></tr></table></figure></p>
<p>Which of these possibilities remain if we instead use serialized procedures:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> x <span class="number">10</span>)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> s (<span class="name">make-serializer</span>))</span><br><span class="line">(<span class="name">parallel-execute</span> (<span class="name">s</span> (<span class="name"><span class="builtin-name">lambda</span></span> () (<span class="name"><span class="builtin-name">set!</span></span> x (<span class="name"><span class="builtin-name">*</span></span> x x))))</span><br><span class="line">                  (<span class="name">s</span> (<span class="name"><span class="builtin-name">lambda</span></span> () (<span class="name"><span class="builtin-name">set!</span></span> x (<span class="name"><span class="builtin-name">*</span></span> x x x)))))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-3-41"><a href="#Exercise-3-41" class="headerlink" title="Exercise 3.41"></a>Exercise 3.41</h3><p>Ben Bitdiddle worries that it would be better to implement the bank account as follows (where the commented line has been changed):<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-account</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">withdraw</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">        (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">               balance)</span><br><span class="line">        <span class="string">"Insufficient funds"</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deposit</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">+</span></span> balance amount))</span><br><span class="line">    balance)</span><br><span class="line">  <span class="comment">;; continued on next page</span></span><br><span class="line"></span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">protected</span> (<span class="name">make-serializer</span>)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m)</span><br><span class="line">      (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'withdraw</span>) (<span class="name">protected</span> withdraw))</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'deposit</span>) (<span class="name">protected</span> deposit))</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'balance</span>)</span><br><span class="line">             ((<span class="name">protected</span> (<span class="name"><span class="builtin-name">lambda</span></span> () balance)))) <span class="comment">; serialized</span></span><br><span class="line">            (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown request -- MAKE-ACCOUNT"</span></span><br><span class="line">                         m))))</span><br><span class="line">    dispatch))</span><br></pre></td></tr></table></figure></p>
<p>because allowing unserialized access to the bank balance can result in anomalous behavior. Do you agree? Is there any scenario that demonstrates Ben’s concern?</p>
<h3 id="Exercise-3-42"><a href="#Exercise-3-42" class="headerlink" title="Exercise 3.42"></a>Exercise 3.42</h3><p>Ben Bitdiddle suggests that it’s a waste of time to create a new serialized procedure in response to every withdraw and deposit message. He says that make-account could be changed so that the calls to protected are done outside the dispatch procedure. That is, an account would return the same serialized procedure (which was created at the same time as the account) each time it is asked for a withdrawal procedure.<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-account</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">withdraw</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">        (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">               balance)</span><br><span class="line">        <span class="string">"Insufficient funds"</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deposit</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">+</span></span> balance amount))</span><br><span class="line">    balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">protected</span> (<span class="name">make-serializer</span>)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">protected-withdraw</span> (<span class="name">protected</span> withdraw))</span><br><span class="line">          (<span class="name">protected-deposit</span> (<span class="name">protected</span> deposit)))</span><br><span class="line">      (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m)</span><br><span class="line">        (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'withdraw</span>) protected-withdraw)</span><br><span class="line">              ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'deposit</span>) protected-deposit)</span><br><span class="line">              ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'balance</span>) balance)</span><br><span class="line">              (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown request -- MAKE-ACCOUNT"</span></span><br><span class="line">                           m))))</span><br><span class="line">      dispatch)))</span><br></pre></td></tr></table></figure></p>
<p>Is this a safe change to make? In particular, is there any difference in what concurrency is allowed by these two versions of make-account ?</p>
<h3 id="Complexity-of-using-multiple-shared-resources"><a href="#Complexity-of-using-multiple-shared-resources" class="headerlink" title="Complexity of using multiple shared resources"></a>Complexity of using multiple shared resources</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">exchange</span> account1 account2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">difference</span> (<span class="name"><span class="builtin-name">-</span></span> (<span class="name">account1</span> <span class="symbol">'balance</span>)</span><br><span class="line">                       (<span class="name">account2</span> <span class="symbol">'balance</span>))))</span><br><span class="line">    ((<span class="name">account1</span> <span class="symbol">'withdraw</span>) difference)</span><br><span class="line">    ((<span class="name">account2</span> <span class="symbol">'deposit</span>) difference)))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-account-and-serializer</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">withdraw</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">        (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">               balance)</span><br><span class="line">        <span class="string">"Insufficient funds"</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deposit</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">+</span></span> balance amount))</span><br><span class="line">    balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">balance-serializer</span> (<span class="name">make-serializer</span>)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m)</span><br><span class="line">      (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'withdraw</span>) withdraw)</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'deposit</span>) deposit)</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'balance</span>) balance)</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'serializer</span>) balance-serializer)</span><br><span class="line">            (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown request -- MAKE-ACCOUNT"</span></span><br><span class="line">                         m))))</span><br><span class="line">    dispatch))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deposit</span> account amount)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">s</span> (<span class="name">account</span> <span class="symbol">'serializer</span>))</span><br><span class="line">        (<span class="name">d</span> (<span class="name">account</span> <span class="symbol">'deposit</span>)))</span><br><span class="line">    ((<span class="name">s</span> d) amount)))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">serialized-exchange</span> account1 account2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">serializer1</span> (<span class="name">account1</span> <span class="symbol">'serializer</span>))</span><br><span class="line">        (<span class="name">serializer2</span> (<span class="name">account2</span> <span class="symbol">'serializer</span>)))</span><br><span class="line">    ((<span class="name">serializer1</span> (<span class="name">serializer2</span> exchange))</span><br><span class="line">     account1</span><br><span class="line">     account2)))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-43"><a href="#Exercise-3-43" class="headerlink" title="Exercise 3.43"></a>Exercise 3.43</h3><p>Suppose that the balances in three accounts start out as $10, $20, and $30, and that multiple processes run, exchanging the balances in the accounts. Argue that if the processes are run sequentially, after any number of concurrent exchanges, the account balances should be $10, $20, and $30 in some order. Draw a timing diagram like the one in figure 3.29 to show how this condition can be violated if the exchanges are implemented using the first version of the account-exchange program in this section. On the other hand, argue that even with this exchange program, the sum of the balances in the accounts will be preserved. Draw a timing diagram to show how even this condition would be violated if we did not serialize the transactions on individual accounts.</p>
<h3 id="Exercise-3-44"><a href="#Exercise-3-44" class="headerlink" title="Exercise 3.44"></a>Exercise 3.44</h3><p>Consider the problem of transferring an amount from one account to another. Ben Bitdiddle claims that this can be accomplished with the following procedure, even if there are multiple people concurrently transferring money among multiple accounts, using any account mechanism that serializes deposit and withdrawal transactions, for example, the version of make-account in the text above.<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">transfer</span> from-account to-account amount)</span><br><span class="line">  ((<span class="name">from-account</span> <span class="symbol">'withdraw</span>) amount)</span><br><span class="line">  ((<span class="name">to-account</span> <span class="symbol">'deposit</span>) amount))</span><br></pre></td></tr></table></figure></p>
<p>Louis Reasoner claims that there is a problem here, and that we need to use a more sophisticated method, such as the one required for dealing with the exchange problem. Is Louis right? If not, what is the essential difference between the transfer problem and the exchange problem? (You should assume that the balance in from-account is at least amount.)</p>
<h3 id="Exercise-3-45"><a href="#Exercise-3-45" class="headerlink" title="Exercise 3.45"></a>Exercise 3.45</h3><p>Louis Reasoner thinks our bank-account system is unnecessarily complex and error-prone now that deposits and withdrawals aren’t automatically serialized. He suggests that make-account-and-serializer should have exported the serializer (for use by such procedures as serialized-exchange) in addition to (rather than instead of) using it to serialize accounts and deposits as make-account did. He proposes to redefine accounts as follows:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-account-and-serializer</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">withdraw</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> balance amount)</span><br><span class="line">        (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">               balance)</span><br><span class="line">        <span class="string">"Insufficient funds"</span>))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deposit</span> amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">+</span></span> balance amount))</span><br><span class="line">    balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">balance-serializer</span> (<span class="name">make-serializer</span>)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">dispatch</span> m)</span><br><span class="line">      (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'withdraw</span>) (<span class="name">balance-serializer</span> withdraw))</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'deposit</span>) (<span class="name">balance-serializer</span> deposit))</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'balance</span>) balance)</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'serializer</span>) balance-serializer)</span><br><span class="line">            (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">error</span> <span class="string">"Unknown request -- MAKE-ACCOUNT"</span></span><br><span class="line">                         m))))</span><br><span class="line">    dispatch))</span><br></pre></td></tr></table></figure></p>
<p>Then deposits are handled as with the original make-account:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">deposit</span> account amount)</span><br><span class="line"> ((<span class="name">account</span> <span class="symbol">'deposit</span>) amount))</span><br></pre></td></tr></table></figure></p>
<p>Explain what is wrong with Louis’s reasoning. In particular, consider what happens when serialized-exchange is called.</p>
<h3 id="Implementing-serializers"><a href="#Implementing-serializers" class="headerlink" title="Implementing serializers"></a>Implementing serializers</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-serializer</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">mutex</span> (<span class="name">make-mutex</span>)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">lambda</span></span> (p)</span><br><span class="line">      (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">serialized-p</span> . args)</span><br><span class="line">        (<span class="name">mutex</span> <span class="symbol">'acquire</span>)</span><br><span class="line">        (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">val</span> (<span class="name"><span class="builtin-name">apply</span></span> p args)))</span><br><span class="line">          (<span class="name">mutex</span> <span class="symbol">'release</span>)</span><br><span class="line">          val))</span><br><span class="line">      serialized-p)))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-mutex</span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">cell</span> (<span class="name"><span class="builtin-name">list</span></span> false)))          </span><br><span class="line">    (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">the-mutex</span> m)</span><br><span class="line">      (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'acquire</span>)</span><br><span class="line">             (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">test-and-set!</span> cell)</span><br><span class="line">                 (<span class="name">the-mutex</span> <span class="symbol">'acquire</span>)))</span><br><span class="line">            ((<span class="name"><span class="builtin-name">eq?</span></span> m <span class="symbol">'release</span>) (<span class="name">clear!</span> cell))))</span><br><span class="line">    the-mutex))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">clear!</span> cell)</span><br><span class="line">  (<span class="name"><span class="builtin-name">set-car!</span></span> cell false))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">test-and-set!</span> cell)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">car</span></span> cell)</span><br><span class="line">      true</span><br><span class="line">      (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set-car!</span></span> cell true)</span><br><span class="line">             false)))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-46"><a href="#Exercise-3-46" class="headerlink" title="Exercise 3.46"></a>Exercise 3.46</h3><p>Suppose that we implement test-and-set! using an ordinary procedure as shown in the text, without attempting to make the operation atomic. Draw a timing diagram like the one in figure 3.29 to demonstrate how the mutex implementation can fail by allowing two processes to acquire the mutex at the same time.</p>
<h3 id="Exercise-3-47"><a href="#Exercise-3-47" class="headerlink" title="Exercise 3.47"></a>Exercise 3.47</h3><p>A semaphore (of size n) is a generalization of a mutex. Like a mutex, a semaphore supports acquire and release operations, but it is more general in that up to n processes can acquire it concurrently. Additional processes that attempt to acquire the semaphore must wait for release operations. Give implementations of semaphores<br>a. in terms of mutexes<br>b. in terms of atomic test-and-set! operations.</p>
<h3 id="Deadlock"><a href="#Deadlock" class="headerlink" title="Deadlock"></a>Deadlock</h3><h3 id="Exercise-3-48"><a href="#Exercise-3-48" class="headerlink" title="Exercise 3.48"></a>Exercise 3.48</h3><p>Explain in detail why the deadlock-avoidance method described above, (i.e., the accounts are numbered, and each process attempts to acquire the smaller-numbered account first) avoids deadlock in the exchange problem. Rewrite serialized-exchange to incorporate this idea. (You will also need to modify make-account so that each account is created with a number, which can be accessed by sending an appropriate message.)</p>
<h3 id="Exercise-3-49"><a href="#Exercise-3-49" class="headerlink" title="Exercise 3.49"></a>Exercise 3.49</h3><p>Give a scenario where the deadlock-avoidance mechanism described above does not work. (Hint: In the exchange problem, each process knows in advance which accounts it will need to get access to. Consider a situation where a process must get access to some shared resources before it can know which additional shared resources it will require.)</p>
<h3 id="Concurrency-time-and-communication"><a href="#Concurrency-time-and-communication" class="headerlink" title="Concurrency, time, and communication"></a>Concurrency, time, and communication</h3><h2 id="流"><a href="#流" class="headerlink" title="流"></a>流</h2><p>(3.5 Streams)</p>
<h2 id="流作为延时的表"><a href="#流作为延时的表" class="headerlink" title="流作为延时的表"></a>流作为延时的表</h2><p>(3.5.1 Streams Are Delayed Lists)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sum-primes</span> a b)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">iter</span> count accum)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">&gt;</span></span> count b) accum)</span><br><span class="line">          ((<span class="name">prime?</span> count) (<span class="name">iter</span> (<span class="name"><span class="builtin-name">+</span></span> count <span class="number">1</span>) (<span class="name"><span class="builtin-name">+</span></span> count accum)))</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">iter</span> (<span class="name"><span class="builtin-name">+</span></span> count <span class="number">1</span>) accum))))</span><br><span class="line">  (<span class="name">iter</span> a <span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sum-primes</span> a b)</span><br><span class="line">  (<span class="name">accumulate</span> +</span><br><span class="line">              <span class="number">0</span></span><br><span class="line">              (<span class="name">filter</span> prime? (<span class="name">enumerate-interval</span> a b))))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">car</span></span> (<span class="name"><span class="builtin-name">cdr</span></span> (<span class="name">filter</span> prime?</span><br><span class="line">                  (<span class="name">enumerate-interval</span> <span class="number">10000</span> <span class="number">1000000</span>))))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">stream-ref</span> s n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> n <span class="number">0</span>)</span><br><span class="line">      (<span class="name">stream-car</span> s)</span><br><span class="line">      (<span class="name">stream-ref</span> (<span class="name">stream-cdr</span> s) (<span class="name"><span class="builtin-name">-</span></span> n <span class="number">1</span>))))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">stream-map</span> proc s)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">stream-null?</span> s)</span><br><span class="line">      the-empty-stream</span><br><span class="line">      (<span class="name">cons-stream</span> (<span class="name">proc</span> (<span class="name">stream-car</span> s))</span><br><span class="line">                   (<span class="name">stream-map</span> proc (<span class="name">stream-cdr</span> s)))))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">stream-for-each</span> proc s)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">stream-null?</span> s)</span><br><span class="line">      <span class="symbol">'done</span></span><br><span class="line">      (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name">proc</span> (<span class="name">stream-car</span> s))</span><br><span class="line">             (<span class="name">stream-for-each</span> proc (<span class="name">stream-cdr</span> s)))))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">display-stream</span> s)</span><br><span class="line">  (<span class="name">stream-for-each</span> display-line s))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">display-line</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">newline</span></span>)</span><br><span class="line">  (<span class="name"><span class="builtin-name">display</span></span> x))</span><br></pre></td></tr></table></figure>
<p>;; stream-car and stream-cdr would normally be built into<br>;;  the stream implementation<br>;: (define (stream-car stream) (car stream))<br>;: (define (stream-cdr stream) (force (cdr stream)))</p>
<h3 id="The-stream-implementation-in-action"><a href="#The-stream-implementation-in-action" class="headerlink" title="The stream implementation in action"></a>The stream implementation in action</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">stream-car</span></span><br><span class="line">(<span class="name">stream-cdr</span></span><br><span class="line">    (<span class="name">stream-filter</span> prime?</span><br><span class="line">                   (<span class="name">stream-enumerate-interval</span> <span class="number">10000</span> <span class="number">1000000</span>))))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">stream-enumerate-interval</span> low high)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;</span></span> low high)</span><br><span class="line">      the-empty-stream</span><br><span class="line">      (<span class="name">cons-stream</span></span><br><span class="line">       low</span><br><span class="line">       (<span class="name">stream-enumerate-interval</span> (<span class="name"><span class="builtin-name">+</span></span> low <span class="number">1</span>) high))))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">stream-filter</span> pred stream)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name">stream-null?</span> stream) the-empty-stream)</span><br><span class="line">        ((<span class="name">pred</span> (<span class="name">stream-car</span> stream))</span><br><span class="line">         (<span class="name">cons-stream</span> (<span class="name">stream-car</span> stream)</span><br><span class="line">                      (<span class="name">stream-filter</span> pred</span><br><span class="line">                                     (<span class="name">stream-cdr</span> stream))))</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">stream-filter</span> pred (<span class="name">stream-cdr</span> stream)))))</span><br></pre></td></tr></table></figure>
<h3 id="Implementing-delay-and-force"><a href="#Implementing-delay-and-force" class="headerlink" title="Implementing delay and force"></a>Implementing delay and force</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;; force would normally be built into</span></span><br><span class="line"><span class="comment">;;  the stream implementation</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">force</span></span> delayed-object)  (<span class="name">delayed-object</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">memo-proc</span> proc)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">already-run?</span> false) (<span class="name">result</span> false))</span><br><span class="line">    (<span class="name"><span class="builtin-name">lambda</span></span> ()</span><br><span class="line">      (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">not</span></span> already-run?)</span><br><span class="line">          (<span class="name"><span class="builtin-name">begin</span></span> (<span class="name"><span class="builtin-name">set!</span></span> result (<span class="name">proc</span>))</span><br><span class="line">                 (<span class="name"><span class="builtin-name">set!</span></span> already-run? true)</span><br><span class="line">                 result)</span><br><span class="line">          result))))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-50"><a href="#Exercise-3-50" class="headerlink" title="Exercise 3.50"></a>Exercise 3.50</h3><p>Complete the following definition, which generalizes stream-map to allow procedures that take multiple arguments, analogous to map in section 2.2.3, footnote 12.<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">stream-map</span> proc . argstreams)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">&lt;??&gt;</span> (<span class="name"><span class="builtin-name">car</span></span> argstreams))</span><br><span class="line">      the-empty-stream</span><br><span class="line">      (<span class="name">&lt;??&gt;</span></span><br><span class="line">       (<span class="name"><span class="builtin-name">apply</span></span> proc (<span class="name"><span class="builtin-name">map</span></span> &lt;??&gt; argstreams))</span><br><span class="line">       (<span class="name"><span class="builtin-name">apply</span></span> stream-map</span><br><span class="line">              (<span class="name"><span class="builtin-name">cons</span></span> proc (<span class="name"><span class="builtin-name">map</span></span> &lt;??&gt; argstreams))))))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-3-51"><a href="#Exercise-3-51" class="headerlink" title="Exercise 3.51"></a>Exercise 3.51</h3><p>In order to take a closer look at delayed evaluation, we will use the following procedure, which simply returns its argument after printing it:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">show</span> x)</span><br><span class="line">  (<span class="name">display-line</span> x)</span><br><span class="line">  x)</span><br></pre></td></tr></table></figure></p>
<p>What does the interpreter print in response to evaluating each expression in the following sequence?<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> x (<span class="name">stream-map</span> show (<span class="name">stream-enumerate-interval</span> <span class="number">0</span> <span class="number">10</span>)))</span><br><span class="line">(<span class="name">stream-ref</span> x <span class="number">5</span>)</span><br><span class="line">(<span class="name">stream-ref</span> x <span class="number">7</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-3-52"><a href="#Exercise-3-52" class="headerlink" title="Exercise 3.52"></a>Exercise 3.52</h3><p>Consider the sequence of expressions<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> sum <span class="number">0</span>)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">accum</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">set!</span></span> sum (<span class="name"><span class="builtin-name">+</span></span> x sum))</span><br><span class="line">  sum)</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> seq (<span class="name">stream-map</span> accum (<span class="name">stream-enumerate-interval</span> <span class="number">1</span> <span class="number">20</span>)))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> y (<span class="name">stream-filter</span> even? seq))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> z (<span class="name">stream-filter</span> (<span class="name"><span class="builtin-name">lambda</span></span> (x) (<span class="name"><span class="builtin-name">=</span></span> (<span class="name"><span class="builtin-name">remainder</span></span> x <span class="number">5</span>) <span class="number">0</span>))</span><br><span class="line">                         seq))</span><br><span class="line">(<span class="name">stream-ref</span> y <span class="number">7</span>)</span><br><span class="line">(<span class="name">display-stream</span> z)</span><br></pre></td></tr></table></figure></p>
<p>What is the value of sum after each of the above expressions is evaluated? What is the printed response to evaluating the stream-ref and display-stream expressions? Would these responses differ if we had implemented (delay <exp>) simply as (lambda () <exp>) without using the optimization provided by memo-proc ? Explain.</exp></exp></p>
<h2 id="无穷流"><a href="#无穷流" class="headerlink" title="无穷流"></a>无穷流</h2><p>(3.5.2 Infinite Streams)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">integers-starting-from</span> n)</span><br><span class="line">  (<span class="name">cons-stream</span> n (<span class="name">integers-starting-from</span> (<span class="name"><span class="builtin-name">+</span></span> n <span class="number">1</span>))))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> integers (<span class="name">integers-starting-from</span> <span class="number">1</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">divisible?</span> x y) (<span class="name"><span class="builtin-name">=</span></span> (<span class="name"><span class="builtin-name">remainder</span></span> x y) <span class="number">0</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> no-sevens</span><br><span class="line">  (<span class="name">stream-filter</span> (<span class="name"><span class="builtin-name">lambda</span></span> (x) (<span class="name"><span class="builtin-name">not</span></span> (<span class="name">divisible?</span> x <span class="number">7</span>)))</span><br><span class="line">                 integers))</span><br><span class="line"></span><br><span class="line"><span class="comment">;: (stream-ref no-sevens 100)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">fibgen</span> a b) (<span class="name">cons-stream</span> a (<span class="name">fibgen</span> b (<span class="name"><span class="builtin-name">+</span></span> a b))))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> fibs (<span class="name">fibgen</span> <span class="number">0</span> <span class="number">1</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sieve</span> stream)</span><br><span class="line">  (<span class="name">cons-stream</span></span><br><span class="line">   (<span class="name">stream-car</span> stream)</span><br><span class="line">   (<span class="name">sieve</span> (<span class="name">stream-filter</span></span><br><span class="line">           (<span class="name"><span class="builtin-name">lambda</span></span> (x)</span><br><span class="line">             (<span class="name"><span class="builtin-name">not</span></span> (<span class="name">divisible?</span> x (<span class="name">stream-car</span> stream))))</span><br><span class="line">           (<span class="name">stream-cdr</span> stream)))))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> primes (<span class="name">sieve</span> (<span class="name">integers-starting-from</span> <span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment">;: (stream-ref primes 50)</span></span><br></pre></td></tr></table></figure>
<h3 id="Defining-streams-implicitly"><a href="#Defining-streams-implicitly" class="headerlink" title="Defining streams implicitly"></a>Defining streams implicitly</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> ones (<span class="name">cons-stream</span> <span class="number">1</span> ones))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">add-streams</span> s1 s2)</span><br><span class="line">  (<span class="name">stream-map</span> + s1 s2))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> integers (<span class="name">cons-stream</span> <span class="number">1</span> (<span class="name">add-streams</span> ones integers)))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> fibs</span><br><span class="line">  (<span class="name">cons-stream</span></span><br><span class="line">   <span class="number">0</span></span><br><span class="line">   (<span class="name">cons-stream</span> <span class="number">1</span> (<span class="name">add-streams</span> (<span class="name">stream-cdr</span> fibs) fibs))))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">scale-stream</span> stream factor)</span><br><span class="line">  (<span class="name">stream-map</span> (<span class="name"><span class="builtin-name">lambda</span></span> (x) (<span class="name"><span class="builtin-name">*</span></span> x factor)) stream))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> double (<span class="name">cons-stream</span> <span class="number">1</span> (<span class="name">scale-stream</span> double <span class="number">2</span>)))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> primes</span><br><span class="line">  (<span class="name">cons-stream</span></span><br><span class="line">   <span class="number">2</span></span><br><span class="line">   (<span class="name">stream-filter</span> prime? (<span class="name">integers-starting-from</span> <span class="number">3</span>))))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">prime?</span> n)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">iter</span> ps)</span><br><span class="line">    (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">&gt;</span></span> (<span class="name">square</span> (<span class="name">stream-car</span> ps)) n) true)</span><br><span class="line">          ((<span class="name">divisible?</span> n (<span class="name">stream-car</span> ps)) false)</span><br><span class="line">          (<span class="name"><span class="builtin-name">else</span></span> (<span class="name">iter</span> (<span class="name">stream-cdr</span> ps)))))</span><br><span class="line">  (<span class="name">iter</span> primes))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-53"><a href="#Exercise-3-53" class="headerlink" title="Exercise 3.53"></a>Exercise 3.53</h3><p>Without running the program, describe the elements of the stream defined by</p>
<p>(define s (cons-stream 1 (add-streams s s)))</p>
<h3 id="Exercise-3-54"><a href="#Exercise-3-54" class="headerlink" title="Exercise 3.54"></a>Exercise 3.54</h3><p>Define a procedure mul-streams, analogous to add-streams, that produces the elementwise product of its two input streams. Use this together with the stream of integers to complete the following definition of the stream whose nth element (counting from 0) is n + 1 factorial:</p>
<p>(define factorials (cons-stream 1 (mul-streams &lt;??&gt; &lt;??&gt;)))</p>
<h3 id="Exercise-3-55"><a href="#Exercise-3-55" class="headerlink" title="Exercise 3.55"></a>Exercise 3.55</h3><p>Define a procedure partial-sums that takes as argument a stream S and returns the stream whose elements are S0, S0 + S1, S0 + S1 + S2, …. For example, (partial-sums integers) should be the stream 1, 3, 6, 10, 15, ….</p>
<h3 id="Exercise-3-56"><a href="#Exercise-3-56" class="headerlink" title="Exercise 3.56"></a>Exercise 3.56</h3><p>A famous problem, first raised by R. Hamming, is to enumerate, in ascending order with no repetitions, all positive integers with no prime factors other than 2, 3, or 5. One obvious way to do this is to simply test each integer in turn to see whether it has any factors other than 2, 3, and 5. But this is very inefficient, since, as the integers get larger, fewer and fewer of them fit the requirement. As an alternative, let us call the required stream of numbers S and notice the following facts about it.</p>
<p>S begins with 1.<br>The elements of (scale-stream S 2) are also elements of S.<br>The same is true for (scale-stream S 3) and (scale-stream 5 S).<br>These are all the elements of S.<br>Now all we have to do is combine elements from these sources. For this we define a procedure merge that combines two ordered streams into one ordered result stream, eliminating repetitions:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">merge</span> s1 s2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name">stream-null?</span> s1) s2)</span><br><span class="line">        ((<span class="name">stream-null?</span> s2) s1)</span><br><span class="line">        (<span class="name"><span class="builtin-name">else</span></span></span><br><span class="line">         (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">s1car</span> (<span class="name">stream-car</span> s1))</span><br><span class="line">               (<span class="name">s2car</span> (<span class="name">stream-car</span> s2)))</span><br><span class="line">           (<span class="name"><span class="builtin-name">cond</span></span> ((<span class="name"><span class="builtin-name">&lt;</span></span> s1car s2car)</span><br><span class="line">                  (<span class="name">cons-stream</span> s1car (<span class="name">merge</span> (<span class="name">stream-cdr</span> s1) s2)))</span><br><span class="line">                 ((<span class="name"><span class="builtin-name">&gt;</span></span> s1car s2car)</span><br><span class="line">                  (<span class="name">cons-stream</span> s2car (<span class="name">merge</span> s1 (<span class="name">stream-cdr</span> s2))))</span><br><span class="line">                 (<span class="name"><span class="builtin-name">else</span></span></span><br><span class="line">                  (<span class="name">cons-stream</span> s1car</span><br><span class="line">                               (<span class="name">merge</span> (<span class="name">stream-cdr</span> s1)</span><br><span class="line">                                      (<span class="name">stream-cdr</span> s2)))))))))</span><br></pre></td></tr></table></figure></p>
<p>Then the required stream may be constructed with merge, as follows:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> S (<span class="name">cons-stream</span> <span class="number">1</span> (<span class="name">merge</span> &lt;??&gt; &lt;??&gt;)))</span><br></pre></td></tr></table></figure></p>
<p>Fill in the missing expressions in the places marked &lt;??&gt; above.</p>
<h3 id="Exercise-3-57"><a href="#Exercise-3-57" class="headerlink" title="Exercise 3.57"></a>Exercise 3.57</h3><p>How many additions are performed when we compute the nth Fibonacci number using the definition of fibs based on the add-streams procedure? Show that the number of additions would be exponentially greater if we had implemented (delay <exp>) simply as (lambda () <exp>), without using the optimization provided by the memo-proc procedure described in section 3.5.1.64</exp></exp></p>
<h3 id="Exercise-3-58"><a href="#Exercise-3-58" class="headerlink" title="Exercise 3.58"></a>Exercise 3.58</h3><p>Give an interpretation of the stream computed by the following procedure:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">expand</span> num den radix)</span><br><span class="line">  (<span class="name">cons-stream</span></span><br><span class="line">   (<span class="name"><span class="builtin-name">quotient</span></span> (<span class="name"><span class="builtin-name">*</span></span> num radix) den)</span><br><span class="line">   (<span class="name">expand</span> (<span class="name"><span class="builtin-name">remainder</span></span> (<span class="name"><span class="builtin-name">*</span></span> num radix) den) den radix)))</span><br></pre></td></tr></table></figure></p>
<p>(Quotient is a primitive that returns the integer quotient of two integers.) What are the successive elements produced by (expand 1 7 10) ? What is produced by (expand 3 8 10) ?</p>
<h3 id="Exercise-3-59"><a href="#Exercise-3-59" class="headerlink" title="Exercise 3.59"></a>Exercise 3.59</h3><p>In section 2.5.3 we saw how to implement a polynomial arithmetic system representing polynomials as lists of terms. In a similar way, we can work with power series, such as</p>
<p>represented as infinite streams. We will represent the series a0 + a1 x + a2 x2 + a3 x3 + ··· as the stream whose elements are the coefficients a0, a1, a2, a3, ….</p>
<p>a. The integral of the series a0 + a1 x + a2 x2 + a3 x3 + ··· is the series</p>
<p>where c is any constant. Define a procedure integrate-series that takes as input a stream a0, a1, a2, … representing a power series and returns the stream a0, (1/2)a1, (1/3)a2, … of coefficients of the non-constant terms of the integral of the series. (Since the result has no constant term, it doesn’t represent a power series; when we use integrate-series, we will cons on the appropriate constant.)</p>
<p>b. The function x ex is its own derivative. This implies that ex and the integral of ex are the same series, except for the constant term, which is e0 = 1. Accordingly, we can generate the series for ex as<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> exp-series</span><br><span class="line">  (<span class="name">cons-stream</span> <span class="number">1</span> (<span class="name">integrate-series</span> exp-series)))</span><br></pre></td></tr></table></figure></p>
<p>Show how to generate the series for sine and cosine, starting from the facts that the derivative of sine is cosine and the derivative of cosine is the negative of sine:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> cosine-series</span><br><span class="line">  (<span class="name">cons-stream</span> <span class="number">1</span> &lt;??&gt;))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> sine-series</span><br><span class="line">  (<span class="name">cons-stream</span> <span class="number">0</span> &lt;??&gt;))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-3-60"><a href="#Exercise-3-60" class="headerlink" title="Exercise 3.60"></a>Exercise 3.60</h3><p>With power series represented as streams of coefficients as in exercise 3.59, adding series is implemented by add-streams. Complete the definition of the following procedure for multiplying series:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">mul-series</span> s1 s2)</span><br><span class="line">  (<span class="name">cons-stream</span> &lt;??&gt; (<span class="name">add-streams</span> &lt;??&gt; &lt;??&gt;)))</span><br></pre></td></tr></table></figure></p>
<p>You can test your procedure by verifying that sin2 x + cos2 x = 1, using the series from exercise 3.59.</p>
<h3 id="Exercise-3-61"><a href="#Exercise-3-61" class="headerlink" title="Exercise 3.61"></a>Exercise 3.61</h3><p>Let S be a power series (exercise 3.59) whose constant term is 1. Suppose we want to find the power series 1/S, that is, the series X such that S · X = 1. Write S = 1 + SR where SR is the part of S after the constant term. Then we can solve for X as follows:</p>
<p>In other words, X is the power series whose constant term is 1 and whose higher-order terms are given by the negative of SR times X. Use this idea to write a procedure invert-unit-series that computes 1/S for a power series S with constant term 1. You will need to use mul-series from exercise 3.60.</p>
<h3 id="Exercise-3-62"><a href="#Exercise-3-62" class="headerlink" title="Exercise 3.62"></a>Exercise 3.62</h3><p>Use the results of exercises 3.60 and 3.61 to define a procedure div-series that divides two power series. Div-series should work for any two series, provided that the denominator series begins with a nonzero constant term. (If the denominator has a zero constant term, then div-series should signal an error.) Show how to use div-series together with the result of exercise 3.59 to generate the power series for tangent.</p>
<h2 id="流计算模式的使用"><a href="#流计算模式的使用" class="headerlink" title="流计算模式的使用"></a>流计算模式的使用</h2><p>(3.5.3 Exploiting the Stream Paradigm)</p>
<h3 id="Formulating-iterations-as-stream-processes"><a href="#Formulating-iterations-as-stream-processes" class="headerlink" title="Formulating iterations as stream processes"></a>Formulating iterations as stream processes</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sqrt-improve</span> guess x)</span><br><span class="line">  (<span class="name">average</span> guess (<span class="name"><span class="builtin-name">/</span></span> x guess)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sqrt-stream</span> x)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> guesses</span><br><span class="line">    (<span class="name">cons-stream</span> <span class="number">1.0</span></span><br><span class="line">                 (<span class="name">stream-map</span> (<span class="name"><span class="builtin-name">lambda</span></span> (guess)</span><br><span class="line">                               (<span class="name">sqrt-improve</span> guess x))</span><br><span class="line">                             guesses)))</span><br><span class="line">  guesses)</span><br><span class="line"></span><br><span class="line"><span class="comment">;: (display-stream (sqrt-stream 2))</span></span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">pi-summands</span> n)</span><br><span class="line">  (<span class="name">cons-stream</span> (<span class="name"><span class="builtin-name">/</span></span> <span class="number">1.0</span> n)</span><br><span class="line">               (<span class="name">stream-map</span> - (<span class="name">pi-summands</span> (<span class="name"><span class="builtin-name">+</span></span> n <span class="number">2</span>)))))</span><br><span class="line"></span><br><span class="line"><span class="comment">;: (define pi-stream</span></span><br><span class="line"><span class="comment">;:   (scale-stream (partial-sums (pi-summands 1)) 4))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;: (display-stream pi-stream)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">euler-transform</span> s)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">s0</span> (<span class="name">stream-ref</span> s <span class="number">0</span>))</span><br><span class="line">        (<span class="name">s1</span> (<span class="name">stream-ref</span> s <span class="number">1</span>))  </span><br><span class="line">        (<span class="name">s2</span> (<span class="name">stream-ref</span> s <span class="number">2</span>)))</span><br><span class="line">    (<span class="name">cons-stream</span> (<span class="name"><span class="builtin-name">-</span></span> s2 (<span class="name"><span class="builtin-name">/</span></span> (<span class="name">square</span> (<span class="name"><span class="builtin-name">-</span></span> s2 s1))</span><br><span class="line">                          (<span class="name"><span class="builtin-name">+</span></span> s0 (<span class="name"><span class="builtin-name">*</span></span> <span class="number">-2</span> s1) s2)))</span><br><span class="line">                 (<span class="name">euler-transform</span> (<span class="name">stream-cdr</span> s)))))</span><br><span class="line"></span><br><span class="line"><span class="comment">;: (display-stream (euler-transform pi-stream))</span></span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-tableau</span> transform s)</span><br><span class="line">  (<span class="name">cons-stream</span> s</span><br><span class="line">               (<span class="name">make-tableau</span> transform</span><br><span class="line">                             (<span class="name">transform</span> s))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">accelerated-sequence</span> transform s)</span><br><span class="line">  (<span class="name">stream-map</span> stream-car</span><br><span class="line">              (<span class="name">make-tableau</span> transform s)))</span><br><span class="line"></span><br><span class="line"><span class="comment">;: (display-stream (accelerated-sequence euler-transform</span></span><br><span class="line"><span class="comment">;:                                       pi-stream))</span></span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-63"><a href="#Exercise-3-63" class="headerlink" title="Exercise 3.63"></a>Exercise 3.63</h3><p>Louis Reasoner asks why the sqrt-stream procedure was not written in the following more straightforward way, without the local variable guesses:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">sqrt-stream</span> x)</span><br><span class="line">  (<span class="name">cons-stream</span> <span class="number">1.0</span></span><br><span class="line">               (<span class="name">stream-map</span> (<span class="name"><span class="builtin-name">lambda</span></span> (guess)</span><br><span class="line">                             (<span class="name">sqrt-improve</span> guess x))</span><br><span class="line">                           (<span class="name">sqrt-stream</span> x))))</span><br></pre></td></tr></table></figure></p>
<p>Alyssa P. Hacker replies that this version of the procedure is considerably less efficient because it performs redundant computation. Explain Alyssa’s answer. Would the two versions still differ in efficiency if our implementation of delay used only (lambda () <exp>) without using the optimization provided by memo-proc (section 3.5.1)?</exp></p>
<h3 id="Exercise-3-64"><a href="#Exercise-3-64" class="headerlink" title="Exercise 3.64"></a>Exercise 3.64</h3><p>Write a procedure stream-limit that takes as arguments a stream and a number (the tolerance). It should examine the stream until it finds two successive elements that differ in absolute value by less than the tolerance, and return the second of the two elements. Using this, we could compute square roots up to a given tolerance by<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name"><span class="builtin-name">sqrt</span></span> x tolerance)</span><br><span class="line">  (<span class="name">stream-limit</span> (<span class="name">sqrt-stream</span> x) tolerance))</span><br></pre></td></tr></table></figure></p>
<h3 id="Exercise-3-65"><a href="#Exercise-3-65" class="headerlink" title="Exercise 3.65"></a>Exercise 3.65</h3><p>Use the series</p>
<p>to compute three sequences of approximations to the natural logarithm of 2, in the same way we did above for . How rapidly do these sequences converge?</p>
<h3 id="Infinite-streams-of-pairs"><a href="#Infinite-streams-of-pairs" class="headerlink" title="Infinite streams of pairs"></a>Infinite streams of pairs</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;: (stream-filter (lambda (pair)</span></span><br><span class="line"><span class="comment">;:                  (prime? (+ (car pair) (cadr pair))))</span></span><br><span class="line"><span class="comment">;:                int-pairs)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">stream-append</span> s1 s2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">stream-null?</span> s1)</span><br><span class="line">      s2</span><br><span class="line">      (<span class="name">cons-stream</span> (<span class="name">stream-car</span> s1)</span><br><span class="line">                   (<span class="name">stream-append</span> (<span class="name">stream-cdr</span> s1) s2))))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">;: (pairs integers integers)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">interleave</span> s1 s2)</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">stream-null?</span> s1)</span><br><span class="line">      s2</span><br><span class="line">      (<span class="name">cons-stream</span> (<span class="name">stream-car</span> s1)</span><br><span class="line">                   (<span class="name">interleave</span> s2 (<span class="name">stream-cdr</span> s1)))))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">pairs</span> s t)</span><br><span class="line">  (<span class="name">cons-stream</span></span><br><span class="line">   (<span class="name"><span class="builtin-name">list</span></span> (<span class="name">stream-car</span> s) (<span class="name">stream-car</span> t))</span><br><span class="line">   (<span class="name">interleave</span></span><br><span class="line">    (<span class="name">stream-map</span> (<span class="name"><span class="builtin-name">lambda</span></span> (x) (<span class="name"><span class="builtin-name">list</span></span> (<span class="name">stream-car</span> s) x))</span><br><span class="line">                (<span class="name">stream-cdr</span> t))</span><br><span class="line">    (<span class="name">pairs</span> (<span class="name">stream-cdr</span> s) (<span class="name">stream-cdr</span> t)))))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-66"><a href="#Exercise-3-66" class="headerlink" title="Exercise 3.66"></a>Exercise 3.66</h3><p>Examine the stream (pairs integers integers). Can you make any general comments about the order in which the pairs are placed into the stream? For example, about how many pairs precede the pair (1,100)? the pair (99,100)? the pair (100,100)? (If you can make precise mathematical statements here, all the better. But feel free to give more qualitative answers if you find yourself getting bogged down.)</p>
<h3 id="Exercise-3-67"><a href="#Exercise-3-67" class="headerlink" title="Exercise 3.67"></a>Exercise 3.67</h3><p>Modify the pairs procedure so that (pairs integers integers) will produce the stream of all pairs of integers (i,j) (without the condition i &lt; j). Hint: You will need to mix in an additional stream.</p>
<h3 id="Exercise-3-68"><a href="#Exercise-3-68" class="headerlink" title="Exercise 3.68"></a>Exercise 3.68</h3><p>Louis Reasoner thinks that building a stream of pairs from three parts is unnecessarily complicated. Instead of separating the pair (S0,T0) from the rest of the pairs in the first row, he proposes to work with the whole first row, as follows:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">pairs</span> s t)</span><br><span class="line">  (<span class="name">interleave</span></span><br><span class="line">   (<span class="name">stream-map</span> (<span class="name"><span class="builtin-name">lambda</span></span> (x) (<span class="name"><span class="builtin-name">list</span></span> (<span class="name">stream-car</span> s) x))</span><br><span class="line">               t)</span><br><span class="line">   (<span class="name">pairs</span> (<span class="name">stream-cdr</span> s) (<span class="name">stream-cdr</span> t))))</span><br></pre></td></tr></table></figure></p>
<p>Does this work? Consider what happens if we evaluate (pairs integers integers) using Louis’s definition of pairs.</p>
<h3 id="Exercise-3-69"><a href="#Exercise-3-69" class="headerlink" title="Exercise 3.69"></a>Exercise 3.69</h3><p>Write a procedure triples that takes three infinite streams, S, T, and U, and produces the stream of triples (Si,Tj,Uk) such that i &lt; j &lt; k. Use triples to generate the stream of all Pythagorean triples of positive integers, i.e., the triples (i,j,k) such that i &lt; j and i2 + j2 = k2.</p>
<h3 id="Exercise-3-70"><a href="#Exercise-3-70" class="headerlink" title="Exercise 3.70"></a>Exercise 3.70</h3><p>It would be nice to be able to generate streams in which the pairs appear in some useful order, rather than in the order that results from an ad hoc interleaving process. We can use a technique similar to the merge procedure of exercise 3.56, if we define a way to say that one pair of integers is “less than” another. One way to do this is to define a “weighting function” W(i,j) and stipulate that (i1,j1) is less than (i2,j2) if W(i1,j1) &lt; W(i2,j2). Write a procedure merge-weighted that is like merge, except that merge-weighted takes an additional argument weight, which is a procedure that computes the weight of a pair, and is used to determine the order in which elements should appear in the resulting merged stream.69 Using this, generalize pairs to a procedure weighted-pairs that takes two streams, together with a procedure that computes a weighting function, and generates the stream of pairs, ordered according to weight. Use your procedure to generate</p>
<p>a. the stream of all pairs of positive integers (i,j) with i &lt; j ordered according to the sum i + j<br>b. the stream of all pairs of positive integers (i,j) with i &lt; j, where neither i nor j is divisible by 2, 3, or 5, and the pairs are ordered according to the sum 2 i + 3 j + 5 i j.</p>
<h3 id="Exercise-3-71"><a href="#Exercise-3-71" class="headerlink" title="Exercise 3.71"></a>Exercise 3.71</h3><p>Numbers that can be expressed as the sum of two cubes in more than one way are sometimes called Ramanujan numbers, in honor of the mathematician Srinivasa Ramanujan.70 Ordered streams of pairs provide an elegant solution to the problem of computing these numbers. To find a number that can be written as the sum of two cubes in two different ways, we need only generate the stream of pairs of integers (i,j) weighted according to the sum i3 + j3 (see exercise 3.70), then search the stream for two consecutive pairs with the same weight. Write a procedure to generate the Ramanujan numbers. The first such number is 1,729. What are the next five?</p>
<h3 id="Exercise-3-72"><a href="#Exercise-3-72" class="headerlink" title="Exercise 3.72"></a>Exercise 3.72</h3><p>In a similar way to exercise 3.71 generate a stream of all numbers that can be written as the sum of two squares in three different ways (showing how they can be so written).</p>
<h3 id="Streams-as-signals"><a href="#Streams-as-signals" class="headerlink" title="Streams as signals"></a>Streams as signals</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">integral</span> integrand initial-value dt)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> int</span><br><span class="line">    (<span class="name">cons-stream</span> initial-value</span><br><span class="line">                 (<span class="name">add-streams</span> (<span class="name">scale-stream</span> integrand dt)</span><br><span class="line">                              int)))</span><br><span class="line">  int)</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-74"><a href="#Exercise-3-74" class="headerlink" title="Exercise 3.74"></a>Exercise 3.74</h3><p>Alyssa P. Hacker is designing a system to process signals coming from physical sensors. One important feature she wishes to produce is a signal that describes the zero crossings of the input signal. That is, the resulting signal should be + 1 whenever the input signal changes from negative to positive, - 1 whenever the input signal changes from positive to negative, and 0 otherwise. (Assume that the sign of a 0 input is positive.) For example, a typical input signal with its associated zero-crossing signal would be</p>
<p>…1 2 1.5 1 0.5 -0.1 -2 -3 -2 -0.5 0.2 3 4 …… 0 0 0 0 0 -1 0 0 0 0 1 0 0 …</p>
<p>In Alyssa’s system, the signal from the sensor is represented as a stream sense-data and the stream zero-crossings is the corresponding stream of zero crossings. Alyssa first writes a procedure sign-change-detector that takes two values as arguments and compares the signs of the values to produce an appropriate 0, 1, or - 1. She then constructs her zero-crossing stream as follows:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-zero-crossings</span> input-stream last-value)</span><br><span class="line">  (<span class="name">cons-stream</span></span><br><span class="line">   (<span class="name">sign-change-detector</span> (<span class="name">stream-car</span> input-stream) last-value)</span><br><span class="line">   (<span class="name">make-zero-crossings</span> (<span class="name">stream-cdr</span> input-stream)</span><br><span class="line">                        (<span class="name">stream-car</span> input-stream))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> zero-crossings (<span class="name">make-zero-crossings</span> sense-data <span class="number">0</span>))</span><br></pre></td></tr></table></figure></p>
<p>Alyssa’s boss, Eva Lu Ator, walks by and suggests that this program is approximately equivalent to the following one, which uses the generalized version of stream-map from exercise 3.50:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> zero-crossings</span><br><span class="line">  (<span class="name">stream-map</span> sign-change-detector sense-data &lt;expression&gt;))</span><br></pre></td></tr></table></figure></p>
<p>Complete the program by supplying the indicated <expression>.</expression></p>
<h3 id="Exercise-3-75"><a href="#Exercise-3-75" class="headerlink" title="Exercise 3.75"></a>Exercise 3.75</h3><p>Unfortunately, Alyssa’s zero-crossing detector in exercise 3.74 proves to be insufficient, because the noisy signal from the sensor leads to spurious zero crossings. Lem E. Tweakit, a hardware specialist, suggests that Alyssa smooth the signal to filter out the noise before extracting the zero crossings. Alyssa takes his advice and decides to extract the zero crossings from the signal constructed by averaging each value of the sense data with the previous value. She explains the problem to her assistant, Louis Reasoner, who attempts to implement the idea, altering Alyssa’s program as follows:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-zero-crossings</span> input-stream last-value)</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">avpt</span> (<span class="name"><span class="builtin-name">/</span></span> (<span class="name"><span class="builtin-name">+</span></span> (<span class="name">stream-car</span> input-stream) last-value) <span class="number">2</span>)))</span><br><span class="line">    (<span class="name">cons-stream</span> (<span class="name">sign-change-detector</span> avpt last-value)</span><br><span class="line">                 (<span class="name">make-zero-crossings</span> (<span class="name">stream-cdr</span> input-stream)</span><br><span class="line">                                      avpt))))</span><br></pre></td></tr></table></figure></p>
<p>This does not correctly implement Alyssa’s plan. Find the bug that Louis has installed and fix it without changing the structure of the program. (Hint: You will need to increase the number of arguments to make-zero-crossings.)</p>
<h3 id="Exercise-3-76"><a href="#Exercise-3-76" class="headerlink" title="Exercise 3.76"></a>Exercise 3.76</h3><p>Eva Lu Ator has a criticism of Louis’s approach in exercise 3.75. The program he wrote is not modular, because it intermixes the operation of smoothing with the zero-crossing extraction. For example, the extractor should not have to be changed if Alyssa finds a better way to condition her input signal. Help Louis by writing a procedure smooth that takes a stream as input and produces a stream in which each element is the average of two successive input stream elements. Then use smooth as a component to implement the zero-crossing detector in a more modular style.</p>
<h2 id="流和延时求值"><a href="#流和延时求值" class="headerlink" title="流和延时求值"></a>流和延时求值</h2><p>(3.5.4 Streams and Delayed Evaluation)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> int</span><br><span class="line">  (<span class="name">cons-stream</span></span><br><span class="line">   initial-value</span><br><span class="line">   (<span class="name">add-streams</span> (<span class="name">scale-stream</span> integrand dt)</span><br><span class="line">                int)))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">solve</span> f y0 dt)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> y (<span class="name">integral</span> dy y0 dt))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> dy (<span class="name">stream-map</span> f y))</span><br><span class="line">  y)</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">integral</span> delayed-integrand initial-value dt)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> int</span><br><span class="line">    (<span class="name">cons-stream</span> initial-value</span><br><span class="line">                 (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">integrand</span> (<span class="name"><span class="builtin-name">force</span></span> delayed-integrand)))</span><br><span class="line">                   (<span class="name">add-streams</span> (<span class="name">scale-stream</span> integrand dt)</span><br><span class="line">                                int))))</span><br><span class="line">  int)</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">solve</span> f y0 dt)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> y (<span class="name">integral</span> (<span class="name"><span class="builtin-name">delay</span></span> dy) y0 dt))</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> dy (<span class="name">stream-map</span> f y))</span><br><span class="line">  y)</span><br></pre></td></tr></table></figure>
<p>;: (stream-ref (solve (lambda (y) y) 1 0.001) 1000)</p>
<h3 id="Exercise-3-77"><a href="#Exercise-3-77" class="headerlink" title="Exercise 3.77"></a>Exercise 3.77</h3><p>The integral procedure used above was analogous to the “implicit” definition of the infinite stream of integers in section 3.5.2. Alternatively, we can give a definition of integral that is more like integers-starting-from (also in section 3.5.2):<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">integral</span> integrand initial-value dt)</span><br><span class="line">  (<span class="name">cons-stream</span> initial-value</span><br><span class="line">               (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">stream-null?</span> integrand)</span><br><span class="line">                   the-empty-stream</span><br><span class="line">                   (<span class="name">integral</span> (<span class="name">stream-cdr</span> integrand)</span><br><span class="line">                             (<span class="name"><span class="builtin-name">+</span></span> (<span class="name"><span class="builtin-name">*</span></span> dt (<span class="name">stream-car</span> integrand))</span><br><span class="line">                                initial-value)</span><br><span class="line">                             dt))))</span><br></pre></td></tr></table></figure></p>
<p>When used in systems with loops, this procedure has the same problem as does our original version of integral. Modify the procedure so that it expects the integrand as a delayed argument and hence can be used in the solve procedure shown above.</p>
<h3 id="Exercise-3-78"><a href="#Exercise-3-78" class="headerlink" title="Exercise 3.78"></a>Exercise 3.78</h3><p>Figure 3.35: Signal-flow diagram for the solution to a second-order linear differential equation.<br>Consider the problem of designing a signal-processing system to study the homogeneous second-order linear differential equation</p>
<p>The output stream, modeling y, is generated by a network that contains a loop. This is because the value of d2y/dt2 depends upon the values of y and dy/dt and both of these are determined by integrating d2y/dt2. The diagram we would like to encode is shown in figure 3.35. Write a procedure solve-2nd that takes as arguments the constants a, b, and dt and the initial values y0 and dy0 for y and dy/dt and generates the stream of successive values of y.</p>
<h3 id="Exercise-3-79"><a href="#Exercise-3-79" class="headerlink" title="Exercise 3.79"></a>Exercise 3.79</h3><p>Generalize the solve-2nd procedure of exercise 3.78 so that it can be used to solve general second-order differential equations d2 y/dt2 = f(dy/dt, y).</p>
<h3 id="Exercise-3-80"><a href="#Exercise-3-80" class="headerlink" title="Exercise 3.80"></a>Exercise 3.80</h3><p>A series RLC circuit consists of a resistor, a capacitor, and an inductor connected in series, as shown in figure 3.36. If R, L, and C are the resistance, inductance, and capacitance, then the relations between voltage (v) and current (i) for the three components are described by the equations</p>
<p>and the circuit connections dictate the relations</p>
<p>Combining these equations shows that the state of the circuit (summarized by vC, the voltage across the capacitor, and iL, the current in the inductor) is described by the pair of differential equations</p>
<p>The signal-flow diagram representing this system of differential equations is shown in figure 3.37.</p>
<h3 id="Normal-order-evaluation"><a href="#Normal-order-evaluation" class="headerlink" title="Normal-order evaluation"></a>Normal-order evaluation</h3><h2 id="函数式程序的模块化和对象的模块化"><a href="#函数式程序的模块化和对象的模块化" class="headerlink" title="函数式程序的模块化和对象的模块化"></a>函数式程序的模块化和对象的模块化</h2><p>(3.5.5 Modularity of Functional Programs and Modularity of Objects)</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;; same as in section 3.1.2</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> rand</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">x</span> random-init))</span><br><span class="line">    (<span class="name"><span class="builtin-name">lambda</span></span> ()</span><br><span class="line">      (<span class="name"><span class="builtin-name">set!</span></span> x (<span class="name">rand-update</span> x))</span><br><span class="line">      x)))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> random-numbers</span><br><span class="line">  (<span class="name">cons-stream</span> random-init</span><br><span class="line">               (<span class="name">stream-map</span> rand-update random-numbers)))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> cesaro-stream</span><br><span class="line">  (<span class="name">map-successive-pairs</span> (<span class="name"><span class="builtin-name">lambda</span></span> (r1 r2) (<span class="name"><span class="builtin-name">=</span></span> (<span class="name"><span class="builtin-name">gcd</span></span> r1 r2) <span class="number">1</span>))</span><br><span class="line">                        random-numbers))</span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">map-successive-pairs</span> f s)</span><br><span class="line">  (<span class="name">cons-stream</span></span><br><span class="line">   (<span class="name">f</span> (<span class="name">stream-car</span> s) (<span class="name">stream-car</span> (<span class="name">stream-cdr</span> s)))</span><br><span class="line">   (<span class="name">map-successive-pairs</span> f (<span class="name">stream-cdr</span> (<span class="name">stream-cdr</span> s)))))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">monte-carlo</span> experiment-stream passed failed)</span><br><span class="line">  (<span class="name"><span class="builtin-name">define</span></span> (<span class="name">next</span> passed failed)</span><br><span class="line">    (<span class="name">cons-stream</span></span><br><span class="line">     (<span class="name"><span class="builtin-name">/</span></span> passed (<span class="name"><span class="builtin-name">+</span></span> passed failed))</span><br><span class="line">     (<span class="name">monte-carlo</span></span><br><span class="line">      (<span class="name">stream-cdr</span> experiment-stream) passed failed)))</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">stream-car</span> experiment-stream)</span><br><span class="line">      (<span class="name">next</span> (<span class="name"><span class="builtin-name">+</span></span> passed <span class="number">1</span>) failed)</span><br><span class="line">      (<span class="name">next</span> passed (<span class="name"><span class="builtin-name">+</span></span> failed <span class="number">1</span>))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> pi</span><br><span class="line">   (<span class="name">stream-map</span> (<span class="name"><span class="builtin-name">lambda</span></span> (p) (<span class="name"><span class="builtin-name">sqrt</span></span> (<span class="name"><span class="builtin-name">/</span></span> <span class="number">6</span> p)))</span><br><span class="line">               (<span class="name">monte-carlo</span> cesaro-stream <span class="number">0</span> <span class="number">0</span>)))</span><br></pre></td></tr></table></figure>
<h3 id="Exercise-3-81"><a href="#Exercise-3-81" class="headerlink" title="Exercise 3.81"></a>Exercise 3.81</h3><p>Exercise 3.6 discussed generalizing the random-number generator to allow one to reset the random-number sequence so as to produce repeatable sequences of “random” numbers. Produce a stream formulation of this same generator that operates on an input stream of requests to generate a new random number or to reset the sequence to a specified value and that produces the desired stream of random numbers. don’t use assignment in your solution.</p>
<h3 id="Exercise-3-82"><a href="#Exercise-3-82" class="headerlink" title="Exercise 3.82"></a>Exercise 3.82</h3><p>Redo exercise 3.5 on Monte Carlo integration in terms of streams. The stream version of estimate-integral will not have an argument telling how many trials to perform. Instead, it will produce a stream of estimates based on successively more trials.</p>
<h3 id="A-functional-programming-view-of-time"><a href="#A-functional-programming-view-of-time" class="headerlink" title="A functional-programming view of time"></a>A functional-programming view of time</h3><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;; same as in section 3.1.3</span></span><br><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">make-simplified-withdraw</span> balance)</span><br><span class="line">  (<span class="name"><span class="builtin-name">lambda</span></span> (amount)</span><br><span class="line">    (<span class="name"><span class="builtin-name">set!</span></span> balance (<span class="name"><span class="builtin-name">-</span></span> balance amount))</span><br><span class="line">    balance))</span><br></pre></td></tr></table></figure>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">stream-withdraw</span> balance amount-stream)</span><br><span class="line">  (<span class="name">cons-stream</span></span><br><span class="line">   balance</span><br><span class="line">   (<span class="name">stream-withdraw</span> (<span class="name"><span class="builtin-name">-</span></span> balance (<span class="name">stream-car</span> amount-stream))</span><br><span class="line">                    (<span class="name">stream-cdr</span> amount-stream))))</span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/06/28/SICP笔记_02_构造数据抽象/" rel="next" title="02_构造数据抽象">
                <i class="fa fa-chevron-left"></i> 02_构造数据抽象
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/07/24/MySQL安装/" rel="prev" title="MySQL安装">
                MySQL安装 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">wangzk1900</p>
              <div class="site-description motion-element" itemprop="description">记录学习总结和思考</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/wangzk1900" title="GitHub &rarr; https://github.com/wangzk1900" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:wangzk1900@gmail.com" title="E-Mail &rarr; mailto:wangzk1900@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#赋值和局部状态"><span class="nav-number">1.</span> <span class="nav-text">赋值和局部状态</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#局部状态变量"><span class="nav-number">1.1.</span> <span class="nav-text">局部状态变量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-1"><span class="nav-number">1.1.1.</span> <span class="nav-text">Exercise 3.1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-2"><span class="nav-number">1.1.2.</span> <span class="nav-text">Exercise 3.2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-3"><span class="nav-number">1.1.3.</span> <span class="nav-text">Exercise 3.3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-4"><span class="nav-number">1.1.4.</span> <span class="nav-text">Exercise 3.4</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#引进赋值带来的利益"><span class="nav-number">1.2.</span> <span class="nav-text">引进赋值带来的利益</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-5"><span class="nav-number">1.2.1.</span> <span class="nav-text">Exercise 3.5</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-6"><span class="nav-number">1.2.2.</span> <span class="nav-text">Exercise 3.6</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#引进赋值的代价"><span class="nav-number">1.3.</span> <span class="nav-text">引进赋值的代价</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-7"><span class="nav-number">1.3.1.</span> <span class="nav-text">Exercise 3.7</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-8"><span class="nav-number">1.3.2.</span> <span class="nav-text">Exercise 3.8</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#求值的环境模型"><span class="nav-number">2.</span> <span class="nav-text">求值的环境模型</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#求值的规则"><span class="nav-number">2.1.</span> <span class="nav-text">求值的规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#简单过程的应用"><span class="nav-number">2.2.</span> <span class="nav-text">简单过程的应用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-9"><span class="nav-number">2.2.1.</span> <span class="nav-text">Exercise 3.9</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Frames作为局部状态的存储库"><span class="nav-number">2.3.</span> <span class="nav-text">Frames作为局部状态的存储库</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-10"><span class="nav-number">2.3.1.</span> <span class="nav-text">Exercise 3.10</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#内部定义"><span class="nav-number">2.4.</span> <span class="nav-text">内部定义</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-11"><span class="nav-number">2.4.1.</span> <span class="nav-text">Exercise 3.11</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#用可变数据做模拟"><span class="nav-number">3.</span> <span class="nav-text">用可变数据做模拟</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#可变列表结构"><span class="nav-number">3.1.</span> <span class="nav-text">可变列表结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-12"><span class="nav-number">3.1.1.</span> <span class="nav-text">Exercise 3.12</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-13"><span class="nav-number">3.1.2.</span> <span class="nav-text">Exercise 3.13</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-14"><span class="nav-number">3.1.3.</span> <span class="nav-text">Exercise 3.14</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sharing-and-identity"><span class="nav-number">3.1.4.</span> <span class="nav-text">Sharing and identity</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-3-15"><span class="nav-number">3.1.4.1.</span> <span class="nav-text">Exercise 3.15</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-3-16"><span class="nav-number">3.1.4.2.</span> <span class="nav-text">Exercise 3.16</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise3-17"><span class="nav-number">3.1.4.3.</span> <span class="nav-text">Exercise3.17</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-3-18"><span class="nav-number">3.1.4.4.</span> <span class="nav-text">Exercise 3.18</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-3-19"><span class="nav-number">3.1.4.5.</span> <span class="nav-text">Exercise 3.19</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mutation-as-assignment"><span class="nav-number">3.1.5.</span> <span class="nav-text">Mutation as assignment</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-3-20"><span class="nav-number">3.1.5.1.</span> <span class="nav-text">Exercise 3.20</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#队列的表示"><span class="nav-number">3.2.</span> <span class="nav-text">队列的表示</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-21"><span class="nav-number">3.2.1.</span> <span class="nav-text">Exercise 3.21</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-22"><span class="nav-number">3.2.2.</span> <span class="nav-text">Exercise 3.22</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-23"><span class="nav-number">3.2.3.</span> <span class="nav-text">Exercise 3.23</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#表的表示"><span class="nav-number">3.3.</span> <span class="nav-text">表的表示</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#二维表-Two-dimensional-tables"><span class="nav-number">3.3.1.</span> <span class="nav-text">二维表(Two-dimensional tables)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建局部表-Creating-local-tables"><span class="nav-number">3.3.2.</span> <span class="nav-text">创建局部表(Creating local tables)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-3-24"><span class="nav-number">3.3.2.1.</span> <span class="nav-text">Exercise 3.24</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-3-25"><span class="nav-number">3.3.2.2.</span> <span class="nav-text">Exercise 3.25</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-3-26"><span class="nav-number">3.3.2.3.</span> <span class="nav-text">Exercise 3.26</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-3-27"><span class="nav-number">3.3.2.4.</span> <span class="nav-text">Exercise 3.27</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数字电路模拟器"><span class="nav-number">3.4.</span> <span class="nav-text">数字电路模拟器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基本功能块-Primitive-function-boxes"><span class="nav-number">3.4.1.</span> <span class="nav-text">基本功能块(Primitive function boxes)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-3-28"><span class="nav-number">3.4.1.1.</span> <span class="nav-text">Exercise 3.28</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-3-29"><span class="nav-number">3.4.1.2.</span> <span class="nav-text">Exercise 3.29</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-3-30"><span class="nav-number">3.4.1.3.</span> <span class="nav-text">Exercise 3.30</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#导线的表示-Representing-wires"><span class="nav-number">3.4.2.</span> <span class="nav-text">导线的表示(Representing wires)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#待处理表-The-agenda"><span class="nav-number">3.4.3.</span> <span class="nav-text">待处理表(The agenda)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#一个模拟示例-A-sample-simulation"><span class="nav-number">3.4.4.</span> <span class="nav-text">一个模拟示例(A sample simulation)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-3-31"><span class="nav-number">3.4.4.1.</span> <span class="nav-text">Exercise 3.31</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#待处理表的实现-Implementing-agenda"><span class="nav-number">3.4.5.</span> <span class="nav-text">待处理表的实现(Implementing agenda)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-3-32"><span class="nav-number">3.4.5.1.</span> <span class="nav-text">Exercise 3.32</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#约束的传递"><span class="nav-number">3.5.</span> <span class="nav-text">约束的传递</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#约束系统的使用-Using-the-constraint-system"><span class="nav-number">3.5.1.</span> <span class="nav-text">约束系统的使用(Using the constraint system)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#约束系统的实现-Implementing-the-constraint-system"><span class="nav-number">3.5.2.</span> <span class="nav-text">约束系统的实现(Implementing the constraint system)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#连接器的表示-Representing-connectors"><span class="nav-number">3.5.3.</span> <span class="nav-text">连接器的表示(Representing connectors)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-33"><span class="nav-number">3.5.4.</span> <span class="nav-text">Exercise 3.33</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-34"><span class="nav-number">3.5.5.</span> <span class="nav-text">Exercise 3.34</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-35"><span class="nav-number">3.5.6.</span> <span class="nav-text">Exercise 3.35</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-36"><span class="nav-number">3.5.7.</span> <span class="nav-text">Exercise 3.36</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-37"><span class="nav-number">3.5.8.</span> <span class="nav-text">Exercise 3.37</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#并发：时间是一个本质问题"><span class="nav-number">3.6.</span> <span class="nav-text">并发：时间是一个本质问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#并发系统中时间的性质"><span class="nav-number">3.7.</span> <span class="nav-text">并发系统中时间的性质</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Correct-behavior-of-concurrent-programs"><span class="nav-number">3.7.1.</span> <span class="nav-text">Correct behavior of concurrent programs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-38"><span class="nav-number">3.7.2.</span> <span class="nav-text">Exercise 3.38</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#控制并发的机制"><span class="nav-number">3.8.</span> <span class="nav-text">控制并发的机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Serializing-access-to-shared-state"><span class="nav-number">3.8.1.</span> <span class="nav-text">Serializing access to shared state</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Serializers-in-Scheme"><span class="nav-number">3.8.2.</span> <span class="nav-text">Serializers in Scheme</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-39"><span class="nav-number">3.8.3.</span> <span class="nav-text">Exercise 3.39</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-40"><span class="nav-number">3.8.4.</span> <span class="nav-text">Exercise 3.40</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-41"><span class="nav-number">3.8.5.</span> <span class="nav-text">Exercise 3.41</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-42"><span class="nav-number">3.8.6.</span> <span class="nav-text">Exercise 3.42</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Complexity-of-using-multiple-shared-resources"><span class="nav-number">3.8.7.</span> <span class="nav-text">Complexity of using multiple shared resources</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-43"><span class="nav-number">3.8.8.</span> <span class="nav-text">Exercise 3.43</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-44"><span class="nav-number">3.8.9.</span> <span class="nav-text">Exercise 3.44</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-45"><span class="nav-number">3.8.10.</span> <span class="nav-text">Exercise 3.45</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Implementing-serializers"><span class="nav-number">3.8.11.</span> <span class="nav-text">Implementing serializers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-46"><span class="nav-number">3.8.12.</span> <span class="nav-text">Exercise 3.46</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-47"><span class="nav-number">3.8.13.</span> <span class="nav-text">Exercise 3.47</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Deadlock"><span class="nav-number">3.8.14.</span> <span class="nav-text">Deadlock</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-48"><span class="nav-number">3.8.15.</span> <span class="nav-text">Exercise 3.48</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-49"><span class="nav-number">3.8.16.</span> <span class="nav-text">Exercise 3.49</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Concurrency-time-and-communication"><span class="nav-number">3.8.17.</span> <span class="nav-text">Concurrency, time, and communication</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#流"><span class="nav-number">3.9.</span> <span class="nav-text">流</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#流作为延时的表"><span class="nav-number">3.10.</span> <span class="nav-text">流作为延时的表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#The-stream-implementation-in-action"><span class="nav-number">3.10.1.</span> <span class="nav-text">The stream implementation in action</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Implementing-delay-and-force"><span class="nav-number">3.10.2.</span> <span class="nav-text">Implementing delay and force</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-50"><span class="nav-number">3.10.3.</span> <span class="nav-text">Exercise 3.50</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-51"><span class="nav-number">3.10.4.</span> <span class="nav-text">Exercise 3.51</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-52"><span class="nav-number">3.10.5.</span> <span class="nav-text">Exercise 3.52</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#无穷流"><span class="nav-number">3.11.</span> <span class="nav-text">无穷流</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Defining-streams-implicitly"><span class="nav-number">3.11.1.</span> <span class="nav-text">Defining streams implicitly</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-53"><span class="nav-number">3.11.2.</span> <span class="nav-text">Exercise 3.53</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-54"><span class="nav-number">3.11.3.</span> <span class="nav-text">Exercise 3.54</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-55"><span class="nav-number">3.11.4.</span> <span class="nav-text">Exercise 3.55</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-56"><span class="nav-number">3.11.5.</span> <span class="nav-text">Exercise 3.56</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-57"><span class="nav-number">3.11.6.</span> <span class="nav-text">Exercise 3.57</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-58"><span class="nav-number">3.11.7.</span> <span class="nav-text">Exercise 3.58</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-59"><span class="nav-number">3.11.8.</span> <span class="nav-text">Exercise 3.59</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-60"><span class="nav-number">3.11.9.</span> <span class="nav-text">Exercise 3.60</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-61"><span class="nav-number">3.11.10.</span> <span class="nav-text">Exercise 3.61</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-62"><span class="nav-number">3.11.11.</span> <span class="nav-text">Exercise 3.62</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#流计算模式的使用"><span class="nav-number">3.12.</span> <span class="nav-text">流计算模式的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Formulating-iterations-as-stream-processes"><span class="nav-number">3.12.1.</span> <span class="nav-text">Formulating iterations as stream processes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-63"><span class="nav-number">3.12.2.</span> <span class="nav-text">Exercise 3.63</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-64"><span class="nav-number">3.12.3.</span> <span class="nav-text">Exercise 3.64</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-65"><span class="nav-number">3.12.4.</span> <span class="nav-text">Exercise 3.65</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Infinite-streams-of-pairs"><span class="nav-number">3.12.5.</span> <span class="nav-text">Infinite streams of pairs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-66"><span class="nav-number">3.12.6.</span> <span class="nav-text">Exercise 3.66</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-67"><span class="nav-number">3.12.7.</span> <span class="nav-text">Exercise 3.67</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-68"><span class="nav-number">3.12.8.</span> <span class="nav-text">Exercise 3.68</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-69"><span class="nav-number">3.12.9.</span> <span class="nav-text">Exercise 3.69</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-70"><span class="nav-number">3.12.10.</span> <span class="nav-text">Exercise 3.70</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-71"><span class="nav-number">3.12.11.</span> <span class="nav-text">Exercise 3.71</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-72"><span class="nav-number">3.12.12.</span> <span class="nav-text">Exercise 3.72</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Streams-as-signals"><span class="nav-number">3.12.13.</span> <span class="nav-text">Streams as signals</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-74"><span class="nav-number">3.12.14.</span> <span class="nav-text">Exercise 3.74</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-75"><span class="nav-number">3.12.15.</span> <span class="nav-text">Exercise 3.75</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-76"><span class="nav-number">3.12.16.</span> <span class="nav-text">Exercise 3.76</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#流和延时求值"><span class="nav-number">3.13.</span> <span class="nav-text">流和延时求值</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-77"><span class="nav-number">3.13.1.</span> <span class="nav-text">Exercise 3.77</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-78"><span class="nav-number">3.13.2.</span> <span class="nav-text">Exercise 3.78</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-79"><span class="nav-number">3.13.3.</span> <span class="nav-text">Exercise 3.79</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-80"><span class="nav-number">3.13.4.</span> <span class="nav-text">Exercise 3.80</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Normal-order-evaluation"><span class="nav-number">3.13.5.</span> <span class="nav-text">Normal-order evaluation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#函数式程序的模块化和对象的模块化"><span class="nav-number">3.14.</span> <span class="nav-text">函数式程序的模块化和对象的模块化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-81"><span class="nav-number">3.14.1.</span> <span class="nav-text">Exercise 3.81</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exercise-3-82"><span class="nav-number">3.14.2.</span> <span class="nav-text">Exercise 3.82</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#A-functional-programming-view-of-time"><span class="nav-number">3.14.3.</span> <span class="nav-text">A functional-programming view of time</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wangzk1900</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.1.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.1"></script>

  <script src="/js/motion.js?v=7.1.1"></script>



  
  


  <script src="/js/affix.js?v=7.1.1"></script>

  <script src="/js/schemes/pisces.js?v=7.1.1"></script>




  
  <script src="/js/scrollspy.js?v=7.1.1"></script>
<script src="/js/post-details.js?v=7.1.1"></script>



  


  <script src="/js/next-boot.js?v=7.1.1"></script>


  

  

  

  


  


  




  

  

  
  

  
  

  
    
      <script type="text/x-mathjax-config">
  

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });
  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') { next = next.nextSibling }
        if (next && next.nodeName.toLowerCase() === 'br') { next.parentNode.removeChild(next) }
      }
    });
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      document.getElementById(all[i].inputID + '-Frame').parentNode.className += ' has-jax';
    }
  });
</script>
<script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=default"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

    
  


  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
